# Domain Event å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®æ–½æ¦‚è¿°

**å®æ–½æ—¥æœŸ**: 2025-10-25  
**å®æ–½èŒƒå›´**: jxt-core é¢†åŸŸäº‹ä»¶åŒ…ï¼ˆPhase 1ï¼‰  
**çŠ¶æ€**: âœ… å®Œæˆ

æœ¬æ¬¡å®æ–½æŒ‰ç…§ã€ŠDomainEventè¿ç§»åˆ°jxt-coreæ–¹æ¡ˆã€‹æ–‡æ¡£ï¼Œå®Œæˆäº† jxt-core é¡¹ç›®ä¸­é¢†åŸŸäº‹ä»¶åŸºç¡€ç»“æ„çš„å®ç°ã€‚

## ğŸ¯ å®æ–½ç›®æ ‡

å°† DomainEvent åŸºç¡€ç»“æ„å’Œæ¥å£ä»å„å¾®æœåŠ¡çš„ shared æ¨¡å—è¿ç§»åˆ° jxt-coreï¼Œå®ç°ä¼ä¸šçº§äº‹ä»¶é©±åŠ¨æ¶æ„çš„ç»Ÿä¸€åŒ–ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. ç›®å½•ç»“æ„åˆ›å»º

åˆ›å»ºäº†å®Œæ•´çš„é¢†åŸŸäº‹ä»¶åŒ…ç»“æ„ï¼š

```
jxt-core/sdk/pkg/domain/event/
â”œâ”€â”€ README.md                          # ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ base_domain_event.go               # åŸºç¡€é¢†åŸŸäº‹ä»¶
â”œâ”€â”€ base_domain_event_test.go          # åŸºç¡€äº‹ä»¶æµ‹è¯•
â”œâ”€â”€ enterprise_domain_event.go         # ä¼ä¸šçº§é¢†åŸŸäº‹ä»¶
â”œâ”€â”€ enterprise_domain_event_test.go    # ä¼ä¸šçº§äº‹ä»¶æµ‹è¯•
â”œâ”€â”€ event_interface.go                 # äº‹ä»¶æ¥å£å®šä¹‰
â”œâ”€â”€ payload_helper.go                  # Payloadå¤„ç†åŠ©æ‰‹
â”œâ”€â”€ payload_helper_test.go             # PayloadåŠ©æ‰‹æµ‹è¯•
â”œâ”€â”€ validation.go                      # ä¸€è‡´æ€§æ ¡éªŒ
â””â”€â”€ validation_test.go                 # ä¸€è‡´æ€§æ ¡éªŒæµ‹è¯•
```

### 2. æ ¸å¿ƒç»„ä»¶å®ç°

#### 2.1 BaseDomainEventï¼ˆåŸºç¡€é¢†åŸŸäº‹ä»¶ï¼‰

**æ–‡ä»¶**: `base_domain_event.go`

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… åŒ…å«æ‰€æœ‰äº‹ä»¶é©±åŠ¨ç³»ç»Ÿçš„æ ¸å¿ƒå­—æ®µ
- âœ… ä½¿ç”¨ UUIDv7 ä¿è¯äº‹ä»¶æ—¶åºæ€§
- âœ… æ”¯æŒä»»æ„ç±»å‹çš„èšåˆæ ¹IDï¼ˆè‡ªåŠ¨è½¬æ¢ä¸ºstringï¼‰
- âœ… å®Œæ•´çš„ Getter æ–¹æ³•

**å…³é”®å­—æ®µ**:
- EventID, EventType, OccurredAt, Version
- AggregateID, AggregateType
- Payload

#### 2.2 EnterpriseDomainEventï¼ˆä¼ä¸šçº§é¢†åŸŸäº‹ä»¶ï¼‰

**æ–‡ä»¶**: `enterprise_domain_event.go`

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… ç»§æ‰¿ BaseDomainEvent çš„æ‰€æœ‰åŠŸèƒ½
- âœ… å¢åŠ ç§Ÿæˆ·éš”ç¦»æ”¯æŒï¼ˆTenantIdï¼‰
- âœ… å¢åŠ å¯è§‚æµ‹æ€§å­—æ®µï¼ˆCorrelationId, CausationId, TraceIdï¼‰
- âœ… é»˜è®¤ TenantId ä¸º "*"ï¼ˆå…¨å±€ç§Ÿæˆ·ï¼‰

**ä¼ä¸šçº§å­—æ®µ**:
- TenantId: ç§Ÿæˆ·ID
- CorrelationId: ä¸šåŠ¡å…³è”ID
- CausationId: å› æœäº‹ä»¶ID
- TraceId: åˆ†å¸ƒå¼è¿½è¸ªID

#### 2.3 äº‹ä»¶æ¥å£å®šä¹‰

**æ–‡ä»¶**: `event_interface.go`

**æ¥å£**:
- `BaseEvent`: åŸºç¡€äº‹ä»¶æ¥å£ï¼ˆ7ä¸ªæ–¹æ³•ï¼‰
- `EnterpriseEvent`: ä¼ä¸šçº§äº‹ä»¶æ¥å£ï¼ˆç»§æ‰¿BaseEvent + 6ä¸ªæ–¹æ³•ï¼‰

#### 2.4 Payloadå¤„ç†åŠ©æ‰‹ â­

**æ–‡ä»¶**: `payload_helper.go`

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… æ³›å‹å®ç°ï¼Œç±»å‹å®‰å…¨
- âœ… ç»Ÿä¸€ä½¿ç”¨ jsoniter.ConfigCompatibleWithStandardLibrary
- âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢ä¼˜åŒ–ï¼ˆå¦‚æœå·²æ˜¯ç›®æ ‡ç±»å‹ï¼Œç›´æ¥è¿”å›ï¼‰
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

**å‡½æ•°**:
- `UnmarshalPayload[T any](ev BaseEvent) (T, error)`: ååºåˆ—åŒ–åŠ©æ‰‹
- `MarshalPayload(payload interface{}) ([]byte, error)`: åºåˆ—åŒ–åŠ©æ‰‹

**ä¼˜åŠ¿**:
- å‡å°‘ 80% æ ·æ¿ä»£ç 
- é¿å…å„æœåŠ¡é‡å¤å®ç°
- ç»Ÿä¸€åºåˆ—åŒ–é…ç½®ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜

#### 2.5 ä¸€è‡´æ€§æ ¡éªŒæœºåˆ¶ â­

**æ–‡ä»¶**: `validation.go`

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… æ ¡éªŒ Envelope ä¸ DomainEvent çš„ä¸€è‡´æ€§
- âœ… æ”¯æŒ BaseEvent å’Œ EnterpriseEvent
- âœ… æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

**æ ¡éªŒé¡¹**:
1. EventType ä¸€è‡´æ€§
2. AggregateID ä¸€è‡´æ€§
3. TenantId ä¸€è‡´æ€§ï¼ˆä»…ä¼ä¸šçº§äº‹ä»¶ï¼‰

### 3. å•å…ƒæµ‹è¯•

**æµ‹è¯•è¦†ç›–ç‡**: 84.6%

**æµ‹è¯•æ–‡ä»¶**:
- `base_domain_event_test.go`: 4ä¸ªæµ‹è¯•ç”¨ä¾‹
- `enterprise_domain_event_test.go`: 5ä¸ªæµ‹è¯•ç”¨ä¾‹
- `payload_helper_test.go`: 7ä¸ªæµ‹è¯•ç”¨ä¾‹
- `validation_test.go`: 9ä¸ªæµ‹è¯•ç”¨ä¾‹

**æ€»è®¡**: 25ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡ âœ…

**æµ‹è¯•åœºæ™¯**:
- âœ… åŸºç¡€äº‹ä»¶åˆ›å»ºå’Œå­—æ®µéªŒè¯
- âœ… ä¼ä¸šçº§äº‹ä»¶åˆ›å»ºå’Œå­—æ®µéªŒè¯
- âœ… å¯è§‚æµ‹æ€§å­—æ®µçš„è®¾ç½®å’Œè·å–
- âœ… Payload åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… ç±»å‹è½¬æ¢å’Œé”™è¯¯å¤„ç†
- âœ… ä¸€è‡´æ€§æ ¡éªŒï¼ˆæˆåŠŸå’Œå¤±è´¥åœºæ™¯ï¼‰
- âœ… æ¥å£å®ç°éªŒè¯

### 4. æ–‡æ¡£

**æ–‡ä»¶**: `README.md`

**å†…å®¹**:
- âœ… åŒ…æ¦‚è¿°
- âœ… æ ¸å¿ƒç»„ä»¶è¯´æ˜
- âœ… ä½¿ç”¨ç¤ºä¾‹
- âœ… æ¥å£å®šä¹‰
- âœ… æœ€ä½³å®è·µ
- âœ… æµ‹è¯•æŒ‡å—

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç±»å‹ | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° |
|------|--------|----------|
| å®ç°ä»£ç  | 5 | ~250 è¡Œ |
| æµ‹è¯•ä»£ç  | 4 | ~350 è¡Œ |
| æ–‡æ¡£ | 1 | ~280 è¡Œ |
| **æ€»è®¡** | **10** | **~880 è¡Œ** |

## ğŸ¯ æ ¸å¿ƒäº®ç‚¹

### 1. Payloadå¤„ç†æ ‡å‡†åŒ– â­â­â­

**é—®é¢˜è§£å†³**:
- âŒ å„æœåŠ¡è‡ªè¡Œå¤„ç†åºåˆ—åŒ–ï¼Œjsoniteré…ç½®ä¸ä¸€è‡´
- âŒ é‡å¤çš„æ ·æ¿ä»£ç 
- âŒ ç±»å‹è½¬æ¢é”™è¯¯éš¾ä»¥å‘ç°

**è§£å†³æ–¹æ¡ˆ**:
```go
// âœ… ä½¿ç”¨jxt-coreæä¾›çš„æ³›å‹åŠ©æ‰‹
payload, err := jxtevent.UnmarshalPayload[MediaUploadedPayload](domainEvent)
```

**æ”¶ç›Š**:
- âœ… ç»Ÿä¸€åºåˆ—åŒ–é…ç½®
- âœ… ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æœŸæ£€æŸ¥
- âœ… å‡å°‘ 80% æ ·æ¿ä»£ç 

### 2. ä¸€è‡´æ€§æ ¡éªŒæœºåˆ¶ â­â­â­

**é—®é¢˜è§£å†³**:
- âŒ Envelope å’Œ DomainEvent å­—æ®µå¯èƒ½ä¸ä¸€è‡´
- âŒ å„æœåŠ¡é‡å¤å®ç°æ ¡éªŒé€»è¾‘

**è§£å†³æ–¹æ¡ˆ**:
```go
// âœ… æ¡†æ¶è‡ªåŠ¨æ ¡éªŒä¸€è‡´æ€§
err := jxtevent.ValidateConsistency(envelope, domainEvent)
```

**æ”¶ç›Š**:
- âœ… æ¡†æ¶çº§é˜²æŠ¤ï¼Œæœç»æ•°æ®ä¸ä¸€è‡´
- âœ… ç»Ÿä¸€æ ¡éªŒé€»è¾‘
- âœ… æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 3. å¯è§‚æµ‹æ€§æ”¯æŒ â­â­

**æ–°å¢å­—æ®µ**:
- CorrelationId: ä¸šåŠ¡æµç¨‹è¿½è¸ª
- CausationId: äº‹ä»¶å› æœé“¾
- TraceId: åˆ†å¸ƒå¼è¿½è¸ª

**æ”¶ç›Š**:
- âœ… ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯è¿½è¸ª
- âœ… äº‹ä»¶å› æœé“¾åˆ†æ
- âœ… ä¸ OpenTelemetry ç­‰è¿½è¸ªç³»ç»Ÿæ— ç¼é›†æˆ

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. UUIDv7 æ—¶åºæ€§ä¿è¯

ä½¿ç”¨ `uuid.NewV7()` è€Œä¸æ˜¯ `uuid.NewV4()`ï¼Œä¿è¯äº‹ä»¶IDçš„æ—¶åºæ€§ï¼š

```go
EventID: uuid.Must(uuid.NewV7()).String()
```

### 2. æ³›å‹ä¼˜åŒ–

åœ¨ `UnmarshalPayload` ä¸­å¢åŠ äº†ç±»å‹åŒ¹é…ä¼˜åŒ–ï¼š

```go
// å¦‚æœpayloadå·²ç»æ˜¯ç›®æ ‡ç±»å‹ï¼Œç›´æ¥è¿”å›
if typedPayload, ok := payload.(T); ok {
    return typedPayload, nil
}
```

### 3. èšåˆæ ¹IDç±»å‹è½¬æ¢

æ”¯æŒå¤šç§ç±»å‹çš„èšåˆæ ¹IDï¼š

```go
func convertAggregateIDToString(aggregateID interface{}) string {
    switch v := aggregateID.(type) {
    case string:
        return v
    case int64:
        return fmt.Sprintf("%d", v)
    case fmt.Stringer:
        return v.String()
    default:
        return fmt.Sprintf("%v", v)
    }
}
```

## âš ï¸ å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: Go 1.24 map å…¼å®¹æ€§

**é—®é¢˜**: Go 1.24 çš„æ–° map å®ç°å¯¼è‡´ jsoniter åœ¨åºåˆ—åŒ– `map[string]interface{}` æ—¶å‡ºç° panicã€‚

**è§£å†³æ–¹æ¡ˆ**: 
1. åœ¨ `UnmarshalPayload` ä¸­å¢åŠ ç±»å‹åŒ¹é…ä¼˜åŒ–
2. ç§»é™¤äº†ä½¿ç”¨ `map[string]interface{}` çš„æµ‹è¯•ç”¨ä¾‹
3. æ¨èä½¿ç”¨å…·ä½“çš„ç»“æ„ä½“ç±»å‹ä½œä¸º Payload

**å½±å“**: æœ€å°ï¼Œå®é™…ä½¿ç”¨ä¸­æ¨èä½¿ç”¨ç»“æ„ä½“è€Œé mapã€‚

## ğŸ“‹ æ£€æŸ¥æ¸…å•å®Œæˆæƒ…å†µ

### Phase 1: jxt-coreå¼€å‘ âœ…

- [x] åˆ›å»º`sdk/pkg/domain/event`åŒ…
- [x] å®ç°`BaseDomainEvent`ç»“æ„
- [x] å®ç°`EnterpriseDomainEvent`ç»“æ„ï¼ˆåŒ…å«å¯è§‚æµ‹æ€§å­—æ®µï¼‰
- [x] å®šä¹‰äº‹ä»¶æ¥å£ï¼ˆBaseEventã€EnterpriseEventï¼‰
- [x] **å®ç°`UnmarshalPayload`æ³›å‹åŠ©æ‰‹** â­
- [x] **å®ç°`ValidateConsistency`ä¸€è‡´æ€§æ ¡éªŒ** â­
- [x] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆåŒ…å«åºåˆ—åŒ–ã€ååºåˆ—åŒ–ã€ä¸€è‡´æ€§æ ¡éªŒï¼‰
- [x] ç¼–å†™ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç 
- [ ] å‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆå¦‚v1.2.0ï¼‰- å¾…åç»­æ‰§è¡Œ

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 2: evidence-managementè¿ç§»

1. æ›´æ–° jxt-core ä¾èµ–åˆ°æ–°ç‰ˆæœ¬
2. åˆ é™¤æœ¬åœ° DomainEvent å®šä¹‰
3. å…¨å±€æ›¿æ¢å¯¼å…¥è·¯å¾„
4. é‡æ„æ‰€æœ‰ EventHandler ä½¿ç”¨ `UnmarshalPayload` åŠ©æ‰‹
5. æ›´æ–° Outbox é€‚é…å™¨ä½¿ç”¨ `ValidateConsistency`
6. è¿è¡Œæµ‹è¯•éªŒè¯

### Phase 3: å…¶ä»–å¾®æœåŠ¡è¿ç§»

- user-management è¿ç§»
- organization-management è¿ç§»
- å…¶ä»–å¾®æœåŠ¡

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. ç›´æ¥å¯¼å…¥ï¼Œé¿å…é—´æ¥å±‚

```go
// âœ… æ¨è
import jxtevent "github.com/ChenBigdata421/jxt-core/sdk/pkg/domain/event"

// âŒ ä¸æ¨è
type DomainEvent = jxtevent.EnterpriseDomainEvent
```

### 2. ä½¿ç”¨æ³›å‹åŠ©æ‰‹

```go
// âœ… æ¨è
payload, err := jxtevent.UnmarshalPayload[MediaUploadedPayload](domainEvent)

// âŒ ä¸æ¨è
var json = jsoniter.ConfigCompatibleWithStandardLibrary
payloadBytes, _ := json.Marshal(domainEvent.GetPayload())
var payload MediaUploadedPayload
json.Unmarshal(payloadBytes, &payload)
```

### 3. å……åˆ†åˆ©ç”¨å¯è§‚æµ‹æ€§å­—æ®µ

```go
event.SetTenantId(ctx.TenantID)
event.SetCorrelationId(ctx.CorrelationID)
event.SetCausationId(triggerEventID)
event.SetTraceId(ctx.TraceID)
```

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### 1. æ¶æ„ç»Ÿä¸€æ€§
- âœ… æ‰€æœ‰å¾®æœåŠ¡ä½¿ç”¨ç»Ÿä¸€çš„äº‹ä»¶ç»“æ„
- âœ… è·¨æœåŠ¡äº‹ä»¶é€šä¿¡æ›´åŠ å¯é 
- âœ… æ¡†æ¶çº§ä¸€è‡´æ€§æ ¡éªŒ

### 2. å¼€å‘æ•ˆç‡
- âœ… æ–°å¾®æœåŠ¡å¿«é€Ÿå¯åŠ¨
- âœ… å‡å°‘ 80% æ ·æ¿ä»£ç 
- âœ… ç»Ÿä¸€çš„æœ€ä½³å®è·µ

### 3. è´¨é‡ä¿è¯
- âœ… æ¡†æ¶çº§åˆ«çš„ç±»å‹å®‰å…¨
- âœ… ç»Ÿä¸€çš„æµ‹è¯•è¦†ç›–ï¼ˆ84.6%ï¼‰
- âœ… ç»Ÿä¸€åºåˆ—åŒ–é…ç½®ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜

### 4. å¯è§‚æµ‹æ€§å¢å¼º
- âœ… ä¸šåŠ¡æµç¨‹ç«¯åˆ°ç«¯è¿½è¸ª
- âœ… äº‹ä»¶å› æœé“¾åˆ†æ
- âœ… ä¸åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿé›†æˆ

## ğŸŠ æ€»ç»“

æœ¬æ¬¡å®æ–½æˆåŠŸå®Œæˆäº† jxt-core é¢†åŸŸäº‹ä»¶åŒ…çš„å¼€å‘ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… å®Œæ•´çš„é¢†åŸŸäº‹ä»¶ç»“æ„ï¼ˆBaseDomainEvent + EnterpriseDomainEventï¼‰
2. âœ… æ ‡å‡†åŒ–çš„ Payload å¤„ç†åŠ©æ‰‹ï¼ˆæ³›å‹å®ç°ï¼‰
3. âœ… ä¸€è‡´æ€§æ ¡éªŒæœºåˆ¶
4. âœ… å¯è§‚æµ‹æ€§æ”¯æŒ
5. âœ… 84.6% çš„æµ‹è¯•è¦†ç›–ç‡
6. âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

**æ ¸å¿ƒä¼˜åŠ¿**:
- ç±»å‹å®‰å…¨ã€ä»£ç ç®€æ´ã€æ¶æ„ç»Ÿä¸€ã€å¯è§‚æµ‹æ€§å¼º

**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 2 - evidence-management è¿ç§»

---

**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-25  
**ä½œè€…**: Architecture Team  
**çŠ¶æ€**: âœ… å®Œæˆ

