# NATS JetStream Hollywood Actor Pool 性能测试报告

## 📊 测试概览

**测试日期**: 2025-10-29  
**测试文件**: `jxt-core/tests/eventbus/performance_regression_tests/kafka_nats_envelope_comparison_test.go`  
**测试时长**: 347.38 秒（约 5.8 分钟）  
**测试场景**: 4 个压力级别（低压、中压、高压、极限）  
**测试次数**: 8 次（Kafka 4 次 + NATS 4 次）  
**测试结果**: ✅ **PASS**

---

## 🎯 测试目的

验证 NATS JetStream 迁移到 Hollywood Actor Pool 后的性能表现，并与 Kafka EventBus（已使用 Hollywood Actor Pool）进行对比。

---

## 📈 性能指标汇总表

| 压力级别 | 系统 | 吞吐量(msg/s) | 延迟(ms) | 成功率(%) | 内存增量(MB) | 协程泄漏 |
|---------|------|--------------|---------|----------|-------------|---------|
| **低压** | Kafka | 33.32 | 468.814 | 100.00 | 1.35 | 0 |
| **低压** | NATS | 33.27 | 85.353 | 100.00 | 2.22 | 1 |
| **中压** | Kafka | 133.24 | 590.221 | 100.00 | 2.33 | 0 |
| **中压** | NATS | 132.13 | 327.105 | 100.00 | 2.64 | 1 |
| **高压** | Kafka | 166.58 | 734.962 | 100.00 | 4.26 | 0 |
| **高压** | NATS | 164.52 | 989.018 | 100.00 | 3.34 | 1 |
| **极限** | Kafka | 332.93 | 927.031 | 100.00 | 7.21 | 0 |
| **极限** | NATS | 322.24 | 2000.396 | 100.00 | 4.33 | 1 |

---

## 🏆 综合评分

### 平均性能对比

| 指标 | Kafka | NATS | Kafka 优势 |
|------|-------|------|-----------|
| **平均吞吐量** | 166.52 msg/s | 163.04 msg/s | +2.13% ✅ |
| **平均延迟** | 680.257 ms | 850.468 ms | -20.01% ✅ |
| **平均内存增量** | 3.79 MB | 3.13 MB | +17.33% ❌ |

### 最终结论

**🥇 Kafka 以 2:1 获胜！**

- ✅ **吞吐量**: Kafka 胜出 (+2.13%)
- ✅ **延迟**: Kafka 胜出 (-20.01%)
- ✅ **内存效率**: NATS 胜出 (-17.33%)

---

## 📊 各压力级别详细分析

### 1. 低压测试（1000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 | 协程泄漏 |
|------|--------|------|--------|----------|----------|
| **Kafka** | 33.32 msg/s | 468.814 ms | 100.00% | 1.35 MB | 0 |
| **NATS** | 33.27 msg/s | 85.353 ms | 100.00% | 2.22 MB | 1 |

**关键发现**:
- NATS 在低压力下延迟更低（**-81.79%**）
- Kafka 内存占用更少（-39.19%）
- NATS 有 1 个协程泄漏

### 2. 中压测试（4000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 | 协程泄漏 |
|------|--------|------|--------|----------|----------|
| **Kafka** | 133.24 msg/s | 590.221 ms | 100.00% | 2.33 MB | 0 |
| **NATS** | 132.13 msg/s | 327.105 ms | 100.00% | 2.64 MB | 1 |

**关键发现**:
- NATS 延迟仍然较低（**-44.58%**）
- Kafka 吞吐量略高（+0.84%）
- 内存占用相近

### 3. 高压测试（6000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 | 协程泄漏 |
|------|--------|------|--------|----------|----------|
| **Kafka** | 166.58 msg/s | 734.962 ms | 100.00% | 4.26 MB | 0 |
| **NATS** | 164.52 msg/s | 989.018 ms | 100.00% | 3.34 MB | 1 |

**关键发现**:
- **转折点**: NATS 延迟开始超过 Kafka（+34.57%）
- Kafka 吞吐量优势增加（+1.25%）
- NATS 内存占用更少（-21.60%）

### 4. 极限测试（10000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 | 协程泄漏 |
|------|--------|------|--------|----------|----------|
| **Kafka** | 332.93 msg/s | 927.031 ms | 100.00% | 7.21 MB | 0 |
| **NATS** | 322.24 msg/s | 2000.396 ms | 100.00% | 4.33 MB | 1 |

**关键发现**:
- Kafka 延迟优势显著（**-53.66%**）
- Kafka 吞吐量优势明显（+3.32%）
- NATS 内存占用更少（-39.97%）
- **极限压力下，Kafka 表现更稳定**

---

## 🔍 资源占用详细分析

### 极限测试资源对比

| 资源指标 | Kafka | NATS | 对比 |
|---------|-------|------|------|
| **初始协程数** | 6 | 6 | 相同 |
| **峰值协程数** | 122 | 1067 | Kafka 更稳定 |
| **最终协程数** | 6 | 7 | NATS 有泄漏 |
| **协程泄漏** | 0 | 1 | Kafka 更好 |
| **初始内存** | 11.15 MB | 12.05 MB | 相近 |
| **峰值内存** | 52.28 MB | 44.06 MB | NATS 更低 |
| **最终内存** | 18.36 MB | 16.38 MB | NATS 更低 |
| **内存增量** | 7.21 MB | 4.33 MB | NATS 更好 |

**关键洞察**:
1. **Kafka 协程管理更稳定**: 峰值协程数仅 122，而 NATS 达到 1067
2. **Kafka 无协程泄漏**: 所有测试场景下都是 0 泄漏
3. **NATS 内存效率更高**: 内存增量比 Kafka 低 39.97%
4. **NATS 有协程泄漏问题**: 每个测试都有 1 个协程泄漏

---

## 📉 性能趋势分析

### 延迟趋势

| 压力级别 | Kafka 延迟 | NATS 延迟 | NATS 优势 |
|---------|-----------|----------|----------|
| 低压 | 468.814 ms | 85.353 ms | **-81.79%** ✅ |
| 中压 | 590.221 ms | 327.105 ms | **-44.58%** ✅ |
| 高压 | 734.962 ms | 989.018 ms | +34.57% ❌ |
| 极限 | 927.031 ms | 2000.396 ms | +115.81% ❌ |

**趋势分析**:
- **低压力**: NATS 延迟优势明显（-81.79%）
- **中压力**: NATS 延迟仍有优势（-44.58%）
- **高压力**: NATS 延迟开始劣化（+34.57%）
- **极限压力**: NATS 延迟显著劣化（+115.81%）

**结论**: NATS 在低压力下延迟更低，但在高压力下延迟增长更快，Kafka 在高压力下表现更稳定。

### 吞吐量趋势

| 压力级别 | Kafka 吞吐量 | NATS 吞吐量 | Kafka 优势 |
|---------|-------------|------------|-----------|
| 低压 | 33.32 msg/s | 33.27 msg/s | +0.15% |
| 中压 | 133.24 msg/s | 132.13 msg/s | +0.84% |
| 高压 | 166.58 msg/s | 164.52 msg/s | +1.25% |
| 极限 | 332.93 msg/s | 322.24 msg/s | +3.32% |

**趋势分析**:
- Kafka 吞吐量优势随压力增加而增大
- 极限压力下，Kafka 吞吐量优势达到 **+3.32%**

---

## 💡 使用建议

### 🔴 选择 Kafka 当:

1. ✅ 需要企业级可靠性和持久化保证
2. ✅ 需要复杂的数据处理管道
3. ✅ 需要成熟的生态系统和工具链
4. ✅ 数据量大且需要长期保存
5. ✅ **需要在高压力下保持稳定的延迟和吞吐量**
6. ✅ **需要严格的资源管理（无协程泄漏）**

### 🔵 选择 NATS JetStream 当:

1. ✅ 需要极致的性能和低延迟（**在低压力下**）
2. ✅ 需要简单的部署和运维
3. ✅ 需要轻量级的消息传递
4. ✅ 构建实时应用和微服务
5. ✅ **需要更低的内存占用**
6. ✅ **压力负载相对稳定且不高**

---

## 🎯 关键洞察

### 1. Hollywood Actor Pool 在两个系统中的表现

**Kafka + Hollywood Actor Pool**:
- ✅ 协程管理稳定（峰值 122）
- ✅ 无协程泄漏
- ✅ 高压力下延迟稳定
- ✅ 吞吐量随压力线性增长

**NATS + Hollywood Actor Pool**:
- ✅ 低压力下延迟更低
- ✅ 内存效率更高
- ⚠️ 协程峰值较高（1067）
- ⚠️ 每个测试有 1 个协程泄漏
- ⚠️ 高压力下延迟增长较快

### 2. 迁移到 Hollywood Actor Pool 的效果

**NATS JetStream 迁移后**:
- ✅ 成功率 100%（所有压力级别）
- ✅ 消息顺序保证正常
- ✅ 多聚合并发处理正常
- ✅ 内存效率优于 Kafka
- ⚠️ 协程泄漏问题需要进一步调查

### 3. 性能瓶颈分析

**NATS 在高压力下的延迟劣化原因**:
1. 协程峰值过高（1067 vs 122）
2. 可能的锁竞争或同步问题
3. JetStream 内部处理机制在高压力下的限制

**建议优化方向**:
1. 调查协程泄漏的根本原因
2. 优化协程池管理，降低峰值协程数
3. 分析高压力下的性能瓶颈

---

## ✅ 测试结论

### 迁移成功验证

1. ✅ **功能正确性**: 所有测试场景成功率 100%
2. ✅ **消息顺序**: 同一聚合ID的消息顺序保证正常
3. ✅ **并发处理**: 多聚合并发处理正常
4. ✅ **资源清理**: 内存和协程资源正常释放（除 1 个协程泄漏）

### 性能表现

1. ✅ **低压力**: NATS 延迟优势明显（-81.79%）
2. ✅ **中压力**: NATS 延迟仍有优势（-44.58%）
3. ⚠️ **高压力**: Kafka 延迟优势开始显现（-34.57%）
4. ⚠️ **极限压力**: Kafka 延迟优势显著（-53.66%）

### 总体评价

**NATS JetStream 迁移到 Hollywood Actor Pool 成功！**

- ✅ 功能完整性：100%
- ✅ 低压力性能：优秀
- ⚠️ 高压力性能：需要优化
- ⚠️ 协程泄漏：需要修复

**建议**:
1. 修复协程泄漏问题
2. 优化高压力下的性能表现
3. 降低协程峰值数量

---

## 📝 附录

### 测试环境

- **Go 版本**: Go 1.x
- **Kafka 版本**: 本地 Kafka 集群
- **NATS 版本**: 本地 NATS JetStream 服务器（端口 4223）
- **测试机器**: Windows 系统

### 测试配置

- **Actor Pool Size**: 256
- **Inbox Size**: 1000
- **Max Restarts**: 3
- **Topic 数量**: 5
- **Partition 数量**: 3（仅 Kafka）

### 测试数据

- **低压**: 1000 条消息
- **中压**: 4000 条消息
- **高压**: 6000 条消息
- **极限**: 10000 条消息

---

**报告生成时间**: 2025-10-29  
**测试执行时间**: 347.38 秒  
**测试状态**: ✅ PASS

