# NATS JetStream ä¼˜åŒ–æ–¹æ¡ˆ - é¡ºåºæ€§ä¿è¯

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

**å¿…é¡»ä¿è¯**ï¼šåŒä¸€ä¸ª topic çš„åŒä¸€ä¸ªèšåˆ ID çš„æ¶ˆæ¯**ä¸¥æ ¼æŒ‰é¡ºåºå‘å¸ƒã€æŒ‰é¡ºåºå¤„ç†**

**å¯ä»¥æ¥å—**ï¼šä¸€ä¸ª topic ä¸€ä¸ªè¿æ¥

---

## âœ… å½“å‰å®ç°çš„é¡ºåºæ€§ä¿è¯

æ‚¨çš„å½“å‰å®ç°**å·²ç»æ­£ç¡®ä¿è¯äº†é¡ºåºæ€§**ï¼š

### 1. æ‹‰å–é¡ºåºä¿è¯

```go
// sdk/pkg/eventbus/nats.go ç¬¬854-894è¡Œ
func (n *natsEventBus) processUnifiedPullMessages(ctx context.Context, topic string, sub *nats.Subscription) {
    for {
        // âœ… å•ä¸ª goroutine æ‹‰å–æ¶ˆæ¯ï¼Œä¿è¯æ‹‰å–é¡ºåº
        msgs, err := sub.Fetch(10, nats.MaxWait(time.Second))
        
        // å¤„ç†æ¶ˆæ¯
        for _, msg := range msgs {
            // ...
        }
    }
}
```

**é¡ºåºä¿è¯**ï¼š
- âœ… æ¯ä¸ª topic åªæœ‰**ä¸€ä¸ª goroutine** æ‹‰å–æ¶ˆæ¯
- âœ… `sub.Fetch()` è¿”å›çš„æ¶ˆæ¯**æŒ‰ JetStream å­˜å‚¨é¡ºåº**æ’åˆ—
- âœ… `for _, msg := range msgs` **æŒ‰é¡ºåºéå†**æ¶ˆæ¯

### 2. å¤„ç†é¡ºåºä¿è¯

```go
// sdk/pkg/eventbus/nats.go ç¬¬921-977è¡Œ
if aggregateID != "" {
    // âœ… ä½¿ç”¨ KeyedWorkerPool ä¿è¯åŒä¸€èšåˆ ID çš„æ¶ˆæ¯é¡ºåºå¤„ç†
    pool := n.keyedPools[topic]
    
    aggMsg := &AggregateMessage{
        AggregateID: aggregateID,
        Value:       data,
        // ...
    }
    
    // âœ… è·¯ç”±åˆ° KeyedWorkerPool å¤„ç†
    pool.ProcessMessage(ctx, aggMsg)
}
```

**é¡ºåºä¿è¯**ï¼š
- âœ… `KeyedWorkerPool` ä¸ºæ¯ä¸ªèšåˆ ID åˆ†é…**å›ºå®šçš„ Worker**
- âœ… åŒä¸€ä¸ªèšåˆ ID çš„æ¶ˆæ¯**æ€»æ˜¯ç”±åŒä¸€ä¸ª Worker å¤„ç†**
- âœ… Worker å†…éƒ¨**ä¸²è¡Œå¤„ç†**æ¶ˆæ¯ï¼Œä¿è¯é¡ºåº

---

## ğŸš« ä¸èƒ½ä½¿ç”¨çš„ä¼˜åŒ–ï¼ˆä¼šç ´åé¡ºåºæ€§ï¼‰

### âŒ ä¼˜åŒ– 4ï¼šå¹¶å‘æ‹‰å–æ¶ˆæ¯

**åŸæ–¹æ¡ˆ**ï¼š
```go
// âŒ å¤šä¸ª goroutine å¹¶å‘æ‹‰å–æ¶ˆæ¯
for i := 0; i < numFetchers; i++ {
    go func() {
        msgs, _ := sub.Fetch(batchSize, nats.MaxWait(100*time.Millisecond))
        // å¤„ç†æ¶ˆæ¯...
    }()
}
```

**ä¸ºä»€ä¹ˆä¼šç ´åé¡ºåº**ï¼š
1. âŒ **æ‹‰å–é¡ºåºä¸ç¡®å®š**ï¼šå¤šä¸ª goroutine å¹¶å‘æ‹‰å–ï¼Œæ— æ³•ä¿è¯å“ªä¸ªå…ˆæ‹‰åˆ°æ¶ˆæ¯
2. âŒ **å¤„ç†é¡ºåºä¸ç¡®å®š**ï¼šå³ä½¿ KeyedWorkerPool ä¿è¯åŒä¸€èšåˆ ID çš„é¡ºåºï¼Œä½†æ‹‰å–é¡ºåºå·²ç»ä¹±äº†

**ç¤ºä¾‹**ï¼š
```
JetStream å­˜å‚¨é¡ºåºï¼š
  æ¶ˆæ¯1 (èšåˆID=A, åºå·=1)
  æ¶ˆæ¯2 (èšåˆID=A, åºå·=2)
  æ¶ˆæ¯3 (èšåˆID=A, åºå·=3)

å¤š Fetcher æ‹‰å–é¡ºåºï¼ˆå¯èƒ½ï¼‰ï¼š
  Fetcher-1 æ‹‰åˆ°ï¼šæ¶ˆæ¯1, æ¶ˆæ¯3
  Fetcher-2 æ‹‰åˆ°ï¼šæ¶ˆæ¯2

KeyedWorkerPool å¤„ç†é¡ºåºï¼ˆå¯èƒ½ï¼‰ï¼š
  Worker-A æ”¶åˆ°ï¼šæ¶ˆæ¯1 â†’ æ¶ˆæ¯3 â†’ æ¶ˆæ¯2  âŒ ä¹±åºï¼
```

**ç»“è®º**ï¼šâŒ **ä¸èƒ½ä½¿ç”¨å¹¶å‘æ‹‰å–**

---

## âœ… å¯ä»¥ä½¿ç”¨çš„ä¼˜åŒ–ï¼ˆä¸å½±å“é¡ºåºæ€§ï¼‰

### âœ… ä¼˜åŒ– 1ï¼šå¼‚æ­¥å‘å¸ƒ

**æ–¹æ¡ˆ**ï¼š
```go
// âœ… ä½¿ç”¨ PublishAsync æ›¿ä»£ Publish
pubAckFuture, err := n.js.PublishAsync(topic, message)

// åå°å¤„ç† ACK
go func() {
    select {
    case <-pubAckFuture.Ok():
        // å‘å¸ƒæˆåŠŸ
    case err := <-pubAckFuture.Err():
        // å‘å¸ƒå¤±è´¥
    }
}()
```

**ä¸ºä»€ä¹ˆä¸å½±å“é¡ºåº**ï¼š
- âœ… **å‘å¸ƒé¡ºåºä¿è¯**ï¼š`PublishAsync` æŒ‰è°ƒç”¨é¡ºåºå‘é€æ¶ˆæ¯åˆ° JetStream
- âœ… **å­˜å‚¨é¡ºåºä¿è¯**ï¼šJetStream æŒ‰æ¥æ”¶é¡ºåºå­˜å‚¨æ¶ˆæ¯
- âœ… **æ¶ˆè´¹é¡ºåºä¿è¯**ï¼šConsumer æŒ‰å­˜å‚¨é¡ºåºæ‹‰å–æ¶ˆæ¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡æå‡ **3-5å€**
- âœ… å»¶è¿Ÿé™ä½ **50-70%**

---

### âœ… ä¼˜åŒ– 2ï¼šå¢å¤§æ‰¹é‡æ‹‰å–å¤§å°

**æ–¹æ¡ˆ**ï¼š
```go
// âœ… å¢å¤§æ‰¹é‡å¤§å°ï¼ˆ10 â†’ 500-1000ï¼‰
batchSize := 500
msgs, err := sub.Fetch(batchSize, nats.MaxWait(100*time.Millisecond))

// âœ… æŒ‰é¡ºåºå¤„ç†æ¶ˆæ¯
for _, msg := range msgs {
    // KeyedWorkerPool ä¿è¯åŒä¸€èšåˆ ID çš„é¡ºåº
    pool.ProcessMessage(ctx, aggMsg)
}
```

**ä¸ºä»€ä¹ˆä¸å½±å“é¡ºåº**ï¼š
- âœ… **å• Fetcher**ï¼šä»ç„¶åªæœ‰ä¸€ä¸ª goroutine æ‹‰å–æ¶ˆæ¯
- âœ… **æ‰¹é‡é¡ºåº**ï¼š`sub.Fetch()` è¿”å›çš„æ¶ˆæ¯æŒ‰é¡ºåºæ’åˆ—
- âœ… **å¤„ç†é¡ºåº**ï¼š`for` å¾ªç¯æŒ‰é¡ºåºéå†æ¶ˆæ¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡æå‡ **5-10å€**ï¼ˆå‡å°‘ç½‘ç»œå¾€è¿”ï¼‰
- âœ… å»¶è¿Ÿé™ä½ **30-50%**

**å…³é”®**ï¼š
- âœ… **æ‰¹é‡å¤§å°åªå½±å“æ€§èƒ½ï¼Œä¸å½±å“é¡ºåº**
- âœ… **å•æ¬¡æ‹‰å–æ›´å¤šæ¶ˆæ¯ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæé«˜ååé‡**

---

### âœ… ä¼˜åŒ– 3ï¼šç¼©çŸ­ MaxWait æ—¶é—´

**æ–¹æ¡ˆ**ï¼š
```go
// âœ… ç¼©çŸ­ MaxWaitï¼ˆ1s â†’ 100msï¼‰
msgs, err := sub.Fetch(batchSize, nats.MaxWait(100*time.Millisecond))
```

**ä¸ºä»€ä¹ˆä¸å½±å“é¡ºåº**ï¼š
- âœ… **MaxWait åªå½±å“ç­‰å¾…æ—¶é—´**ï¼Œä¸å½±å“æ¶ˆæ¯é¡ºåº
- âœ… å¦‚æœæœ‰æ¶ˆæ¯ï¼Œç«‹å³è¿”å›ï¼›å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæœ€å¤šç­‰å¾… 100ms

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… å»¶è¿Ÿé™ä½ **50-90%**ï¼ˆå‡å°‘ä¸å¿…è¦çš„ç­‰å¾…ï¼‰
- âœ… ååé‡æå‡ **10-20%**

---

### âœ… ä¼˜åŒ– 5ï¼šæ¯ä¸ª Topic ä¸€ä¸ªè¿æ¥

**æ–¹æ¡ˆ**ï¼š
```go
type natsEventBus struct {
    // âœ… æ¯ä¸ª topic ä¸€ä¸ªè¿æ¥
    topicConns map[string]*nats.Conn
    topicJS    map[string]nats.JetStreamContext
}

// å‘å¸ƒæ¶ˆæ¯æ—¶ä½¿ç”¨ topic çš„è¿æ¥
func (n *natsEventBus) Publish(ctx context.Context, topic string, message []byte) error {
    _, js, _ := n.getTopicConnection(topic)
    _, err = js.PublishAsync(topic, message)
    return err
}
```

**ä¸ºä»€ä¹ˆä¸å½±å“é¡ºåº**ï¼š
- âœ… **æ¯ä¸ª topic ç‹¬ç«‹è¿æ¥**ï¼Œä¸åŒ topic ä¹‹é—´ä¸äº’ç›¸å½±å“
- âœ… **åŒä¸€ä¸ª topic çš„æ¶ˆæ¯ä»ç„¶é€šè¿‡åŒä¸€ä¸ªè¿æ¥å‘å¸ƒ**ï¼Œé¡ºåºä¿è¯
- âœ… **æ¯ä¸ª topic ä»ç„¶æ˜¯å• Fetcher**ï¼Œæ‹‰å–é¡ºåºä¿è¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡æå‡ **2-3å€**ï¼ˆé¿å…è¿æ¥ç«äº‰ï¼‰
- âœ… éš”ç¦»æ€§æå‡ï¼ˆä¸€ä¸ª topic çš„é—®é¢˜ä¸å½±å“å…¶ä»– topicï¼‰

---

### âœ… ä¼˜åŒ– 8ï¼šé…ç½®ä¼˜åŒ–

**æ–¹æ¡ˆ**ï¼š
```go
Consumer: NATSConsumerConfig{
    MaxAckPending: 10000,  // âœ… 500 â†’ 10000
    MaxWaiting:    1000,   // âœ… 200 â†’ 1000
    AckWait:       30 * time.Second,
}

Stream: StreamConfig{
    MaxBytes: 1024 * 1024 * 1024,  // âœ… 512MB â†’ 1GB
    MaxMsgs:  1000000,              // âœ… 100000 â†’ 1000000
}
```

**ä¸ºä»€ä¹ˆä¸å½±å“é¡ºåº**ï¼š
- âœ… **é…ç½®åªå½±å“å®¹é‡é™åˆ¶**ï¼Œä¸å½±å“æ¶ˆæ¯é¡ºåº
- âœ… å¢å¤§é…ç½®å¯ä»¥å‡å°‘å› é…ç½®ä¸è¶³å¯¼è‡´çš„é”™è¯¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡æå‡ **20-30%**ï¼ˆå‡å°‘é…ç½®é™åˆ¶ï¼‰
- âœ… ç¨³å®šæ€§æå‡

---

## ğŸ“Š ç»¼åˆä¼˜åŒ–æ•ˆæœï¼ˆä¿è¯é¡ºåºæ€§ï¼‰

### å®æ–½ä¼˜åŒ– 1ã€2ã€3ã€8

| æŒ‡æ ‡ | å½“å‰ (NATS) | ä¼˜åŒ–å (é¢„æœŸ) | æå‡å¹…åº¦ | vs Kafka |
|------|------------|--------------|---------|----------|
| **ååé‡** | 242.92 msg/s | **1900-3600 msg/s** | **8-15å€** âœ… | **1.9-3.6å€** ğŸš€ |
| **å»¶è¿Ÿ** | 18.82ms | **2-4ms** | **é™ä½ 80-90%** âœ… | **ä¼˜äº Kafka** ğŸ¯ |
| **å†…å­˜** | 9.47MB | **9.47MB** | **æŒå¹³** âšª | **æŒå¹³** âšª |
| **Goroutine** | 1025 | **1025** | **æŒå¹³** âšª | **ä»é«˜äº Kafka** âš ï¸ |
| **é¡ºåºæ€§** | âœ… ä¿è¯ | âœ… **ä¿è¯** | **æ— å½±å“** âœ… | âœ… ä¿è¯ |

**å…³é”®å‘ç°**ï¼š
- âœ… **ååé‡å¯ä»¥æ¥è¿‘ Kafka**ï¼ˆ1900-3600 vs 995.65 msg/sï¼‰
- âœ… **å»¶è¿Ÿä¼˜äº Kafka**ï¼ˆ2-4ms vs 498msï¼‰
- âœ… **é¡ºåºæ€§å®Œå…¨ä¿è¯**ï¼ˆåŒä¸€èšåˆ ID çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰é¡ºåºå¤„ç†ï¼‰

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿè§æ•ˆï¼ˆ1-2 å°æ—¶ï¼‰

**å®æ–½ä¼˜åŒ–**ï¼š
1. âœ… ä¼˜åŒ– 2ï¼šæ‰¹é‡å¤§å° 10 â†’ 500
2. âœ… ä¼˜åŒ– 3ï¼šMaxWait 1s â†’ 100ms
3. âœ… ä¼˜åŒ– 8ï¼šMaxAckPending 500 â†’ 10000, MaxWaiting 200 â†’ 1000

**ä»£ç ä¿®æ”¹**ï¼š
```go
// ä¿®æ”¹ processUnifiedPullMessages
func (n *natsEventBus) processUnifiedPullMessages(ctx context.Context, topic string, sub *nats.Subscription) {
    for {
        // âœ… ä¿®æ”¹è¿™é‡Œï¼šæ‰¹é‡å¤§å° 10 â†’ 500ï¼ŒMaxWait 1s â†’ 100ms
        msgs, err := sub.Fetch(500, nats.MaxWait(100*time.Millisecond))
        // ... å…¶ä»–ä»£ç ä¸å˜
    }
}

// ä¿®æ”¹é…ç½®
Consumer: NATSConsumerConfig{
    MaxAckPending: 10000,  // âœ… ä¿®æ”¹è¿™é‡Œ
    MaxWaiting:    1000,   // âœ… ä¿®æ”¹è¿™é‡Œ
}
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡æå‡ **5-8å€**ï¼ˆä» 242.92 â†’ 1200-1900 msg/sï¼‰
- âœ… å»¶è¿Ÿé™ä½ **50-70%**ï¼ˆä» 18.82ms â†’ 6-9msï¼‰
- âœ… **é¡ºåºæ€§ä¿è¯**ï¼šæ— å½±å“

**æµ‹è¯•éªŒè¯**ï¼š
```bash
# è¿è¡Œå‹åŠ›æµ‹è¯•
go test -v -run TestNATSComprehensivePressure ./sdk/pkg/eventbus/ -timeout 30m

# éªŒè¯é¡ºåºæ€§ï¼šæ£€æŸ¥åŒä¸€èšåˆ ID çš„æ¶ˆæ¯æ˜¯å¦æŒ‰é¡ºåºå¤„ç†
```

---

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¼˜åŒ–ï¼ˆ2-4 å°æ—¶ï¼‰

**å®æ–½ä¼˜åŒ–**ï¼š
4. âœ… ä¼˜åŒ– 1ï¼šå¼‚æ­¥å‘å¸ƒï¼ˆPublishAsyncï¼‰

**ä»£ç ä¿®æ”¹**ï¼š
```go
// ä¿®æ”¹ Publish æ–¹æ³•
func (n *natsEventBus) Publish(ctx context.Context, topic string, message []byte) error {
    // âœ… ä½¿ç”¨ PublishAsync æ›¿ä»£ Publish
    pubAckFuture, err := n.js.PublishAsync(topic, message)
    if err != nil {
        return err
    }
    
    // âœ… åå°å¤„ç† ACK
    go func() {
        select {
        case <-pubAckFuture.Ok():
            n.publishedMessages.Add(1)
        case err := <-pubAckFuture.Err():
            n.errorCount.Add(1)
            n.logger.Error("Async publish failed", zap.Error(err))
        }
    }()
    
    return nil
}
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- âœ… ååé‡å†æå‡ **3-5å€**ï¼ˆä» 1200-1900 â†’ 3600-9500 msg/sï¼‰
- âœ… å»¶è¿Ÿé™ä½ **50-70%**ï¼ˆä» 6-9ms â†’ 2-3msï¼‰
- âœ… **é¡ºåºæ€§ä¿è¯**ï¼šæ— å½±å“

---

## âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹

### 1. æ‰¹é‡å¤§å°è°ƒä¼˜

**å…¬å¼**ï¼š
```
æ‰¹é‡å¤§å° â‰¤ (AckWait / å•æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´)
```

**ç¤ºä¾‹**ï¼š
- AckWait = 30 ç§’
- å•æ¡æ¶ˆæ¯å¤„ç†æ—¶é—´ = 10ms
- æœ€å¤§æ‰¹é‡å¤§å° = 30s / 10ms = 3000 æ¡

**å»ºè®®**ï¼š
- èµ·å§‹å€¼ï¼š500
- æ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´ï¼š500 â†’ 1000 â†’ 2000
- å¦‚æœå‡ºç° AckWait è¶…æ—¶ï¼Œå‡å°æ‰¹é‡å¤§å°

### 2. å¼‚æ­¥å‘å¸ƒé™æµ

**é—®é¢˜**ï¼šå¼‚æ­¥å‘å¸ƒå¯èƒ½å¯¼è‡´æœªç¡®è®¤æ¶ˆæ¯å †ç§¯ï¼Œå†…å­˜æº¢å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
```go
// é™åˆ¶æœªç¡®è®¤æ¶ˆæ¯çš„æ•°é‡
js, err := nc.JetStream(nats.PublishAsyncMaxPending(10000))
```

### 3. é¡ºåºæ€§éªŒè¯

**æµ‹è¯•æ–¹æ³•**ï¼š
```go
// å‘å¸ƒ 1000 æ¡æ¶ˆæ¯ï¼ŒåŒä¸€ä¸ªèšåˆ ID
for i := 0; i < 1000; i++ {
    envelope := &Envelope{
        AggregateID: "test-aggregate-1",
        Sequence:    uint64(i),
        // ...
    }
    eventBus.PublishEnvelope(ctx, topic, envelope)
}

// æ¶ˆè´¹ç«¯éªŒè¯é¡ºåº
var lastSequence uint64 = 0
handler := func(ctx context.Context, envelope *Envelope) error {
    if envelope.Sequence != lastSequence + 1 {
        panic("é¡ºåºé”™è¯¯ï¼")
    }
    lastSequence = envelope.Sequence
    return nil
}
```

---

## ğŸ“š æ€»ç»“

### âœ… å¯ä»¥ä½¿ç”¨çš„ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | é¢„æœŸæ”¶ç›Š | é¡ºåºæ€§å½±å“ |
|--------|---------|-----------|
| **ä¼˜åŒ– 1ï¼šå¼‚æ­¥å‘å¸ƒ** | ååé‡ +3-5å€ | âœ… æ— å½±å“ |
| **ä¼˜åŒ– 2ï¼šå¢å¤§æ‰¹é‡å¤§å°** | ååé‡ +5-10å€ | âœ… æ— å½±å“ |
| **ä¼˜åŒ– 3ï¼šç¼©çŸ­ MaxWait** | å»¶è¿Ÿ -50-90% | âœ… æ— å½±å“ |
| **ä¼˜åŒ– 5ï¼šæ¯ Topic ä¸€ä¸ªè¿æ¥** | ååé‡ +2-3å€ | âœ… æ— å½±å“ |
| **ä¼˜åŒ– 8ï¼šé…ç½®ä¼˜åŒ–** | ååé‡ +20-30% | âœ… æ— å½±å“ |

### âŒ ä¸èƒ½ä½¿ç”¨çš„ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | åŸå›  |
|--------|------|
| **ä¼˜åŒ– 4ï¼šå¹¶å‘æ‹‰å–** | âŒ ä¼šç ´åæ‹‰å–é¡ºåº |

### ğŸ¯ æœ€ç»ˆæ•ˆæœ

- âœ… **ååé‡æå‡ 8-15å€**ï¼ˆä» 242.92 â†’ 1900-3600 msg/sï¼‰
- âœ… **å»¶è¿Ÿé™ä½ 80-90%**ï¼ˆä» 18.82ms â†’ 2-4msï¼‰
- âœ… **é¡ºåºæ€§å®Œå…¨ä¿è¯**ï¼ˆåŒä¸€èšåˆ ID çš„æ¶ˆæ¯ä¸¥æ ¼æŒ‰é¡ºåºå¤„ç†ï¼‰
- âœ… **æ¥è¿‘æˆ–è¶…è¿‡ Kafka æ€§èƒ½**ï¼ˆååé‡ 1900-3600 vs 995.65 msg/sï¼‰

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-10-12  
**ä½œè€…**ï¼šAugment Agent  
**ç‰ˆæœ¬**ï¼šv1.0

