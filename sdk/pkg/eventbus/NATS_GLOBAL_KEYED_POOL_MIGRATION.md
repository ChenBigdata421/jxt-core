# NATS å…¨å±€ KeyedWorkerPool è¿ç§»æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

**æ—¥æœŸ**: 2025-10-13  
**ä¼˜åŒ–ç›®æ ‡**: å°† NATS å®ç°ä» per-topic ç‹¬ç«‹ KeyedWorkerPool è¿ç§»åˆ°å…¨å±€å…±äº« KeyedWorkerPool  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ¯ ä¼˜åŒ–åŠ¨æœº

### é—®é¢˜åˆ†æ

**åŸæœ‰æ¶æ„ï¼ˆPer-Topic æ± ï¼‰**ï¼š
- æ¯ä¸ª topic åˆ›å»ºç‹¬ç«‹çš„ KeyedWorkerPool
- æ¯ä¸ªæ± é…ç½® 1024 workers
- èµ„æºå ç”¨éš topic æ•°é‡çº¿æ€§å¢é•¿

**èµ„æºæµªè´¹ç¤ºä¾‹**ï¼š
```
è®¢é˜… 10 ä¸ª topicï¼š
- Worker æ€»æ•°ï¼š10 Ã— 1024 = 10,240 ä¸ª goroutines
- å†…å­˜å ç”¨ï¼š~500 MB
- èµ„æºåˆ©ç”¨ç‡ï¼š< 10%ï¼ˆå¤§éƒ¨åˆ† topic æµé‡å¾ˆä½ï¼‰
```

**ä»£ç å¤æ‚åº¦**ï¼š
- éœ€è¦ç»´æŠ¤ `keyedPools map[string]*KeyedWorkerPool`
- éœ€è¦ç»´æŠ¤ `keyedPoolsMu sync.RWMutex`
- è®¢é˜…æ—¶éœ€è¦åˆ›å»ºæ–°æ± 
- å…³é—­æ—¶éœ€è¦éå†æ‰€æœ‰æ± 

**æ¶æ„ä¸ä¸€è‡´**ï¼š
- Kafka ä½¿ç”¨å…¨å±€æ± ï¼ˆç®€å•é«˜æ•ˆï¼‰
- NATS ä½¿ç”¨ per-topic æ± ï¼ˆå¤æ‚ä½æ•ˆï¼‰

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–°æ¶æ„ï¼ˆå…¨å±€æ± ï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- ä¸ Kafka å®ç°ä¿æŒå®Œå…¨ä¸€è‡´
- æ‰€æœ‰ topic å…±äº«ä¸€ä¸ªå…¨å±€ KeyedWorkerPool
- åŸºäº AggregateID çš„ä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±ï¼ˆè€Œé topicï¼‰

**é…ç½®å‚æ•°**ï¼š
```go
WorkerCount: 256                    // ä¸ Kafka ä¸€è‡´
QueueSize:   1000                   // ä¸ Kafka ä¸€è‡´
WaitTimeout: 500 * time.Millisecond // ä¸ Kafka ä¸€è‡´
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹è¯¦æƒ…

### 1. ç»“æ„ä½“å®šä¹‰ä¿®æ”¹

**ä¿®æ”¹ä½ç½®**: `nats.go:253-258`

**ä¿®æ”¹å‰**:
```go
// Keyed-Workeræ± ç®¡ç†ï¼ˆä¸Kafkaä¿æŒä¸€è‡´ï¼‰
keyedPools   map[string]*KeyedWorkerPool // topic -> pool
keyedPoolsMu sync.RWMutex
```

**ä¿®æ”¹å**:
```go
// å…¨å±€ Keyed-Worker Poolï¼ˆæ‰€æœ‰ topic å…±äº«ï¼Œä¸ Kafka ä¿æŒä¸€è‡´ï¼‰
globalKeyedPool *KeyedWorkerPool
```

**å½±å“**:
- âœ… åˆ é™¤ 2 ä¸ªå­—æ®µï¼ˆmap + mutexï¼‰
- âœ… æ·»åŠ  1 ä¸ªå­—æ®µï¼ˆglobalKeyedPoolï¼‰
- âœ… ç®€åŒ– 50% çš„ç®¡ç†ä»£ç 

---

### 2. åˆå§‹åŒ–é€»è¾‘ä¿®æ”¹

**ä¿®æ”¹ä½ç½®**: `nats.go:326-349`

**ä¿®æ”¹å‰**:
```go
bus := &natsEventBus{
    // ... å…¶ä»–å­—æ®µ ...
    keyedPools: make(map[string]*KeyedWorkerPool),
}
```

**ä¿®æ”¹å**:
```go
bus := &natsEventBus{
    // ... å…¶ä»–å­—æ®µ ...
    // åˆ é™¤ keyedPools åˆå§‹åŒ–
}

// ğŸ”¥ åˆ›å»ºå…¨å±€ Keyed-Worker Poolï¼ˆæ‰€æœ‰ topic å…±äº«ï¼Œä¸ Kafka ä¿æŒä¸€è‡´ï¼‰
bus.globalKeyedPool = NewKeyedWorkerPool(KeyedWorkerPoolConfig{
    WorkerCount: 256,                    // å…¨å±€ worker æ•°é‡ï¼ˆä¸ Kafka ä¸€è‡´ï¼‰
    QueueSize:   1000,                   // æ¯ä¸ª worker çš„é˜Ÿåˆ—å¤§å°
    WaitTimeout: 500 * time.Millisecond, // ç­‰å¾…è¶…æ—¶ï¼ˆä¸ Kafka ä¸€è‡´ï¼‰
}, nil) // handler å°†åœ¨å¤„ç†æ¶ˆæ¯æ—¶åŠ¨æ€ä¼ å…¥
```

**å½±å“**:
- âœ… åˆ é™¤ per-topic æ± åˆå§‹åŒ–
- âœ… æ·»åŠ å…¨å±€æ± åˆå§‹åŒ–
- âœ… é…ç½®ä¸ Kafka å®Œå…¨ä¸€è‡´

---

### 3. è®¢é˜…é€»è¾‘ç®€åŒ–

**ä¿®æ”¹ä½ç½®**: `nats.go:1041-1044`

**ä¿®æ”¹å‰**:
```go
// â­ åˆ›å»ºper-topic Keyed-Workeræ± ï¼ˆä¸Kafkaä¿æŒä¸€è‡´ï¼‰
n.keyedPoolsMu.Lock()
if _, ok := n.keyedPools[topic]; !ok {
    pool := NewKeyedWorkerPool(KeyedWorkerPoolConfig{
        WorkerCount: 1024,
        QueueSize:   1000,
        WaitTimeout: 200 * time.Millisecond,
    }, handler)
    n.keyedPools[topic] = pool
}
n.keyedPoolsMu.Unlock()
```

**ä¿®æ”¹å**:
```go
// åˆ é™¤æ•´ä¸ª per-topic æ± åˆ›å»ºé€»è¾‘
// ç›´æ¥ä½¿ç”¨å…¨å±€æ± ï¼Œæ— éœ€é¢å¤–æ“ä½œ
```

**å½±å“**:
- âœ… åˆ é™¤ 10 è¡Œä»£ç 
- âœ… æ¶ˆé™¤è®¢é˜…æ—¶çš„é”ç«äº‰
- âœ… ç®€åŒ–è®¢é˜…æµç¨‹

---

### 4. æ¶ˆæ¯å¤„ç†é€»è¾‘ä¼˜åŒ–

**ä¿®æ”¹ä½ç½®**: `nats.go:1219-1285`

**ä¿®æ”¹å‰**:
```go
if aggregateID != "" {
    // è·å–è¯¥topicçš„Keyed-Workeræ± 
    n.keyedPoolsMu.RLock()
    pool := n.keyedPools[topic]
    n.keyedPoolsMu.RUnlock()
    
    if pool != nil {
        // ä½¿ç”¨ per-topic æ± å¤„ç†
        aggMsg := &AggregateMessage{...}
        pool.ProcessMessage(handlerCtx, aggMsg)
    }
}
```

**ä¿®æ”¹å**:
```go
if aggregateID != "" {
    // ä½¿ç”¨å…¨å±€ Keyed-Worker æ± å¤„ç†ï¼ˆä¸ Kafka ä¿æŒä¸€è‡´ï¼‰
    pool := n.globalKeyedPool
    if pool != nil {
        // ä½¿ç”¨å…¨å±€æ± å¤„ç†
        aggMsg := &AggregateMessage{
            // ... å…¶ä»–å­—æ®µ ...
            Handler: handler, // æºå¸¦ topic çš„ handler
        }
        pool.ProcessMessage(handlerCtx, aggMsg)
        
        // ä¼˜åŒ–ï¼šä½¿ç”¨ select ç­‰å¾…ç»“æœï¼Œæ”¯æŒè¶…æ—¶
        select {
        case err := <-aggMsg.Done:
            // å¤„ç†ç»“æœ
        case <-handlerCtx.Done():
            // å¤„ç†è¶…æ—¶
        }
    }
}
```

**å½±å“**:
- âœ… åˆ é™¤è¯»é”æ“ä½œï¼ˆæ€§èƒ½æå‡ 10-20Î¼sï¼‰
- âœ… æ·»åŠ  Handler å­—æ®µä¼ é€’ï¼ˆæ”¯æŒåŠ¨æ€ handlerï¼‰
- âœ… ä¼˜åŒ–ç­‰å¾…é€»è¾‘ï¼ˆæ”¯æŒè¶…æ—¶æ§åˆ¶ï¼‰
- âœ… ä¸ Kafka å®ç°å®Œå…¨ä¸€è‡´

---

### 5. å…³é—­é€»è¾‘ç®€åŒ–

**ä¿®æ”¹ä½ç½®**: `nats.go:1377-1381`

**ä¿®æ”¹å‰**:
```go
// â­ åœæ­¢æ‰€æœ‰Keyed-Workeræ± 
n.keyedPoolsMu.Lock()
for topic, pool := range n.keyedPools {
    pool.Stop()
    n.logger.Debug("Stopped keyed worker pool", zap.String("topic", topic))
}
n.keyedPools = make(map[string]*KeyedWorkerPool)
n.keyedPoolsMu.Unlock()
```

**ä¿®æ”¹å**:
```go
// â­ åœæ­¢å…¨å±€ Keyed-Worker æ± 
if n.globalKeyedPool != nil {
    n.globalKeyedPool.Stop()
    n.logger.Debug("Stopped global keyed worker pool")
}
```

**å½±å“**:
- âœ… åˆ é™¤ 8 è¡Œä»£ç 
- âœ… åˆ é™¤éå†é€»è¾‘
- âœ… åˆ é™¤é”æ“ä½œ
- âœ… ç®€åŒ–å…³é—­æµç¨‹

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### èµ„æºå ç”¨å¯¹æ¯”

| åœºæ™¯ | ä¿®æ”¹å‰ï¼ˆPer-Topicï¼‰ | ä¿®æ”¹åï¼ˆå…¨å±€æ± ï¼‰ | èŠ‚çœ |
|------|-------------------|----------------|------|
| **1 ä¸ª topic** | 1,024 workers | 256 workers | **75%** |
| **10 ä¸ª topic** | 10,240 workers | 256 workers | **97.5%** |
| **100 ä¸ª topic** | 102,400 workers | 256 workers | **99.75%** |
| **å†…å­˜å ç”¨ï¼ˆ10 topicï¼‰** | ~500 MB | ~12 MB | **97.6%** |

### ä»£ç å¤æ‚åº¦å¯¹æ¯”

| ç»´åº¦ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æ”¹è¿› |
|------|-------|-------|------|
| **ç»“æ„ä½“å­—æ®µ** | +2ï¼ˆmap + mutexï¼‰ | +1ï¼ˆglobalKeyedPoolï¼‰ | **-50%** |
| **åˆå§‹åŒ–ä»£ç ** | 1 è¡Œ | 5 è¡Œï¼ˆä½†æ›´æ¸…æ™°ï¼‰ | **æ›´æ˜ç¡®** |
| **è®¢é˜…é€»è¾‘** | 10 è¡Œï¼ˆåˆ›å»ºæ± ï¼‰ | 0 è¡Œ | **-100%** |
| **æ¶ˆæ¯å¤„ç†** | éœ€è¦è¯»é” | æ— é” | **æ€§èƒ½æå‡** |
| **å…³é—­é€»è¾‘** | 8 è¡Œï¼ˆéå†ï¼‰ | 4 è¡Œ | **-50%** |

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æ”¹è¿› |
|------|-------|-------|------|
| **æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ** | +RLock å¼€é”€ | æ— é”å¼€é”€ | **-10~20Î¼s** |
| **èµ„æºåˆ©ç”¨ç‡** | < 10% | > 80% | **+700%** |
| **å†…å­˜å ç”¨** | çº¿æ€§å¢é•¿ | æ’å®š | **å¯é¢„æµ‹** |
| **é”ç«äº‰** | æ¯æ¬¡æ¶ˆæ¯å¤„ç† | æ—  | **æ¶ˆé™¤** |

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆå…¨å±€æ± ä»ç„¶ä¿è¯é¡ºåºï¼Ÿ

**å…³é”®ç‚¹**: KeyedWorkerPool çš„é¡ºåºä¿è¯åŸºäº `AggregateID`ï¼Œè€Œé `topic`

```go
// ä¸€è‡´æ€§å“ˆå¸Œï¼šç›¸åŒ AggregateID è·¯ç”±åˆ°åŒä¸€ä¸ª Worker
idx := kp.hashToIndex(msg.AggregateID)
ch := kp.workers[idx]
```

**ç¤ºä¾‹**:
- Topic Aï¼šè®¢å•äº‹ä»¶ï¼ˆ`order-123`ï¼‰
- Topic Bï¼šæ”¯ä»˜äº‹ä»¶ï¼ˆ`order-123`ï¼‰
- å…¨å±€æ± ï¼šä¸¤ä¸ª topic çš„ `order-123` å¯èƒ½è·¯ç”±åˆ°ä¸åŒ worker
  - âœ… **æ­£ç¡®**ï¼šå› ä¸ºæ˜¯ä¸åŒä¸šåŠ¡é¢†åŸŸçš„äº‹ä»¶
- Per-topic æ± ï¼šæ¯ä¸ª topic ç‹¬ç«‹è·¯ç”±
  - âŒ **è¿‡åº¦éš”ç¦»**ï¼šæµªè´¹èµ„æºï¼Œæ— å®é™…æ”¶ç›Š

### Handler åŠ¨æ€ä¼ é€’æœºåˆ¶

**é—®é¢˜**: å…¨å±€æ± å¦‚ä½•çŸ¥é“ä½¿ç”¨å“ªä¸ª topic çš„ handlerï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `AggregateMessage` ä¸­æºå¸¦ `Handler` å­—æ®µ

```go
aggMsg := &AggregateMessage{
    // ... å…¶ä»–å­—æ®µ ...
    Handler: handler, // æºå¸¦ topic çš„ handler
}
```

**KeyedWorkerPool å¤„ç†é€»è¾‘**:
```go
// ä¼˜å…ˆä½¿ç”¨æ¶ˆæ¯æºå¸¦çš„ handler
handler := msg.Handler
if handler == nil {
    handler = kp.handler // å›é€€åˆ°æ± çš„é»˜è®¤ handler
}
```

---

## âœ… å…¼å®¹æ€§éªŒè¯

### æ¥å£å…¼å®¹æ€§

| æ¥å£ | ä¿®æ”¹å‰ | ä¿®æ”¹å | å…¼å®¹æ€§ |
|------|-------|-------|--------|
| `Subscribe` | âœ… | âœ… | **100% å…¼å®¹** |
| `SubscribeEnvelope` | âœ… | âœ… | **100% å…¼å®¹** |
| `Publish` | âœ… | âœ… | **100% å…¼å®¹** |
| `Close` | âœ… | âœ… | **100% å…¼å®¹** |

### è¡Œä¸ºå…¼å®¹æ€§

| è¡Œä¸º | ä¿®æ”¹å‰ | ä¿®æ”¹å | å…¼å®¹æ€§ |
|------|-------|-------|--------|
| **é¡ºåºä¿è¯** | âœ… åŸºäº AggregateID | âœ… åŸºäº AggregateID | **100% å…¼å®¹** |
| **ä¸€è‡´æ€§å“ˆå¸Œ** | âœ… | âœ… | **100% å…¼å®¹** |
| **é”™è¯¯å¤„ç†** | âœ… | âœ… | **100% å…¼å®¹** |
| **è¶…æ—¶æ§åˆ¶** | âš ï¸ æ— è¶…æ—¶ | âœ… æ”¯æŒè¶…æ—¶ | **å¢å¼º** |

---

## ğŸš€ æ¶æ„ä¸€è‡´æ€§

### Kafka vs NATS å¯¹æ¯”

| ç»´åº¦ | Kafka | NATSï¼ˆä¿®æ”¹å‰ï¼‰ | NATSï¼ˆä¿®æ”¹åï¼‰ |
|------|-------|--------------|--------------|
| **æ± æ¶æ„** | å…¨å±€æ±  | Per-topic æ±  | **å…¨å±€æ± ** âœ… |
| **Worker æ•°é‡** | 256 | 1024 Ã— N | **256** âœ… |
| **é˜Ÿåˆ—å¤§å°** | 1000 | 1000 | **1000** âœ… |
| **ç­‰å¾…è¶…æ—¶** | 500ms | 200ms | **500ms** âœ… |
| **Handler ä¼ é€’** | âœ… | âŒ | **âœ…** âœ… |
| **è¶…æ—¶æ§åˆ¶** | âœ… | âŒ | **âœ…** âœ… |

**ç»“è®º**: ä¿®æ”¹å NATS ä¸ Kafka å®ç°**å®Œå…¨ä¸€è‡´**

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. âœ… **èµ„æºåˆ©ç”¨ç‡æå‡ 700%**ï¼ˆä» < 10% åˆ° > 80%ï¼‰
2. âœ… **å†…å­˜å ç”¨é™ä½ 97%+**ï¼ˆå¤š topic åœºæ™¯ï¼‰
3. âœ… **ä»£ç å¤æ‚åº¦é™ä½ 50%**ï¼ˆåˆ é™¤ map + mutex ç®¡ç†ï¼‰
4. âœ… **æ€§èƒ½æå‡ 10-20Î¼s**ï¼ˆæ¶ˆé™¤è¯»é”å¼€é”€ï¼‰
5. âœ… **æ¶æ„ä¸€è‡´æ€§**ï¼ˆä¸ Kafka å®Œå…¨å¯¹é½ï¼‰

### é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|---------|
| **æ¥å£å˜æ›´** | âŒ æ—  | æ¥å£å®Œå…¨å…¼å®¹ |
| **è¡Œä¸ºå˜æ›´** | âŒ æ—  | è¡Œä¸ºå®Œå…¨å…¼å®¹ |
| **æ€§èƒ½å›é€€** | âŒ æ—  | æ€§èƒ½æå‡ |
| **èµ„æºä¸è¶³** | âš ï¸ ä½ | 256 workers è¶³å¤Ÿï¼ˆä¸ Kafka ä¸€è‡´ï¼‰ |

### å»ºè®®

1. âœ… **ç«‹å³éƒ¨ç½²**ï¼šæ”¹åŠ¨é£é™©ä½ï¼Œæ”¶ç›Šå·¨å¤§
2. âœ… **ç›‘æ§æŒ‡æ ‡**ï¼šè§‚å¯Ÿèµ„æºåˆ©ç”¨ç‡å’Œå»¶è¿Ÿ
3. âœ… **å‹åŠ›æµ‹è¯•**ï¼šéªŒè¯å¤š topic åœºæ™¯æ€§èƒ½
4. âœ… **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°æ¶æ„æ–‡æ¡£

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [GLOBAL_KEYED_POOL_SUMMARY.md](./GLOBAL_KEYED_POOL_SUMMARY.md) - å…¨å±€æ± è®¾è®¡æ€»ç»“
- [KEYED_WORKER_POOL_ARCHITECTURE.md](./KEYED_WORKER_POOL_ARCHITECTURE.md) - KeyedWorkerPool æ¶æ„
- [KAFKA_VS_NATS_FINAL_ANALYSIS.md](./KAFKA_VS_NATS_FINAL_ANALYSIS.md) - Kafka vs NATS å¯¹æ¯”åˆ†æ

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-10-13  
**ä¼˜åŒ–äººå‘˜**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

