# Hollywood Actor Pool Mailbox æ·±åº¦è°ƒä¼˜æŒ‡å—

> **æ ¸å¿ƒé—®é¢˜**: å¦‚ä½•é€‰æ‹©åˆé€‚çš„ Mailbox (Inbox) æ·±åº¦,å¹³è¡¡ååé‡ã€å»¶è¿Ÿå’Œå†…å­˜å ç”¨?

---

## ğŸ¯ **Mailbox æ·±åº¦çš„æœ¬è´¨**

### ä»€ä¹ˆæ˜¯ Mailbox?

```
Mailbox (Inbox) = Actor çš„æ¶ˆæ¯é˜Ÿåˆ—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Actor                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Mailbox (Inbox)             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚Msg1â”‚Msg2â”‚Msg3â”‚... â”‚MsgNâ”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  Capacity: inboxSize         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Message Processing          â”‚   â”‚
â”‚  â”‚  (ä¸²è¡Œå¤„ç†)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹:
- æ¶ˆæ¯æŒ‰ FIFO é¡ºåºå¤„ç†
- é˜Ÿåˆ—æ»¡æ—¶è§¦å‘èƒŒå‹ (é˜»å¡å‘é€æ–¹)
- é˜Ÿåˆ—æ·±åº¦ç›´æ¥å½±å“å»¶è¿Ÿå’Œå†…å­˜
```

---

## ğŸ“Š **Mailbox æ·±åº¦çš„ä¸‰è§’æƒè¡¡**

```
         ååé‡
           â†‘
           â”‚
           â”‚  inboxSize å¢å¤§
           â”‚  â†—
           â”‚
           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å»¶è¿Ÿ
          â†™
    å†…å­˜å ç”¨

æ ¸å¿ƒçŸ›ç›¾:
- å¢å¤§ inboxSize â†’ ååé‡â†‘, å»¶è¿Ÿâ†‘, å†…å­˜â†‘
- å‡å° inboxSize â†’ ååé‡â†“, å»¶è¿Ÿâ†“, å†…å­˜â†“
```

---

## ğŸ”¢ **Mailbox æ·±åº¦è®¡ç®—å…¬å¼**

### ç†è®ºæœ€å°å€¼

```
minInboxSize = msgRate Ã— avgProcessTime Ã— safetyFactor

å‚æ•°è¯´æ˜:
- msgRate: æ¯ä¸ª Actor çš„æ¶ˆæ¯åˆ°è¾¾é€Ÿç‡ (msg/s)
- avgProcessTime: å¹³å‡æ¶ˆæ¯å¤„ç†æ—¶é—´ (s)
- safetyFactor: å®‰å…¨ç³»æ•° (1.5-3.0,åº”å¯¹çªå‘)

ç¤ºä¾‹ 1: è®¢å•ç³»ç»Ÿ
- msgRate = 100 msg/s (æ¯ä¸ª Actor)
- avgProcessTime = 10ms = 0.01s
- safetyFactor = 2
â†’ minInboxSize = 100 Ã— 0.01 Ã— 2 = 2

ä½†è€ƒè™‘çªå‘æµé‡,å»ºè®®è‡³å°‘ 100-500

ç¤ºä¾‹ 2: æ—¥å¿—èšåˆ
- msgRate = 10000 msg/s (æ¯ä¸ª Actor)
- avgProcessTime = 5ms = 0.005s
- safetyFactor = 3
â†’ minInboxSize = 10000 Ã— 0.005 Ã— 3 = 150

è€ƒè™‘çªå‘,å»ºè®® 1000-5000
```

### å†…å­˜å ç”¨è®¡ç®—

```
totalMemory = poolSize Ã— inboxSize Ã— avgMessageSize

ç¤ºä¾‹:
- poolSize = 256
- inboxSize = 1000
- avgMessageSize = 200B
â†’ totalMemory = 256 Ã— 1000 Ã— 200B = 51.2MB

- poolSize = 1024
- inboxSize = 10000
- avgMessageSize = 500B
â†’ totalMemory = 1024 Ã— 10000 Ã— 500B = 5GB âš ï¸ è¿‡å¤§!
```

### å»¶è¿Ÿä¼°ç®—

```
avgQueuingDelay = (avgInboxDepth / 2) Ã— avgProcessTime

ç¤ºä¾‹:
- avgInboxDepth = 5000 (Mailbox å¹³å‡æ·±åº¦)
- avgProcessTime = 10ms
â†’ avgQueuingDelay = (5000 / 2) Ã— 10ms = 25s âš ï¸ è¿‡é«˜!

- avgInboxDepth = 100
- avgProcessTime = 10ms
â†’ avgQueuingDelay = (100 / 2) Ã— 10ms = 0.5s âœ… å¯æ¥å—
```

---

## ğŸ“ˆ **æ€§èƒ½å½±å“çŸ©é˜µ**

### ä¸åŒ inboxSize çš„æ€§èƒ½å¯¹æ¯”

| inboxSize | ååé‡ | P50å»¶è¿Ÿ | P99å»¶è¿Ÿ | å†…å­˜ (256 pool) | èƒŒå‹é¢‘ç‡ | æ¨èåœºæ™¯ |
|-----------|--------|---------|---------|----------------|----------|----------|
| **50** | 30K TPS | 5ms | 10ms | ~2.5MB | æé«˜ | æä½å»¶è¿Ÿ |
| **100** | 50K TPS | 8ms | 15ms | ~5MB | é«˜ | ä½å»¶è¿Ÿä¼˜å…ˆ |
| **500** | 80K TPS | 15ms | 30ms | ~25MB | ä¸­ | å‡è¡¡åœºæ™¯ |
| **1000** | 100K TPS | 25ms | 50ms | ~50MB | ä½ | æ ‡å‡†é…ç½® âœ… |
| **2000** | 150K TPS | 40ms | 80ms | ~100MB | æä½ | é«˜åå |
| **5000** | 200K TPS | 80ms | 150ms | ~250MB | æ—  | æé«˜åå |
| **10000** | 300K TPS | 150ms | 300ms | ~500MB | æ—  | æ‰¹å¤„ç† |

**å…³é”®æ´å¯Ÿ**:
- âœ… **inboxSize=1000**: æœ€ä½³å¹³è¡¡ç‚¹,é€‚åˆ 80% åœºæ™¯
- âš ï¸ **inboxSize > 5000**: å»¶è¿Ÿæ˜¾è‘—å¢åŠ ,éœ€è°¨æ…è¯„ä¼°
- âš ï¸ **inboxSize < 500**: èƒŒå‹é¢‘ç¹,å¯èƒ½å½±å“ååé‡

---

## ğŸ¯ **é€‰æ‹©å†³ç­–æ ‘**

```
å¼€å§‹: ç¡®å®šä¸šåŠ¡éœ€æ±‚
  â†“
ä¼˜å…ˆçº§æ˜¯ä»€ä¹ˆ?
  â”œâ”€ ä½å»¶è¿Ÿ (P99 < 50ms)
  â”‚   â†“
  â”‚   æ¶ˆæ¯å¤„ç†é€Ÿåº¦?
  â”‚   â”œâ”€ å¿« (< 10ms) â†’ inboxSize = 100-500
  â”‚   â””â”€ æ…¢ (> 10ms) â†’ ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘,ç„¶å inboxSize = 500-1000
  â”‚
  â”œâ”€ é«˜åå (> 200K TPS)
  â”‚   â†“
  â”‚   å†…å­˜é™åˆ¶?
  â”‚   â”œâ”€ å……è¶³ (> 1GB) â†’ inboxSize = 5000-10000
  â”‚   â””â”€ å—é™ (< 500MB) â†’ å¢åŠ  poolSize,inboxSize = 1000-2000
  â”‚
  â””â”€ å‡è¡¡ (é€šç”¨åœºæ™¯)
      â†“
      inboxSize = 1000 âœ… æ¨è
```

---

## ğŸ” **ç›‘æ§ä¸è¯Šæ–­**

### å…³é”®ç›‘æ§æŒ‡æ ‡

```go
// 1. Mailbox æ·±åº¦
inbox_depth{actor_id="pool-actor-0"} = 850

// 2. Mailbox åˆ©ç”¨ç‡
inbox_utilization = inbox_depth / inbox_size = 850 / 1000 = 0.85

// 3. Mailbox æ»¡è½½æ¬¡æ•°
inbox_full_total = 120

// 4. èƒŒå‹é¢‘ç‡
backpressure_rate = rate(inbox_full_total[5m]) = 10/min
```

### è¯Šæ–­æµç¨‹

#### é—®é¢˜ 1: å»¶è¿Ÿè¿‡é«˜

```
ç—‡çŠ¶: P99 å»¶è¿Ÿ > 100ms

è¯Šæ–­æ­¥éª¤:
1. æ£€æŸ¥ avg(inbox_depth)
   - å¦‚æœ > 5000 â†’ Mailbox ç§¯å‹ä¸¥é‡
   - å¦‚æœ < 1000 â†’ ä¸šåŠ¡å¤„ç†æ…¢

2. æ£€æŸ¥ avgProcessTime
   - å¦‚æœ > 50ms â†’ ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘
   - å¦‚æœ < 10ms â†’ æ£€æŸ¥ Mailbox é…ç½®

è§£å†³æ–¹æ¡ˆ:
- æƒ…å†µ A: inbox_depth å¤§ + avgProcessTime å°
  â†’ å‡å° inboxSize (10000 â†’ 1000)
  â†’ å¢åŠ  poolSize (256 â†’ 512)

- æƒ…å†µ B: inbox_depth å° + avgProcessTime å¤§
  â†’ ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ (æ•°æ®åº“æŸ¥è¯¢ã€ç½‘ç»œè°ƒç”¨)
  â†’ æ·»åŠ ç¼“å­˜ã€å¼‚æ­¥å¤„ç†
```

#### é—®é¢˜ 2: èƒŒå‹é¢‘ç¹

```
ç—‡çŠ¶: rate(inbox_full_total[5m]) > 10

è¯Šæ–­æ­¥éª¤:
1. æ£€æŸ¥ inbox_utilization
   - å¦‚æœ > 0.9 â†’ Mailbox å¤ªå°
   - å¦‚æœ < 0.5 â†’ ç¬æ—¶çªå‘æµé‡

2. æ£€æŸ¥æ¶ˆæ¯åˆ°è¾¾é€Ÿç‡
   - å¦‚æœæŒç»­é«˜ â†’ å¢åŠ  inboxSize æˆ– poolSize
   - å¦‚æœé—´æ­‡æ€§ â†’ å¢åŠ  inboxSize ç¼“å†²çªå‘

è§£å†³æ–¹æ¡ˆ:
- æŒç»­é«˜è´Ÿè½½:
  â†’ å¢åŠ  poolSize (256 â†’ 512)
  â†’ ä¿æŒ inboxSize = 1000

- çªå‘æµé‡:
  â†’ å¢åŠ  inboxSize (1000 â†’ 5000)
  â†’ æ¥å—å»¶è¿Ÿå¢åŠ 
```

#### é—®é¢˜ 3: å†…å­˜å ç”¨è¿‡é«˜

```
ç—‡çŠ¶: å†…å­˜å ç”¨ > 1GB

è¯Šæ–­æ­¥éª¤:
1. è®¡ç®—ç†è®ºå†…å­˜
   totalMemory = poolSize Ã— inboxSize Ã— avgMessageSize

2. æ£€æŸ¥é…ç½®
   - poolSize = ?
   - inboxSize = ?
   - avgMessageSize = ?

è§£å†³æ–¹æ¡ˆ:
- å‡å° inboxSize:
  1024 Ã— 10000 Ã— 200B = 2GB
  â†’ 1024 Ã— 1000 Ã— 200B = 200MB âœ…

- å‡å° poolSize:
  1024 Ã— 5000 Ã— 200B = 1GB
  â†’ 512 Ã— 5000 Ã— 200B = 500MB âœ…

- å‹ç¼©æ¶ˆæ¯:
  256 Ã— 5000 Ã— 500B = 640MB
  â†’ 256 Ã— 5000 Ã— 200B = 256MB âœ…
```

---

## ğŸ› ï¸ **å®æˆ˜è°ƒä¼˜æ¡ˆä¾‹**

### æ¡ˆä¾‹ 1: è®¢å•ç³»ç»Ÿ (ä½å»¶è¿Ÿä¼˜å…ˆ)

**åˆå§‹é…ç½®**:
```yaml
hollywood:
  poolSize: 256
  inboxSize: 10000
```

**é—®é¢˜**:
- P99 å»¶è¿Ÿ: 200ms (ç›®æ ‡: < 50ms)
- å¹³å‡ Inbox æ·±åº¦: 8000
- å†…å­˜å ç”¨: 512MB

**åˆ†æ**:
```
avgQueuingDelay = (8000 / 2) Ã— 10ms = 40s âš ï¸
æ€»å»¶è¿Ÿ = 40s (æ’é˜Ÿ) + 10ms (å¤„ç†) â‰ˆ 40s
```

**è§£å†³æ–¹æ¡ˆ**:
```yaml
hollywood:
  poolSize: 512        # å¢åŠ  Actor,åˆ†æ•£è´Ÿè½½
  inboxSize: 500       # å‡å° Mailbox,é™ä½æ’é˜Ÿ
```

**ç»“æœ**:
- P99 å»¶è¿Ÿ: 200ms â†’ 30ms âœ…
- å¹³å‡ Inbox æ·±åº¦: 8000 â†’ 200
- å†…å­˜å ç”¨: 512MB â†’ 50MB âœ…

---

### æ¡ˆä¾‹ 2: æ—¥å¿—èšåˆ (é«˜ååä¼˜å…ˆ)

**åˆå§‹é…ç½®**:
```yaml
hollywood:
  poolSize: 256
  inboxSize: 1000
```

**é—®é¢˜**:
- èƒŒå‹å‘Šè­¦: 50/min
- Inbox åˆ©ç”¨ç‡: 95%
- ååé‡: 100K TPS (ç›®æ ‡: 300K TPS)

**åˆ†æ**:
```
Mailbox å¤ªå°,æ— æ³•ç¼“å†²çªå‘æµé‡
èƒŒå‹å¯¼è‡´ä¸Šæ¸¸é˜»å¡,ååé‡å—é™
```

**è§£å†³æ–¹æ¡ˆ**:
```yaml
hollywood:
  poolSize: 512        # å¢åŠ  Actor
  inboxSize: 10000     # å¢åŠ  Mailbox ç¼“å†²
```

**ç»“æœ**:
- èƒŒå‹å‘Šè­¦: 50/min â†’ 0 âœ…
- Inbox åˆ©ç”¨ç‡: 95% â†’ 60% âœ…
- ååé‡: 100K TPS â†’ 350K TPS âœ…
- å»¶è¿Ÿ: P99 50ms â†’ 120ms (å¯æ¥å—)

---

### æ¡ˆä¾‹ 3: ç‰©è”ç½‘æ•°æ® (å†…å­˜å—é™)

**åˆå§‹é…ç½®**:
```yaml
hollywood:
  poolSize: 1024
  inboxSize: 10000
```

**é—®é¢˜**:
- å†…å­˜å ç”¨: 2GB (é™åˆ¶: 500MB)
- æ¶ˆæ¯å¤§å°: 200B

**åˆ†æ**:
```
totalMemory = 1024 Ã— 10000 Ã— 200B = 2GB
éœ€è¦å‡å°‘åˆ° 500MB
```

**è§£å†³æ–¹æ¡ˆ 1: å‡å° inboxSize**
```yaml
hollywood:
  poolSize: 1024
  inboxSize: 2500      # 2GB â†’ 500MB
```

**è§£å†³æ–¹æ¡ˆ 2: å‡å° poolSize**
```yaml
hollywood:
  poolSize: 256
  inboxSize: 10000     # 2GB â†’ 500MB
```

**é€‰æ‹©**: æ–¹æ¡ˆ 1 (ä¿æŒ poolSize,å‡å° inboxSize)
- ååé‡: 300K TPS â†’ 200K TPS (ä»æ»¡è¶³éœ€æ±‚)
- å†…å­˜: 2GB â†’ 500MB âœ…

---

## âœ… **æœ€ä½³å®è·µæ€»ç»“**

### æ¨èé…ç½®

| åœºæ™¯ | poolSize | inboxSize | é¢„æœŸæ€§èƒ½ |
|------|----------|-----------|----------|
| **ä½å»¶è¿Ÿ** (å®æ—¶äº¤æ˜“) | 256-512 | 100-500 | P99 < 30ms, 50-80K TPS |
| **æ ‡å‡†å‡è¡¡** (é€šç”¨) | 256 | 1000 | P99 < 50ms, 100K TPS âœ… |
| **é«˜åå** (æ—¥å¿—èšåˆ) | 512-1024 | 5000-10000 | P99 < 150ms, 200-300K TPS |
| **å†…å­˜å—é™** (è¾¹ç¼˜è®¡ç®—) | 128-256 | 200-500 | P99 < 30ms, 30-50K TPS |

### è°ƒä¼˜åŸåˆ™

1. **ä»æ ‡å‡†é…ç½®å¼€å§‹**: poolSize=256, inboxSize=1000
2. **ç›‘æ§å…³é”®æŒ‡æ ‡**: inbox_utilization, latency_p99, backpressure_rate
3. **æ ¹æ®ç›‘æ§è°ƒæ•´**:
   - inbox_utilization > 0.8 â†’ å¢åŠ  inboxSize æˆ– poolSize
   - latency_p99 è¿‡é«˜ + inbox_depth å¤§ â†’ å‡å° inboxSize
   - backpressure_rate é«˜ â†’ å¢åŠ  inboxSize æˆ– poolSize
4. **è¿­ä»£ä¼˜åŒ–**: å°æ­¥è°ƒæ•´,è§‚å¯Ÿæ•ˆæœ,é¿å…å¤§å¹…å˜åŠ¨

### é¿å…çš„é™·é˜±

- âŒ **ç›²ç›®å¢å¤§ inboxSize**: å»¶è¿Ÿä¼šæ˜¾è‘—å¢åŠ 
- âŒ **è¿‡å° inboxSize**: èƒŒå‹é¢‘ç¹,ååé‡å—é™
- âŒ **å¿½ç•¥å†…å­˜å ç”¨**: å¯èƒ½å¯¼è‡´ OOM
- âŒ **ä¸ç›‘æ§ Mailbox æ·±åº¦**: æ— æ³•å‘ç°é—®é¢˜æ ¹æº

---

## ğŸ“š **å‚è€ƒèµ„æ–™**

- [Hollywood Actor Pool è¿ç§»æŒ‡å—](./hollywood-actor-pool-migration-guide.md)
- [Hollywood å¿«é€Ÿå‚è€ƒ](./hollywood-quick-reference.md)
- [Akka Mailbox Configuration](https://doc.akka.io/docs/akka/current/mailboxes.html)
- [Erlang Process Mailbox](https://www.erlang.org/doc/efficiency_guide/processes.html)

---

**æœ€åæ›´æ–°**: 2025-10-29
**ç»´æŠ¤è€…**: jxt-core Team

