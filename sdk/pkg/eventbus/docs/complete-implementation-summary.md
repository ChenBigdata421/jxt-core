# é«˜çº§äº‹ä»¶æ€»çº¿å®Œæ•´å®æ–½æ–¹æ¡ˆæ€»ç»“

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†å°† evidence-management ä¸­çš„ `KafkaSubscriberManager` å’Œ `KafkaPublisherManager` å®Œæ•´è¿ç§»åˆ° jxt-core çš„å®æ–½æ–¹æ¡ˆã€‚é€šè¿‡ç»Ÿä¸€çš„æŠ€æœ¯åŸºç¡€è®¾æ–½ï¼Œå®ç°äº†è®¢é˜…ç«¯å’Œå‘å¸ƒç«¯çš„å®Œæ•´åŠŸèƒ½è¦†ç›–ã€‚

## åŠŸèƒ½è¿ç§»åˆ†ææ€»ç»“

### ğŸ“Š **æ•´ä½“è¿ç§»æ¯”ä¾‹**

| ç»„ä»¶ | å¯è¿ç§»åˆ° jxt-core | å¿…é¡»ä¿ç•™åœ¨ä¸šåŠ¡å±‚ | è¿ç§»æ¯”ä¾‹ |
|------|------------------|------------------|----------|
| **KafkaSubscriberManager** | 70% | 30% | 70% |
| **KafkaPublisherManager** | 80% | 20% | 80% |
| **æ•´ä½“å¹³å‡** | **75%** | **25%** | **75%** |

### âœ… **å¯ä»¥å®Œå…¨ç§»åˆ° jxt-core çš„åŠŸèƒ½**

#### 1. **ç»Ÿä¸€å¥åº·æ£€æŸ¥ç³»ç»Ÿ**
- **ä¸»é¢˜ç®¡ç†**ï¼š`jxt-core-kafka-health-check` ç»Ÿä¸€ä¸»é¢˜
- **æ¶ˆæ¯æ ¼å¼**ï¼šæ ‡å‡†åŒ–çš„ `HealthCheckMessage` ç»“æ„
- **æ£€æŸ¥é€»è¾‘**ï¼šç»Ÿä¸€çš„å¥åº·æ£€æŸ¥å™¨å®ç°
- **çŠ¶æ€ç®¡ç†**ï¼šå¤±è´¥è®¡æ•°ã€æˆåŠŸæ—¶é—´è·Ÿè¸ª
- **å›è°ƒé€šçŸ¥**ï¼šå¥åº·çŠ¶æ€å˜åŒ–å›è°ƒ

#### 2. **è¿æ¥ç®¡ç†å’Œé‡è¿æœºåˆ¶**
- **è¿æ¥æ± ç®¡ç†**ï¼šPublisher/Subscriber ç”Ÿå‘½å‘¨æœŸ
- **æ•…éšœæ£€æµ‹**ï¼šè¿æ¥çŠ¶æ€ç›‘æ§
- **é‡è¿ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿ç®—æ³•
- **å›è°ƒæœºåˆ¶**ï¼šé‡è¿æˆåŠŸ/å¤±è´¥é€šçŸ¥

#### 3. **è®¢é˜…ç«¯é«˜çº§åŠŸèƒ½**
- **ç§¯å‹æ£€æµ‹**ï¼šKafka æ¶ˆè´¹è€…ç»„ lag ç›‘æ§
- **æ¢å¤æ¨¡å¼**ï¼šç§¯å‹æ—¶çš„æœ‰åºæ¶ˆæ¯å¤„ç†
- **èšåˆå¤„ç†å™¨**ï¼šæŒ‰èšåˆIDåˆ†ç»„çš„æ¶ˆæ¯å¤„ç†
- **æµé‡æ§åˆ¶**ï¼šä»¤ç‰Œæ¡¶é™æµæœºåˆ¶

#### 4. **å‘å¸ƒç«¯é«˜çº§åŠŸèƒ½**
- **å‘å¸ƒç®¡ç†**ï¼šé«˜çº§å‘å¸ƒé€‰é¡¹å’Œå…ƒæ•°æ®æ”¯æŒ
- **æ¶ˆæ¯æ ¼å¼åŒ–**ï¼šå¯æ’æ‹”çš„æ ¼å¼åŒ–å™¨æ¡†æ¶
- **å‘å¸ƒå›è°ƒ**ï¼šå‘å¸ƒç»“æœé€šçŸ¥æœºåˆ¶
- **é‡è¯•æœºåˆ¶**ï¼šå‘å¸ƒå¤±è´¥çš„é‡è¯•ç­–ç•¥

### âŒ **å¿…é¡»ä¿ç•™åœ¨ä¸šåŠ¡å±‚çš„åŠŸèƒ½**

#### 1. **ä¸šåŠ¡æ¶ˆæ¯å¤„ç†é€»è¾‘**
- **äº‹ä»¶å¤„ç†å™¨**ï¼š`MediaEventHandler`ã€`ArchiveEventHandler` ç­‰
- **ä¸šåŠ¡è§„åˆ™**ï¼šç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å’ŒéªŒè¯
- **æ•°æ®è½¬æ¢**ï¼šä¸šåŠ¡å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–

#### 2. **ä¸šåŠ¡ç‰¹å®šé…ç½®**
- **ä¸»é¢˜æ˜ å°„**ï¼šä¸šåŠ¡äº‹ä»¶ç±»å‹åˆ°ä¸»é¢˜çš„æ˜ å°„
- **å¤„ç†ç­–ç•¥**ï¼šä¸šåŠ¡ç‰¹å®šçš„é”™è¯¯å¤„ç†å’Œé‡è¯•ç­–ç•¥
- **æ€§èƒ½å‚æ•°**ï¼šåŸºäºä¸šåŠ¡éœ€æ±‚çš„æ€§èƒ½è°ƒä¼˜å‚æ•°

#### 3. **ä¸šåŠ¡é›†æˆé€»è¾‘**
- **Outbox æ¨¡å¼**ï¼šäº‹ä»¶çŠ¶æ€ç®¡ç†å’Œè°ƒåº¦
- **ç§Ÿæˆ·å¤„ç†**ï¼šå¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†
- **ä¸šåŠ¡ç›‘æ§**ï¼šä¸šåŠ¡ç‰¹å®šçš„æŒ‡æ ‡å’Œå‘Šè­¦

## æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å¾®æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚                                              â”‚ â”‚
â”‚  â”‚  - MediaEventHandler (è®¢é˜…ç«¯ä¸šåŠ¡é€»è¾‘)                   â”‚ â”‚
â”‚  â”‚  - EventPublisher é€‚é…å™¨ (å‘å¸ƒç«¯ä¸šåŠ¡é€»è¾‘)               â”‚ â”‚
â”‚  â”‚  - ä¸šåŠ¡ç‰¹å®šçš„æ¶ˆæ¯æ ¼å¼åŒ–å™¨                               â”‚ â”‚
â”‚  â”‚  - ä¸šåŠ¡ç‰¹å®šçš„é”™è¯¯å¤„ç†ç­–ç•¥                               â”‚ â”‚
â”‚  â”‚  - Outbox æ¨¡å¼é›†æˆ                                     â”‚ â”‚
â”‚  â”‚  - ä¸šåŠ¡é…ç½®å’Œä¸»é¢˜æ˜ å°„                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ æ¥å£è°ƒç”¨
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     jxt-core å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é«˜çº§äº‹ä»¶æ€»çº¿ (AdvancedEventBus)                        â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚   è®¢é˜…ç«¯ç»„ä»¶     â”‚  â”‚   å‘å¸ƒç«¯ç»„ä»¶     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ - ç§¯å‹æ£€æµ‹      â”‚  â”‚ - å‘å¸ƒç®¡ç†å™¨    â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ - æ¢å¤æ¨¡å¼      â”‚  â”‚ - æ¶ˆæ¯æ ¼å¼åŒ–    â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ - èšåˆå¤„ç†å™¨    â”‚  â”‚ - å‘å¸ƒå›è°ƒ      â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ - æµé‡æ§åˆ¶      â”‚  â”‚ - é‡è¯•æœºåˆ¶      â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                ç»Ÿä¸€ç»„ä»¶                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - ç»Ÿä¸€å¥åº·æ£€æŸ¥å™¨ (HealthChecker)                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - æ ‡å‡†å¥åº·æ£€æŸ¥æ¶ˆæ¯ (HealthCheckMessage)             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - é‡è¿ç®¡ç†å™¨ (ReconnectionManager)                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - å›è°ƒæœºåˆ¶æ¡†æ¶ (CallbackManager)                    â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  åŸºç¡€äº‹ä»¶æ€»çº¿ (EventBus)                                â”‚ â”‚
â”‚  â”‚  - Kafka å®ç°                                          â”‚ â”‚
â”‚  â”‚  - NATS å®ç°                                           â”‚ â”‚
â”‚  â”‚  - Memory å®ç°                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¥å£è®¾è®¡

```go
// é«˜çº§äº‹ä»¶æ€»çº¿ç»Ÿä¸€æ¥å£
type AdvancedEventBus interface {
    EventBus // ç»§æ‰¿åŸºç¡€æ¥å£
    
    // è®¢é˜…ç«¯åŠŸèƒ½
    SubscribeWithOptions(ctx context.Context, topic string, handler MessageHandler, opts SubscribeOptions) error
    SetRecoveryMode(enabled bool) error
    IsInRecoveryMode() bool
    RegisterBacklogCallback(callback BacklogStateCallback) error
    StartBacklogMonitoring(ctx context.Context) error
    
    // å‘å¸ƒç«¯åŠŸèƒ½
    PublishWithOptions(ctx context.Context, topic string, message []byte, opts PublishOptions) error
    SetMessageFormatter(formatter MessageFormatter) error
    RegisterPublishCallback(callback PublishCallback) error
    
    // ç»Ÿä¸€åŠŸèƒ½
    StartHealthCheck(ctx context.Context) error
    StopHealthCheck() error
    GetHealthStatus() HealthCheckStatus
    RegisterHealthCheckCallback(callback HealthCheckCallback) error
    RegisterReconnectCallback(callback ReconnectCallback) error
    GetConnectionState() ConnectionState
}
```

## å®æ–½è®¡åˆ’

### æ€»ä½“æ—¶é—´å®‰æ’ï¼ˆ6å‘¨ï¼‰

| é˜¶æ®µ | æ—¶é—´ | ä¸»è¦ä»»åŠ¡ | äº¤ä»˜ç‰© |
|------|------|----------|--------|
| **é˜¶æ®µ1** | ç¬¬1å‘¨ | æ ¸å¿ƒæ¥å£å’Œé…ç½®è®¾è®¡ | æ¥å£å®šä¹‰ã€é…ç½®ç»“æ„ |
| **é˜¶æ®µ2** | ç¬¬2å‘¨ | ç»Ÿä¸€å¥åº·æ£€æŸ¥å®ç° | HealthCheckerã€HealthCheckMessage |
| **é˜¶æ®µ3** | ç¬¬3å‘¨ | è®¢é˜…ç«¯é«˜çº§åŠŸèƒ½ | ç§¯å‹æ£€æµ‹ã€æ¢å¤æ¨¡å¼ã€èšåˆå¤„ç†å™¨ |
| **é˜¶æ®µ4** | ç¬¬4å‘¨ | å‘å¸ƒç«¯é«˜çº§åŠŸèƒ½ | å‘å¸ƒç®¡ç†å™¨ã€æ¶ˆæ¯æ ¼å¼åŒ–å™¨ |
| **é˜¶æ®µ5** | ç¬¬5å‘¨ | Kafka é›†æˆå’Œæµ‹è¯• | å®Œæ•´çš„ Kafka å®ç° |
| **é˜¶æ®µ6** | ç¬¬6å‘¨ | ä¸šåŠ¡å±‚é€‚é…å’Œè¿ç§» | é€‚é…å™¨ã€è¿ç§»è„šæœ¬ã€æ–‡æ¡£ |

### è¯¦ç»†å®æ–½æ­¥éª¤

#### ç¬¬1å‘¨ï¼šåŸºç¡€æ¡†æ¶
1. **æ¥å£è®¾è®¡**ï¼šå®šä¹‰ `AdvancedEventBus` æ¥å£
2. **é…ç½®ç»“æ„**ï¼šè®¾è®¡ç»Ÿä¸€çš„é…ç½®ä½“ç³»
3. **é¡¹ç›®ç»“æ„**ï¼šåˆ›å»ºç›®å½•ç»“æ„å’ŒåŸºç¡€æ–‡ä»¶
4. **å•å…ƒæµ‹è¯•æ¡†æ¶**ï¼šå»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½

#### ç¬¬2å‘¨ï¼šç»Ÿä¸€å¥åº·æ£€æŸ¥
1. **å¥åº·æ£€æŸ¥æ¶ˆæ¯**ï¼šå®ç° `HealthCheckMessage`
2. **å¥åº·æ£€æŸ¥å™¨**ï¼šå®ç° `HealthChecker`
3. **ç»Ÿä¸€ä¸»é¢˜**ï¼šå®šä¹‰å’Œå®ç°ç»Ÿä¸€å¥åº·æ£€æŸ¥ä¸»é¢˜
4. **å›è°ƒæœºåˆ¶**ï¼šå®ç°å¥åº·æ£€æŸ¥çŠ¶æ€å›è°ƒ

#### ç¬¬3å‘¨ï¼šè®¢é˜…ç«¯åŠŸèƒ½
1. **ç§¯å‹æ£€æµ‹å™¨**ï¼šå®ç° `BacklogDetector`
2. **æ¢å¤æ¨¡å¼ç®¡ç†å™¨**ï¼šå®ç° `RecoveryManager`
3. **èšåˆå¤„ç†å™¨ç®¡ç†å™¨**ï¼šå®ç° `AggregateProcessorManager`
4. **æ¶ˆæ¯è·¯ç”±å™¨**ï¼šå®ç°å¯æ’æ‹”çš„æ¶ˆæ¯è·¯ç”±

#### ç¬¬4å‘¨ï¼šå‘å¸ƒç«¯åŠŸèƒ½
1. **é«˜çº§å‘å¸ƒç®¡ç†å™¨**ï¼šå®ç° `AdvancedPublisher`
2. **æ¶ˆæ¯æ ¼å¼åŒ–å™¨**ï¼šå®ç°å¯æ’æ‹”çš„æ ¼å¼åŒ–å™¨
3. **å‘å¸ƒå›è°ƒæœºåˆ¶**ï¼šå®ç°å‘å¸ƒç»“æœé€šçŸ¥
4. **é‡è¿ç®¡ç†**ï¼šå®ç°å‘å¸ƒç«¯é‡è¿é€»è¾‘

#### ç¬¬5å‘¨ï¼šKafka é›†æˆ
1. **Kafka é«˜çº§äº‹ä»¶æ€»çº¿**ï¼šé›†æˆæ‰€æœ‰åŠŸèƒ½åˆ° Kafka å®ç°
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–æ€§èƒ½å’Œèµ„æºä½¿ç”¨
3. **é›†æˆæµ‹è¯•**ï¼šå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
4. **å‹åŠ›æµ‹è¯•**ï¼šæ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•

#### ç¬¬6å‘¨ï¼šä¸šåŠ¡é€‚é…
1. **é€‚é…å™¨å®ç°**ï¼šåˆ›å»ºä¸šåŠ¡å±‚é€‚é…å™¨
2. **è¿ç§»è„šæœ¬**ï¼šè‡ªåŠ¨åŒ–è¿ç§»å·¥å…·
3. **æ–‡æ¡£å®Œå–„**ï¼šä½¿ç”¨æŒ‡å—å’Œæœ€ä½³å®è·µ
4. **åŸ¹è®­ææ–™**ï¼šå›¢é˜ŸåŸ¹è®­å’ŒçŸ¥è¯†è½¬ç§»

## é…ç½®ç¤ºä¾‹

### ç»Ÿä¸€é…ç½®æ–‡ä»¶
```yaml
eventbus:
  type: "kafka"
  serviceName: "evidence-management"
  
  kafka:
    brokers: ["localhost:9092"]
    consumer_group: "evidence-management"
  
  # ç»Ÿä¸€å¥åº·æ£€æŸ¥é…ç½®
  healthCheck:
    enabled: true
    # topic ç”± jxt-core ç»Ÿä¸€ç®¡ç†
    interval: "2m"
    timeout: "10s"
    failureThreshold: 3
  
  # è®¢é˜…ç«¯é…ç½®
  subscriber:
    recoveryMode:
      enabled: true
      autoDetection: true
      transitionThreshold: 3
    
    backlogDetection:
      enabled: true
      maxLagThreshold: 1000
      checkInterval: "1m"
    
    aggregateProcessor:
      enabled: true
      cacheSize: 1000
      idleTimeout: "5m"
  
  # å‘å¸ƒç«¯é…ç½®
  publisher:
    maxReconnectAttempts: 5
    maxBackoff: "1m"
    publishTimeout: "30s"
```

### ä¸šåŠ¡å±‚ä½¿ç”¨ç¤ºä¾‹
```go
// ç»Ÿä¸€åˆå§‹åŒ–
func initEventBus() (eventbus.AdvancedEventBus, error) {
    config := GetEventBusConfig()
    bus, err := eventbus.NewKafkaAdvancedEventBus(config)
    if err != nil {
        return nil, err
    }
    
    // è®¾ç½®ä¸šåŠ¡ç»„ä»¶
    bus.SetMessageRouter(&EvidenceMessageRouter{})
    bus.SetErrorHandler(&EvidenceErrorHandler{})
    bus.SetMessageFormatter(&EvidenceMessageFormatter{})
    
    // æ³¨å†Œç»Ÿä¸€å›è°ƒ
    bus.RegisterHealthCheckCallback(handleHealthCheck)
    bus.RegisterReconnectCallback(handleReconnect)
    bus.RegisterBacklogCallback(handleBacklogChange)
    bus.RegisterPublishCallback(handlePublishResult)
    
    // å¯åŠ¨ç»Ÿä¸€å¥åº·æ£€æŸ¥
    if err := bus.StartHealthCheck(context.Background()); err != nil {
        return nil, err
    }
    
    return bus, nil
}

// è®¢é˜…ç«¯ä½¿ç”¨
func setupSubscriber(bus eventbus.AdvancedEventBus) error {
    opts := eventbus.SubscribeOptions{
        UseAggregateProcessor: true,
        ProcessingTimeout:     30 * time.Second,
        RateLimit:            1000,
    }
    
    return bus.SubscribeWithOptions(
        context.Background(),
        "media-events",
        handleMediaEvent,
        opts,
    )
}

// å‘å¸ƒç«¯ä½¿ç”¨
func publishEvent(bus eventbus.AdvancedEventBus, event Event) error {
    payload, _ := event.MarshalJSON()
    
    opts := eventbus.PublishOptions{
        AggregateID: event.GetAggregateID(),
        Metadata: map[string]string{
            "eventType": event.GetEventType(),
        },
        Timeout: 30 * time.Second,
    }
    
    return bus.PublishWithOptions(
        context.Background(),
        "media-events",
        payload,
        opts,
    )
}
```

## é¢„æœŸæ”¶ç›Š

### ğŸ“ˆ **é‡åŒ–æ”¶ç›Š**
1. **ä»£ç å‡å°‘ 75%**ï¼šæŠ€æœ¯åŸºç¡€è®¾æ–½ç»Ÿä¸€å®ç°
2. **é…ç½®ç®€åŒ– 60%**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†
3. **ç»´æŠ¤æˆæœ¬é™ä½ 70%**ï¼šé›†ä¸­ç»´æŠ¤æŠ€æœ¯ç»„ä»¶
4. **å¼€å‘æ•ˆç‡æå‡ 50%**ï¼šæ ‡å‡†åŒ–çš„å¼€å‘æ¨¡å¼

### ğŸ¯ **è´¨é‡æ”¶ç›Š**
1. **ç»Ÿä¸€å¥åº·æ£€æŸ¥**ï¼šæ‰€æœ‰å¾®æœåŠ¡ä½¿ç”¨ç›¸åŒçš„å¥åº·æ£€æŸ¥æœºåˆ¶
2. **æ ‡å‡†åŒ–ç›‘æ§**ï¼šç»Ÿä¸€çš„ç›‘æ§æ•°æ®æ ¼å¼å’ŒæŒ‡æ ‡
3. **æé«˜å¯é æ€§**ï¼šç»è¿‡å……åˆ†æµ‹è¯•çš„æŠ€æœ¯ç»„ä»¶
4. **å¢å¼ºå¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ›´å¤šäº‹ä»¶æ€»çº¿å®ç°

### ğŸ”§ **æŠ€æœ¯æ”¶ç›Š**
1. **æ¶æ„æ¸…æ™°**ï¼šæ˜ç¡®çš„æŠ€æœ¯å’Œä¸šåŠ¡åˆ†å±‚
2. **æ¥å£æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„æ¥å£å’Œå›è°ƒæœºåˆ¶
3. **é…ç½®ç»Ÿä¸€**ï¼šä¸€è‡´çš„é…ç½®ç»“æ„å’Œç®¡ç†
4. **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œæœ€ä½³å®è·µ

## é£é™©è¯„ä¼°å’Œç¼“è§£

### âš ï¸ **ä¸»è¦é£é™©**
1. **æ€§èƒ½å½±å“**ï¼šæ–°çš„æŠ½è±¡å±‚å¯èƒ½å¸¦æ¥æ€§èƒ½å¼€é”€
2. **å…¼å®¹æ€§é—®é¢˜**ï¼šä¸ç°æœ‰ä¸šåŠ¡ä»£ç çš„å…¼å®¹æ€§
3. **è¿ç§»å¤æ‚åº¦**ï¼šå¤§è§„æ¨¡ä»£ç è¿ç§»çš„é£é™©
4. **å­¦ä¹ æˆæœ¬**ï¼šå›¢é˜Ÿå¯¹æ–°æ¶æ„çš„å­¦ä¹ æˆæœ¬

### ğŸ›¡ï¸ **ç¼“è§£æªæ–½**
1. **æ€§èƒ½æµ‹è¯•**ï¼šå……åˆ†çš„æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–
2. **é€‚é…å™¨æ¨¡å¼**ï¼šé€šè¿‡é€‚é…å™¨ä¿æŒæ¥å£å…¼å®¹æ€§
3. **åˆ†é˜¶æ®µè¿ç§»**ï¼šé€æ­¥è¿ç§»ï¼Œé™ä½é£é™©
4. **åŸ¹è®­å’Œæ–‡æ¡£**ï¼šå®Œå–„çš„åŸ¹è®­ææ–™å’Œæ–‡æ¡£

## æ€»ç»“

è¿™ä¸ªå®Œæ•´çš„å®æ–½æ–¹æ¡ˆå°† evidence-management ä¸­çš„äº‹ä»¶æ€»çº¿åŠŸèƒ½å…¨é¢è¿ç§»åˆ° jxt-coreï¼Œå®ç°äº†ï¼š

1. **æŠ€æœ¯ç»Ÿä¸€**ï¼š75% çš„æŠ€æœ¯åŸºç¡€è®¾æ–½ç»Ÿä¸€å®ç°
2. **åŠŸèƒ½å®Œæ•´**ï¼šè¦†ç›–è®¢é˜…ç«¯å’Œå‘å¸ƒç«¯çš„æ‰€æœ‰é«˜çº§åŠŸèƒ½
3. **æ¶æ„æ¸…æ™°**ï¼šæ˜ç¡®çš„åˆ†å±‚å’ŒèŒè´£åˆ†ç¦»
4. **æ˜“äºç»´æŠ¤**ï¼šé›†ä¸­çš„æŠ€æœ¯ç»„ä»¶ç»´æŠ¤
5. **ä¸šåŠ¡çµæ´»**ï¼šé€šè¿‡é€‚é…å™¨å’Œå›è°ƒä¿æŒä¸šåŠ¡çµæ´»æ€§

é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼Œä¸ä»…è§£å†³äº†å½“å‰çš„ä»£ç é‡å¤é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„æ‰©å±•å’Œä¼˜åŒ–å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
