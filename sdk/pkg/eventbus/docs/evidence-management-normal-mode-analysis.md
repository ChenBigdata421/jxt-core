# evidence-management æ­£å¸¸æ¨¡å¼ä¸‹çš„æ¶ˆæ¯é¡ºåºå¤„ç†åˆ†æ

## ğŸ¯ **æ ¸å¿ƒé—®é¢˜åˆ†æ**

### é—®é¢˜1ï¼šæ­£å¸¸æ¨¡å¼ä¸‹èƒ½å¦ä¿è¯åŒä¸€èšåˆæ¶ˆæ¯çš„æŒ‰é¡ºåºå¤„ç†ï¼Ÿ
### é—®é¢˜2ï¼šæ­£å¸¸æ¨¡å¼ä¸‹ä½¿ç”¨èšåˆå¤„ç†å™¨ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

---

## ğŸ” **æ­£å¸¸æ¨¡å¼ä¸‹çš„å¤„ç†é€»è¾‘è¯¦è§£**

### 1. **æ¶ˆæ¯è·¯ç”±å†³ç­–æœºåˆ¶**

```go
func (km *KafkaSubscriberManager) processMessage(ctx context.Context, msg *message.Message, handler func(*message.Message) error, timeout time.Duration) {
    aggregateID := msg.Metadata.Get("aggregateID")
    
    // ğŸ”´ å…³é”®å†³ç­–ç‚¹
    if km.IsInRecoveryMode() || (aggregateID != "" && km.aggregateProcessors.Contains(aggregateID)) {
        km.processMessageWithAggregateProcessor(ctx, msg, handler, timeout)
    } else {
        km.processMessageImmediately(ctx, msg, handler, timeout)
    }
}
```

**å†³ç­–é€»è¾‘åˆ†æ**ï¼š
- âœ… **æ¢å¤æ¨¡å¼**ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½è¿›å…¥èšåˆå¤„ç†å™¨
- âœ… **æ­£å¸¸æ¨¡å¼ + å·²æœ‰å¤„ç†å™¨**ï¼šå¦‚æœèšåˆIDå·²æœ‰å¤„ç†å™¨ï¼Œä»ç„¶è¿›å…¥æœ‰åºå¤„ç†
- âŒ **æ­£å¸¸æ¨¡å¼ + æ— å¤„ç†å™¨**ï¼šç«‹å³å¹¶å‘å¤„ç†ï¼Œ**æ— æ³•ä¿è¯é¡ºåº**

### 2. **æ­£å¸¸æ¨¡å¼ä¸‹çš„å¤„ç†å™¨åˆ›å»ºé™åˆ¶**

```go
func (km *KafkaSubscriberManager) getOrCreateProcessor(ctx context.Context, aggregateID string, handler func(*message.Message) error) (*aggregateProcessor, error) {
    if proc, exists := km.aggregateProcessors.Get(aggregateID); exists {
        return proc, nil
    }
    
    // ğŸ”´ å…³é”®é™åˆ¶ï¼šåªåœ¨æ¢å¤æ¨¡å¼ä¸‹åˆ›å»ºæ–°å¤„ç†å™¨
    if !km.IsInRecoveryMode() {
        return nil, fmt.Errorf("not in recovery mode, cannot create new processor")
    }
    
    // åˆ›å»ºæ–°å¤„ç†å™¨çš„é€»è¾‘...
}
```

**é™åˆ¶åˆ†æ**ï¼š
- âŒ **æ— æ³•åˆ›å»ºæ–°å¤„ç†å™¨**ï¼šæ­£å¸¸æ¨¡å¼ä¸‹ä¸èƒ½ä¸ºæ–°èšåˆIDåˆ›å»ºå¤„ç†å™¨
- âœ… **ä½¿ç”¨ç°æœ‰å¤„ç†å™¨**ï¼šå¦‚æœå¤„ç†å™¨å·²å­˜åœ¨ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨
- âš ï¸ **æ¸è¿›å¼é€€åŒ–**ï¼šéšç€å¤„ç†å™¨ç©ºé—²é‡Šæ”¾ï¼Œè¶Šæ¥è¶Šå¤šçš„èšåˆIDå¤±å»é¡ºåºä¿è¯

---

## ğŸ“Š **æ­£å¸¸æ¨¡å¼ä¸‹çš„é¡ºåºå¤„ç†èƒ½åŠ›åˆ†æ**

### 1. **èƒ½ä¿è¯é¡ºåºçš„æƒ…å†µ**

#### åœºæ™¯Aï¼šå¤„ç†å™¨ä»ç„¶å­˜åœ¨
```go
// èšåˆID "user-123" çš„å¤„ç†å™¨ä»åœ¨è¿è¡Œ
aggregateID := "user-123"
if km.aggregateProcessors.Contains(aggregateID) {
    // âœ… ä»ç„¶è¿›å…¥æœ‰åºå¤„ç†
    km.processMessageWithAggregateProcessor(ctx, msg, handler, timeout)
}
```

**ä¿è¯æ¡ä»¶**ï¼š
- âœ… èšåˆå¤„ç†å™¨å°šæœªå› ç©ºé—²è€Œé‡Šæ”¾
- âœ… æ¶ˆæ¯é—´éš” < 5åˆ†é’Ÿï¼ˆç©ºé—²è¶…æ—¶æ—¶é—´ï¼‰
- âœ… ç³»ç»Ÿæœªé‡å¯

#### åœºæ™¯Bï¼šé«˜é¢‘æ¶ˆæ¯æµ
```go
// é«˜é¢‘æ¶ˆæ¯æµåœºæ™¯
æ—¶é—´è½´ï¼š
T0: æ¶ˆæ¯1 (user-123) â†’ åˆ›å»ºå¤„ç†å™¨ â†’ æœ‰åºå¤„ç†
T1: æ¶ˆæ¯2 (user-123) â†’ ä½¿ç”¨ç°æœ‰å¤„ç†å™¨ â†’ æœ‰åºå¤„ç†  
T2: æ¶ˆæ¯3 (user-123) â†’ ä½¿ç”¨ç°æœ‰å¤„ç†å™¨ â†’ æœ‰åºå¤„ç†
...
T300: æ¶ˆæ¯N (user-123) â†’ å¤„ç†å™¨ç©ºé—²é‡Šæ”¾
T301: æ¶ˆæ¯N+1 (user-123) â†’ æ— å¤„ç†å™¨ â†’ å¹¶å‘å¤„ç† âŒ
```

### 2. **æ— æ³•ä¿è¯é¡ºåºçš„æƒ…å†µ**

#### åœºæ™¯Cï¼šå¤„ç†å™¨å·²é‡Šæ”¾
```go
// èšåˆID "user-456" çš„å¤„ç†å™¨å·²é‡Šæ”¾
aggregateID := "user-456"
if !km.aggregateProcessors.Contains(aggregateID) {
    // âŒ ç«‹å³å¹¶å‘å¤„ç†ï¼Œæ— é¡ºåºä¿è¯
    km.processMessageImmediately(ctx, msg, handler, timeout)
}
```

#### åœºæ™¯Dï¼šç³»ç»Ÿé‡å¯å
```go
// ç³»ç»Ÿé‡å¯åï¼Œæ‰€æœ‰å¤„ç†å™¨éƒ½ä¸å­˜åœ¨
// ç¬¬ä¸€ä¸ªæ¶ˆæ¯åˆ°è¾¾æ—¶ï¼š
if !km.IsInRecoveryMode() && !km.aggregateProcessors.Contains(aggregateID) {
    // âŒ æ— æ³•åˆ›å»ºæ–°å¤„ç†å™¨ï¼Œç›´æ¥å¹¶å‘å¤„ç†
    km.processMessageImmediately(ctx, msg, handler, timeout)
}
```

#### åœºæ™¯Eï¼šä½é¢‘æ¶ˆæ¯æµ
```go
// ä½é¢‘æ¶ˆæ¯æµåœºæ™¯
æ—¶é—´è½´ï¼š
T0: æ¶ˆæ¯1 (user-789) â†’ æ¢å¤æ¨¡å¼ â†’ åˆ›å»ºå¤„ç†å™¨ â†’ æœ‰åºå¤„ç†
T300: å¤„ç†å™¨ç©ºé—²é‡Šæ”¾
T600: æ¶ˆæ¯2 (user-789) â†’ æ­£å¸¸æ¨¡å¼ â†’ æ— å¤„ç†å™¨ â†’ å¹¶å‘å¤„ç† âŒ
T900: æ¶ˆæ¯3 (user-789) â†’ æ­£å¸¸æ¨¡å¼ â†’ æ— å¤„ç†å™¨ â†’ å¹¶å‘å¤„ç† âŒ
```

---

## ğŸ¤” **ä¸ºä»€ä¹ˆæ­£å¸¸æ¨¡å¼ä¸‹ä¸å…è®¸åˆ›å»ºæ–°å¤„ç†å™¨ï¼Ÿ**

### 1. **è®¾è®¡ç†å¿µåˆ†æ**

#### æ€§èƒ½ä¼˜å…ˆåŸåˆ™
```go
// æ­£å¸¸æ¨¡å¼çš„è®¾è®¡ç›®æ ‡ï¼šæœ€å¤§åŒ–å¹¶å‘æ€§èƒ½
func (km *KafkaSubscriberManager) processMessageImmediately(ctx context.Context, msg *message.Message, handler func(*message.Message) error, timeout time.Duration) {
    // æ¯ä¸ªæ¶ˆæ¯éƒ½åœ¨ç‹¬ç«‹çš„ goroutine ä¸­å¹¶å‘å¤„ç†
    go func() {
        if err := handler(msg); err != nil {
            // é”™è¯¯å¤„ç†...
        }
        msg.Ack()
    }()
}
```

**è®¾è®¡è€ƒè™‘**ï¼š
- ğŸš€ **æœ€å¤§å¹¶å‘**ï¼šæ­£å¸¸æ¨¡å¼è¿½æ±‚æœ€é«˜çš„æ¶ˆæ¯å¤„ç†ååé‡
- ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…å¤„ç†å™¨ç®¡ç†çš„å¼€é”€
- ğŸ¯ **ç®€åŒ–é€»è¾‘**ï¼šå‡å°‘æ­£å¸¸è¿è¡Œæ—¶çš„å¤æ‚æ€§

#### èµ„æºç®¡ç†è€ƒè™‘
```go
// é¿å…å¤„ç†å™¨æ— é™å¢é•¿
type KafkaSubscriberManager struct {
    aggregateProcessors *lru.Cache[string, *aggregateProcessor] // æœ‰é™å®¹é‡
}
```

**èµ„æºé™åˆ¶**ï¼š
- ğŸ’¾ **å†…å­˜æ§åˆ¶**ï¼šé¿å…å¤„ç†å™¨æ•°é‡æ— é™å¢é•¿
- ğŸ”„ **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ­£å¸¸æ¨¡å¼ä¸‹è®©å¤„ç†å™¨è‡ªç„¶æ¶ˆäº¡
- âš–ï¸ **å¹³è¡¡ç­–ç•¥**ï¼šåœ¨æ€§èƒ½å’Œé¡ºåºæ€§ä¹‹é—´å–èˆ

### 2. **ä¸šåŠ¡åœºæ™¯è€ƒè™‘**

#### ç§¯å‹æ¢å¤ vs æ­£å¸¸è¿è¡Œ
```go
// ä¸åŒé˜¶æ®µçš„ä¸åŒéœ€æ±‚
æ¢å¤é˜¶æ®µï¼š
- å¤§é‡ç§¯å‹æ¶ˆæ¯éœ€è¦æœ‰åºå¤„ç†
- æ€§èƒ½ä¸æ˜¯é¦–è¦è€ƒè™‘
- æ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆ

æ­£å¸¸è¿è¡Œï¼š
- æ¶ˆæ¯é‡ç›¸å¯¹è¾ƒå°‘
- æ€§èƒ½å’Œååé‡ä¼˜å…ˆ
- å¶å°”çš„é¡ºåºé—®é¢˜å¯ä»¥å®¹å¿
```

---

## ğŸ› ï¸ **æ­£å¸¸æ¨¡å¼ä¸‹ä½¿ç”¨èšåˆå¤„ç†å™¨çš„é—®é¢˜åˆ†æ**

### 1. **å¦‚æœæ­£å¸¸æ¨¡å¼ä¸‹ä¹Ÿå…è®¸åˆ›å»ºå¤„ç†å™¨ä¼šæ€æ ·ï¼Ÿ**

#### æ½œåœ¨é—®é¢˜Aï¼šèµ„æºæ³„æ¼
```go
// å‡è®¾æ­£å¸¸æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥åˆ›å»ºå¤„ç†å™¨
func (km *KafkaSubscriberManager) getOrCreateProcessor(ctx context.Context, aggregateID string, handler func(*message.Message) error) (*aggregateProcessor, error) {
    if proc, exists := km.aggregateProcessors.Get(aggregateID); exists {
        return proc, nil
    }
    
    // å¦‚æœç§»é™¤è¿™ä¸ªé™åˆ¶...
    // if !km.IsInRecoveryMode() {
    //     return nil, fmt.Errorf("not in recovery mode, cannot create new processor")
    // }
    
    // é—®é¢˜ï¼šå¯èƒ½æ— é™åˆ›å»ºå¤„ç†å™¨
    proc := &aggregateProcessor{...}
    return proc, nil
}
```

**é—®é¢˜åˆ†æ**ï¼š
- ğŸ’¾ **å†…å­˜æ³„æ¼**ï¼šæ¯ä¸ªæ–°èšåˆIDéƒ½ä¼šåˆ›å»ºå¤„ç†å™¨
- ğŸ”„ **å¤„ç†å™¨å †ç§¯**ï¼šä½é¢‘èšåˆIDçš„å¤„ç†å™¨é•¿æœŸå ç”¨èµ„æº
- ğŸ“Š **ç¼“å­˜å‹åŠ›**ï¼šLRUç¼“å­˜é¢‘ç¹æ·˜æ±°ï¼Œå½±å“æ€§èƒ½

#### æ½œåœ¨é—®é¢˜Bï¼šæ€§èƒ½é€€åŒ–
```go
// å¤§é‡å¤„ç†å™¨çš„æ€§èƒ½å½±å“
åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿï¼Œæ¯ä¸ªç”¨æˆ·IDä½œä¸ºèšåˆID
- 100ä¸‡æ´»è·ƒç”¨æˆ·
- æ¯ä¸ªç”¨æˆ·éƒ½æœ‰å¯¹åº”çš„å¤„ç†å™¨
- æ¯ä¸ªå¤„ç†å™¨å ç”¨ï¼šgoroutine + channel + å†…å­˜

èµ„æºæ¶ˆè€—ï¼š
- 100ä¸‡ä¸ª goroutine
- 100ä¸‡ä¸ª channel (æ¯ä¸ªç¼“å†²100æ¡æ¶ˆæ¯)
- å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
```

#### æ½œåœ¨é—®é¢˜Cï¼šå¤æ‚æ€§å¢åŠ 
```go
// å¤„ç†å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å¤æ‚åŒ–
æ­£å¸¸æ¨¡å¼ä¸‹çš„å¤„ç†å™¨ç®¡ç†ï¼š
- ä½•æ—¶åˆ›å»ºï¼Ÿæ¯ä¸ªæ–°èšåˆIDéƒ½åˆ›å»ºï¼Ÿ
- ä½•æ—¶é‡Šæ”¾ï¼Ÿç©ºé—²å¤šä¹…é‡Šæ”¾ï¼Ÿ
- å¦‚ä½•é™åˆ¶ï¼Ÿæœ€å¤§å¤„ç†å™¨æ•°é‡ï¼Ÿ
- å¦‚ä½•ç›‘æ§ï¼Ÿå¤„ç†å™¨å¥åº·çŠ¶æ€ï¼Ÿ
```

### 2. **å½“å‰è®¾è®¡çš„æƒè¡¡**

#### ä¼˜åŠ¿
- âœ… **ç®€å•æ˜ç¡®**ï¼šæ­£å¸¸æ¨¡å¼å°±æ˜¯å¹¶å‘å¤„ç†ï¼Œé€»è¾‘æ¸…æ™°
- âœ… **æ€§èƒ½ä¼˜å…ˆ**ï¼šé¿å…å¤„ç†å™¨ç®¡ç†å¼€é”€
- âœ… **èµ„æºå¯æ§**ï¼šå¤„ç†å™¨æ•°é‡è‡ªç„¶å‡å°‘
- âœ… **æ•…éšœéš”ç¦»**ï¼šæ­£å¸¸æ¨¡å¼ä¸‹çš„é—®é¢˜ä¸ä¼šå½±å“æ¢å¤æ¨¡å¼

#### åŠ£åŠ¿
- âŒ **é¡ºåºä¸¢å¤±**ï¼šæ­£å¸¸æ¨¡å¼ä¸‹æ— æ³•ä¿è¯æ–°èšåˆIDçš„é¡ºåº
- âŒ **ä¸ä¸€è‡´æ€§**ï¼šåŒä¸€ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ç§å¤„ç†æ¨¡å¼
- âŒ **ä¸šåŠ¡å¤æ‚**ï¼šä¸šåŠ¡å±‚éœ€è¦å¤„ç†é¡ºåºä¸ä¸€è‡´çš„æƒ…å†µ

---

## ğŸ¯ **æ€»ç»“å’Œå»ºè®®**

### ğŸ“‹ **é—®é¢˜ç­”æ¡ˆ**

#### Q1: æ­£å¸¸æ¨¡å¼ä¸‹èƒ½å¦ä¿è¯åŒä¸€èšåˆæ¶ˆæ¯çš„æŒ‰é¡ºåºå¤„ç†ï¼Ÿ
**ç­”æ¡ˆï¼šéƒ¨åˆ†èƒ½å¤Ÿï¼Œä½†ä¸å®Œæ•´**

- âœ… **å·²æœ‰å¤„ç†å™¨çš„èšåˆID**ï¼šå¯ä»¥ä¿è¯é¡ºåº
- âŒ **æ–°èšåˆIDæˆ–å¤„ç†å™¨å·²é‡Šæ”¾**ï¼šæ— æ³•ä¿è¯é¡ºåº
- âš ï¸ **æ¸è¿›å¼é€€åŒ–**ï¼šéšç€æ—¶é—´æ¨ç§»ï¼Œè¶Šæ¥è¶Šå¤šèšåˆIDå¤±å»é¡ºåºä¿è¯

#### Q2: æ­£å¸¸æ¨¡å¼ä¸‹ä½¿ç”¨èšåˆå¤„ç†å™¨ä¼šæœ‰é—®é¢˜å—ï¼Ÿ
**ç­”æ¡ˆï¼šä¼šæœ‰æ˜¾è‘—é—®é¢˜**

- ğŸ’¾ **èµ„æºé—®é¢˜**ï¼šå†…å­˜æ³„æ¼ã€å¤„ç†å™¨å †ç§¯
- ğŸš€ **æ€§èƒ½é—®é¢˜**ï¼šå¤§é‡goroutineã€ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
- ğŸ”§ **å¤æ‚æ€§é—®é¢˜**ï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†å¤æ‚åŒ–

### ğŸ’¡ **è®¾è®¡æ”¹è¿›å»ºè®®**

#### æ–¹æ¡ˆ1ï¼šæ··åˆæ¨¡å¼
```go
// ä¸ºæ­£å¸¸æ¨¡å¼æ·»åŠ å¯é…ç½®çš„é¡ºåºä¿è¯
type ProcessingMode int
const (
    RecoveryMode ProcessingMode = iota  // å¼ºåˆ¶æœ‰åº
    HybridMode                          // å¯é€‰æœ‰åº
    PerformanceMode                     // çº¯å¹¶å‘
)
```

#### æ–¹æ¡ˆ2ï¼šæ™ºèƒ½å¤„ç†å™¨ç®¡ç†
```go
// åŸºäºæ¶ˆæ¯é¢‘ç‡åŠ¨æ€ç®¡ç†å¤„ç†å™¨
type SmartProcessorManager struct {
    frequencyThreshold time.Duration  // æ¶ˆæ¯é¢‘ç‡é˜ˆå€¼
    maxProcessors     int            // æœ€å¤§å¤„ç†å™¨æ•°é‡
    priorityAggregates map[string]bool // ä¼˜å…ˆä¿è¯é¡ºåºçš„èšåˆID
}
```

#### æ–¹æ¡ˆ3ï¼šä¸šåŠ¡å±‚é€‰æ‹©
```go
// è®©ä¸šåŠ¡å±‚å†³å®šæ˜¯å¦éœ€è¦é¡ºåºä¿è¯
type MessageOptions struct {
    RequireOrder bool
    AggregateID  string
}

func (km *KafkaSubscriberManager) ProcessMessageWithOptions(msg *message.Message, opts MessageOptions) {
    if opts.RequireOrder {
        km.processMessageWithAggregateProcessor(ctx, msg, handler, timeout)
    } else {
        km.processMessageImmediately(ctx, msg, handler, timeout)
    }
}
```

### ğŸ¯ **æ ¸å¿ƒæ´å¯Ÿ**

evidence-management çš„è®¾è®¡ä½“ç°äº†ä¸€ä¸ªé‡è¦çš„å·¥ç¨‹æƒè¡¡ï¼š

- **æ¢å¤é˜¶æ®µ**ï¼šæ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆï¼Œæ€§èƒ½å…¶æ¬¡
- **æ­£å¸¸è¿è¡Œ**ï¼šæ€§èƒ½ä¼˜å…ˆï¼Œå¶å°”çš„é¡ºåºé—®é¢˜å¯ä»¥å®¹å¿

è¿™ç§è®¾è®¡é€‚åˆ**ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯**ï¼Œä½†ä¹Ÿæš´éœ²äº†**é€šç”¨æ€§ä¸è¶³**çš„é—®é¢˜ã€‚è¿™æ­£æ˜¯ä¸ºä»€ä¹ˆ jxt-core EventBus é€‰æ‹©å°†æ¢å¤ç­–ç•¥äº¤ç»™ä¸šåŠ¡å±‚å®ç°çš„åŸå› â€”â€”ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦ä¸åŒçš„æƒè¡¡ç­–ç•¥ã€‚
