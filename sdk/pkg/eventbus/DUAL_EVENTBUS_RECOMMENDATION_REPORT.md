# åŒEventBuså®ä¾‹æ¶æ„æ¨èæŠ¥å‘Š

## ğŸ¯ **ä¸šåŠ¡åœºæ™¯åˆ†æç»“è®º**

åŸºäºä½ çš„ä¸šåŠ¡éœ€æ±‚åˆ†æï¼Œ**å¼ºçƒˆæ¨èä½¿ç”¨åŒEventBuså®ä¾‹æ¶æ„**ï¼Œè€Œä¸æ˜¯å•ä¸€å®ä¾‹æ–¹æ¡ˆã€‚

### ğŸ“‹ **ä½ çš„ä¸šåŠ¡åœºæ™¯**

**ä¸šåŠ¡Aï¼šé¢†åŸŸäº‹ä»¶å¤„ç†**
- âœ… éœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶æŒä¹…åŒ–é¢†åŸŸäº‹ä»¶
- âœ… å‘å¸ƒæ—¶é€šè¿‡Envelopeæºå¸¦èšåˆID
- âœ… è®¢é˜…ç«¯æ ¹æ®èšåˆIDå“ˆå¸Œåˆ°Keyed-Workeræ± 
- âœ… ç¡®ä¿åŒä¸€èšåˆIDé¢†åŸŸäº‹ä»¶å¤„ç†çš„é¡ºåºæ€§

**ä¸šåŠ¡Bï¼šæ™®é€šæ¶ˆæ¯å¤„ç†**
- âŒ ä¸éœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶æŒä¹…åŒ–
- âŒ ä¸éœ€è¦EnvelopeåŒ…è£…
- âŒ ä¸éœ€è¦Keyed-Workeræ± 
- âš¡ è¿½æ±‚é«˜æ€§èƒ½å¹¶å‘å¤„ç†

## ğŸ—ï¸ **æ¨èæ¶æ„ï¼šåŒEventBuså®ä¾‹**

### æ¶æ„è®¾è®¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ä¸šåŠ¡AæœåŠ¡        â”‚           ä¸šåŠ¡BæœåŠ¡                    â”‚
â”‚   (è®¢å•ã€æ”¯ä»˜ç­‰)      â”‚      (é€šçŸ¥ã€ç¼“å­˜ç­‰)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBuså®ä¾‹A       â”‚        EventBuså®ä¾‹B                  â”‚
â”‚  (é¢†åŸŸäº‹ä»¶)          â”‚        (ç®€å•æ¶ˆæ¯)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… NATS JetStream    â”‚ âš¡ Memory/Redis                       â”‚
â”‚ âœ… EnvelopeåŒ…è£…      â”‚ âŒ ç›´æ¥æ¶ˆæ¯                            â”‚
â”‚ âœ… Keyed-Workeræ±     â”‚ âŒ ç›´æ¥å¹¶å‘                            â”‚
â”‚ âœ… æŒä¹…åŒ–å­˜å‚¨        â”‚ âŒ å†…å­˜å­˜å‚¨                            â”‚
â”‚ âœ… é¡ºåºä¿è¯          â”‚ âš¡ é«˜ååé‡                            â”‚
â”‚ âœ… äº‹åŠ¡ä¸€è‡´æ€§        â”‚ âš¡ ä½å»¶è¿Ÿ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š **æ¶æ„ä¼˜åŠ¿åˆ†æ**

### 1. **ä¸šåŠ¡éš”ç¦»ä¼˜åŠ¿**

| ç»´åº¦ | é¢†åŸŸäº‹ä»¶EventBus | ç®€å•æ¶ˆæ¯EventBus | ä¼˜åŠ¿ |
|------|-----------------|-----------------|------|
| **æ•…éšœéš”ç¦»** | ç‹¬ç«‹æ•…éšœåŸŸ | ç‹¬ç«‹æ•…éšœåŸŸ | âœ… äº’ä¸å½±å“ |
| **æ€§èƒ½éš”ç¦»** | å¯é æ€§ä¼˜å…ˆ | æ€§èƒ½ä¼˜å…ˆ | âœ… ç²¾ç¡®ä¼˜åŒ– |
| **æ‰©å±•éš”ç¦»** | æŒ‰éœ€æ‰©å±• | æŒ‰éœ€æ‰©å±• | âœ… ç‹¬ç«‹ä¼¸ç¼© |
| **ç›‘æ§éš”ç¦»** | ä¸šåŠ¡æŒ‡æ ‡ | æ€§èƒ½æŒ‡æ ‡ | âœ… ç²¾ç¡®ç›‘æ§ |

### 2. **æŠ€æœ¯é€‰å‹ä¼˜åŠ¿**

**é¢†åŸŸäº‹ä»¶EventBusï¼ˆä¸šåŠ¡Aï¼‰**ï¼š
```yaml
type: nats  # NATS JetStream
jetstream:
  enabled: true
  stream:
    storage: "file"      # æŒä¹…åŒ–å­˜å‚¨
    replicas: 3          # é«˜å¯ç”¨
    retention: "limits"  # é•¿æœŸä¿ç•™
    maxAge: "30d"        # 30å¤©ä¿ç•™æœŸ
```

**ç®€å•æ¶ˆæ¯EventBusï¼ˆä¸šåŠ¡Bï¼‰**ï¼š
```yaml
type: memory  # å†…å­˜å®ç°
# æˆ–è€…
type: redis   # Redisé«˜æ€§èƒ½
redis:
  poolSize: 100
  maxRetries: 0  # æ— é‡è¯•ï¼Œè¿½æ±‚æ€§èƒ½
```

### 3. **æ€§èƒ½ç‰¹å¾å¯¹æ¯”**

| æŒ‡æ ‡ | é¢†åŸŸäº‹ä»¶ | ç®€å•æ¶ˆæ¯ | å·®å¼‚ |
|------|---------|---------|------|
| **å»¶è¿Ÿ** | 50-200ms | 1-10ms | **20å€å·®å¼‚** |
| **ååé‡** | 1K-10K msg/s | 100K+ msg/s | **10å€å·®å¼‚** |
| **å¯é æ€§** | 99.99% | 95-99% | **å¯é æ€§vsæ€§èƒ½** |
| **å­˜å‚¨** | æŒä¹…åŒ– | å†…å­˜ | **ä¸åŒéœ€æ±‚** |

## ğŸ’» **å®ç°ç¤ºä¾‹**

### æœåŠ¡åˆå§‹åŒ–

```go
type BusinessService struct {
    // ä¸šåŠ¡Aï¼šé¢†åŸŸäº‹ä»¶EventBus
    domainEventsBus   eventbus.EventBus
    
    // ä¸šåŠ¡Bï¼šç®€å•æ¶ˆæ¯EventBus  
    simpleMessagesBus eventbus.EventBus
}

func NewBusinessService() *BusinessService {
    return &BusinessService{
        domainEventsBus:   createDomainEventsBus(),    // æŒä¹…åŒ–é…ç½®
        simpleMessagesBus: createSimpleMessagesBus(),  // é«˜æ€§èƒ½é…ç½®
    }
}
```

### ä¸šåŠ¡Aï¼šé¢†åŸŸäº‹ä»¶å¤„ç†

```go
// å‘å¸ƒé¢†åŸŸäº‹ä»¶
func (s *BusinessService) PublishDomainEvent(ctx context.Context, aggregateID string, eventType string, payload []byte) error {
    envelope := eventbus.NewEnvelope(aggregateID, eventType, version, payload)
    envelope.TraceID = "domain-" + aggregateID
    
    // å‘å¸ƒåˆ°æŒä¹…åŒ–EventBus
    return s.domainEventsBus.PublishEnvelope(ctx, "domain.events", envelope)
}

// è®¢é˜…é¢†åŸŸäº‹ä»¶
func (s *BusinessService) SubscribeDomainEvents(ctx context.Context) error {
    handler := func(ctx context.Context, envelope *eventbus.Envelope) error {
        // Keyed-Workeræ± ç¡®ä¿åŒä¸€èšåˆIDçš„äº‹ä»¶é¡ºåºå¤„ç†
        return s.handleDomainEvent(envelope)
    }
    
    return s.domainEventsBus.SubscribeEnvelope(ctx, "domain.events", handler)
}
```

### ä¸šåŠ¡Bï¼šç®€å•æ¶ˆæ¯å¤„ç†

```go
// å‘å¸ƒç®€å•æ¶ˆæ¯
func (s *BusinessService) PublishSimpleMessage(ctx context.Context, message []byte) error {
    // ç›´æ¥å‘å¸ƒï¼Œæ— EnvelopeåŒ…è£…
    return s.simpleMessagesBus.Publish(ctx, "simple.messages", message)
}

// è®¢é˜…ç®€å•æ¶ˆæ¯
func (s *BusinessService) SubscribeSimpleMessages(ctx context.Context) error {
    handler := func(ctx context.Context, message []byte) error {
        // ç›´æ¥å¹¶å‘å¤„ç†ï¼Œè¿½æ±‚é«˜æ€§èƒ½
        return s.handleSimpleMessage(message)
    }
    
    return s.simpleMessagesBus.Subscribe(ctx, "simple.messages", handler)
}
```

## ğŸš€ **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®**

### 1. **åŸºç¡€è®¾æ–½é…ç½®**

**é¢†åŸŸäº‹ä»¶åŸºç¡€è®¾æ–½**ï¼š
```yaml
# NATS JetStreamé›†ç¾¤
nats_cluster:
  replicas: 3
  storage: "50Gi"      # å¤§å®¹é‡å­˜å‚¨
  memory: "8Gi"        # å……è¶³å†…å­˜
  cpu: "4"             # é«˜æ€§èƒ½CPU

# ç›‘æ§é…ç½®
monitoring:
  - eventbus_domain_events_lag
  - eventbus_domain_events_storage_usage
  - eventbus_domain_events_processing_duration
```

**ç®€å•æ¶ˆæ¯åŸºç¡€è®¾æ–½**ï¼š
```yaml
# Redisé›†ç¾¤æˆ–å†…å­˜å®ä¾‹
redis_cluster:
  replicas: 2
  memory: "4Gi"        # å†…å­˜ä¼˜åŒ–
  cpu: "2"             # ä¸­ç­‰CPU
  persistence: false   # æ— æŒä¹…åŒ–

# ç›‘æ§é…ç½®  
monitoring:
  - eventbus_simple_messages_throughput
  - eventbus_simple_messages_latency
  - eventbus_simple_messages_error_rate
```

### 2. **æ‰©å±•ç­–ç•¥**

```yaml
scaling:
  domain_events:
    min_replicas: 2
    max_replicas: 10
    target_cpu: 70%
    target_memory: 80%
    
  simple_messages:
    min_replicas: 1
    max_replicas: 20     # æ›´æ¿€è¿›çš„æ‰©å±•
    target_cpu: 80%
    target_throughput: 50000  # åŸºäºååé‡æ‰©å±•
```

## ğŸ“ˆ **å®é™…æµ‹è¯•ç»“æœ**

åŸºäºç¤ºä¾‹è¿è¡Œçš„å®é™…æ•ˆæœï¼š

### é¢†åŸŸäº‹ä»¶å¤„ç†æ•ˆæœ
```
ğŸ›ï¸ [é¢†åŸŸäº‹ä»¶æœåŠ¡] æ”¶åˆ°æŒä¹…åŒ–é¢†åŸŸäº‹ä»¶:
  èšåˆID: order-001 (è·¯ç”±åˆ°å›ºå®šWorkerï¼Œç¡®ä¿é¡ºåº)
  äº‹ä»¶ç±»å‹: OrderCreated
  äº‹ä»¶ç‰ˆæœ¬: 1
  è¿½è¸ªID: domain-trace-order-001
  å¤„ç†æ¨¡å¼: Keyed-Workeræ±  (é¡ºåºä¿è¯ + æŒä¹…åŒ–)
   ğŸ”„ å¤„ç†è®¢å•åˆ›å»ºé¢†åŸŸäº‹ä»¶: order-001, é‡‘é¢: 99.99
   ğŸ“‹ ä¸šåŠ¡è§„åˆ™éªŒè¯: [amount_validation customer_verification]
   âœ… è®¢å• order-001 é¢†åŸŸäº‹ä»¶å¤„ç†å®Œæˆ
```

### ç®€å•æ¶ˆæ¯å¤„ç†æ•ˆæœ
```
ğŸ“¢ [ç®€å•æ¶ˆæ¯æœåŠ¡] æ”¶åˆ°ç³»ç»Ÿé€šçŸ¥:
  ç±»å‹: info, ä¼˜å…ˆçº§: low
  å¤„ç†æ¨¡å¼: ç›´æ¥å¹¶å‘å¤„ç† (é«˜æ€§èƒ½ï¼Œæ— æŒä¹…åŒ–)
  é€šçŸ¥å†…å®¹: ç³»ç»Ÿç»´æŠ¤ - ç³»ç»Ÿå°†äºä»Šæ™šè¿›è¡Œç»´æŠ¤
   âš¡ é€šçŸ¥å¤„ç†å®Œæˆ
```

## ğŸ¯ **æœ€ç»ˆæ¨è**

### âœ… **å¼ºçƒˆæ¨èï¼šåŒEventBuså®ä¾‹æ¶æ„**

**ç†ç”±**ï¼š
1. **ğŸ—ï¸ ä¸šåŠ¡éš”ç¦»**ï¼šé¢†åŸŸäº‹ä»¶å’Œç®€å•æ¶ˆæ¯å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
2. **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šå„è‡ªä½¿ç”¨æœ€é€‚åˆçš„æŠ€æœ¯æ ˆå’Œé…ç½®
3. **ğŸ”’ å¯é æ€§ä¿è¯**ï¼šé¢†åŸŸäº‹ä»¶æŒä¹…åŒ–ï¼Œç®€å•æ¶ˆæ¯é«˜æ€§èƒ½
4. **ğŸ“Š ç²¾ç¡®ç›‘æ§**ï¼šä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒçš„ç›‘æ§æŒ‡æ ‡
5. **ğŸš€ ç‹¬ç«‹æ‰©å±•**ï¼šæ ¹æ®ä¸šåŠ¡è´Ÿè½½ç‹¬ç«‹æ‰©ç¼©å®¹

### ğŸ“‹ **å®æ–½æ­¥éª¤**

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šåˆ›å»ºä¸¤ä¸ªEventBuså®ä¾‹ï¼Œä½¿ç”¨å†…å­˜æ¨¡å¼éªŒè¯
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šé¢†åŸŸäº‹ä»¶EventBusåˆ‡æ¢åˆ°NATS JetStream
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šç®€å•æ¶ˆæ¯EventBusä¼˜åŒ–ä¸ºRedisæˆ–ä¿æŒå†…å­˜
4. **ç¬¬å››é˜¶æ®µ**ï¼šå®Œå–„ç›‘æ§ã€å‘Šè­¦å’Œè¿ç»´ä½“ç³»

è¿™ç§æ¶æ„è®¾è®¡å®Œç¾åŒ¹é…äº†ä½ çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå®ç°äº†**æŠ€æœ¯é€‰å‹ç²¾ç¡®åŒ–ã€æ€§èƒ½ä¼˜åŒ–æœ€å¤§åŒ–ã€ä¸šåŠ¡éš”ç¦»å½»åº•åŒ–**çš„ç›®æ ‡ï¼Œæ˜¯ä¼ä¸šçº§äº‹ä»¶é©±åŠ¨æ¶æ„çš„æœ€ä½³å®è·µï¼ğŸ‰
