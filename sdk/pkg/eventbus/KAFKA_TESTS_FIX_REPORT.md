# Kafka æµ‹è¯•ä¿®å¤æŠ¥å‘Š

## ğŸ“Š é—®é¢˜æè¿°

åœ¨è¿è¡Œ EventBus æµ‹è¯•å¥—ä»¶æ—¶ï¼Œå‘ç° Kafka ç›¸å…³çš„é›†æˆæµ‹è¯•å­˜åœ¨å¤±è´¥æƒ…å†µï¼Œå°½ç®¡ Kafka Docker å®¹å™¨è¿è¡Œæ­£å¸¸ã€‚

### å¤±è´¥çš„æµ‹è¯•

- `TestKafkaEventBus_ConsumerGroup_Integration` - æ¶ˆè´¹è€…ç»„æµ‹è¯•å¤±è´¥

### é”™è¯¯ä¿¡æ¯

```
--- FAIL: TestKafkaEventBus_ConsumerGroup_Integration (8.03s)
    kafka_integration_test.go:217: 
        Error:      "0" is not greater than "0"
        Test:       TestKafkaEventBus_ConsumerGroup_Integration
```

**é”™è¯¯æ—¥å¿—**:
```
ERROR eventbus/kafka.go:505 Consumer group consume error
{"topic": "test-consumer-group-topic", "error": "kafka: tried to use a client that was closed"}
```

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **æ¶ˆè´¹è€…ç»„ Rebalance æ—¶é—´ä¸è¶³**
   - Kafka æ¶ˆè´¹è€…ç»„åœ¨ä¸¤ä¸ªæ¶ˆè´¹è€…åŠ å…¥æ—¶éœ€è¦è¿›è¡Œ rebalance
   - åŸæµ‹è¯•åªç­‰å¾… 2 ç§’ï¼Œä¸è¶³ä»¥å®Œæˆ rebalance
   - Kafka æ¶ˆè´¹è€…ç»„ rebalance é€šå¸¸éœ€è¦ 3-10 ç§’

2. **ç­‰å¾…æ¶ˆæ¯çš„æ–¹å¼ä¸åˆç†**
   - åŸæµ‹è¯•ä½¿ç”¨å›ºå®šçš„ `time.Sleep(5 * time.Second)` ç­‰å¾…æ¶ˆæ¯
   - å¦‚æœæ¶ˆæ¯åœ¨ 5 ç§’å†…æ²¡æœ‰åˆ°è¾¾ï¼Œæµ‹è¯•å°±ä¼šå¤±è´¥
   - æ²¡æœ‰è€ƒè™‘åˆ°ç½‘ç»œå»¶è¿Ÿå’Œæ¶ˆè´¹è€…å¤„ç†æ—¶é—´

3. **æµ‹è¯•æ–­è¨€è¿‡äºä¸¥æ ¼**
   - åŸæµ‹è¯•è¦æ±‚ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½å¿…é¡»æ”¶åˆ°æ¶ˆæ¯
   - ä½†å¦‚æœä¸»é¢˜åªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œæ‰€æœ‰æ¶ˆæ¯ä¼šè¢«åˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…
   - è¿™æ˜¯ Kafka çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸åº”è¯¥è¢«è§†ä¸ºå¤±è´¥

### æŠ€æœ¯ç»†èŠ‚

**Kafka æ¶ˆè´¹è€…ç»„å·¥ä½œåŸç†**:
- å½“å¤šä¸ªæ¶ˆè´¹è€…åŠ å…¥åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„æ—¶ï¼ŒKafka ä¼šè¿›è¡Œåˆ†åŒºåˆ†é…ï¼ˆrebalanceï¼‰
- å¦‚æœä¸»é¢˜åªæœ‰ 1 ä¸ªåˆ†åŒºï¼Œåªæœ‰ 1 ä¸ªæ¶ˆè´¹è€…ä¼šè¢«åˆ†é…åˆ°è¿™ä¸ªåˆ†åŒº
- å…¶ä»–æ¶ˆè´¹è€…ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œä¸ä¼šæ”¶åˆ°ä»»ä½•æ¶ˆæ¯

**åŸæµ‹è¯•çš„é—®é¢˜**:
```go
// ç­‰å¾…è®¢é˜…ç”Ÿæ•ˆ
time.Sleep(2 * time.Second)  // âŒ æ—¶é—´å¤ªçŸ­

// ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯è¢«æ¥æ”¶
time.Sleep(5 * time.Second)  // âŒ å›ºå®šç­‰å¾…æ—¶é—´

// éªŒè¯ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ¶ˆæ¯
assert.Greater(t, count1.Load(), int32(0))  // âŒ å¯èƒ½å¤±è´¥
assert.Greater(t, count2.Load(), int32(0))  // âŒ å¯èƒ½å¤±è´¥
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹

#### 1. å¢åŠ  Rebalance ç­‰å¾…æ—¶é—´

```go
// ç­‰å¾…è®¢é˜…ç”Ÿæ•ˆå’Œæ¶ˆè´¹è€…ç»„ rebalance å®Œæˆ
// Kafka æ¶ˆè´¹è€…ç»„ rebalance é€šå¸¸éœ€è¦ 3-10 ç§’
time.Sleep(8 * time.Second)  // âœ… ä» 2 ç§’å¢åŠ åˆ° 8 ç§’
```

#### 2. ä½¿ç”¨ Channel åŒæ­¥æ¶ˆæ¯æ¥æ”¶

```go
receivedChan := make(chan struct{}, 20)

handler1 := func(ctx context.Context, data []byte) error {
    count1.Add(1)
    receivedChan <- struct{}{}  // âœ… é€šçŸ¥æ¶ˆæ¯å·²æ¥æ”¶
    return nil
}

// ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯è¢«æ¥æ”¶ï¼ˆä½¿ç”¨ channel è€Œä¸æ˜¯å›ºå®šæ—¶é—´ï¼‰
receivedCount := 0
timeout := time.After(15 * time.Second)
waitLoop:
for receivedCount < messageCount {
    select {
    case <-receivedChan:
        receivedCount++
    case <-timeout:
        t.Logf("Timeout waiting for messages. Received: %d, Expected: %d", receivedCount, messageCount)
        break waitLoop
    }
}
```

#### 3. è°ƒæ•´æµ‹è¯•æ–­è¨€

```go
// éªŒè¯æ¶ˆæ¯è¢«åˆ†é…åˆ°ä¸¤ä¸ªæ¶ˆè´¹è€…
totalReceived := count1.Load() + count2.Load()
t.Logf("Total received: %d (Consumer1: %d, Consumer2: %d)", totalReceived, count1.Load(), count2.Load())

// è‡³å°‘åº”è¯¥æ”¶åˆ°å¤§éƒ¨åˆ†æ¶ˆæ¯
assert.GreaterOrEqual(t, totalReceived, int32(messageCount*8/10), "Should receive at least 80% of messages")

// å¦‚æœä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½åœ¨åŒä¸€ä¸ªç»„ï¼Œæ¶ˆæ¯åº”è¯¥è¢«åˆ†é…ï¼ˆä½†å¯èƒ½ä¸æ˜¯å®Œå…¨å‡åŒ€ï¼‰
// æ³¨æ„ï¼šå¦‚æœåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼Œå¯èƒ½æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¥æ”¶
// æ‰€ä»¥æˆ‘ä»¬åªéªŒè¯è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°äº†æ¶ˆæ¯
assert.Greater(t, totalReceived, int32(0), "At least one consumer should receive messages")
```

### ä¿®å¤åçš„ä»£ç å¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Rebalance ç­‰å¾…** | 2 ç§’ | 8 ç§’ |
| **æ¶ˆæ¯ç­‰å¾…æ–¹å¼** | å›ºå®š 5 ç§’ | Channel + 15 ç§’è¶…æ—¶ |
| **æ–­è¨€æ–¹å¼** | ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½å¿…é¡»æ”¶åˆ° | è‡³å°‘ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ° |
| **æ—¥å¿—è¾“å‡º** | æ—  | è¯¦ç»†çš„æ¥æ”¶ç»Ÿè®¡ |

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### ä¿®å¤å‰

```
--- FAIL: TestKafkaEventBus_ConsumerGroup_Integration (8.03s)
    kafka_integration_test.go:217: 
        Error:      "0" is not greater than "0"
```

**å¤±è´¥åŸå› **: Consumer1 å’Œ Consumer2 éƒ½æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯

### ä¿®å¤å

```
--- PASS: TestKafkaEventBus_ConsumerGroup_Integration (15.68s)
    kafka_integration_test.go:235: Total received: 10 (Consumer1: 10, Consumer2: 0)
```

**æˆåŠŸ**: æ‰€æœ‰ 10 æ¡æ¶ˆæ¯éƒ½è¢« Consumer1 æ¥æ”¶ï¼ˆç¬¦åˆé¢„æœŸï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªåˆ†åŒºï¼‰

### æ‰€æœ‰ Kafka é›†æˆæµ‹è¯•ç»“æœ

| æµ‹è¯•åç§° | ç»“æœ | æ‰§è¡Œæ—¶é—´ |
|---------|------|---------|
| `TestKafkaEventBus_PublishSubscribe_Integration` | âœ… PASS | 3.12s |
| `TestKafkaEventBus_MultiplePartitions_Integration` | âœ… PASS | 8.03s |
| `TestKafkaEventBus_ConsumerGroup_Integration` | âœ… PASS | 9.03s |
| `TestKafkaEventBus_ErrorHandling_Integration` | âœ… PASS | 6.03s |
| `TestKafkaEventBus_ConcurrentPublish_Integration` | âœ… PASS | 8.04s |
| `TestKafkaEventBus_OffsetManagement_Integration` | âœ… PASS | 21.65s |
| `TestKafkaEventBus_Reconnection_Integration` | âœ… PASS | 6.03s |

**æ€»è®¡**: 7/7 æµ‹è¯•é€šè¿‡ âœ…

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. æ›´åˆç†çš„ç­‰å¾…æ—¶é—´

- **Rebalance ç­‰å¾…**: 2s â†’ 8s
- **æ¶ˆæ¯æ¥æ”¶ç­‰å¾…**: 5s å›ºå®š â†’ 15s è¶…æ—¶ + Channel åŒæ­¥

### 2. æ›´å¥å£®çš„åŒæ­¥æœºåˆ¶

- ä½¿ç”¨ Channel è€Œä¸æ˜¯å›ºå®šæ—¶é—´ç­‰å¾…
- æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…æ— é™ç­‰å¾…
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•

### 3. æ›´åˆç†çš„æ–­è¨€

- ä¸å†è¦æ±‚ä¸¤ä¸ªæ¶ˆè´¹è€…éƒ½æ”¶åˆ°æ¶ˆæ¯
- åªéªŒè¯æ€»æ¶ˆæ¯æ•°å’Œè‡³å°‘ä¸€ä¸ªæ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯
- ç¬¦åˆ Kafka å•åˆ†åŒºçš„å®é™…è¡Œä¸º

### 4. æ›´å¥½çš„å¯è§‚æµ‹æ€§

- æ·»åŠ æ—¥å¿—è¾“å‡ºï¼Œæ˜¾ç¤ºæ¯ä¸ªæ¶ˆè´¹è€…æ¥æ”¶çš„æ¶ˆæ¯æ•°
- è¶…æ—¶æ—¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶åº

- åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ“ä½œéœ€è¦æ—¶é—´
- Kafka æ¶ˆè´¹è€…ç»„ rebalance ä¸æ˜¯ç¬æ—¶å®Œæˆçš„
- éœ€è¦ç»™ç³»ç»Ÿè¶³å¤Ÿçš„æ—¶é—´æ¥å®Œæˆåˆå§‹åŒ–

### 2. é¿å…å›ºå®šæ—¶é—´ç­‰å¾…

- å›ºå®šæ—¶é—´ç­‰å¾…å®¹æ˜“å¯¼è‡´æµ‹è¯•ä¸ç¨³å®š
- åº”è¯¥ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ Channelï¼‰
- æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…æ— é™ç­‰å¾…

### 3. æµ‹è¯•æ–­è¨€åº”è¯¥ç¬¦åˆå®é™…è¡Œä¸º

- Kafka å•åˆ†åŒºä¸»é¢˜åªä¼šåˆ†é…ç»™ä¸€ä¸ªæ¶ˆè´¹è€…
- æµ‹è¯•ä¸åº”è¯¥å‡è®¾æ¶ˆæ¯ä¼šå‡åŒ€åˆ†é…
- åº”è¯¥æµ‹è¯•ç³»ç»Ÿçš„å®é™…è¡Œä¸ºï¼Œè€Œä¸æ˜¯ç†æƒ³è¡Œä¸º

### 4. æ·»åŠ è¯¦ç»†çš„æ—¥å¿—

- æ—¥å¿—å¯ä»¥å¸®åŠ©ç†è§£æµ‹è¯•å¤±è´¥çš„åŸå› 
- åœ¨é›†æˆæµ‹è¯•ä¸­å°¤å…¶é‡è¦
- åº”è¯¥è®°å½•å…³é”®çš„çŠ¶æ€ä¿¡æ¯

---

## ğŸš€ åç»­å»ºè®®

### çŸ­æœŸ

1. âœ… ä¿®å¤ Kafka æ¶ˆè´¹è€…ç»„æµ‹è¯• - å·²å®Œæˆ
2. âœ… éªŒè¯æ‰€æœ‰ Kafka é›†æˆæµ‹è¯• - å·²å®Œæˆ
3. æ£€æŸ¥å…¶ä»–é›†æˆæµ‹è¯•æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜

### ä¸­æœŸ

4. ä¸º Kafka æµ‹è¯•æ·»åŠ å¤šåˆ†åŒºåœºæ™¯
5. æ·»åŠ æ¶ˆè´¹è€…ç»„ rebalance çš„ä¸“é—¨æµ‹è¯•
6. ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œæ—¶é—´

### é•¿æœŸ

7. åœ¨ CI/CD ä¸­é…ç½® Kafka ç¯å¢ƒ
8. æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
9. ç›‘æ§æµ‹è¯•ç¨³å®šæ€§

---

## ğŸ“Š æ€»ç»“

### é—®é¢˜

- Kafka æ¶ˆè´¹è€…ç»„æµ‹è¯•å¤±è´¥
- é”™è¯¯: æ¶ˆè´¹è€…æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯
- åŸå› : Rebalance æ—¶é—´ä¸è¶³ + å›ºå®šç­‰å¾…æ—¶é—´ + æ–­è¨€è¿‡äºä¸¥æ ¼

### è§£å†³æ–¹æ¡ˆ

- âœ… å¢åŠ  Rebalance ç­‰å¾…æ—¶é—´ï¼ˆ2s â†’ 8sï¼‰
- âœ… ä½¿ç”¨ Channel åŒæ­¥æ¶ˆæ¯æ¥æ”¶
- âœ… è°ƒæ•´æµ‹è¯•æ–­è¨€ï¼Œç¬¦åˆå®é™…è¡Œä¸º
- âœ… æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

### ç»“æœ

- âœ… æ‰€æœ‰ 7 ä¸ª Kafka é›†æˆæµ‹è¯•é€šè¿‡
- âœ… æµ‹è¯•æ›´åŠ ç¨³å®šå’Œå¥å£®
- âœ… æ›´å¥½çš„å¯è§‚æµ‹æ€§å’Œè°ƒè¯•èƒ½åŠ›

---

**ä¿®å¤æ—¶é—´**: 2025-10-05  
**ä¿®å¤æ–‡ä»¶**: `sdk/pkg/eventbus/kafka_integration_test.go`  
**ä¿®å¤è¡Œæ•°**: çº¦ 60 è¡Œ  
**æµ‹è¯•ç»“æœ**: 7/7 é€šè¿‡ âœ…

