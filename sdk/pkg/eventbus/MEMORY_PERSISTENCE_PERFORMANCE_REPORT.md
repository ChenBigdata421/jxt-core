# Kafka vs NATS JetStream 内存持久化性能对比报告

## 📊 测试概览

**测试日期**: 2025-10-29  
**测试文件**: `jxt-core/tests/eventbus/performance_regression_tests/memory_persistence_comparison_test.go`  
**测试时长**: 163.51 秒（约 2.7 分钟）  
**测试场景**: 4 个压力级别（Low, Medium, High, Extreme）  
**测试次数**: 8 次（Kafka 4 次 + NATS 4 次）  
**测试结果**: ✅ **PASS**

---

## 🎯 测试目的

对比 Kafka 和 NATS JetStream 在**内存持久化模式**下的性能表现，验证 NATS 迁移到 Hollywood Actor Pool 后的性能。

**关键特点**:
- ✅ 使用 `Publish/Subscribe` 方法（无聚合ID）
- ✅ Kafka 和 NATS 都使用内存持久化
- ✅ Kafka 使用 3 分区配置
- ✅ 两个系统都使用全局 Worker 池处理订阅消息
- ✅ Topic 数量: 5

---

## 📈 性能指标汇总表

| 场景 | 系统 | 吞吐量(msg/s) | 延迟(ms) | 成功率(%) | 内存增量(MB) |
|------|------|--------------|---------|----------|-------------|
| **Low** | Kafka | 490.05 | 138.145 | 100.00 | 1.07 |
| **Low** | NATS | 436.82 | 87.658 | 100.00 | 2.43 |
| **Medium** | Kafka | 1862.75 | 148.560 | 100.00 | 1.14 |
| **Medium** | NATS | 1158.12 | 219.172 | 100.00 | 2.42 |
| **High** | Kafka | 4072.72 | 211.328 | 100.00 | 1.31 |
| **High** | NATS | 1799.01 | 568.929 | 100.00 | 2.43 |
| **Extreme** | Kafka | 6881.54 | 207.434 | 100.00 | 1.18 |
| **Extreme** | NATS | 1884.76 | 1054.397 | 100.00 | 2.42 |

---

## 🏆 综合评分

### 平均性能对比

| 指标 | Kafka | NATS | Kafka 优势 |
|------|-------|------|-----------|
| **平均吞吐量** | 3326.77 msg/s | 1319.68 msg/s | +152.1% ✅ |
| **平均延迟** | 176.367 ms | 482.539 ms | -173.6% ✅ |
| **平均内存增量** | 1.18 MB | 2.43 MB | -106.0% ❌ |

### 最终结论

**🥇 Kafka 以 2:1 获胜！**

- ✅ **吞吐量**: Kafka 胜出 (+152.1%)
- ✅ **延迟**: Kafka 胜出 (-173.6%)
- ✅ **内存效率**: NATS 胜出 (-106.0%)

---

## 📊 各压力级别详细分析

### 1. Low 压力测试（1000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 |
|------|--------|------|--------|----------|
| **Kafka** | 490.05 msg/s | 138.145 ms | 100.00% | 1.07 MB |
| **NATS** | 436.82 msg/s | 87.658 ms | 100.00% | 2.43 MB |

**关键发现**:
- NATS 延迟更低（**-36.5%**）
- Kafka 吞吐量略高（+12.2%）
- NATS 内存占用更高（+127.1%）

### 2. Medium 压力测试（4000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 |
|------|--------|------|--------|----------|
| **Kafka** | 1862.75 msg/s | 148.560 ms | 100.00% | 1.14 MB |
| **NATS** | 1158.12 msg/s | 219.172 ms | 100.00% | 2.42 MB |

**关键发现**:
- Kafka 吞吐量优势开始显现（**+60.8%**）
- Kafka 延迟开始优于 NATS（-32.2%）
- NATS 内存占用仍然更高（+112.3%）

### 3. High 压力测试（6000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 |
|------|--------|------|--------|----------|
| **Kafka** | 4072.72 msg/s | 211.328 ms | 100.00% | 1.31 MB |
| **NATS** | 1799.01 msg/s | 568.929 ms | 100.00% | 2.43 MB |

**关键发现**:
- Kafka 吞吐量优势显著（**+126.4%**）
- Kafka 延迟优势显著（**-62.9%**）
- NATS 内存占用更高（+85.5%）

### 4. Extreme 压力测试（10000 条消息）

| 系统 | 吞吐量 | 延迟 | 成功率 | 内存增量 |
|------|--------|------|--------|----------|
| **Kafka** | 6881.54 msg/s | 207.434 ms | 100.00% | 1.18 MB |
| **NATS** | 1884.76 msg/s | 1054.397 ms | 100.00% | 2.42 MB |

**关键发现**:
- Kafka 吞吐量优势巨大（**+265.1%**）
- Kafka 延迟优势巨大（**-408.3%**）
- NATS 内存占用更高（+105.1%）
- **极限压力下，Kafka 表现远超 NATS**

---

## 🔍 资源占用详细分析

### Extreme 压力测试资源对比

| 资源指标 | Kafka | NATS | 对比 |
|---------|-------|------|------|
| **初始协程数** | 83 | 81 | 相近 |
| **峰值协程数** | 221 | 98 | Kafka 更高 |
| **最终协程数** | 216 | 93 | Kafka 更高 |
| **协程泄漏** | 133 | 12 | NATS 更好 |
| **初始内存** | 14.30 MB | 15.24 MB | 相近 |
| **峰值内存** | 31.95 MB | 31.29 MB | 相近 |
| **最终内存** | 15.47 MB | 17.66 MB | 相近 |
| **内存增量** | 1.18 MB | 2.42 MB | NATS 更高 |

**关键洞察**:
1. **Kafka 协程数更高**: 峰值 221 vs 98，但吞吐量也更高
2. **NATS 协程泄漏更少**: 12 vs 133
3. **NATS 内存增量更高**: 2.42 MB vs 1.18 MB（+105.1%）
4. **峰值内存相近**: 两者都在 31 MB 左右

---

## 📉 性能趋势分析

### 吞吐量趋势

| 压力级别 | Kafka 吞吐量 | NATS 吞吐量 | Kafka 优势 |
|---------|-------------|------------|-----------|
| Low | 490.05 msg/s | 436.82 msg/s | +12.2% |
| Medium | 1862.75 msg/s | 1158.12 msg/s | +60.8% |
| High | 4072.72 msg/s | 1799.01 msg/s | +126.4% |
| Extreme | 6881.54 msg/s | 1884.76 msg/s | **+265.1%** |

**趋势分析**:
- Kafka 吞吐量随压力增加而线性增长
- NATS 吞吐量增长缓慢，在 Extreme 压力下几乎停滞
- **Kafka 吞吐量优势随压力增加而显著增大**

### 延迟趋势

| 压力级别 | Kafka 延迟 | NATS 延迟 | Kafka 优势 |
|---------|-----------|----------|-----------|
| Low | 138.145 ms | 87.658 ms | -36.5% ❌ |
| Medium | 148.560 ms | 219.172 ms | -32.2% ✅ |
| High | 211.328 ms | 568.929 ms | -62.9% ✅ |
| Extreme | 207.434 ms | 1054.397 ms | **-408.3%** ✅ |

**趋势分析**:
- **Low 压力**: NATS 延迟更低（-36.5%）
- **Medium 压力**: Kafka 延迟开始优于 NATS
- **High 压力**: Kafka 延迟优势显著
- **Extreme 压力**: Kafka 延迟优势巨大（-408.3%）

**结论**: NATS 在低压力下延迟更低，但在高压力下延迟急剧增长，Kafka 延迟保持稳定。

---

## 💡 关键发现

### 1. 内存持久化模式下的性能差异

**Kafka 优势**:
- ✅ 吞吐量随压力线性增长（最高 6881.54 msg/s）
- ✅ 延迟保持稳定（200 ms 左右）
- ✅ 内存增量更低（平均 1.18 MB）

**NATS 劣势**:
- ⚠️ 吞吐量增长缓慢（最高 1884.76 msg/s）
- ⚠️ 延迟在高压力下急剧增长（最高 1054.397 ms）
- ⚠️ 内存增量更高（平均 2.43 MB）

### 2. 与 Envelope 模式对比

**Envelope 模式**（之前的测试）:
- Kafka 平均吞吐量: 166.52 msg/s
- NATS 平均吞吐量: 163.04 msg/s
- 差异: +2.13%

**内存持久化模式**（本次测试）:
- Kafka 平均吞吐量: 3326.77 msg/s
- NATS 平均吞吐量: 1319.68 msg/s
- 差异: **+152.1%**

**结论**: 在内存持久化模式下，Kafka 的吞吐量优势远超 Envelope 模式。

### 3. Hollywood Actor Pool 的影响

**NATS + Hollywood Actor Pool**:
- ✅ 低压力下延迟优秀（87.658 ms）
- ⚠️ 高压力下延迟劣化严重（1054.397 ms）
- ⚠️ 吞吐量增长受限

**可能原因**:
1. Actor Pool 在无聚合ID场景下可能不是最优选择
2. 内存持久化模式下，NATS 的性能瓶颈更明显
3. 需要进一步优化 Actor Pool 的配置或实现

---

## 💡 使用建议

### 🔴 选择 Kafka 当:

1. ✅ 需要高吞吐量（>2000 msg/s）
2. ✅ 需要稳定的延迟（不随压力增长）
3. ✅ 需要更低的内存占用
4. ✅ 需要在高压力下保持性能
5. ✅ **使用内存持久化模式**

### 🔵 选择 NATS JetStream 当:

1. ✅ 需要极低的延迟（在低压力下）
2. ✅ 压力负载相对稳定且不高（<1000 msg/s）
3. ✅ 需要简单的部署和运维
4. ✅ 构建实时应用和微服务
5. ⚠️ **注意**: 在内存持久化模式下，NATS 性能可能不如 Envelope 模式

---

## 🎯 关键洞察

### 1. 内存持久化 vs Envelope 模式

| 模式 | Kafka 吞吐量 | NATS 吞吐量 | Kafka 优势 |
|------|-------------|------------|-----------|
| **Envelope 模式** | 166.52 msg/s | 163.04 msg/s | +2.13% |
| **内存持久化模式** | 3326.77 msg/s | 1319.68 msg/s | **+152.1%** |

**结论**: 
- Kafka 在内存持久化模式下性能提升 **20 倍**
- NATS 在内存持久化模式下性能提升 **8 倍**
- Kafka 在内存持久化模式下的优势更明显

### 2. 协程泄漏问题

| 系统 | 协程泄漏 | 状态 |
|------|---------|------|
| **Kafka** | 133 | ⚠️ 需要修复 |
| **NATS** | 12 | ⚠️ 需要修复 |

**建议**: 两个系统都需要修复协程泄漏问题。

### 3. 性能瓶颈分析

**NATS 在高压力下的性能瓶颈**:
1. 吞吐量增长受限（最高 1884.76 msg/s）
2. 延迟急剧增长（最高 1054.397 ms）
3. 可能的原因：
   - Actor Pool 配置不适合无聚合ID场景
   - JetStream 内部处理机制的限制
   - 内存持久化模式下的性能瓶颈

**建议优化方向**:
1. 优化 Actor Pool 配置
2. 考虑在无聚合ID场景下使用不同的处理策略
3. 分析 JetStream 的性能瓶颈

---

## ✅ 测试结论

### 功能正确性

1. ✅ **成功率**: 所有测试场景成功率 100%
2. ✅ **消息完整性**: 所有消息都被正确接收
3. ✅ **资源清理**: 内存和协程资源正常释放（除协程泄漏）

### 性能表现

1. ✅ **Kafka 吞吐量**: 远超 NATS（+152.1%）
2. ✅ **Kafka 延迟**: 在高压力下远优于 NATS（-408.3%）
3. ⚠️ **NATS 延迟**: 在低压力下优于 Kafka（-36.5%）
4. ⚠️ **NATS 吞吐量**: 在高压力下增长受限

### 总体评价

**内存持久化模式下，Kafka 性能远超 NATS！**

- ✅ Kafka 吞吐量优势: +152.1%
- ✅ Kafka 延迟优势: -173.6%（平均）
- ⚠️ NATS 内存效率: -106.0%
- ⚠️ 协程泄漏问题: 两个系统都需要修复

**建议**:
1. 在高吞吐量场景下优先选择 Kafka
2. 在低延迟、低压力场景下可以选择 NATS
3. 修复协程泄漏问题
4. 优化 NATS 在高压力下的性能表现

---

## 📝 附录

### 测试环境

- **Go 版本**: Go 1.x
- **Kafka 版本**: 本地 Kafka 集群
- **NATS 版本**: 本地 NATS JetStream 服务器（端口 4223）
- **测试机器**: Windows 系统

### 测试配置

- **Worker Pool Size**: 256
- **Topic 数量**: 5
- **Kafka Partition 数量**: 3（每个 topic）
- **持久化模式**: 内存持久化

### 测试数据

- **Low**: 1000 条消息
- **Medium**: 4000 条消息
- **High**: 6000 条消息
- **Extreme**: 10000 条消息

---

**报告生成时间**: 2025-10-29  
**测试执行时间**: 163.51 秒  
**测试状态**: ✅ PASS

