# EventBus + NATS JetStream 全面压力测试结果报告

**测试日期**: 2025-10-12  
**测试环境**: NATS JetStream on localhost:4223  
**持久化配置**: 磁盘持久化 (`Storage: "file"`)  
**架构**: 统一JetStream架构（1个EventBus, 1个连接, 1个JetStream Context, 1个Consumer）

---

## 📊 测试结果总览

| 压力级别 | 消息数 | 并发数 | 消息大小 | 成功率 | 吞吐量 | 发送速率 | 首条延迟 | 发送耗时 | 总耗时 | 内存增量 | Goroutine增量 |
|---------|--------|--------|----------|--------|--------|----------|----------|----------|--------|----------|---------------|
| **低压** | 500 | 5 | 1KB | **100.00%** | **137.23 msg/s** | 137.29 msg/s | 40.42ms | 3.64s | 3.64s | 12.60MB | 1025 |
| **中压** | 2,000 | 10 | 2KB | **100.00%** | **194.82 msg/s** | 194.83 msg/s | 20.55ms | 10.27s | 10.27s | 10.94MB | 1026 |
| **高压** | 5,000 | 20 | 4KB | **100.00%** | **239.23 msg/s** | 239.24 msg/s | 11.58ms | 20.90s | 20.90s | 16.18MB | 1025 |
| **极限** | 10,000 | 50 | 8KB | **100.00%** | **242.92 msg/s** | 242.93 msg/s | 18.82ms | 41.16s | 41.17s | 9.47MB | 1025 |

---

## 🎯 关键性能指标

### 1. 成功率
- ✅ **所有压力级别均达到100%成功率**
- ✅ 无消息丢失
- ✅ 无发送错误

### 2. 吞吐量
- 🏆 **最高吞吐量**: 242.92 msg/s（极限压力）
- 📈 **吞吐量增长**: 77% (低压 → 极限)
- ⚠️ **扩展性**: 吞吐量增长较慢，从137.23增长到242.92

### 3. 延迟
- ⚡ **首条消息延迟**: 11.58ms - 40.42ms
- ✅ **延迟极低**: 所有压力级别延迟都在50ms以内
- 🏆 **最低延迟**: 11.58ms（高压场景）

### 4. 资源使用
- 💾 **内存增量**: 9.47MB - 16.18MB
- 🔄 **Goroutine增量**: 1025-1026（所有压力级别基本一致）
- ⚠️ **资源占用**: 相对较高，每个测试约1000个Goroutine

---

## 🚀 配置详情

### 1. NATS JetStream配置

```go
JetStream: JetStreamConfig{
    Enabled:        true,
    PublishTimeout: 10 * time.Second,
    AckWait:        15 * time.Second,
    MaxDeliver:     3,
    Stream: StreamConfig{
        Name:      "PRESSURE_STREAM_*",
        Subjects:  []string{"pressure.*.*"},
        Retention: "limits",
        Storage:   "file",              // 磁盘持久化
        Replicas:  1,
        MaxAge:    30 * time.Minute,
        MaxBytes:  512 * 1024 * 1024,   // 512MB
        MaxMsgs:   100000,
        Discard:   "old",
    },
    Consumer: NATSConsumerConfig{
        DurableName:   "pressure_consumer_*",
        DeliverPolicy: "all",
        AckPolicy:     "explicit",
        ReplayPolicy:  "instant",
        MaxAckPending: 500,
        MaxWaiting:    200,
        MaxDeliver:    3,
    },
}
```

**关键配置说明**:
- ✅ **磁盘持久化**: `Storage: "file"` 确保消息持久化到磁盘
- ✅ **Durable Consumer**: 使用持久化Consumer，重启后可恢复
- ✅ **Explicit Ack**: 显式确认，确保消息不丢失
- ✅ **Replay Policy**: "instant" 立即重放消息

### 2. 统一架构

```
1个EventBus实例
    ↓
1个NATS连接
    ↓
1个JetStream Context
    ↓
1个Consumer (Durable)
    ↓
多个Pull Subscription (每个topic一个)
```

**优势**:
- ✅ 资源占用稳定（Goroutine数量固定）
- ✅ 连接复用，减少网络开销
- ✅ 统一管理，易于维护

---

## 📈 性能趋势分析

### 吞吐量 vs 消息数量
```
低压 (500条):    137.23 msg/s
中压 (2000条):   194.82 msg/s  (+42%)
高压 (5000条):   239.23 msg/s  (+74%)
极限 (10000条):  242.92 msg/s  (+77%)
```

**观察**:
- 吞吐量随消息数量增长，但增长速度逐渐放缓
- 从高压到极限，吞吐量几乎没有增长（239.23 → 242.92）
- 说明NATS JetStream在高负载下存在性能瓶颈

### 延迟 vs 消息数量
```
低压 (500条):    40.42ms
中压 (2000条):   20.55ms  (-49%)
高压 (5000条):   11.58ms  (-71%)
极限 (10000条):  18.82ms  (-53%)
```

**观察**:
- 延迟随消息数量增加而降低（批处理效应）
- 高压场景延迟最低（11.58ms）
- 极限场景延迟略有上升（18.82ms）

### 内存使用 vs 消息数量
```
低压 (500条):    12.60MB
中压 (2000条):   10.94MB  (-13%)
高压 (5000条):   16.18MB  (+28%)
极限 (10000条):  9.47MB   (-25%)
```

**观察**:
- 内存使用波动较大，没有明显的线性关系
- 可能受GC影响
- 平均内存使用约12MB

---

## 🎓 结论

### ✅ 测试通过
- **所有4个压力级别测试100%通过**
- **成功率100%，无消息丢失**
- **延迟极低，所有场景都在50ms以内**

### 🏆 性能优秀
- **最高吞吐量**: 242.92 msg/s（极限压力）
- **最低延迟**: 11.58ms（高压场景）
- **稳定性好**: 所有场景成功率100%

### ⚠️ 性能瓶颈
- **扩展性较差**: 吞吐量增长缓慢（77%）
- **资源占用高**: 每个测试约1000个Goroutine，内存约10-16MB
- **高负载瓶颈**: 从高压到极限，吞吐量几乎没有增长

### 🚀 适用场景
- ✅ **低延迟场景**: 延迟极低（11-40ms），适合实时性要求高的场景
- ✅ **低负载场景**: 在低压场景下性能优秀（137.23 msg/s）
- ⚠️ **高负载场景**: 吞吐量有限（242.92 msg/s），不适合高吞吐量场景
- ⚠️ **资源受限场景**: Goroutine和内存占用较高，不适合资源受限环境

---

## 📊 与Kafka对比

| 指标 | NATS JetStream | Kafka | NATS优势 |
|------|---------------|-------|----------|
| **成功率** | 100% | 100% | 平手 ⚪ |
| **极限吞吐量** | 242.92 msg/s | 995.65 msg/s | **Kafka快4.1倍** ❌ |
| **低压吞吐量** | 137.23 msg/s | 49.98 msg/s | **NATS快2.75倍** ✅ |
| **延迟** | 11.58-40.42ms | 498ms-1.01s | **NATS快24-86倍** ✅ |
| **内存使用** | 9.47-16.18MB | 1.48-4.56MB | **Kafka省2-8倍** ❌ |
| **Goroutine** | 1025 | 83 | **Kafka省12倍** ❌ |
| **扩展性** | 77% | 1892% | **Kafka好24倍** ❌ |

**结论**: 
- ✅ **NATS优势**: 延迟极低，低压场景吞吐量高
- ❌ **NATS劣势**: 高负载吞吐量低，资源占用高，扩展性差

---

## 📚 参考文档

1. **测试代码**: `sdk/pkg/eventbus/nats_comprehensive_pressure_test.go`
2. **测试日志**: `nats_comprehensive_full_test.log`
3. **对比报告**: `KAFKA_VS_NATS_COMPREHENSIVE_COMPARISON.md`
4. **可视化图表**: `PERFORMANCE_COMPARISON_CHARTS.md`

---

## 🔍 技术细节

### 为什么NATS延迟这么低？

1. **同步发送**: NATS使用同步发送，消息立即发送到服务器
2. **无批处理**: 不像Kafka有10ms的linger时间
3. **轻量级协议**: NATS协议简单，开销小

### 为什么NATS吞吐量增长缓慢？

1. **同步发送**: 每条消息都要等待ACK，限制了吞吐量
2. **单线程发送**: 测试使用单线程发送，无法充分利用并发
3. **Pull Subscription**: 每个Pull操作都有网络往返开销

### 为什么NATS资源占用高？

1. **Pull Subscription**: 每个topic创建独立的Pull Subscription
2. **Goroutine**: 每个Pull Subscription创建多个goroutine（约1000个）
3. **缓冲区**: 每个Subscription都有独立的消息缓冲区

---

**测试完成时间**: 2025-10-12 09:50:09  
**总测试时长**: 116.41秒  
**测试状态**: ✅ PASS (100%成功率)

