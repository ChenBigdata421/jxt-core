=== RUN   TestE2E_MemoryEventBus_WithEnvelope
--- PASS: TestE2E_MemoryEventBus_WithEnvelope (1.21s)
=== RUN   TestE2E_MemoryEventBus_MultipleTopics
--- PASS: TestE2E_MemoryEventBus_MultipleTopics (0.60s)
=== RUN   TestE2E_MemoryEventBus_ConcurrentPublishSubscribe
--- PASS: TestE2E_MemoryEventBus_ConcurrentPublishSubscribe (2.10s)
=== RUN   TestE2E_MemoryEventBus_ErrorRecovery
--- PASS: TestE2E_MemoryEventBus_ErrorRecovery (0.60s)
=== RUN   TestE2E_MemoryEventBus_ContextCancellation
--- PASS: TestE2E_MemoryEventBus_ContextCancellation (0.30s)
=== RUN   TestE2E_MemoryEventBus_Metrics
--- PASS: TestE2E_MemoryEventBus_Metrics (0.60s)
=== RUN   TestMarshalToString
--- PASS: TestMarshalToString (0.00s)
=== RUN   TestUnmarshalFromString
--- PASS: TestUnmarshalFromString (0.00s)
=== RUN   TestMarshal
--- PASS: TestMarshal (0.00s)
=== RUN   TestUnmarshal
--- PASS: TestUnmarshal (0.00s)
=== RUN   TestMarshalFast
--- PASS: TestMarshalFast (0.00s)
=== RUN   TestUnmarshalFast
--- PASS: TestUnmarshalFast (0.00s)
=== RUN   TestJSON_RoundTrip
--- PASS: TestJSON_RoundTrip (0.00s)
=== RUN   TestJSONFast_RoundTrip
--- PASS: TestJSONFast_RoundTrip (0.00s)
=== RUN   TestMarshalToString_Error
--- PASS: TestMarshalToString_Error (0.00s)
=== RUN   TestUnmarshalFromString_Error
--- PASS: TestUnmarshalFromString_Error (0.00s)
=== RUN   TestMarshal_Struct
--- PASS: TestMarshal_Struct (0.00s)
=== RUN   TestUnmarshal_Struct
--- PASS: TestUnmarshal_Struct (0.00s)
=== RUN   TestJSON_Variables
--- PASS: TestJSON_Variables (0.00s)
=== RUN   TestRawMessage
--- PASS: TestRawMessage (0.00s)
=== RUN   TestMarshalToString_EmptyObject
--- PASS: TestMarshalToString_EmptyObject (0.00s)
=== RUN   TestUnmarshalFromString_EmptyObject
--- PASS: TestUnmarshalFromString_EmptyObject (0.00s)
=== RUN   TestMarshal_Array
--- PASS: TestMarshal_Array (0.00s)
=== RUN   TestUnmarshal_Array
--- PASS: TestUnmarshal_Array (0.00s)
=== RUN   TestKafkaBasicPublishSubscribe
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.basic.1760445690717
    kafka_nats_test.go:38: 📨 Received message: Hello Kafka!
    kafka_nats_test.go:56: ✅ Kafka basic publish/subscribe test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.basic.1760445690717
--- PASS: TestKafkaBasicPublishSubscribe (10.52s)
=== RUN   TestNATSBasicPublishSubscribe
    kafka_nats_test.go:78: 📨 Received message: Hello NATS!
    kafka_nats_test.go:96: ✅ NATS basic publish/subscribe test passed
--- PASS: TestNATSBasicPublishSubscribe (3.11s)
=== RUN   TestKafkaMultipleMessages
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.multiple.1760445704349
    kafka_nats_test.go:137: ✅ Kafka multiple messages test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.multiple.1760445704349
--- PASS: TestKafkaMultipleMessages (10.44s)
=== RUN   TestNATSMultipleMessages
    kafka_nats_test.go:178: ✅ NATS multiple messages test passed
--- PASS: TestNATSMultipleMessages (3.11s)
=== RUN   TestKafkaPublishWithOptions
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.options.1760445717896
    kafka_nats_test.go:222: ✅ Kafka PublishWithOptions test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.options.1760445717896
--- PASS: TestKafkaPublishWithOptions (10.55s)
=== RUN   TestNATSPublishWithOptions
    kafka_nats_test.go:265: ✅ NATS PublishWithOptions test passed
--- PASS: TestNATSPublishWithOptions (3.11s)
=== RUN   TestKafkaEnvelopePublishSubscribe
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.envelope.1760445731560
    kafka_nats_test.go:291: 📨 Received envelope: AggregateID=test-aggregate-1, EventType=TestEvent, Version=1
    kafka_nats_test.go:319: ✅ Kafka Envelope publish/subscribe test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.envelope.1760445731560
--- PASS: TestKafkaEnvelopePublishSubscribe (10.51s)
=== RUN   TestNATSEnvelopePublishSubscribe
    kafka_nats_test.go:342: 📨 Received envelope: AggregateID=test-aggregate-1, EventType=TestEvent, Version=1
    kafka_nats_test.go:370: ✅ NATS Envelope publish/subscribe test passed
--- PASS: TestNATSEnvelopePublishSubscribe (4.12s)
=== RUN   TestKafkaEnvelopeOrdering
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.envelope.order.1760445746188
    kafka_nats_test.go:435: ✅ Kafka Envelope ordering test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.envelope.order.1760445746188
--- PASS: TestKafkaEnvelopeOrdering (10.49s)
=== RUN   TestNATSEnvelopeOrdering
    kafka_nats_test.go:501: ✅ NATS Envelope ordering test passed
--- PASS: TestNATSEnvelopeOrdering (4.11s)
=== RUN   TestKafkaMultipleAggregates
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.multi.agg.1760445760797
    kafka_nats_test.go:551: ✅ Kafka multiple aggregates test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.multi.agg.1760445760797
--- PASS: TestKafkaMultipleAggregates (10.50s)
=== RUN   TestKafkaClose
    kafka_nats_test.go:579: ✅ Kafka Close test passed
--- PASS: TestKafkaClose (0.01s)
=== RUN   TestNATSClose
    kafka_nats_test.go:600: ✅ NATS Close test passed
--- PASS: TestNATSClose (0.00s)
=== RUN   TestKafkaPublishCallback
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.pub.callback.1760445771315
    kafka_nats_test.go:618: 📞 Publish callback called: Topic=test.kafka.pub.callback.1760445771315, Error=<nil>
    kafka_nats_test.go:632: ✅ Kafka RegisterPublishCallback test passed (callback called: true)
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.pub.callback.1760445771315
--- PASS: TestKafkaPublishCallback (7.23s)
=== RUN   TestKafkaTopicConfiguration
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.topic.config.1760445778543
    kafka_nats_test.go:679: ✅ Kafka topic configuration test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.topic.config.1760445778543
--- PASS: TestKafkaTopicConfiguration (5.24s)
=== RUN   TestNATSTopicConfiguration
    kafka_nats_test.go:723: ✅ NATS topic configuration test passed
--- PASS: TestNATSTopicConfiguration (2.01s)
=== RUN   TestKafkaSetTopicPersistence
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.persistence.1760445785798
    kafka_nats_test.go:748: ✅ Kafka SetTopicPersistence test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.persistence.1760445785798
--- PASS: TestKafkaSetTopicPersistence (5.24s)
=== RUN   TestNATSSetTopicPersistence
    kafka_nats_test.go:774: ✅ NATS SetTopicPersistence test passed
--- PASS: TestNATSSetTopicPersistence (2.01s)
=== RUN   TestKafkaRemoveTopicConfig
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.remove.config.1760445793046
    kafka_nats_test.go:812: ✅ Kafka RemoveTopicConfig test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.remove.config.1760445793046
--- PASS: TestKafkaRemoveTopicConfig (5.12s)
=== RUN   TestNATSRemoveTopicConfig
    kafka_nats_test.go:851: ✅ NATS RemoveTopicConfig test passed
--- PASS: TestNATSRemoveTopicConfig (2.01s)
=== RUN   TestKafkaStartupTopicConfiguration
    test_helper.go:330: ✅ Created Kafka topic: business.orders.1760445800183
    test_helper.go:330: ✅ Created Kafka topic: system.notifications.1760445800183
    test_helper.go:330: ✅ Created Kafka topic: audit.logs.1760445800183
    kafka_nats_test.go:907: ✅ Configured topic: system.notifications.1760445800183
    kafka_nats_test.go:907: ✅ Configured topic: audit.logs.1760445800183
    kafka_nats_test.go:907: ✅ Configured topic: business.orders.1760445800183
    kafka_nats_test.go:924: ✅ Kafka startup topic configuration test passed (configured 3 topics)
    test_helper.go:213: ✅ Deleted Kafka topic: business.orders.1760445800183
    test_helper.go:213: ✅ Deleted Kafka topic: system.notifications.1760445800183
    test_helper.go:213: ✅ Deleted Kafka topic: audit.logs.1760445800183
--- PASS: TestKafkaStartupTopicConfiguration (5.63s)
=== RUN   TestKafkaIdempotentTopicConfiguration
    test_helper.go:330: ✅ Created Kafka topic: test.kafka.idempotent.1760445805817
    kafka_nats_test.go:966: ✅ Kafka idempotent topic configuration test passed
    test_helper.go:213: ✅ Deleted Kafka topic: test.kafka.idempotent.1760445805817
--- PASS: TestKafkaIdempotentTopicConfiguration (5.23s)
=== RUN   TestNATSStartupTopicConfiguration
    kafka_nats_test.go:1000: ✅ Configured topic: system.notifications.1760445811050 (mode: ephemeral)
    kafka_nats_test.go:1000: ✅ Configured topic: business.orders.1760445811050 (mode: persistent)
    kafka_nats_test.go:1007: ✅ NATS startup topic configuration test passed (configured 2 topics)
--- PASS: TestNATSStartupTopicConfiguration (1.01s)
=== RUN   TestKafkaTopicConfigStrategy
    kafka_nats_test.go:1030: ✅ Kafka topic config strategy test passed
--- PASS: TestKafkaTopicConfigStrategy (1.01s)
=== RUN   TestNATSTopicConfigStrategy
    kafka_nats_test.go:1054: ✅ NATS topic config strategy test passed
--- PASS: TestNATSTopicConfigStrategy (1.01s)
=== RUN   TestKafkaSubscriberBacklogMonitoring
    monitoring_test.go:48: ✅ Kafka subscriber backlog monitoring test passed (callback called: false)
--- PASS: TestKafkaSubscriberBacklogMonitoring (4.01s)
=== RUN   TestNATSSubscriberBacklogMonitoring
    monitoring_test.go:83: ✅ NATS subscriber backlog monitoring test passed (callback called: false)
--- PASS: TestNATSSubscriberBacklogMonitoring (4.01s)
=== RUN   TestKafkaPublisherBacklogMonitoring
    monitoring_test.go:117: ✅ Kafka publisher backlog monitoring test passed (callback called: false)
--- PASS: TestKafkaPublisherBacklogMonitoring (4.01s)
=== RUN   TestNATSPublisherBacklogMonitoring
    monitoring_test.go:152: ✅ NATS publisher backlog monitoring test passed (callback called: false)
--- PASS: TestNATSPublisherBacklogMonitoring (4.01s)
=== RUN   TestKafkaStartAllBacklogMonitoring
    monitoring_test.go:193: ✅ Kafka StartAllBacklogMonitoring test passed (sub: false, pub: false)
--- PASS: TestKafkaStartAllBacklogMonitoring (4.01s)
=== RUN   TestNATSStartAllBacklogMonitoring
    monitoring_test.go:236: ✅ NATS StartAllBacklogMonitoring test passed (sub: false, pub: false)
--- PASS: TestNATSStartAllBacklogMonitoring (4.01s)
=== RUN   TestKafkaSetMessageRouter
    monitoring_test.go:255: ✅ Kafka SetMessageRouter test passed
--- PASS: TestKafkaSetMessageRouter (1.01s)
=== RUN   TestNATSSetMessageRouter
    monitoring_test.go:274: ✅ NATS SetMessageRouter test passed
--- PASS: TestNATSSetMessageRouter (1.01s)
=== RUN   TestKafkaSetErrorHandler
    monitoring_test.go:302: ✅ Kafka SetErrorHandler test passed
--- PASS: TestKafkaSetErrorHandler (1.00s)
=== RUN   TestKafkaHealthCheckPublisher
    monitoring_test.go:337: 📊 Health check publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 20:44:01.1709503 +0800 CST m=+155.884063601 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:kafka Source:kafka-eventbus}
    monitoring_test.go:343: ✅ Kafka health check publisher test passed
--- PASS: TestKafkaHealthCheckPublisher (4.02s)
=== RUN   TestNATSHealthCheckPublisher
    monitoring_test.go:366: 📊 Health check publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 20:44:05.1840284 +0800 CST m=+159.897141701 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:nats Source:nats-eventbus}
    monitoring_test.go:372: ✅ NATS health check publisher test passed
--- PASS: TestNATSHealthCheckPublisher (4.01s)
=== RUN   TestKafkaHealthCheckSubscriber
    monitoring_test.go:394: 📊 Health check subscriber stats: {StartTime:2025-10-14 20:44:09.1914346 +0800 CST m=+163.904547901 LastMessageTime:2025-10-14 20:44:09.4178494 +0800 CST m=+164.130962701 TotalMessagesReceived:1 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:6.0009432}
    monitoring_test.go:400: ✅ Kafka health check subscriber test passed
--- PASS: TestKafkaHealthCheckSubscriber (7.09s)
=== RUN   TestNATSHealthCheckSubscriber
    monitoring_test.go:423: 📊 Health check subscriber stats: {StartTime:2025-10-14 20:44:16.3021581 +0800 CST m=+171.015271401 LastMessageTime:0001-01-01 00:00:00 +0000 UTC TotalMessagesReceived:0 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:false UptimeSeconds:3.000307}
    monitoring_test.go:429: ✅ NATS health check subscriber test passed
--- PASS: TestNATSHealthCheckSubscriber (4.03s)
=== RUN   TestKafkaStartAllHealthCheck
    monitoring_test.go:452: 📊 Publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 20:44:20.3107632 +0800 CST m=+175.023876501 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:kafka Source:kafka-eventbus}
    monitoring_test.go:453: 📊 Subscriber stats: {StartTime:2025-10-14 20:44:20.3107632 +0800 CST m=+175.023876501 LastMessageTime:2025-10-14 20:44:20.5272445 +0800 CST m=+175.240357801 TotalMessagesReceived:2 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:6.0006256}
    monitoring_test.go:459: ✅ Kafka StartAllHealthCheck test passed
--- PASS: TestKafkaStartAllHealthCheck (7.08s)
=== RUN   TestNATSStartAllHealthCheck
    monitoring_test.go:483: 📊 Publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 20:44:27.393008 +0800 CST m=+182.106121301 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:nats Source:nats-eventbus}
    monitoring_test.go:484: 📊 Subscriber stats: {StartTime:2025-10-14 20:44:27.393008 +0800 CST m=+182.106121301 LastMessageTime:2025-10-14 20:44:27.3940716 +0800 CST m=+182.107184901 TotalMessagesReceived:1 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:3.000533}
    monitoring_test.go:490: ✅ NATS StartAllHealthCheck test passed
--- PASS: TestNATSStartAllHealthCheck (4.01s)
=== RUN   TestKafkaHealthCheckPublisherCallback
    monitoring_test.go:511: 📞 Health check publisher callback called: {Success:true Timestamp:2025-10-14 20:44:31.4025447 +0800 CST m=+186.115658001 Duration:0s Error:<nil> ConsecutiveFailures:0 EventBusType:kafka Source:kafka-eventbus}
    monitoring_test.go:523: ✅ Kafka health check publisher callback test passed (callback called: true)
--- PASS: TestKafkaHealthCheckPublisherCallback (4.01s)
=== RUN   TestNATSHealthCheckPublisherCallback
    monitoring_test.go:545: 📞 Health check publisher callback called: {Success:true Timestamp:2025-10-14 20:44:35.4152194 +0800 CST m=+190.128332701 Duration:0s Error:<nil> ConsecutiveFailures:0 EventBusType:nats Source:nats-eventbus}
    monitoring_test.go:557: ✅ NATS health check publisher callback test passed (callback called: true)
--- PASS: TestNATSHealthCheckPublisherCallback (4.01s)
=== RUN   TestKafkaHealthCheckSubscriberCallback
    monitoring_test.go:590: ✅ Kafka health check subscriber callback test passed (callback called: false)
--- PASS: TestKafkaHealthCheckSubscriberCallback (10.05s)
=== RUN   TestKafkaHealthCheckPublisherSubscriberIntegration
    monitoring_test.go:637: 🚀 A 端：启动健康检查发布器（间隔：10秒）
    monitoring_test.go:642: 🚀 B 端：启动健康检查订阅器
    monitoring_test.go:648: ⏳ 等待健康检查消息发送和接收（1分钟）...
    monitoring_test.go:649: ✅ EventBus 现在使用自定义健康检查配置（间隔：10秒）
    monitoring_test.go:654: 📊 A 端发布器状态: IsHealthy=true, ConsecutiveFailures=0, LastSuccessTime=2025-10-14 20:45:49.4824542 +0800 CST m=+264.195567501
    monitoring_test.go:676: 📊 B 端订阅器统计: TotalMessagesReceived=10, ConsecutiveMisses=0, IsHealthy=true, LastMessageTime=2025-10-14 20:45:49.5246563 +0800 CST m=+264.237769601
    monitoring_test.go:697: ⚠️  B 端订阅器在 1 分钟内接收到 10 条消息，超过预期的 8 条
    monitoring_test.go:708: 🛑 停止 A 端健康检查发布器
    monitoring_test.go:713: 🛑 停止 B 端健康检查订阅器
    monitoring_test.go:717: ✅ Kafka 健康检查发布端和订阅端集成测试通过
    monitoring_test.go:718:    - A 端成功发送健康检查消息（自定义间隔：10秒）
    monitoring_test.go:719:    - B 端成功接收 10 条健康检查消息（测试时长：1分钟）
--- PASS: TestKafkaHealthCheckPublisherSubscriberIntegration (65.03s)
=== RUN   TestNATSHealthCheckPublisherSubscriberIntegration
    monitoring_test.go:765: 🚀 B 端：先启动健康检查订阅器（NATS Core 需要先订阅）
    monitoring_test.go:773: 🚀 A 端：再启动健康检查发布器
    monitoring_test.go:779: ⏳ 等待健康检查消息发送和接收（1分钟）...
    monitoring_test.go:780: ✅ EventBus 现在使用自定义健康检查配置（间隔：10秒）
    monitoring_test.go:785: 📊 A 端发布器状态: IsHealthy=true, ConsecutiveFailures=0, LastSuccessTime=2025-10-14 20:46:45.5140849 +0800 CST m=+320.227198201
    monitoring_test.go:807: 📊 B 端订阅器统计: TotalMessagesReceived=6, ConsecutiveMisses=0, IsHealthy=true, LastMessageTime=2025-10-14 20:46:45.5152931 +0800 CST m=+320.228406401
    monitoring_test.go:830: ✅ B 端订阅器在 1 分钟内接收到 6 条消息，符合预期（5-8 条）
    monitoring_test.go:839: 🛑 停止 A 端健康检查发布器
    monitoring_test.go:844: 🛑 停止 B 端健康检查订阅器
    monitoring_test.go:848: ✅ NATS 健康检查发布端和订阅端集成测试通过
    monitoring_test.go:849:    - A 端成功发送健康检查消息（自定义间隔：10秒）
    monitoring_test.go:850:    - B 端成功接收 6 条健康检查消息（测试时长：1分钟）
--- PASS: TestNATSHealthCheckPublisherSubscriberIntegration (63.02s)
PASS
ok  	github.com/ChenBigdata421/jxt-core/tests/eventbus/function_tests	332.479s
