=== RUN   TestKafkaSubscriberBacklogMonitoring
    backlog_test.go:43: ✅ Kafka subscriber backlog monitoring test passed (callback called: false)
--- PASS: TestKafkaSubscriberBacklogMonitoring (4.03s)
=== RUN   TestNATSSubscriberBacklogMonitoring
    backlog_test.go:78: ✅ NATS subscriber backlog monitoring test passed (callback called: false)
--- PASS: TestNATSSubscriberBacklogMonitoring (4.01s)
=== RUN   TestKafkaPublisherBacklogMonitoring
    backlog_test.go:112: ✅ Kafka publisher backlog monitoring test passed (callback called: false)
--- PASS: TestKafkaPublisherBacklogMonitoring (4.02s)
=== RUN   TestNATSPublisherBacklogMonitoring
    backlog_test.go:147: ✅ NATS publisher backlog monitoring test passed (callback called: false)
--- PASS: TestNATSPublisherBacklogMonitoring (4.01s)
=== RUN   TestKafkaStartAllBacklogMonitoring
    backlog_test.go:188: ✅ Kafka StartAllBacklogMonitoring test passed (sub: false, pub: false)
--- PASS: TestKafkaStartAllBacklogMonitoring (4.01s)
=== RUN   TestNATSStartAllBacklogMonitoring
    backlog_test.go:231: ✅ NATS StartAllBacklogMonitoring test passed (sub: false, pub: false)
--- PASS: TestNATSStartAllBacklogMonitoring (4.01s)
=== RUN   TestKafkaSetMessageRouter
    backlog_test.go:250: ✅ Kafka SetMessageRouter test passed
--- PASS: TestKafkaSetMessageRouter (1.01s)
=== RUN   TestNATSSetMessageRouter
    backlog_test.go:269: ✅ NATS SetMessageRouter test passed
--- PASS: TestNATSSetMessageRouter (1.01s)
=== RUN   TestKafkaSetErrorHandler
    backlog_test.go:297: ✅ Kafka SetErrorHandler test passed
--- PASS: TestKafkaSetErrorHandler (1.01s)
=== RUN   TestKafkaBasicPublishSubscribe
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.basic.1760423627146
    basic_test.go:34: 📨 Received message: Hello Kafka!
    basic_test.go:53: ✅ Kafka basic publish/subscribe test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.basic.1760423627146
--- PASS: TestKafkaBasicPublishSubscribe (10.47s)
=== RUN   TestNATSBasicPublishSubscribe
    basic_test.go:80: 📨 Received message: Hello NATS!
    basic_test.go:99: ✅ NATS basic publish/subscribe test passed
--- PASS: TestNATSBasicPublishSubscribe (4.12s)
=== RUN   TestKafkaMultipleMessages
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.multiple.1760423641738
    basic_test.go:137: ✅ Kafka multiple messages test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.multiple.1760423641738
--- PASS: TestKafkaMultipleMessages (10.49s)
=== RUN   TestNATSMultipleMessages
    basic_test.go:176: ✅ NATS multiple messages test passed
--- PASS: TestNATSMultipleMessages (4.12s)
=== RUN   TestKafkaPublishWithOptions
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.options.1760423656345
    basic_test.go:215: ✅ Kafka PublishWithOptions test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.options.1760423656345
--- PASS: TestKafkaPublishWithOptions (10.50s)
=== RUN   TestNATSPublishWithOptions
    basic_test.go:255: ✅ NATS PublishWithOptions test passed
--- PASS: TestNATSPublishWithOptions (4.12s)
=== RUN   TestKafkaEnvelopePublishSubscribe
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.envelope.1760423670962
    envelope_test.go:33: 📨 Received envelope: AggregateID=test-aggregate-1, EventType=TestEvent, Version=1
    envelope_test.go:61: ✅ Kafka Envelope publish/subscribe test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.envelope.1760423670962
--- PASS: TestKafkaEnvelopePublishSubscribe (10.49s)
=== RUN   TestNATSEnvelopePublishSubscribe
    envelope_test.go:84: 📨 Received envelope: AggregateID=test-aggregate-1, EventType=TestEvent, Version=1
    envelope_test.go:112: ✅ NATS Envelope publish/subscribe test passed
--- PASS: TestNATSEnvelopePublishSubscribe (4.12s)
=== RUN   TestKafkaEnvelopeOrdering
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.envelope.order.1760423685573
    envelope_test.go:177: ✅ Kafka Envelope ordering test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.envelope.order.1760423685573
--- PASS: TestKafkaEnvelopeOrdering (10.40s)
=== RUN   TestNATSEnvelopeOrdering
    envelope_test.go:243: ✅ NATS Envelope ordering test passed
--- PASS: TestNATSEnvelopeOrdering (4.12s)
=== RUN   TestKafkaMultipleAggregates
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.multi.agg.1760423700093
    envelope_test.go:293: ✅ Kafka multiple aggregates test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.multi.agg.1760423700093
--- PASS: TestKafkaMultipleAggregates (10.50s)
=== RUN   TestKafkaHealthCheckPublisher
    healthcheck_test.go:31: 📊 Health check publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 14:35:10.604479 +0800 CST m=+110.590895801 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:kafka Source:kafka-eventbus}
    healthcheck_test.go:37: ✅ Kafka health check publisher test passed
--- PASS: TestKafkaHealthCheckPublisher (4.01s)
=== RUN   TestNATSHealthCheckPublisher
    healthcheck_test.go:60: 📊 Health check publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 14:35:14.6098845 +0800 CST m=+114.596301301 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:nats Source:nats-eventbus}
    healthcheck_test.go:66: ✅ NATS health check publisher test passed
--- PASS: TestNATSHealthCheckPublisher (4.01s)
=== RUN   TestKafkaHealthCheckSubscriber
    healthcheck_test.go:88: 📊 Health check subscriber stats: {StartTime:2025-10-14 14:35:18.621796 +0800 CST m=+118.608212801 LastMessageTime:2025-10-14 14:35:18.8463125 +0800 CST m=+118.832729301 TotalMessagesReceived:2 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:6.0007382}
    healthcheck_test.go:94: ✅ Kafka health check subscriber test passed
--- PASS: TestKafkaHealthCheckSubscriber (7.09s)
=== RUN   TestNATSHealthCheckSubscriber
    healthcheck_test.go:117: 📊 Health check subscriber stats: {StartTime:2025-10-14 14:35:25.7101956 +0800 CST m=+125.696612401 LastMessageTime:0001-01-01 00:00:00 +0000 UTC TotalMessagesReceived:0 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:false UptimeSeconds:3.0007136}
    healthcheck_test.go:123: ✅ NATS health check subscriber test passed
--- PASS: TestNATSHealthCheckSubscriber (4.01s)
=== RUN   TestKafkaStartAllHealthCheck
    healthcheck_test.go:146: 📊 Publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 14:35:29.7199474 +0800 CST m=+129.706364201 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:kafka Source:kafka-eventbus}
    healthcheck_test.go:147: 📊 Subscriber stats: {StartTime:2025-10-14 14:35:29.7199474 +0800 CST m=+129.706364201 LastMessageTime:2025-10-14 14:35:29.9340652 +0800 CST m=+129.920482001 TotalMessagesReceived:3 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:6.000536}
    healthcheck_test.go:153: ✅ Kafka StartAllHealthCheck test passed
--- PASS: TestKafkaStartAllHealthCheck (7.09s)
=== RUN   TestNATSStartAllHealthCheck
    healthcheck_test.go:177: 📊 Publisher status: {IsHealthy:true ConsecutiveFailures:0 LastSuccessTime:2025-10-14 14:35:36.8109402 +0800 CST m=+136.797357001 LastFailureTime:0001-01-01 00:00:00 +0000 UTC IsRunning:true EventBusType:nats Source:nats-eventbus}
    healthcheck_test.go:178: 📊 Subscriber stats: {StartTime:2025-10-14 14:35:36.8109402 +0800 CST m=+136.797357001 LastMessageTime:2025-10-14 14:35:36.8120171 +0800 CST m=+136.798433901 TotalMessagesReceived:1 ConsecutiveMisses:0 TotalAlerts:0 LastAlertTime:0001-01-01 00:00:00 +0000 UTC IsHealthy:true UptimeSeconds:3.0002534}
    healthcheck_test.go:184: ✅ NATS StartAllHealthCheck test passed
--- PASS: TestNATSStartAllHealthCheck (4.01s)
=== RUN   TestKafkaHealthCheckPublisherCallback
    healthcheck_test.go:205: 📞 Health check publisher callback called: {Success:true Timestamp:2025-10-14 14:35:40.8197724 +0800 CST m=+140.806189201 Duration:539.5µs Error:<nil> ConsecutiveFailures:0 EventBusType:kafka Source:kafka-eventbus}
    healthcheck_test.go:217: ✅ Kafka health check publisher callback test passed (callback called: true)
--- PASS: TestKafkaHealthCheckPublisherCallback (4.01s)
=== RUN   TestNATSHealthCheckPublisherCallback
    healthcheck_test.go:239: 📞 Health check publisher callback called: {Success:true Timestamp:2025-10-14 14:35:44.8303832 +0800 CST m=+144.816800001 Duration:0s Error:<nil> ConsecutiveFailures:0 EventBusType:nats Source:nats-eventbus}
    healthcheck_test.go:251: ✅ NATS health check publisher callback test passed (callback called: true)
--- PASS: TestNATSHealthCheckPublisherCallback (4.01s)
=== RUN   TestKafkaHealthCheckSubscriberCallback
    healthcheck_test.go:284: ✅ Kafka health check subscriber callback test passed (callback called: false)
--- PASS: TestKafkaHealthCheckSubscriberCallback (10.08s)
=== RUN   TestKafkaHealthCheckPublisherSubscriberIntegration
    healthcheck_test.go:305: 🚀 A 端：启动健康检查发布器
    healthcheck_test.go:310: 🚀 B 端：启动健康检查订阅器
    healthcheck_test.go:316: ⏳ 等待健康检查消息发送和接收（5秒）...
    healthcheck_test.go:321: 📊 A 端发布器状态: IsHealthy=true, ConsecutiveFailures=0, LastSuccessTime=2025-10-14 14:35:58.9315297 +0800 CST m=+158.917946501
    healthcheck_test.go:343: 📊 B 端订阅器统计: TotalMessagesReceived=5, ConsecutiveMisses=0, IsHealthy=true, LastMessageTime=2025-10-14 14:35:59.1600631 +0800 CST m=+159.146479901
    healthcheck_test.go:363: ✅ B 端订阅器在 5 秒内接收到 5 条消息，符合预期
    healthcheck_test.go:372: 🛑 停止 A 端健康检查发布器
    healthcheck_test.go:377: 🛑 停止 B 端健康检查订阅器
    healthcheck_test.go:381: ✅ Kafka 健康检查发布端和订阅端集成测试通过
    healthcheck_test.go:382:    - A 端成功发送健康检查消息
    healthcheck_test.go:383:    - B 端成功接收 5 条健康检查消息
--- PASS: TestKafkaHealthCheckPublisherSubscriberIntegration (10.05s)
=== RUN   TestNATSHealthCheckPublisherSubscriberIntegration
    healthcheck_test.go:406: 🚀 A 端：启动健康检查发布器
    healthcheck_test.go:411: 🚀 B 端：启动健康检查订阅器
    healthcheck_test.go:417: ⏳ 等待健康检查消息发送和接收（5秒）...
    healthcheck_test.go:422: 📊 A 端发布器状态: IsHealthy=true, ConsecutiveFailures=0, LastSuccessTime=2025-10-14 14:36:08.9855019 +0800 CST m=+168.971918701
    healthcheck_test.go:444: 📊 B 端订阅器统计: TotalMessagesReceived=0, ConsecutiveMisses=0, IsHealthy=false, LastMessageTime=0001-01-01 00:00:00 +0000 UTC
    healthcheck_test.go:452: ❌ B 端订阅器应该接收到健康检查消息，但实际接收数量为 0
    healthcheck_test.go:462: ⚠️  B 端订阅器在 5 秒内只接收到 0 条消息，预期至少 3 条
    healthcheck_test.go:469: ❌ B 端订阅器应该接收过消息，但 LastMessageTime 为零值
    healthcheck_test.go:473: 🛑 停止 A 端健康检查发布器
    healthcheck_test.go:478: 🛑 停止 B 端健康检查订阅器
    healthcheck_test.go:482: ✅ NATS 健康检查发布端和订阅端集成测试通过
    healthcheck_test.go:483:    - A 端成功发送健康检查消息
    healthcheck_test.go:484:    - B 端成功接收 0 条健康检查消息
--- FAIL: TestNATSHealthCheckPublisherSubscriberIntegration (7.02s)
=== RUN   TestKafkaStartStop
    lifecycle_test.go:31: ✅ Kafka Start/Stop test passed
--- PASS: TestKafkaStartStop (2.01s)
=== RUN   TestNATSStartStop
    lifecycle_test.go:56: ✅ NATS Start/Stop test passed
--- PASS: TestNATSStartStop (2.01s)
=== RUN   TestKafkaGetConnectionState
    lifecycle_test.go:69: 📊 Connection state: {IsConnected:true LastConnectedTime:2025-10-14 14:36:20.0123531 +0800 CST m=+179.998769901 ReconnectCount:0 LastError:}
    lifecycle_test.go:74: ✅ Kafka GetConnectionState test passed
--- PASS: TestKafkaGetConnectionState (1.01s)
=== RUN   TestNATSGetConnectionState
    lifecycle_test.go:88: 📊 Connection state: {IsConnected:true LastConnectedTime:2025-10-14 14:36:21.0234427 +0800 CST m=+181.009859501 ReconnectCount:0 LastError:}
    lifecycle_test.go:93: ✅ NATS GetConnectionState test passed
--- PASS: TestNATSGetConnectionState (1.01s)
=== RUN   TestKafkaGetMetrics
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.metrics.1760423782024
    lifecycle_test.go:121: 📊 Metrics: {MessagesPublished:5 MessagesConsumed:0 PublishErrors:0 ConsumeErrors:0 ConnectionErrors:0 LastHealthCheck:2025-10-14 14:36:26.2410547 +0800 CST m=+186.227471501 HealthCheckStatus:healthy ActiveConnections:1 MessageBacklog:0}
    lifecycle_test.go:126: ✅ Kafka GetMetrics test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.metrics.1760423782024
--- PASS: TestKafkaGetMetrics (7.22s)
=== RUN   TestNATSGetMetrics
    lifecycle_test.go:155: 📊 Metrics: {MessagesPublished:5 MessagesConsumed:0 PublishErrors:0 ConsumeErrors:0 ConnectionErrors:0 LastHealthCheck:2025-10-14 14:36:31.265409 +0800 CST m=+191.251825801 HealthCheckStatus:healthy ActiveConnections:1 MessageBacklog:0}
    lifecycle_test.go:160: ✅ NATS GetMetrics test passed
--- PASS: TestNATSGetMetrics (4.03s)
=== RUN   TestKafkaReconnectCallback
    lifecycle_test.go:181: ✅ Kafka RegisterReconnectCallback test passed (callback registered: true)
--- PASS: TestKafkaReconnectCallback (1.01s)
=== RUN   TestNATSReconnectCallback
    lifecycle_test.go:203: ✅ NATS RegisterReconnectCallback test passed (callback registered: true)
--- PASS: TestNATSReconnectCallback (1.01s)
=== RUN   TestKafkaClose
    lifecycle_test.go:223: ✅ Kafka Close test passed
--- PASS: TestKafkaClose (0.01s)
=== RUN   TestNATSClose
    lifecycle_test.go:244: ✅ NATS Close test passed
--- PASS: TestNATSClose (0.01s)
=== RUN   TestKafkaPublishCallback
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.pub.callback.1760423795310
    lifecycle_test.go:262: 📞 Publish callback called: Topic=test.kafka.pub.callback.1760423795310, Error=<nil>
    lifecycle_test.go:276: ✅ Kafka RegisterPublishCallback test passed (callback called: true)
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.pub.callback.1760423795310
--- PASS: TestKafkaPublishCallback (7.24s)
=== RUN   TestKafkaTopicConfiguration
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.topic.config.1760423802547
    test_helper.go:204: ConfigureTopic should not return error: failed to configure topic test.kafka.topic.config.1760423802547: Kafka admin client not available
    topic_config_test.go:52: ✅ Kafka topic configuration test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.topic.config.1760423802547
--- FAIL: TestKafkaTopicConfiguration (5.13s)
=== RUN   TestNATSTopicConfiguration
    topic_config_test.go:96: ✅ NATS topic configuration test passed
--- PASS: TestNATSTopicConfiguration (2.02s)
=== RUN   TestKafkaSetTopicPersistence
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.persistence.1760423809698
    test_helper.go:204: SetTopicPersistence should not return error: failed to configure topic test.kafka.persistence.1760423809698: Kafka admin client not available
    topic_config_test.go:121: ✅ Kafka SetTopicPersistence test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.persistence.1760423809698
--- FAIL: TestKafkaSetTopicPersistence (5.13s)
=== RUN   TestNATSSetTopicPersistence
    topic_config_test.go:147: ✅ NATS SetTopicPersistence test passed
--- PASS: TestNATSSetTopicPersistence (2.02s)
=== RUN   TestKafkaRemoveTopicConfig
    test_helper.go:235: ✅ Created Kafka topic: test.kafka.remove.config.1760423816844
    test_helper.go:204: ConfigureTopic should not return error: failed to configure topic test.kafka.remove.config.1760423816844: Kafka admin client not available
    topic_config_test.go:185: ✅ Kafka RemoveTopicConfig test passed
    test_helper.go:118: ✅ Deleted Kafka topic: test.kafka.remove.config.1760423816844
--- FAIL: TestKafkaRemoveTopicConfig (5.23s)
=== RUN   TestNATSRemoveTopicConfig
    topic_config_test.go:224: ✅ NATS RemoveTopicConfig test passed
--- PASS: TestNATSRemoveTopicConfig (2.01s)
=== RUN   TestKafkaTopicConfigStrategy
    topic_config_test.go:247: ✅ Kafka topic config strategy test passed
--- PASS: TestKafkaTopicConfigStrategy (1.01s)
=== RUN   TestNATSTopicConfigStrategy
    topic_config_test.go:271: ✅ NATS topic config strategy test passed
--- PASS: TestNATSTopicConfigStrategy (1.01s)
FAIL
FAIL	github.com/ChenBigdata421/jxt-core/tests/eventbus/function_tests	226.359s
FAIL
