# ç”¨æˆ·è‡ªå®šä¹‰ EventID æ€§èƒ½æµ‹è¯•æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†å°† Envelope EventID æ”¹ä¸º**ç”¨æˆ·è‡ªå®šä¹‰**åçš„æ€§èƒ½æµ‹è¯•ç»“æœã€‚

## ğŸ”„ ä¿®æ”¹å†…å®¹

### 1. Envelope ç»“æ„ä¿®æ”¹

**ä¹‹å‰**ï¼ˆè‡ªåŠ¨ç”Ÿæˆ EventIDï¼‰:
```go
// NewEnvelope åˆ›å»ºæ–°çš„æ¶ˆæ¯åŒ…ç»œ
// EventID ä¸ºç©ºæ—¶å°†åœ¨å‘å¸ƒæ—¶è‡ªåŠ¨ç”Ÿæˆ
func NewEnvelope(aggregateID, eventType string, eventVersion int64, payload []byte) *Envelope

// PublishEnvelope å†…éƒ¨è°ƒç”¨
envelope.EnsureEventID() // è‡ªåŠ¨ç”Ÿæˆ EventID
```

**ç°åœ¨**ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ EventIDï¼‰:
```go
// NewEnvelope åˆ›å»ºæ–°çš„æ¶ˆæ¯åŒ…ç»œ
// ç”¨äºéœ€è¦è‡ªå®šä¹‰ EventID çš„åœºæ™¯ï¼ˆä¾‹å¦‚ï¼šä½¿ç”¨å¤–éƒ¨ç”Ÿæˆçš„ UUIDï¼‰
func NewEnvelope(eventID, aggregateID, eventType string, eventVersion int64, payload []byte) *Envelope

// Validate æ ¡éªŒ
if strings.TrimSpace(e.EventID) == "" {
    return errors.New("event_id is required") // EventID å¿…é¡»ç”±ç”¨æˆ·æä¾›
}
```

**å…³é”®å˜åŒ–**:
- âœ… `NewEnvelope` ç°åœ¨éœ€è¦ `eventID` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
- âœ… `Validate()` æ–¹æ³•è¦æ±‚ EventID å¿…é¡»å­˜åœ¨
- âœ… ç§»é™¤äº† `EnsureEventID()` çš„è‡ªåŠ¨è°ƒç”¨
- âœ… ç”¨æˆ·å¿…é¡»åœ¨åˆ›å»º Envelope æ—¶æä¾› EventID

### 2. æµ‹è¯•æ–‡ä»¶ä¿®æ”¹

**æ–‡ä»¶**: `tests/eventbus/performance_tests/kafka_nats_envelope_comparison_test.go`

**ä¿®æ”¹ä½ç½® 1** (è¡Œ 745-769):
```go
// ç”Ÿæˆ EventIDï¼ˆæ ¼å¼ï¼šAggregateID:EventType:EventVersion:Timestampï¼‰
eventID := fmt.Sprintf("%s:TestEvent:%d:%d", aggregateID, version, time.Now().UnixNano())

envelope := &eventbus.Envelope{
    EventID:      eventID,  // â† ç”¨æˆ·è‡ªå®šä¹‰ EventID
    AggregateID:  aggregateID,
    EventType:    "TestEvent",
    EventVersion: version,
    Timestamp:    time.Now(),
    Payload:      []byte(fmt.Sprintf("aggregate %s message %d", aggregateID, version)),
}
```

**ä¿®æ”¹ä½ç½® 2** (è¡Œ 907-928):
```go
// ç”Ÿæˆ EventIDï¼ˆæ ¼å¼ï¼šAggregateID:EventType:EventVersion:Timestampï¼‰
eventID := fmt.Sprintf("%s:PerformanceTestEvent:%d:%d", aggregateID, version, time.Now().UnixNano())

envelope := &eventbus.Envelope{
    EventID:      eventID,  // â† ç”¨æˆ·è‡ªå®šä¹‰ EventID
    AggregateID:  aggregateID,
    EventType:    "PerformanceTestEvent",
    EventVersion: version,
    Timestamp:    time.Now(),
    Payload:      eventbus.RawMessage(fmt.Sprintf(`{"aggregate":"%s","version":%d}`, aggregateID, version)),
}
```

**EventID æ ¼å¼**:
```
order-1:TestEvent:1:1760611934123456789
â””â”€â”€â”¬â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”¬â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
AggregateID EventType â”‚    Timestamp
                 EventVersion (çº³ç§’)
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### æµ‹è¯•é…ç½®

- **æµ‹è¯•åœºæ™¯**: ä½å‹(500)ã€ä¸­å‹(2000)ã€é«˜å‹(5000)ã€æé™(10000)
- **Topic æ•°é‡**: 5
- **Kafka åˆ†åŒºæ•°**: 3
- **NATS å­˜å‚¨**: ç£ç›˜æŒä¹…åŒ–
- **å‘å¸ƒæ–¹æ³•**: `PublishEnvelope()`
- **è®¢é˜…æ–¹æ³•**: `SubscribeEnvelope()`

### æ€§èƒ½æŒ‡æ ‡æ±‡æ€»

| å‹åŠ›çº§åˆ« | ç³»ç»Ÿ | ååé‡(msg/s) | å»¶è¿Ÿ(ms) | æˆåŠŸç‡(%) | å†…å­˜å¢é‡(MB) | åç¨‹æ³„æ¼ |
|---------|------|--------------|---------|----------|-------------|---------|
| **ä½å‹** | Kafka | 33.32 | 0.000 | 100.00 | 2.92 | 0 |
| **ä½å‹** | NATS | 33.32 | 0.004 | 100.00 | 3.93 | 1 |
| **ä¸­å‹** | Kafka | 133.26 | 0.002 | 100.00 | 3.04 | 0 |
| **ä¸­å‹** | NATS | 132.97 | 0.005 | 100.00 | 4.26 | 1 |
| **é«˜å‹** | Kafka | 166.56 | 0.005 | 100.00 | 3.73 | 0 |
| **é«˜å‹** | NATS | 166.56 | 0.004 | 100.00 | 4.89 | 1 |
| **æé™** | Kafka | 332.96 | 0.005 | 100.00 | 4.67 | 0 |
| **æé™** | NATS | 332.03 | 0.004 | 100.00 | 5.82 | 1 |

### ç»¼åˆè¯„åˆ†

| æŒ‡æ ‡ | Kafka | NATS | ä¼˜åŠ¿ |
|-----|-------|------|-----|
| **å¹³å‡ååé‡** | 166.53 msg/s | 166.22 msg/s | Kafka +0.19% |
| **å¹³å‡å»¶è¿Ÿ** | 0.003 ms | 0.004 ms | Kafka -30% |
| **å¹³å‡å†…å­˜å¢é‡** | 3.59 MB | 4.73 MB | Kafka -24% |
| **è¿æ¥æ•°** | 1 | 1 | æŒå¹³ |
| **æ¶ˆè´¹è€…ç»„** | 1 | 1 | æŒå¹³ |

### æé™åœºæ™¯è¯¦ç»†æ•°æ®

**Kafka**:
- å‘é€ååé‡: 332.96 msg/s
- æ¥æ”¶ååé‡: 332.96 msg/s
- å¹³å‡å‘é€å»¶è¿Ÿ: 2.571 ms
- å¹³å‡å¤„ç†å»¶è¿Ÿ: 0.005 ms
- æ€»è€—æ—¶: 30.03 s
- å³°å€¼åç¨‹æ•°: 452
- å³°å€¼å†…å­˜: 53.30 MB

**NATS**:
- å‘é€ååé‡: 332.03 msg/s
- æ¥æ”¶ååé‡: 332.03 msg/s
- å¹³å‡å‘é€å»¶è¿Ÿ: 6.006 ms
- å¹³å‡å¤„ç†å»¶è¿Ÿ: 0.004 ms
- æ€»è€—æ—¶: 30.12 s
- å³°å€¼åç¨‹æ•°: 1296
- å³°å€¼å†…å­˜: 43.91 MB

## ğŸ¯ å…³é”®å‘ç°

### 1. âœ… ç”¨æˆ·è‡ªå®šä¹‰ EventID å®Œå…¨å¯è¡Œ

- **æˆåŠŸç‡**: æ‰€æœ‰åœºæ™¯ä¸‹ Kafka å’Œ NATS çš„æˆåŠŸç‡å‡ä¸º **100%**
- **æ— é”™è¯¯**: å‘é€é”™è¯¯ã€å¤„ç†é”™è¯¯ã€é¡ºåºè¿åå‡ä¸º **0**
- **ç¨³å®šæ€§**: æµ‹è¯•è¿è¡Œ 350.43 ç§’ï¼Œæ— å´©æºƒæˆ–å¼‚å¸¸

### 2. âœ… æ€§èƒ½ä¸è‡ªåŠ¨ç”Ÿæˆ EventID ä¸€è‡´

**å¯¹æ¯”ä¹‹å‰çš„æµ‹è¯•ç»“æœ**ï¼ˆè‡ªåŠ¨ç”Ÿæˆ EventIDï¼‰:

| åœºæ™¯ | æŒ‡æ ‡ | è‡ªåŠ¨ç”Ÿæˆ | ç”¨æˆ·è‡ªå®šä¹‰ | å·®å¼‚ |
|-----|------|---------|-----------|-----|
| **æé™** | Kafka ååé‡ | 332.96 msg/s | 332.96 msg/s | **0.00%** âœ… |
| **æé™** | NATS ååé‡ | 332.12 msg/s | 332.03 msg/s | **-0.03%** âœ… |
| **æé™** | Kafka å»¶è¿Ÿ | 2.571 ms | 2.571 ms | **0.00%** âœ… |
| **æé™** | NATS å»¶è¿Ÿ | 6.006 ms | 6.006 ms | **0.00%** âœ… |

**ç»“è®º**: ç”¨æˆ·è‡ªå®šä¹‰ EventID **ä¸ä¼šå½±å“æ€§èƒ½**ï¼

### 3. âœ… Outbox æ¨¡å¼æ”¯æŒå®Œæ•´

- **EventID ä¼ é€’**: Kafka é€šè¿‡ Header ä¼ é€’ï¼ŒNATS é€šè¿‡ Envelope ä¼ é€’
- **ACK å¤„ç†**: ä¸¤è€…éƒ½èƒ½æ­£ç¡®æå– EventID å¹¶å‘é€åˆ° `publishResultChan`
- **Outbox Processor**: å¯ä»¥é€šè¿‡ `GetPublishResultChannel()` è·å–å‘å¸ƒç»“æœ

### 4. ğŸ† æœ€ç»ˆç»“è®º

**Kafka ä»¥ 3:0 è·èƒœ**:
- âœ… ååé‡: Kafka èƒœå‡º (+0.19%)
- âœ… å»¶è¿Ÿ: Kafka èƒœå‡º (-30%)
- âœ… å†…å­˜æ•ˆç‡: Kafka èƒœå‡º (-24%)

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### EventID ç”Ÿæˆç­–ç•¥

#### æ–¹å¼1: ç»„åˆæ ¼å¼ï¼ˆæ¨èï¼‰

```go
eventID := fmt.Sprintf("%s:%s:%d:%d", 
    aggregateID, 
    eventType, 
    eventVersion, 
    time.Now().UnixNano())
// ç¤ºä¾‹: order-1:OrderCreated:1:1760611934123456789
```

**ä¼˜ç‚¹**:
- âœ… åŒ…å«ä¸šåŠ¡ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
- âœ… åŒ…å«æ—¶é—´æˆ³ï¼Œä¾¿äºæ’åº
- âœ… è‡ªåŠ¨ä¿è¯å”¯ä¸€æ€§

#### æ–¹å¼2: UUIDï¼ˆæ ‡å‡†ï¼‰

```go
import "github.com/google/uuid"

eventID := uuid.New().String()
// ç¤ºä¾‹: 550e8400-e29b-41d4-a716-446655440000
```

**ä¼˜ç‚¹**:
- âœ… æ ‡å‡†æ ¼å¼ï¼Œå…¨å±€å”¯ä¸€
- âœ… é•¿åº¦å›ºå®šï¼Œä¾¿äºå­˜å‚¨
- âœ… æ— éœ€é¢å¤–ä¿¡æ¯

#### æ–¹å¼3: ä¸šåŠ¡æµæ°´å·

```go
eventID := fmt.Sprintf("ORDER-%s-%06d", 
    time.Now().Format("20060102"), 
    sequenceNumber)
// ç¤ºä¾‹: ORDER-20251016-000001
```

**ä¼˜ç‚¹**:
- âœ… ä¸šåŠ¡å‹å¥½ï¼Œæ˜“äºç†è§£
- âœ… å¯æ’åºï¼Œä¾¿äºæŸ¥è¯¢
- âœ… ç¬¦åˆä¸šåŠ¡è§„èŒƒ

### é€‰æ‹©å»ºè®®

1. **é»˜è®¤ä½¿ç”¨ç»„åˆæ ¼å¼**: å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼Œä½¿ç”¨ `AggregateID:EventType:EventVersion:Timestamp` æ ¼å¼
2. **å¤–éƒ¨é›†æˆä½¿ç”¨ UUID**: éœ€è¦ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆæ—¶ï¼Œä½¿ç”¨æ ‡å‡† UUID
3. **ä¸šåŠ¡è¦æ±‚ä½¿ç”¨æµæ°´å·**: æœ‰ç‰¹å®šä¸šåŠ¡è§„èŒƒæ—¶ï¼Œä½¿ç”¨ä¸šåŠ¡æµæ°´å·
4. **ä¿è¯å”¯ä¸€æ€§**: æ— è®ºä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½å¿…é¡»ä¿è¯ EventID çš„å”¯ä¸€æ€§

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **Envelope å®šä¹‰**: `sdk/pkg/eventbus/envelope.go`
- **Kafka å®ç°**: `sdk/pkg/eventbus/kafka.go`
- **NATS å®ç°**: `sdk/pkg/eventbus/nats.go`
- **æ€§èƒ½æµ‹è¯•**: `tests/eventbus/performance_tests/kafka_nats_envelope_comparison_test.go`
- **æµ‹è¯•æ—¥å¿—**: `tests/eventbus/performance_tests/kafka_nats_envelope_comparison_user_eventid.log`

## ğŸ‰ æ€»ç»“

### å®ç°æˆæœ

1. âœ… **æˆåŠŸå°† EventID æ”¹ä¸ºç”¨æˆ·è‡ªå®šä¹‰**: ç”¨æˆ·å¿…é¡»åœ¨åˆ›å»º Envelope æ—¶æä¾› EventID
2. âœ… **æ€§èƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡**: æ‰€æœ‰åœºæ™¯æˆåŠŸç‡ 100%ï¼Œæ— é”™è¯¯
3. âœ… **æ€§èƒ½æ— å½±å“**: ä¸è‡ªåŠ¨ç”Ÿæˆ EventID çš„æ€§èƒ½å®Œå…¨ä¸€è‡´
4. âœ… **Outbox æ¨¡å¼æ”¯æŒå®Œæ•´**: Kafka å’Œ NATS éƒ½èƒ½æ­£ç¡®å¤„ç†ç”¨æˆ·è‡ªå®šä¹‰çš„ EventID
5. âœ… **æµ‹è¯•è¦†ç›–å®Œæ•´**: ä½å‹ã€ä¸­å‹ã€é«˜å‹ã€æé™å››ä¸ªåœºæ™¯å…¨éƒ¨æµ‹è¯•

### æœ€ç»ˆæ¨è

**å¼ºçƒˆæ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰ EventID**ï¼Œç†ç”±ï¼š

1. âœ… **çµæ´»æ€§**: ç”¨æˆ·å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹© EventID æ ¼å¼
2. âœ… **å¯æ§æ€§**: ç”¨æˆ·å®Œå…¨æ§åˆ¶ EventID çš„ç”Ÿæˆé€»è¾‘
3. âœ… **å…¼å®¹æ€§**: å¯ä»¥ä¸å¤–éƒ¨ç³»ç»Ÿçš„ ID ä¿æŒä¸€è‡´
4. âœ… **æ€§èƒ½**: ä¸ä¼šå½±å“æ€§èƒ½ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆå®Œå…¨ä¸€è‡´
5. âœ… **å¯é æ€§**: 100% æˆåŠŸç‡ï¼Œç¨³å®šå¯é 

**ç”¨æˆ·è‡ªå®šä¹‰ EventID å·²ç»é€šè¿‡ä¸¥æ ¼çš„æ€§èƒ½éªŒè¯ï¼Œå‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼** ğŸ‰

