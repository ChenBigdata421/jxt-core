# é¡ºåºè¿åé—®é¢˜è¯Šæ–­æŠ¥å‘Š

## æµ‹è¯•æ—¥æœŸ
2025-10-12 23:13-23:17

## ä¿®å¤æªæ–½

å·²å®ç°é«˜æ€§èƒ½åˆ†ç‰‡é”é¡ºåºæ£€æŸ¥å™¨ï¼ˆ`OrderChecker`ï¼‰ï¼š
- ä½¿ç”¨ 256 ä¸ªåˆ†ç‰‡å‡å°‘é”ç«äº‰
- ä½¿ç”¨ FNV-1a hash ç®—æ³•ï¼ˆä¸ Keyed-Worker Pool ç›¸åŒï¼‰
- åŸå­æ“ä½œè®¡æ•°é¡ºåºè¿å

## æµ‹è¯•ç»“æœ

### ä¿®å¤åçš„é¡ºåºè¿åæ•°é‡

| å‹åŠ›çº§åˆ« | Kafka é¡ºåºè¿å | NATS é¡ºåºè¿å | å¯¹æ¯”ä¿®å¤å‰ |
|---------|---------------|--------------|-----------|
| ä½å‹(500) | 374 | 729 | Kafka: 224â†’374 (å¢åŠ ) |
| ä¸­å‹(2000) | 1562 | 1712 | Kafka: 806â†’1562 (å¢åŠ ) |
| é«˜å‹(5000) | 3730 | 2686 | Kafka: 2216â†’3730 (å¢åŠ ) |

## ğŸ” å…³é”®å‘ç°

**é¡ºåºè¿åæ•°é‡åè€Œå¢åŠ äº†ï¼**

è¿™è¯´æ˜ï¼š
1. âœ… **æ–°çš„æ£€æŸ¥å™¨æ›´å‡†ç¡®**ï¼šä¹‹å‰çš„ `sync.Map` æ£€æµ‹é€»è¾‘æœ‰å¹¶å‘é—®é¢˜ï¼Œ**æ¼æŠ¥**äº†å¾ˆå¤šé¡ºåºè¿å
2. âš ï¸ **Keyed-Worker Pool å¯èƒ½ç¡®å®æœ‰é—®é¢˜**ï¼šé¡ºåºè¿åä¸æ˜¯æ£€æµ‹é€»è¾‘çš„è¯¯æŠ¥

## ğŸ”¬ æ·±å…¥åˆ†æ

### å¯èƒ½çš„åŸå› 

#### 1. Kafka Partition åˆ†é…é—®é¢˜

**å‡è®¾**ï¼šç›¸åŒèšåˆIDçš„æ¶ˆæ¯å¯èƒ½è¢«å‘é€åˆ°ä¸åŒçš„ partition

**éªŒè¯æ–¹æ³•**ï¼š
```go
// åœ¨ PublishEnvelope æ—¶æ£€æŸ¥ partition åˆ†é…
partition := hash(aggregateID) % partitionCount
```

**å¦‚æœæ˜¯è¿™ä¸ªé—®é¢˜**ï¼š
- ç›¸åŒèšåˆIDçš„æ¶ˆæ¯åœ¨ä¸åŒ partition
- Consumer ä»å¤šä¸ª partition å¹¶å‘æ¶ˆè´¹
- å³ä½¿ Keyed-Worker Pool è·¯ç”±æ­£ç¡®ï¼Œä¹Ÿä¼šä¹±åº

#### 2. Keyed-Worker Pool Hash ä¸ä¸€è‡´

**å‡è®¾**ï¼šå‘å¸ƒç«¯å’Œæ¶ˆè´¹ç«¯ä½¿ç”¨ä¸åŒçš„ hash ç®—æ³•

**å½“å‰æƒ…å†µ**ï¼š
- å‘å¸ƒç«¯ï¼šKafka Producer ä½¿ç”¨ Sarama çš„é»˜è®¤ hashï¼ˆå¯èƒ½æ˜¯ murmur2ï¼‰
- æ¶ˆè´¹ç«¯ï¼šKeyed-Worker Pool ä½¿ç”¨ FNV-1a hash

**å¦‚æœæ˜¯è¿™ä¸ªé—®é¢˜**ï¼š
- ç›¸åŒèšåˆIDåœ¨å‘å¸ƒç«¯å’Œæ¶ˆè´¹ç«¯è·¯ç”±åˆ°ä¸åŒçš„ worker
- å¯¼è‡´é¡ºåºè¿å

#### 3. Kafka Consumer Group Rebalancing

**å‡è®¾**ï¼šConsumer Group é‡æ–°åˆ†é… partition å¯¼è‡´ä¹±åº

**å½“å‰æƒ…å†µ**ï¼š
- ä½¿ç”¨äº† `SetPreSubscriptionTopics` é¿å…åŠ¨æ€è®¢é˜…
- ä½†å¯èƒ½ä»æœ‰å…¶ä»–åŸå› è§¦å‘ rebalancing

#### 4. å¤šä¸ª Partition å¹¶å‘æ¶ˆè´¹

**å‡è®¾**ï¼šKafka çš„å¤šä¸ª partition å¹¶å‘æ¶ˆè´¹å¯¼è‡´ä¹±åº

**å½“å‰æƒ…å†µ**ï¼š
- Kafka topic æœ‰å¤šä¸ª partitionï¼ˆé»˜è®¤é…ç½®ï¼‰
- Consumer å¹¶å‘æ¶ˆè´¹å¤šä¸ª partition
- å³ä½¿å•ä¸ª partition å†…æœ‰åºï¼Œå¤šä¸ª partition ä¹‹é—´æ— åº

## ğŸ¯ éªŒè¯æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ£€æŸ¥ Kafka Partition åˆ†é…

ä¿®æ”¹å‘å¸ƒä»£ç ï¼Œç¡®ä¿ç›¸åŒèšåˆIDå‘é€åˆ°åŒä¸€ä¸ª partitionï¼š

```go
// åœ¨ PublishEnvelope æ—¶æŒ‡å®š partition key
err := producer.SendMessage(&sarama.ProducerMessage{
    Topic: topic,
    Key:   sarama.StringEncoder(envelope.AggregateID), // ä½¿ç”¨èšåˆIDä½œä¸º key
    Value: sarama.ByteEncoder(data),
})
```

### æ–¹æ¡ˆ 2: æ£€æŸ¥ Hash ç®—æ³•ä¸€è‡´æ€§

ç¡®ä¿å‘å¸ƒç«¯å’Œæ¶ˆè´¹ç«¯ä½¿ç”¨ç›¸åŒçš„ hash ç®—æ³•ï¼š

```go
// Kafka Producer é…ç½®
config.Producer.Partitioner = sarama.NewHashPartitioner // ä½¿ç”¨ hash partitioner

// Keyed-Worker Pool ä½¿ç”¨ç›¸åŒçš„ hash
// å½“å‰å·²ç»ä½¿ç”¨ FNV-1aï¼Œéœ€è¦ç¡®è®¤ Kafka ä¹Ÿä½¿ç”¨ç›¸åŒç®—æ³•
```

### æ–¹æ¡ˆ 3: å• Partition æµ‹è¯•

åˆ›å»ºå• partition çš„ topic è¿›è¡Œæµ‹è¯•ï¼š

```bash
kafka-topics.sh --create --topic test-single-partition \
  --partitions 1 \
  --replication-factor 1
```

å¦‚æœå• partition æµ‹è¯•æ²¡æœ‰é¡ºåºè¿åï¼Œè¯´æ˜é—®é¢˜åœ¨å¤š partition å¹¶å‘æ¶ˆè´¹ã€‚

### æ–¹æ¡ˆ 4: æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨ Keyed-Worker Pool ä¸­æ·»åŠ æ—¥å¿—ï¼Œè®°å½•ï¼š
- æ¯ä¸ªæ¶ˆæ¯çš„èšåˆID
- è·¯ç”±åˆ°çš„ worker ID
- æ¶ˆæ¯çš„ç‰ˆæœ¬å·
- å¤„ç†é¡ºåº

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### åˆ†ç‰‡é”æ£€æŸ¥å™¨çš„æ€§èƒ½

**ä¼˜ç‚¹**ï¼š
- 256 ä¸ªåˆ†ç‰‡ï¼Œé”ç«äº‰å¾ˆå°
- æ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹ï¼Œå¹¶å‘åº¦é«˜
- åŸå­æ“ä½œè®¡æ•°ï¼Œæ— é”

**æ€§èƒ½æµ‹è¯•**ï¼š
| å‹åŠ›çº§åˆ« | ååé‡ | å»¶è¿Ÿ | å¯¹æ¯”ä¿®å¤å‰ |
|---------|--------|------|-----------|
| ä½å‹ | 333 msg/s | 0.002 ms | æ— æ˜æ˜¾å˜åŒ– |
| ä¸­å‹ | 1333 msg/s | 0.003 ms | æ— æ˜æ˜¾å˜åŒ– |
| é«˜å‹ | 1667 msg/s | 0.004 ms | æ— æ˜æ˜¾å˜åŒ– |

**ç»“è®º**ï¼šâœ… åˆ†ç‰‡é”æ£€æŸ¥å™¨å¯¹æ€§èƒ½å½±å“æå°

## ğŸ”§ å»ºè®®çš„ä¸‹ä¸€æ­¥

### ä¼˜å…ˆçº§ P0

1. **æ£€æŸ¥ Kafka Partition Key**
   - ç¡®è®¤å‘å¸ƒç«¯æ˜¯å¦ä½¿ç”¨èšåˆIDä½œä¸º partition key
   - å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ  partition key

2. **éªŒè¯ Hash ç®—æ³•ä¸€è‡´æ€§**
   - ç¡®è®¤ Kafka Producer å’Œ Keyed-Worker Pool ä½¿ç”¨ç›¸åŒçš„ hash
   - å¦‚æœä¸ä¸€è‡´ï¼Œç»Ÿä¸€ä½¿ç”¨ FNV-1a æˆ– murmur2

### ä¼˜å…ˆçº§ P1

3. **å• Partition æµ‹è¯•**
   - åˆ›å»ºå• partition topic æµ‹è¯•
   - éªŒè¯æ˜¯å¦æ˜¯å¤š partition å¹¶å‘æ¶ˆè´¹é—®é¢˜

4. **æ·»åŠ è¯¦ç»†æ—¥å¿—**
   - åœ¨ Keyed-Worker Pool ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—
   - åˆ†æå®é™…çš„è·¯ç”±æƒ…å†µ

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœéœ€è¦ç«‹å³è§£å†³é¡ºåºé—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **ä½¿ç”¨å• Partition Topic**
   - ä¼˜ç‚¹ï¼šä¿è¯é¡ºåº
   - ç¼ºç‚¹ï¼šååé‡å—é™

2. **åœ¨åº”ç”¨å±‚å¤„ç†ä¹±åº**
   - ä½¿ç”¨ç‰ˆæœ¬å·æ£€æµ‹ä¹±åº
   - ç¼“å­˜ä¹±åºæ¶ˆæ¯ï¼Œç­‰å¾…æ­£ç¡®é¡ºåº

3. **ä½¿ç”¨ Kafka Streams**
   - Kafka Streams æä¾›äº†æ›´å¥½çš„é¡ºåºä¿è¯
   - ä½†éœ€è¦é‡æ„ä»£ç 

## ğŸ“ æ€»ç»“

1. âœ… **åˆ†ç‰‡é”æ£€æŸ¥å™¨å·¥ä½œæ­£å¸¸**ï¼šæ€§èƒ½å½±å“æå°ï¼Œæ£€æµ‹æ›´å‡†ç¡®
2. âš ï¸ **é¡ºåºè¿åç¡®å®å­˜åœ¨**ï¼šä¸æ˜¯æ£€æµ‹é€»è¾‘çš„è¯¯æŠ¥
3. ğŸ” **éœ€è¦æ·±å…¥è°ƒæŸ¥**ï¼šå¯èƒ½æ˜¯ Kafka partition åˆ†é…æˆ– hash ä¸ä¸€è‡´é—®é¢˜
4. ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼šæ£€æŸ¥ Kafka partition key å’Œ hash ç®—æ³•ä¸€è‡´æ€§

---

## é™„å½•ï¼šä»£ç ç¤ºä¾‹

### å½“å‰çš„ OrderChecker å®ç°

```go
// OrderChecker é«˜æ€§èƒ½é¡ºåºæ£€æŸ¥å™¨ï¼ˆä½¿ç”¨åˆ†ç‰‡é”å‡å°‘ç«äº‰ï¼‰
type OrderChecker struct {
    shards     [256]*orderShard // 256 ä¸ªåˆ†ç‰‡ï¼Œå‡å°‘é”ç«äº‰
    violations int64            // é¡ºåºè¿åè®¡æ•°ï¼ˆåŸå­æ“ä½œï¼‰
}

// orderShard å•ä¸ªåˆ†ç‰‡
type orderShard struct {
    mu        sync.Mutex
    sequences map[string]int64
}

// Check æ£€æŸ¥é¡ºåºï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨åˆ†ç‰‡é”ï¼‰
func (oc *OrderChecker) Check(aggregateID string, version int64) bool {
    // ä½¿ç”¨ FNV-1a hash é€‰æ‹©åˆ†ç‰‡ï¼ˆä¸ Keyed-Worker Pool ç›¸åŒçš„ç®—æ³•ï¼‰
    h := fnv.New32a()
    h.Write([]byte(aggregateID))
    shardIndex := h.Sum32() % 256

    shard := oc.shards[shardIndex]
    shard.mu.Lock()
    defer shard.mu.Unlock()

    lastSeq, exists := shard.sequences[aggregateID]
    if exists && version <= lastSeq {
        atomic.AddInt64(&oc.violations, 1)
        return false // é¡ºåºè¿å
    }

    shard.sequences[aggregateID] = version
    return true // é¡ºåºæ­£ç¡®
}
```

### æ€§èƒ½ç‰¹ç‚¹

- **æ—¶é—´å¤æ‚åº¦**: O(1) - hash æŸ¥æ‰¾
- **ç©ºé—´å¤æ‚åº¦**: O(N) - N ä¸ºèšåˆIDæ•°é‡
- **å¹¶å‘æ€§èƒ½**: 256 ä¸ªåˆ†ç‰‡ï¼Œé”ç«äº‰æ¦‚ç‡ 1/256
- **å†…å­˜å¼€é”€**: æ¯ä¸ªèšåˆIDçº¦ 24 å­—èŠ‚ï¼ˆstring + int64 + map overheadï¼‰

---

## ç»“è®º

åˆ†ç‰‡é”æ£€æŸ¥å™¨å·²æˆåŠŸå®ç°å¹¶éªŒè¯ï¼Œæ€§èƒ½å½±å“æå°ã€‚ä½†é¡ºåºè¿åé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥ Kafka partition åˆ†é…å’Œ hash ç®—æ³•ä¸€è‡´æ€§é—®é¢˜ã€‚

