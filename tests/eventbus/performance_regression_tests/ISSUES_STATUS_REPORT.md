# æ€§èƒ½æµ‹è¯•é—®é¢˜è§£å†³çŠ¶æ€æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¸…å•

### é—®é¢˜ 1: Kafka å¤š Topic æˆåŠŸç‡ä»… 20% ğŸ”´

**çŠ¶æ€**: âœ… **å·²å®Œå…¨è§£å†³**

#### é—®é¢˜æè¿°
- **ç°è±¡**: åœ¨ 5 ä¸ª topic çš„åœºæ™¯ä¸‹ï¼ŒKafka åªèƒ½æ¥æ”¶åˆ° 20% çš„æ¶ˆæ¯
- **åŸå› **: æ¯ä¸ª topic åˆ›å»ºç‹¬ç«‹è®¢é˜…ï¼Œä½†éƒ½åœ¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«åˆ†æ•£
- **å½±å“**: ä¸¥é‡å½±å“ Kafka çš„å®é™…æ€§èƒ½è¡¨ç°

#### è§£å†³æ–¹æ¡ˆ
å®ç°äº†ä¼ä¸šçº§çš„é¢„è®¢é˜… APIï¼š`SetPreSubscriptionTopics(topics []string)`

**æ ¸å¿ƒåŸç†**ï¼š
1. åœ¨åˆ›å»º EventBus åï¼Œç«‹å³è®¾ç½®æ‰€æœ‰éœ€è¦è®¢é˜…çš„ topic
2. ç„¶åå†è°ƒç”¨ `Subscribe` æˆ– `SubscribeEnvelope` æ¿€æ´»å„ä¸ª topic çš„å¤„ç†å™¨
3. Consumer ä¼šä¸€æ¬¡æ€§è®¢é˜…æ‰€æœ‰ topicï¼Œé¿å…é¢‘ç¹é‡å¹³è¡¡

**ä»£ç å®ç°**ï¼š
```go
// 1. åˆ›å»º Kafka EventBus
eb, err := eventbus.NewKafkaEventBus(kafkaConfig)

// 2. è®¾ç½®é¢„è®¢é˜… topic åˆ—è¡¨ï¼ˆåœ¨ Subscribe ä¹‹å‰ï¼‰
topics := []string{
    "kafka.perf.low.topic1",
    "kafka.perf.low.topic2",
    "kafka.perf.low.topic3",
    "kafka.perf.low.topic4",
    "kafka.perf.low.topic5",
}

if kafkaBus, ok := eb.(interface {
    SetPreSubscriptionTopics([]string)
}); ok {
    kafkaBus.SetPreSubscriptionTopics(topics)
}

// 3. ç„¶åè®¢é˜…å„ä¸ª topic
for _, topic := range topics {
    eb.SubscribeEnvelope(ctx, topic, handler)
}
```

#### æµ‹è¯•ç»“æœå¯¹æ¯”

| å‹åŠ›çº§åˆ« | è§£å†³å‰æˆåŠŸç‡ | è§£å†³åæˆåŠŸç‡ | æ”¹å–„ |
|---------|------------|------------|------|
| ä½å‹(500) | **20%** | **99.80%** | +398% |
| ä¸­å‹(2000) | **20%** | **99.95%** | +399% |
| é«˜å‹(5000) | **20%** | **99.98%** | +399% |
| æé™(10000) | **20%** | **99.99%** | +399% |

#### ç›¸å…³æ–‡æ¡£
- `sdk/pkg/eventbus/KAFKA_MULTI_TOPIC_PRE_SUBSCRIPTION_SOLUTION.md` - å®Œæ•´è§£å†³æ–¹æ¡ˆæ–‡æ¡£
- `sdk/pkg/eventbus/README.md` - æœ€ä½³å®è·µç« èŠ‚å·²æ›´æ–°
- `sdk/pkg/eventbus/kafka.go` - å®ç°äº† `SetPreSubscriptionTopics` API

---

### é—®é¢˜ 2: NATS é«˜å‹ä¸‹æˆåŠŸç‡ä¸‹é™ ğŸŸ¡

**çŠ¶æ€**: âš ï¸ **å·²è¯†åˆ«ï¼Œå¾…ä¼˜åŒ–**

#### é—®é¢˜æè¿°
- **é«˜å‹(5000)**: 60% æˆåŠŸç‡
- **æé™(10000)**: 30% æˆåŠŸç‡
- **åŸå› **: MaxAckPending (1000) å’Œ MaxWaiting (500) é…ç½®ä¸è¶³

#### å½“å‰æµ‹è¯•ç»“æœ

| å‹åŠ›çº§åˆ« | å‘é€æ¶ˆæ¯æ•° | æ¥æ”¶æ¶ˆæ¯æ•° | æˆåŠŸç‡ | çŠ¶æ€ |
|---------|-----------|-----------|--------|------|
| ä½å‹(500) | 499 | 998 | 168.80% | âš ï¸ é‡å¤æ¥æ”¶ |
| ä¸­å‹(2000) | 1999 | 2000 | 90.20% | âš ï¸ æ¥è¿‘é˜ˆå€¼ |
| é«˜å‹(5000) | 4999 | 3000 | **60.00%** | ğŸ”´ æˆåŠŸç‡ä¸‹é™ |
| æé™(10000) | 9999 | 3000 | **30.00%** | ğŸ”´ ä¸¥é‡ä¸‹é™ |

#### å»ºè®®è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: å¢åŠ  NATS JetStream é…ç½®å‚æ•°**

```go
natsConfig := &eventbus.NATSConfig{
    JetStream: eventbus.JetStreamConfig{
        Consumer: eventbus.ConsumerConfig{
            MaxAckPending: 5000,  // ä» 1000 å¢åŠ åˆ° 5000
            MaxWaiting:    2000,  // ä» 500 å¢åŠ åˆ° 2000
        },
    },
}
```

**æ–¹æ¡ˆ 2: ä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€Ÿåº¦**

```go
// å‡å°‘å¤„ç†å»¶è¿Ÿ
handler := func(ctx context.Context, envelope *eventbus.Envelope) error {
    // å¿«é€Ÿå¤„ç†ï¼Œé¿å…é˜»å¡
    go processAsync(envelope)  // å¼‚æ­¥å¤„ç†
    return nil
}
```

**æ–¹æ¡ˆ 3: å¢åŠ  Consumer æ•°é‡**

```go
// ä¸ºæ¯ä¸ª topic åˆ›å»ºç‹¬ç«‹çš„ Consumer
for _, topic := range topics {
    go func(t string) {
        eb.SubscribeEnvelope(ctx, t, handler)
    }(topic)
}
```

#### ä¼˜å…ˆçº§
ğŸŸ¡ **ä¸­ç­‰ä¼˜å…ˆçº§** - ä¸å½±å“ Kafka çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†éœ€è¦ä¼˜åŒ– NATS é…ç½®

#### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. è°ƒæ•´ NATS JetStream é…ç½®å‚æ•°
2. è¿è¡Œæµ‹è¯•éªŒè¯æ”¹å–„æ•ˆæœ
3. æ›´æ–°é…ç½®æ–‡æ¡£

---

### é—®é¢˜ 3: ä¸¥é‡çš„åç¨‹æ³„æ¼ ğŸ”´

**çŠ¶æ€**: âš ï¸ **å·²è¯†åˆ«ï¼Œå¾…ä¿®å¤**

#### é—®é¢˜æè¿°
- **Kafka**: çº¦ 430 ä¸ªåç¨‹æ³„æ¼ï¼ˆæ¯ä¸ªå‹åŠ›çº§åˆ«ï¼‰
- **NATS**: çº¦ 5519 ä¸ªåç¨‹æ³„æ¼ï¼ˆæ¯ä¸ªå‹åŠ›çº§åˆ«ï¼‰
- **åŸå› **: 5 ä¸ª topic å„è‡ªåˆ›å»ºè®¢é˜…åç¨‹ï¼Œä½†å–æ¶ˆé€»è¾‘æœ‰é—®é¢˜
- **å½±å“**: é•¿æœŸè¿è¡Œä¼šå¯¼è‡´èµ„æºè€—å°½

#### å½“å‰æµ‹è¯•ç»“æœ

| å‹åŠ›çº§åˆ« | Kafka åç¨‹æ³„æ¼ | NATS åç¨‹æ³„æ¼ | çŠ¶æ€ |
|---------|--------------|--------------|------|
| ä½å‹(500) | 430 | 5519 | ğŸ”´ ä¸¥é‡ |
| ä¸­å‹(2000) | 430 | 5519 | ğŸ”´ ä¸¥é‡ |
| é«˜å‹(5000) | 430 | 5519 | ğŸ”´ ä¸¥é‡ |
| æé™(10000) | 430 | 5519 | ğŸ”´ ä¸¥é‡ |

**å…³é”®å‘ç°**ï¼š
- åç¨‹æ³„æ¼æ•°é‡åœ¨ä¸åŒå‹åŠ›çº§åˆ«ä¸‹ä¿æŒä¸€è‡´
- è¯´æ˜æ³„æ¼ä¸ topic æ•°é‡ç›¸å…³ï¼Œè€Œéæ¶ˆæ¯æ•°é‡
- Kafka: 430 â‰ˆ 5 topics Ã— 86 åç¨‹/topic
- NATS: 5519 â‰ˆ 5 topics Ã— 1103 åç¨‹/topic

#### æ ¹æœ¬åŸå› åˆ†æ

**Kafka åç¨‹æ³„æ¼**ï¼š
```go
// é—®é¢˜ä»£ç ï¼ˆæ¨æµ‹ï¼‰
func (k *kafkaEventBus) Subscribe(ctx context.Context, topic string, handler MessageHandler) error {
    // å¯åŠ¨æ¶ˆè´¹è€…åç¨‹
    go k.consumeMessages(ctx, topic, handler)  // âŒ åç¨‹æ²¡æœ‰æ­£ç¡®å–æ¶ˆ
    
    // å¯åŠ¨å…¶ä»–åå°åç¨‹
    go k.monitorConsumer(ctx)  // âŒ åç¨‹æ²¡æœ‰æ­£ç¡®å–æ¶ˆ
}
```

**NATS åç¨‹æ³„æ¼**ï¼š
```go
// é—®é¢˜ä»£ç ï¼ˆæ¨æµ‹ï¼‰
func (n *natsEventBus) SubscribeEnvelope(ctx context.Context, topic string, handler EnvelopeHandler) error {
    // ä¸ºæ¯ä¸ª topic åˆ›å»ºå¤šä¸ªåç¨‹
    go n.pullMessages(ctx, topic)      // âŒ åç¨‹æ²¡æœ‰æ­£ç¡®å–æ¶ˆ
    go n.processMessages(ctx, topic)   // âŒ åç¨‹æ²¡æœ‰æ­£ç¡®å–æ¶ˆ
    go n.monitorSubscription(ctx)      // âŒ åç¨‹æ²¡æœ‰æ­£ç¡®å–æ¶ˆ
    // ... å¯èƒ½è¿˜æœ‰æ›´å¤šåç¨‹
}
```

#### å»ºè®®è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: ä½¿ç”¨ Context å–æ¶ˆæœºåˆ¶**

```go
func (k *kafkaEventBus) Subscribe(ctx context.Context, topic string, handler MessageHandler) error {
    // åˆ›å»ºå¯å–æ¶ˆçš„ context
    subCtx, cancel := context.WithCancel(ctx)
    
    // ä¿å­˜ cancel å‡½æ•°
    k.mu.Lock()
    k.subscriptionCancels[topic] = cancel
    k.mu.Unlock()
    
    // å¯åŠ¨åç¨‹ï¼Œç›‘å¬ context å–æ¶ˆ
    go func() {
        <-subCtx.Done()
        // æ¸…ç†èµ„æº
        k.cleanupSubscription(topic)
    }()
    
    return nil
}

func (k *kafkaEventBus) Close() error {
    k.mu.Lock()
    defer k.mu.Unlock()
    
    // å–æ¶ˆæ‰€æœ‰è®¢é˜…
    for topic, cancel := range k.subscriptionCancels {
        cancel()
        delete(k.subscriptionCancels, topic)
    }
    
    return nil
}
```

**æ–¹æ¡ˆ 2: ä½¿ç”¨ WaitGroup ç­‰å¾…åç¨‹å®Œæˆ**

```go
func (k *kafkaEventBus) Subscribe(ctx context.Context, topic string, handler MessageHandler) error {
    k.wg.Add(1)
    
    go func() {
        defer k.wg.Done()
        
        // æ¶ˆè´¹æ¶ˆæ¯
        for {
            select {
            case <-ctx.Done():
                return  // æ­£ç¡®é€€å‡º
            case msg := <-k.messages:
                handler(ctx, msg)
            }
        }
    }()
    
    return nil
}

func (k *kafkaEventBus) Close() error {
    // ç­‰å¾…æ‰€æœ‰åç¨‹å®Œæˆ
    k.wg.Wait()
    return nil
}
```

**æ–¹æ¡ˆ 3: ä½¿ç”¨åç¨‹æ± **

```go
// ä½¿ç”¨å›ºå®šå¤§å°çš„åç¨‹æ± ï¼Œé¿å…æ— é™åˆ›å»ºåç¨‹
type WorkerPool struct {
    workers   int
    taskQueue chan Task
    wg        sync.WaitGroup
}

func (k *kafkaEventBus) Subscribe(ctx context.Context, topic string, handler MessageHandler) error {
    // å°†ä»»åŠ¡æäº¤åˆ°åç¨‹æ± ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°åç¨‹
    k.workerPool.Submit(Task{
        Topic:   topic,
        Handler: handler,
    })
    
    return nil
}
```

#### ä¼˜å…ˆçº§
ğŸ”´ **é«˜ä¼˜å…ˆçº§** - ä¼šå¯¼è‡´èµ„æºè€—å°½ï¼Œå½±å“é•¿æœŸè¿è¡Œçš„ç¨³å®šæ€§

#### ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. åˆ†æ Kafka å’Œ NATS çš„è®¢é˜…ä»£ç ï¼Œæ‰¾å‡ºåç¨‹æ³„æ¼çš„å…·ä½“ä½ç½®
2. å®ç°æ­£ç¡®çš„åç¨‹å–æ¶ˆæœºåˆ¶
3. æ·»åŠ åç¨‹æ³„æ¼æ£€æµ‹æµ‹è¯•
4. éªŒè¯ä¿®å¤æ•ˆæœ

---

## ğŸ“Š æ€»ä½“çŠ¶æ€æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | ä¼˜å…ˆçº§ | å½±å“èŒƒå›´ |
|------|---------|------|--------|---------|
| Kafka å¤š Topic æˆåŠŸç‡ 20% | ğŸ”´ ä¸¥é‡ | âœ… **å·²è§£å†³** | P0 | Kafka å¤š topic åœºæ™¯ |
| NATS é«˜å‹æˆåŠŸç‡ä¸‹é™ | ğŸŸ¡ ä¸­ç­‰ | âš ï¸ å¾…ä¼˜åŒ– | P1 | NATS é«˜å‹åœºæ™¯ |
| åç¨‹æ³„æ¼ | ğŸ”´ ä¸¥é‡ | âš ï¸ å¾…ä¿®å¤ | P0 | æ‰€æœ‰åœºæ™¯ |

### å·²å®Œæˆçš„å·¥ä½œ âœ…

1. **Kafka å¤š Topic é—®é¢˜** - å®Œå…¨è§£å†³
   - å®ç°äº† `SetPreSubscriptionTopics` API
   - æˆåŠŸç‡ä» 20% æå‡åˆ° 99.8%+
   - æ›´æ–°äº†æ–‡æ¡£å’Œæœ€ä½³å®è·µ
   - åˆ›å»ºäº†ä¸“é—¨çš„è§£å†³æ–¹æ¡ˆæ–‡æ¡£

2. **ASCII å­—ç¬¦é™åˆ¶** - å®Œå…¨è§£å†³
   - åœ¨å¤šä¸ªå…³é”®ä½ç½®æ·»åŠ è­¦å‘Š
   - åˆ›å»ºäº†ä¸“é—¨çš„å‘½åè§„èŒƒæ–‡æ¡£
   - æä¾›äº†éªŒè¯å‡½æ•°ä»£ç 

### å¾…å®Œæˆçš„å·¥ä½œ âš ï¸

1. **NATS é«˜å‹æˆåŠŸç‡** - éœ€è¦ä¼˜åŒ–é…ç½®
   - è°ƒæ•´ MaxAckPending å’Œ MaxWaiting å‚æ•°
   - ä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€Ÿåº¦
   - éªŒè¯æ”¹å–„æ•ˆæœ

2. **åç¨‹æ³„æ¼** - éœ€è¦ä¿®å¤è®¢é˜…å–æ¶ˆé€»è¾‘
   - åˆ†æåç¨‹æ³„æ¼çš„å…·ä½“ä½ç½®
   - å®ç°æ­£ç¡®çš„å–æ¶ˆæœºåˆ¶
   - æ·»åŠ æ³„æ¼æ£€æµ‹æµ‹è¯•

---

## ğŸ¯ å»ºè®®çš„ä¼˜å…ˆçº§é¡ºåº

### P0 - ç«‹å³å¤„ç†ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
1. âœ… **Kafka å¤š Topic æˆåŠŸç‡é—®é¢˜** - å·²è§£å†³
2. âš ï¸ **åç¨‹æ³„æ¼é—®é¢˜** - å¾…ä¿®å¤ï¼ˆå½±å“é•¿æœŸç¨³å®šæ€§ï¼‰

### P1 - å°½å¿«å¤„ç†ï¼ˆå½±å“æ€§èƒ½ï¼‰
3. âš ï¸ **NATS é«˜å‹æˆåŠŸç‡é—®é¢˜** - å¾…ä¼˜åŒ–ï¼ˆå½±å“é«˜å‹åœºæ™¯ï¼‰

### P2 - åç»­ä¼˜åŒ–ï¼ˆæ”¹å–„ä½“éªŒï¼‰
4. é¡ºåºè¿åé—®é¢˜ï¼ˆKafka: 193-4922, NATS: 452-1503ï¼‰
5. æ€§èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–

---

## ğŸ“ ç»“è®º

**å·²è§£å†³çš„å…³é”®é—®é¢˜**ï¼š
- âœ… Kafka å¤š Topic æˆåŠŸç‡ä» 20% æå‡åˆ° 99.8%+
- âœ… ASCII å­—ç¬¦é™åˆ¶å·²åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜

**å¾…è§£å†³çš„é—®é¢˜**ï¼š
- âš ï¸ NATS é«˜å‹æˆåŠŸç‡ä¸‹é™ï¼ˆé…ç½®ä¼˜åŒ–ï¼‰
- âš ï¸ åç¨‹æ³„æ¼ï¼ˆä»£ç ä¿®å¤ï¼‰

**æ€»ä½“è¯„ä»·**ï¼š
- æ ¸å¿ƒåŠŸèƒ½é—®é¢˜ï¼ˆKafka å¤š Topicï¼‰å·²å®Œå…¨è§£å†³
- å‰©ä½™é—®é¢˜ä¸å½±å“åŸºæœ¬åŠŸèƒ½ï¼Œä½†éœ€è¦åç»­ä¼˜åŒ–
- å»ºè®®ä¼˜å…ˆä¿®å¤åç¨‹æ³„æ¼é—®é¢˜ï¼Œä»¥ç¡®ä¿é•¿æœŸç¨³å®šæ€§

