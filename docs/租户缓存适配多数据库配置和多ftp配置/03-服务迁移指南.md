# 租户缓存适配多数据库配置和多FTP配置 - 服务迁移指南

## 1. 概述

本指南帮助使用 jxt-core/sdk/pkg/tenant 组件的服务迁移到新的 v2 API，以支持多数据库配置和多FTP配置。

## 2. 变更影响范围

### 2.1 主要变更

| 组件 | v1 API | v2 API | 变更说明 |
|-----|--------|--------|---------|
| database.Cache | `GetByID(tenantID)` | `GetByService(tenantID, serviceCode)` | 需要指定服务代码 |
| ftp.Cache | `GetByID(tenantID)` | `GetAll(tenantID)` | 返回数组而非单个对象 |
| Provider | `GetDatabaseConfig(tenantID)` | `GetServiceDatabaseConfig(tenantID, serviceCode)` | 支持服务级别配置 |

### 2.2 受影响的服务

- evidence-management/command
- evidence-management/query
- file-storage-service
- security-management

## 3. 服务代码 (ServiceCode) 定义

每个服务需要使用其对应的服务代码获取数据库配置：

| 服务代码 | 服务名称 | 用途 |
|---------|---------|------|
| `evidence-command` | 证据管理命令服务 | 写操作数据库 |
| `evidence-query` | 证据管理查询服务 | 读操作数据库 |
| `file-storage` | 文件存储服务 | 文件存储数据库 |
| `security-management` | 安全管理服务 | 安全管理数据库 |

## 4. 数据库配置迁移

### 4.1 旧代码 (v1)

```go
// 旧代码 - 获取租户数据库配置
dbCache := tenant_database.NewCache(provider)
cfg, err := dbCache.GetByID(ctx, tenantID)
if err != nil {
    return err
}

// 使用配置
dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
    cfg.Username,
    cfg.Password,  // 密码在配置中
    cfg.Host,
    cfg.Port,
    cfg.DbName,
)

db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
```

### 4.2 新代码 (v2)

```go
// 新代码 - 获取指定服务的数据库配置
dbCache := tenant_database.NewCache(provider)
cfg, err := dbCache.GetByService(ctx, tenantID, "evidence-command")
if err != nil {
    return err
}

// 密码可能为空，需要通过 Provider 获取
if cfg.Password == "" {
    // 方法1: 使用 Provider 获取完整配置（包含密码）
    cfg, err = dbCache.GetConnection(ctx, tenantID, "evidence-command")
    if err != nil {
        return err
    }
}

dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True&loc=Local",
    cfg.Username,
    cfg.Password,  // v2 中密码可能通过 API 获取
    cfg.Host,
    cfg.Port,
    cfg.Database,  // 字段名从 DbName 改为 Database
)

db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
```

### 4.3 配置初始化变更

**旧代码:**
```go
// 旧的服务初始化
func NewService(tenantID int, provider *tenant.Provider) (*Service, error) {
    dbCache := tenant_database.NewCache(provider)
    cfg, err := dbCache.GetByID(context.Background(), tenantID)
    // ...
}
```

**新代码:**
```go
// 新的服务初始化 - 需要传入 serviceCode
func NewService(tenantID int, serviceCode string, provider *tenant.Provider) (*Service, error) {
    dbCache := tenant_database.NewCache(provider)
    cfg, err := dbCache.GetByService(context.Background(), tenantID, serviceCode)
    // ...
}

// 或者定义常量
const ServiceCode = "evidence-command"

func NewService(tenantID int, provider *tenant.Provider) (*Service, error) {
    dbCache := tenant_database.NewCache(provider)
    cfg, err := dbCache.GetByService(context.Background(), tenantID, ServiceCode)
    // ...
}
```

## 5. FTP 配置迁移

### 5.1 旧代码 (v1)

```go
// 旧代码 - 获取单个 FTP 配置
ftpCache := tenant_ftp.NewCache(provider)
cfg, err := ftpCache.GetByID(ctx, tenantID)
if err != nil {
    return err
}

// 使用配置
ftpConfig := &ftp.Server{
    Host:           "0.0.0.0",
    Port:           21,
    Username:       cfg.Username,
    Password:       cfg.PasswordHash,
    HomeDirectory:  cfg.HomeDirectory,
    WritePermission: cfg.WritePermission,
}
```

### 5.2 新代码 (v2)

```go
// 新代码 - 获取所有 FTP 配置
ftpCache := tenant_ftp.NewCache(provider)
configs, err := ftpCache.GetAll(ctx, tenantID)
if err != nil {
    return err
}

// 或者仅获取活跃的配置
configs, err := ftpCache.GetActive(ctx, tenantID)
if err != nil {
    return err
}

// 为每个配置创建 FTP 服务
for _, cfg := range configs {
    ftpConfig := &ftp.Server{
        Host:           "0.0.0.0",
        Port:           21,
        Username:       cfg.Username,
        Password:       cfg.PasswordHash,
        Description:    cfg.Description,  // 新增字段
    }
    // ...
}
```

### 5.3 通过用户名查找 FTP 配置

```go
// 新增功能 - 通过用户名查找
ftpCache := tenant_ftp.NewCache(provider)
cfg, err := ftpCache.GetByUsername(ctx, "ftp_user_001")
if err != nil {
    return err
}

// 使用配置
```

## 6. 字段名称变更

### 6.1 数据库配置字段变更

| 旧字段名 (v1) | 新字段名 (v2) | 说明 |
|-------------|--------------|------|
| `dbName` | `database` | 数据库名称 |
| `password` | `password` | 可能为空，需要通过 API 获取 |
| 无 | `serviceCode` | 新增：服务代码 |
| 无 | `enabled` | 新增：是否启用 |

### 6.2 FTP 配置字段变更

| 旧字段名 (v1) | 新字段名 (v2) | 说明 |
|-------------|--------------|------|
| `passwordHash` | `passwordHash` | 保持不变 |
| `homeDirectory` | - | 移除 |
| `writePermission` | - | 移除 |
| 无 | `description` | 新增：配置描述 |
| 无 | `status` | 新增：active/inactive |

## 7. 完整迁移示例

### 7.1 evidence-management/command 迁移

**旧代码 (cmd/main.go):**
```go
func main() {
    // ...
    tenantProvider := setupTenantProvider()

    // 获取数据库配置
    dbCache := tenant_database.NewCache(tenantProvider)
    dbCfg, err := dbCache.GetByID(ctx, tenantID)
    if err != nil {
        log.Fatal(err)
    }

    // 初始化数据库
    db := setupDatabase(dbCfg)
    // ...
}
```

**新代码 (cmd/main.go):**
```go
const ServiceCode = "evidence-command"

func main() {
    // ...
    tenantProvider := setupTenantProvider()

    // 获取数据库配置（指定服务代码）
    dbCache := tenant_database.NewCache(tenantProvider)
    dbCfg, err := dbCache.GetByService(ctx, tenantID, ServiceCode)
    if err != nil {
        log.Fatal(err)
    }

    // 初始化数据库
    db := setupDatabase(dbCfg)
    // ...
}
```

### 7.2 file-storage-service 迁移

**旧代码:**
```go
// FTP 服务器配置
ftpCache := tenant_ftp.NewCache(provider)
ftpCfg, err := ftpCache.GetByID(ctx, tenantID)

server := ftp.NewServer(&ftp.Server{
    Host:     "0.0.0.0",
    Port:     21,
    Username: ftpCfg.Username,
    Password: ftpCfg.PasswordHash,
})
```

**新代码:**
```go
// FTP 服务器配置（支持多个）
ftpCache := tenant_ftp.NewCache(provider)
ftpConfigs, err := ftpCache.GetActive(ctx, tenantID)

for _, ftpCfg := range ftpConfigs {
    server := ftp.NewServer(&ftp.Server{
        Host:        "0.0.0.0",
        Port:        21,
        Username:    ftpCfg.Username,
        Password:    ftpCfg.PasswordHash,
        Description: ftpCfg.Description,
    })
    // 启动服务器
}
```

## 8. 环境变量配置

### 8.1 新增环境变量

```bash
# Tenant Service API 配置（用于获取密码）
TENANT_SERVICE_API_URL=http://tenant-service:8010
TENANT_SERVICE_API_TOKEN=your-internal-token

# 密码缓存配置
DATABASE_PASSWORD_CACHE_TTL=1h
```

### 8.2 Provider 初始化变更

**旧代码:**
```go
provider := tenant_provider.NewProvider(etcdClient,
    tenant_provider.WithNamespace("jxt/"),
    tenant_provider.WithConfigTypes(
        tenant_provider.ConfigTypeDatabase,
        tenant_provider.ConfigTypeFtp,
    ),
)
```

**新代码:**
```go
provider := tenant_provider.NewProvider(etcdClient,
    tenant_provider.WithNamespace("/jxt/"),  // 注意前缀变化
    tenant_provider.WithConfigTypes(
        tenant_provider.ConfigTypeDatabase,
        tenant_provider.ConfigTypeFtp,
    ),
    tenant_provider.WithTenantServiceAPI(
        os.Getenv("TENANT_SERVICE_API_URL"),
        os.Getenv("TENANT_SERVICE_API_TOKEN"),
    ),
)
```

## 9. 测试清单

迁移完成后，请验证以下功能：

### 9.1 数据库配置测试

- [ ] 能正确获取指定服务的数据库配置
- [ ] 密码为空时能通过 API 正确获取
- [ ] 错误的服务代码返回适当的错误
- [ ] 不存在的租户返回适当的错误

### 9.2 FTP 配置测试

- [ ] 能正确获取所有 FTP 配置
- [ ] 能正确获取活跃的 FTP 配置
- [ ] 能通过用户名查找 FTP 配置
- [ ] 无 FTP 配置时返回空列表而非错误

### 9.3 集成测试

- [ ] 服务能正常启动
- [ ] 数据库连接正常
- [ ] FTP 服务正常工作（如适用）
- [ ] ETCD watch 断线重连正常

## 10. 回滚计划

如果迁移后发现问题，可以通过以下方式回滚：

1. **临时回滚**：修改环境变量切换回 v1 API
   ```bash
   TENANT_API_VERSION=v1
   ```

2. **代码回滚**：恢复到迁移前的代码版本

3. **配置回滚**：tenant-service 停止发布 v2 格式配置

## 11. 常见问题

### Q1: 密码获取失败怎么办？

**A:** 检查以下配置：
- TENANT_SERVICE_API_URL 是否正确
- TENANT_SERVICE_API_TOKEN 是否有效
- tenant-service 是否正常运行

### Q2: 旧服务是否必须立即迁移？

**A:** 不是必须。jxt-core 提供兼容层，旧代码可以继续工作。但建议尽快迁移以获取新功能。

### Q3: 如何确定我的服务应该使用哪个 serviceCode？

**A:** 根据服务类型选择：
- 命令服务（写操作）→ `evidence-command`
- 查询服务（读操作）→ `evidence-query`
- 文件存储服务 → `file-storage`
- 其他服务 → 与 tenant-service 中定义的一致

### Q4: FTP 配置从单个变为数组，代码改动大吗？

**A:** 改动不大。主要是：
- 将单个处理改为循环处理
- 更新变量名从单数改为复数

## 12. 联系方式

如有迁移问题，请联系：
- 技术支持：[team-email]
- 文档：[doc-link]
