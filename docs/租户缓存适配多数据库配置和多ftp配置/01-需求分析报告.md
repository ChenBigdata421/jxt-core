# 租户缓存适配多数据库配置和多FTP配置 - 需求分析报告

## 1. 背景

tenant-service 项目向 etcd 中发布的租户配置结构发生了重大变化：

1. **数据库配置**：从单一数据库配置变为服务级数据库配置（每个租户可以有多个服务的数据库配置）
2. **FTP配置**：从单一FTP配置变为支持多个FTP账户配置

jxt-core/sdk/pkg/tenant/ 组件作为消费端，需要同步这些变化以保持数据一致性。

## 2. 当前架构分析

### 2.1 现有 etcd Key 结构

| 配置类型 | 现有 Key 结构 | 数据模型 |
|---------|--------------|---------|
| 租户元数据 | `jxt/tenants/{id}/meta` | TenantMeta |
| 数据库配置 | `jxt/tenants/{id}/database` | DatabaseConfig (单个) |
| FTP配置 | `jxt/tenants/{id}/ftp` | FtpConfig (单个) |
| 存储配置 | `jxt/tenants/{id}/storage` | StorageConfig |

### 2.2 jxt-core 现有数据结构

#### DatabaseConfig (provider/models.go)
```go
type DatabaseConfig struct {
    TenantID  int
    Code      string
    Name      string
    Driver    string
    DbName    string
    Host      string
    Port      int
    Username  string
    Password  string  // ⚠️ 旧结构包含密码
    SSLMode   string
    // ... 连接池和超时配置
}
```

#### FtpConfig (provider/models.go)
```go
type FtpConfig struct {
    TenantID        int
    Code            string
    Name            string
    Username        string
    PasswordHash    string
    HomeDirectory   string
    WritePermission bool
}
```

## 3. 新架构分析

### 3.1 新 etcd Key 结构

| 配置类型 | 新 Key 结构 | 数据模型 |
|---------|------------|---------|
| 服务数据库配置 | `/jxt/config/tenants/{tenant_id}/services/{service_code}/database` | ServiceDatabaseConfig |
| FTP配置 | `/tenants/{id}/ftp` | FtpConfigs (数组) |
| FTP用户索引 | `/ftp-users/{username}` | FtpUserIndex |

#### 支持的服务代码 (service_code)
- `evidence-command` - 证据管理命令服务
- `evidence-query` - 证据管理查询服务
- `file-storage` - 文件存储服务
- `security-management` - 安全管理服务

### 3.2 新数据结构

#### ServiceDatabaseConfig
```json
{
  "tenantId": int,
  "serviceCode": string,    // 新增：服务代码
  "driver": string,
  "host": string,
  "port": int,
  "database": string,       // 字段名从 dbName 改为 database
  "username": string,
  "sslMode": string,
  "maxOpenConns": int,
  "maxIdleConns": int,
  // 注意：密码不再发布到 etcd
}
```

#### FtpConfigs (新结构)
```json
{
  "tenantId": int,
  "ftpConfigs": [           // 新增：数组结构
    {
      "tenantId": int,
      "username": string,
      "passwordHash": string,
      "description": string,    // 新增：描述字段
      "status": string          // 新增：active/inactive
    }
  ]
}
```

## 4. 差异分析

### 4.1 数据库配置变更

| 方面 | 旧结构 | 新结构 | 影响 |
|-----|-------|-------|------|
| Key 命名空间 | `jxt/tenants/{id}/database` | `/jxt/config/tenants/{tenant_id}/services/{service_code}/database` | 需要更新 watch key 前缀 |
| 配置数量 | 每租户1个 | 每租户N个（每个服务1个） | 需要支持多配置 |
| 服务标识 | 无 | service_code | 需要新增字段 |
| 字段命名 | dbName | database | 字段映射 |
| 密码存储 | etcd中 | 不在etcd中，需API获取 | 需要密码获取机制 |

### 4.2 FTP配置变更

| 方面 | 旧结构 | 新结构 | 影响 |
|-----|-------|-------|------|
| Key 命名空间 | `jxt/tenants/{id}/ftp` | `/tenants/{id}/ftp` | 命名空间变化 |
| 配置数量 | 每租户1个 | 每租户N个 | 需要支持数组 |
| 新增字段 | 无 | description, status | 需要新增字段 |
| 用户索引 | 无 | `/ftp-users/{username}` | 新增索引支持 |

## 5. 重构需求

### 5.1 功能需求

#### FR1: 多数据库配置支持
- Provider 应能存储和检索每个租户的多个服务数据库配置
- 提供 `GetDatabaseConfig(tenantID, serviceCode)` 方法
- 支持 serviceCode 参数过滤

#### FR2: 多FTP配置支持
- Provider 应能存储和检索每个租户的多个FTP配置
- 提供 `GetFtpConfigs(tenantID)` 返回配置数组
- 提供 `GetFtpConfigByUsername(username)` 通过用户名查找

#### FR3: 密码获取机制
- 数据库配置不再包含密码
- 需要通过 tenant-service 内部API获取密码
- 提供密码缓存机制减少API调用

#### FR4: 向后兼容
- 保持现有公共API不变
- 通过内部适配层处理新旧结构差异
- 提供迁移指南

### 5.2 非功能需求

#### NFR1: 性能
- Copy-on-Write 读取性能保持 ~25ns
- 内存增长受控（多配置导致的内存增加）

#### NFR2: 可靠性
- ETCD watch 断线重连机制保持
- 本地缓存降级策略保持

#### NFR3: 可维护性
- 清晰的版本分离
- 充分的单元测试覆盖

## 6. 影响范围评估

### 6.1 jxt-core 内部影响

| 模块 | 影响程度 | 说明 |
|-----|---------|------|
| provider/models.go | 高 | 新增 ServiceDatabaseConfig，修改 DatabaseConfig |
| provider/provider.go | 高 | 修改 watch 逻辑、缓存结构 |
| database/cache.go | 中 | API 变更支持 serviceCode |
| ftp/cache.go | 中 | 返回类型从单个改为数组 |
| cache/file_cache.go | 低 | 序列化格式变更 |

### 6.2 消费服务影响

| 服务 | 影响程度 | 迁移方式 |
|-----|---------|---------|
| evidence-management/command | 高 | 数据库连接初始化需指定 serviceCode |
| evidence-management/query | 高 | 数据库连接初始化需指定 serviceCode |
| file-storage-service | 中 | FTP 配置改为获取列表 |
| security-management | 低 | 主要是影响其他服务 |

## 7. 风险识别

| 风险 | 级别 | 缓解措施 |
|-----|------|---------|
| 密码获取API成为性能瓶颈 | 中 | 实现本地缓存 + TTL |
| 新旧配置共存期混乱 | 中 | 明确的版本切换策略 |
| 多配置导致内存膨胀 | 低 | 评估内存占用，必要时添加限制 |
| 现有服务大量代码修改 | 高 | 提供兼容层保持API稳定 |

## 8. 迁移策略建议

### 阶段1: 准备阶段
1. 新增 v2 数据结构，保留 v1 结构
2. Provider 同时支持新旧两种 key 格式

### 阶段2: 适配阶段
1. 消费服务逐步迁移到新 API
2. 监控新旧格式使用情况

### 阶段3: 清理阶段
1. 确认无 v1 格式使用后移除
2. 清理兼容代码

## 9. 总结

本次重构是必要的，主要变化：

1. **数据库配置**：从单一配置变为服务级多配置，需要支持 serviceCode 维度
2. **FTP配置**：从单一配置变为多配置数组
3. **密码安全**：密码不再存储在 etcd，需要新的获取机制

建议采用渐进式迁移策略，先支持新格式，再逐步迁移消费服务。
