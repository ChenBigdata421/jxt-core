# 设计文档评审与修正

## 1. 评审概述

本文档是对《01-需求分析报告》和《02-详细设计方案》的评审，基于对 tenant-service 实际代码和 etcd 中实际数据的深入分析。

## 2. 实际数据结构验证

### 2.1 ETCD 实际 Key 结构（已验证）

通过查询 etcd 实际数据，确认以下 Key 结构：

| 配置类型 | 实际 Key | 示例 |
|---------|---------|------|
| 服务数据库配置 | `jxt//jxt/config/tenants/{tenantId}/services/{serviceCode}/database` | `jxt//jxt/config/tenants/1/services/evidence-command/database` |
| FTP配置 | `jxt//tenants/{tenantId}/ftp` | `jxt//tenants/1/ftp` |
| FTP用户索引 | `jxt//ftp-users/{username}` | `jxt//ftp-users/default_ftp` |
| 租户元数据 | `jxt//tenants/{tenantId}/meta` | `jxt//tenants/1/meta` |

### 2.2 实际数据结构（已验证）

#### 服务数据库配置（从 etcd 查询）
```json
{
  "database": "tenant_default_evidence_command",
  "driver": "mysql",
  "host": "mysql-command",
  "maxIdleConns": 20,
  "maxOpenConns": 100,
  "port": 3306,
  "serviceCode": "evidence-command",
  "sslMode": "disable",
  "tenantId": 1,
  "username": "tenant_default_cmd"
}
```

#### FTP配置（从 etcd 查询）
```json
{
  "tenantId": 1,
  "ftpConfigs": [
    {
      "tenantId": 1,
      "username": "default_ftp",
      "passwordHash": "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy",
      "description": "",
      "status": "active"
    }
  ]
}
```

#### FTP用户索引（从 etcd 查询）
```json
{
  "code": "default",
  "name": "默认租户",
  "tenantId": 1
}
```

## 3. 关键发现与修正

### 3.1 双斜杠问题 ⚠️

**问题**：etcd 中的 Key 前缀是 `jxt//` 而非 `jxt/`

**原因分析**：
- tenant-service 中 etcd 配置的 namespace 可能设置为 `jxt/`
- 发布 Key 时又添加了 `/` 前缀
- 导致最终 Key 为 `jxt//` + 具体路径

**影响**：
- jxt-core Provider 的 Watch 前缀需要适配 `jxt//`
- 需要确认这是设计预期还是配置 bug

**建议**：
1. 检查 tenant-service 的 etcd namespace 配置
2. 统一 Key 前缀规范
3. 在 jxt-core 中添加兼容性处理

### 3.2 数据库配置字段缺失 ⚠️

**原设计文档中包含的字段**：
```go
ConnMaxIdleTime int
ConnMaxLifeTime int
ConnectTimeout  int
ReadTimeout     int
WriteTimeout    int
Enabled         bool
```

**实际 etcd 中没有这些字段**！

**原因**：
查看 `etcd_publisher.go` 的 `PublishTenantServiceDatabaseConfig` 方法（第504-563行）：

```go
data := map[string]interface{}{
    "tenantId":     cfg.GetTenantId(),
    "serviceCode":  cfg.GetServiceCode(),
    "driver":       cfg.GetDriver(),
    "host":         cfg.GetHost(),
    "port":         cfg.GetPort(),
    "database":     cfg.GetDatabase(),
    "username":     cfg.GetUsername(),
    "sslMode":      cfg.GetSSLMode(),
    "maxOpenConns": cfg.GetMaxOpenConns(),
    "maxIdleConns": cfg.GetMaxIdleConns(),
    // 注意：密码不发布到 etcd
}
```

**这些字段存在于数据库表但未发布到 etcd**：
- `ConnMaxIdleTime` - 连接最大空闲时间
- `ConnMaxLifeTime` - 连接最大生命周期
- `ConnectTimeout` - 连接超时
- `ReadTimeout` - 读超时
- `WriteTimeout` - 写超时
- `Enabled` - 是否启用

**修正方案**：
1. **方案A（推荐）**：修改 tenant-service 发布逻辑，添加这些字段到 etcd
2. **方案B**：在 jxt-core 中使用默认值填充这些字段
3. **方案C**：消费服务从其他来源获取这些配置

### 3.3 ServiceDatabaseConfig 结构修正

**修正后的结构**：

```go
// ServiceDatabaseConfig v2 - 服务级数据库配置（基于实际 etcd 数据）
type ServiceDatabaseConfig struct {
    TenantID    int    `json:"tenantId"`
    ServiceCode string `json:"serviceCode"`
    Driver      string `json:"driver"`
    Host        string `json:"host"`
    Port        int    `json:"port"`
    Database    string `json:"database"`
    Username    string `json:"username"`
    SSLMode     string `json:"sslMode"`
    MaxOpenConns int   `json:"maxOpenConns"`
    MaxIdleConns int   `json:"maxIdleConns"`
    // 注意：以下字段不在 etcd 中，需要默认值
    ConnMaxIdleTime int `json:"-"` // 不从 etcd 读取
    ConnMaxLifeTime int `json:"-"` // 不从 etcd 读取
    ConnectTimeout  int `json:"-"` // 不从 etcd 读取
    ReadTimeout     int `json:"-"` // 不从 etcd 读取
    WriteTimeout    int `json:"-"` // 不从 etcd 读取
    Enabled         bool `json:"-"` // 不从 etcd 读取
}
```

### 3.4 命名规范修正

**发现**：etcd 中使用 camelCase 命名（如 `tenantId`, `serviceCode`, `maxOpenConns`）

**修正**：确保 jxt-core 的 JSON 标签与 etcd 保持一致

```go
type ServiceDatabaseConfig struct {
    TenantID    int    `json:"tenantId"`    // 正确
    ServiceCode string `json:"serviceCode"` // 正确
    MaxOpenConns int   `json:"maxOpenConns"` // 正确
    // ...
}
```

### 3.5 密码获取机制分析

**重要发现**：
1. **密码确实不在 etcd 中** ✓
2. **但 tenant-service 目前没有提供密码查询 API** ✗

**现状**：
- `TenantServiceDatabaseConfig` 聚合根有 `Password` 字段（加密存储）
- `PublishTenantServiceDatabaseConfig` 方法明确注释"密码不发布到 etcd"
- **但是**没有找到对应的密码查询 API 端点

**问题**：
- 原设计中的 `GetDatabasePassword` API 无法实现
- 需要新增 tenant-service API 或其他密码获取方式

**建议**：
1. 在 tenant-service 中新增内部 API 端点：`GET /api/v1/internal/tenants/{tenantId}/services/{serviceCode}/database/password`
2. 或者在服务启动时直接从数据库读取完整配置（包括密码）
3. 或者使用服务间 gRPC 调用获取密码

## 4. FTP 配置分析

### 4.1 FTP 配置结构（已确认正确）

```go
// FtpConfigDetail v2 - FTP配置详情
type FtpConfigDetail struct {
    TenantID     int    `json:"tenantId"`
    Username     string `json:"username"`
    PasswordHash string `json:"passwordHash"` // bcrypt hash
    Description  string `json:"description"`
    Status       string `json:"status"` // active, inactive
}
```

### 4.2 FTP 用户索引结构（已确认）

```go
// FtpUserIndex - FTP用户到租户的映射
type FtpUserIndex struct {
    TenantID int    `json:"tenantId"`
    Code     string `json:"code"`  // 租户编码
    Name     string `json:"name"`  // 租户名称
}
```

### 4.3 FTP 配置删除逻辑

**发现**：`DeleteFtpConfig` 方法（etcd_publisher_ext.go 第233-264行）表明：
- 删除单个 FTP 配置时，会重新发布剩余的所有 FTP 配置
- 如果没有剩余配置，则删除整个 Key

**含义**：FTP 配置必须以完整数组形式存储

## 5. 修订后的数据结构

### 5.1 Provider 层数据结构（修订版）

```go
// provider/models.go

// tenantData v2 - 支持多数据库和多FTP配置（修订版）
type tenantData struct {
    Metas    map[int]*TenantMeta                          `json:"metas"`
    Databases map[int]map[string]*ServiceDatabaseConfig   `json:"databases"` // tenantID -> serviceCode -> config
    Ftps      map[int][]*FtpConfigDetail                  `json:"ftps"`       // tenantID -> configs[]
    FtpUsers  map[string]*FtpUserIndex                    `json:"ftpUsers"`   // username -> index (新增)
    Storages  map[int]*StorageConfig                      `json:"storages"`
}

// ServiceDatabaseConfig v2（修订版 - 仅包含 etcd 中的字段）
type ServiceDatabaseConfig struct {
    TenantID    int    `json:"tenantId"`
    ServiceCode string `json:"serviceCode"`
    Driver      string `json:"driver"`
    Host        string `json:"host"`
    Port        int    `json:"port"`
    Database    string `json:"database"`
    Username    string `json:"username"`
    SSLMode     string `json:"sslMode"`
    MaxOpenConns int   `json:"maxOpenConns"`
    MaxIdleConns int   `json:"maxIdleConns"`
}

// FtpConfigDetail v2（修订版）
type FtpConfigDetail struct {
    TenantID     int    `json:"tenantId"`
    Username     string `json:"username"`
    PasswordHash string `json:"passwordHash"`
    Description  string `json:"description"`
    Status       string `json:"status"` // active, inactive
}

// FtpUserIndex v2（修订版）
type FtpUserIndex struct {
    TenantID int    `json:"tenantId"`
    Code     string `json:"code"`
    Name     string `json:"name"`
}
```

### 5.2 Watch Key 前缀（修订版）

```go
const (
    // 注意：实际 etcd 中有双斜杠 jxt//
    // 可能是 namespace="jxt/" 且 key 以 "/" 开头导致
    PrefixTenant          = "jxt//tenants/"
    PrefixServiceDatabase = "jxt//jxt/config/tenants/"
    PrefixFtpUser         = "jxt//ftp-users/"
)
```

## 6. 需要澄清的问题

### 6.1 双斜杠问题
- [ ] 确认 `jxt//` 是预期设计还是配置 bug
- [ ] 如果是 bug，是否需要修复 tenant-service
- [ ] jxt-core 是否需要同时支持两种前缀

### 6.2 密码获取方案
- [ ] 确认 tenant-service 是否提供密码查询 API
- [ ] 如果没有，选择哪种方案：
  - 新增 API
  - 直接读数据库
  - 其他方式

### 6.3 缺失字段处理
- [ ] 是否修改 tenant-service 发布完整字段
- [ ] 或在 jxt-core 中使用默认值

## 7. 修订建议

### 7.1 短期修正（必须）
1. 修正 `ServiceDatabaseConfig` 结构，移除不在 etcd 中的字段
2. 添加 `FtpUserIndex` 结构和对应的 Watch
3. 修正 Watch Key 前缀为 `jxt//`
4. 添加默认值填充逻辑

### 7.2 中期优化（建议）
1. 与 tenant-service 团队协调，统一 Key 前缀
2. 补充密码获取 API 设计
3. 完善缺失字段的发布

### 7.3 长期规划（可选）
1. 考虑将完整配置（包括超时参数）发布到 etcd
2. 添加配置版本控制
3. 实现配置变更通知机制

## 8. 更新后的文档清单

| 文档 | 状态 | 说明 |
|-----|------|------|
| 01-需求分析报告.md | 需更新 | 添加双斜杠问题、缺失字段问题 |
| 02-详细设计方案.md | 需更新 | 修正数据结构、Watch 逻辑 |
| 03-服务迁移指南.md | 需更新 | 添加密码获取说明 |
| 04-设计文档评审与修正.md | ✓ | 本文档 |

## 9. 后续行动

1. **立即执行**：
   - 修正 `ServiceDatabaseConfig` 结构定义
   - 添加 `FtpUserIndex` 支持
   - 更新 Watch Key 前缀

2. **协调确认**：
   - 与 tenant-service 团队确认双斜杠问题
   - 确认密码获取方案
   - 确认缺失字段处理方式

3. **实施调整**：
   - 根据确认结果调整实施方案
   - 更新相关设计文档
   - 更新单元测试用例
