# 每个租户支持多个FTP配置 - 设计文档

## 1. 需求背景

当前 tenant-service 中每个租户只能有一个 FTP 配置（`TenantId` 有 uniqueIndex 约束）。

**业务场景**：租户下属的不同部门或客户需要独立的 FTP 配置。

**目标**：支持一个租户可以创建多个 FTP 配置。

## 2. 数据库设计

### 2.1 Schema 变更

**原表结构**:
```go
type TenantFtpConfig struct {
    Id           int64  `gorm:"primaryKey;autoIncrement"`
    TenantId     int    `gorm:"uniqueIndex;not null"`          // ❌ 每个租户只能有一条
    Username     string `gorm:"size:64;not null;uniqueIndex:idx_ftp_username"`
    PasswordHash string `gorm:"size:255;not null"`
    CreatedAt    time.Time
    UpdatedAt    time.Time
}
```

**新表结构**:
```go
type TenantFtpConfig struct {
    Id           int64     `gorm:"primaryKey;autoIncrement"`
    TenantId     int       `gorm:"index:idx_tenant_ftp;not null"`        // ✅ 改为普通索引
    Username     string    `gorm:"size:64;not null;uniqueIndex:idx_ftp_username"`
    PasswordHash string    `gorm:"size:255;not null"`
    Description  string    `gorm:"size:255"`                            // ✅ 新增：用于标识不同FTP
    Status       string    `gorm:"size:16;default:active"`              // ✅ 新增：active, inactive
    CreatedAt    time.Time `json:"createdAt"`
    UpdatedAt    time.Time `json:"updatedAt"`
    DeletedAt    *time.Time `gorm:"index"`                              // ✅ 新增：软删除支持
}
```

### 2.2 SQL 迁移脚本

```sql
-- 1. 修改 TenantId 索引（uniqueIndex -> 普通索引）
DROP INDEX idx_tenant_ftp_configs_tenant_id ON tenant_ftp_configs;
CREATE INDEX idx_tenant_ftp ON tenant_ftp_configs(tenant_id);

-- 2. 添加新字段
ALTER TABLE tenant_ftp_configs ADD COLUMN description VARCHAR(255);
ALTER TABLE tenant_ftp_configs ADD COLUMN status VARCHAR(16) DEFAULT 'active';
ALTER TABLE tenant_ftp_configs ADD COLUMN deleted_at TIMESTAMP;

-- 3. 为 deleted_at 添加索引（软删除）
CREATE INDEX idx_tenant_ftp_configs_deleted_at ON tenant_ftp_configs(deleted_at);
```

## 3. API 接口设计

### 3.1 接口清单

| 方法   | 路径                                    | 说明           |
|--------|-----------------------------------------|----------------|
| POST   | `/api/v1/tenants/{id}/ftp`              | 创建FTP配置    |
| GET    | `/api/v1/tenants/{id}/ftp`              | 获取FTP配置列表 |
| GET    | `/api/v1/tenants/{id}/ftp/{ftpId}`      | 获取指定FTP配置 |
| PUT    | `/api/v1/tenants/{id}/ftp/{ftpId}`      | 更新FTP配置    |
| DELETE | `/api/v1/tenants/{id}/ftp/{ftpId}`      | 删除FTP配置    |

### 3.2 DTO 定义

```go
// 创建FTP配置请求
type CreateFtpConfigReq struct {
    TenantId    int    `json:"tenantId" binding:"required"`
    Username    string `json:"username" binding:"required"`
    Password    string `json:"password" binding:"required"`
    Description string `json:"description"`
}

// 更新FTP配置请求
type UpdateFtpConfigReq struct {
    Description string `json:"description"`
    Password    string `json:"password"`
    Status      string `json:"status" binding:"omitempty,oneof=active inactive"`
}

// FTP配置响应
type FtpConfigResp struct {
    Id          int64     `json:"id"`
    TenantId    int       `json:"tenantId"`
    Username    string    `json:"username"`
    Description string    `json:"description"`
    Status      string    `json:"status"`
    CreatedAt   time.Time `json:"createdAt"`
    UpdatedAt   time.Time `json:"updatedAt"`
}

// FTP配置列表响应
type FtpConfigListResp struct {
    Total int               `json:"total"`
    Items []FtpConfigResp   `json:"items"`
}
```

### 3.3 API Handler 示例

```go
// CreateFtpConfig 创建FTP配置
func (a *TenantApi) CreateFtpConfig(c *gin.Context) {
    tenantId, err := parseIDParam(c, "id")
    if err != nil {
        a.Error(c, 400, err, "租户ID格式错误")
        return
    }

    var req dto.CreateFtpConfigReq
    if !a.BindAndValidate(c, &req) {
        return
    }
    req.TenantId = tenantId

    config, err := a.service.CreateFtpConfig(c.Request.Context(), &req)
    if err != nil {
        a.Error(c, 500, err, "创建失败")
        return
    }

    var resp dto.FtpConfigResp
    resp.FromAggregate(config)
    a.OK(c, resp, "创建成功")
}

// ListFtpConfigs 获取FTP配置列表
func (a *TenantApi) ListFtpConfigs(c *gin.Context) {
    tenantId, err := parseIDParam(c, "id")
    if err != nil {
        a.Error(c, 400, err, "租户ID格式错误")
        return
    }

    configs, err := a.service.ListFtpConfigs(c.Request.Context(), tenantId)
    if err != nil {
        a.Error(c, 500, err, "查询失败")
        return
    }

    resp := dto.FtpConfigListResp{Items: make([]dto.FtpConfigResp, len(configs))}
    for i, cfg := range configs {
        resp.Items[i].FromAggregate(&cfg)
    }
    resp.Total = len(configs)

    a.OK(c, resp, "查询成功")
}

// UpdateFtpConfig 更新FTP配置
func (a *TenantApi) UpdateFtpConfig(c *gin.Context) {
    tenantId, err := parseIDParam(c, "id")
    if err != nil {
        a.Error(c, 400, err, "租户ID格式错误")
        return
    }

    ftpId, err := parseIDParam(c, "ftpId")
    if err != nil {
        a.Error(c, 400, err, "FTP配置ID格式错误")
        return
    }

    var req dto.UpdateFtpConfigReq
    if !a.BindAndValidate(c, &req) {
        return
    }

    if err := a.service.UpdateFtpConfig(c.Request.Context(), tenantId, ftpId, &req); err != nil {
        a.Error(c, 500, err, "更新失败")
        return
    }

    a.OK(c, nil, "更新成功")
}

// DeleteFtpConfig 删除FTP配置（软删除）
func (a *TenantApi) DeleteFtpConfig(c *gin.Context) {
    tenantId, err := parseIDParam(c, "id")
    if err != nil {
        a.Error(c, 400, err, "租户ID格式错误")
        return
    }

    ftpId, err := parseIDParam(c, "ftpId")
    if err != nil {
        a.Error(c, 400, err, "FTP配置ID格式错误")
        return
    }

    if err := a.service.DeleteFtpConfig(c.Request.Context(), tenantId, ftpId); err != nil {
        a.Error(c, 500, err, "删除失败")
        return
    }

    a.OK(c, nil, "删除成功")
}
```

## 4. 业务逻辑

### 4.1 验证规则

1. **Username 全局唯一**：一个 FTP user 只能属于一个租户
2. **TenantId 必须存在**且状态为 `active`
3. **Description**：建议填写以便区分同一租户下的多个 FTP
4. **密码安全**：必须经过 bcrypt 哈希后存储

### 4.2 软删除处理

- 使用 GORM 的软删除机制 (`DeletedAt`)
- 查询时自动过滤已删除记录
- Username 唯一性约束考虑软删除情况（软删除后的 username 可复用）

### 4.3 File-Storage-Service 影响

- FTP username 认证时，可以直接查询到唯一的租户
- **无需改动**现有认证逻辑

## 5. 代码变更清单

| 序号 | 文件                                                      | 变更说明                                 |
|------|-----------------------------------------------------------|------------------------------------------|
| 1    | `cmd/migrate/migration/models/tenant.go`                  | 更新模型定义（添加新字段）                |
| 2    | `tenant/domain/aggregate/tenant_ftp_config.go`            | 添加新字段、修改 uniqueIndex 标签         |
| 3    | `tenant/application/dto/tenant_config.go`                 | 新增 DTO                                 |
| 4    | `tenant/application/service/port/tenant.go`               | 更新接口定义                             |
| 5    | `tenant/application/service/tenant.go`                    | 实现新业务逻辑                           |
| 6    | `tenant/interface/rest/api/tenant_config.go`              | 新增/修改 API handlers                   |
| 7    | `tenant/interface/rest/router/tenant.go`                  | 更新路由                                 |
| 8    | 新增 Ginkgo 测试                                          | API 测试、Service 测试                   |

## 6. 验证步骤

```bash
# 1. 运行数据库迁移
cd tenant-service
make m

# 2. 重新编译
make b

# 3. 运行测试
ginkgo -v

# 4. 启动服务验证
./tenant-service server -c config/settings.yml
```

## 7. API 测试示例

```bash
# 创建FTP配置
curl -X POST http://localhost:8010/api/v1/tenants/1/ftp \
  -H "Content-Type: application/json" \
  -d '{
    "username": "tenant1_sales_ftp",
    "password": "password123",
    "description": "销售部FTP"
  }'

# 获取FTP配置列表
curl http://localhost:8010/api/v1/tenants/1/ftp

# 更新FTP配置
curl -X PUT http://localhost:8010/api/v1/tenants/1/ftp/1 \
  -H "Content-Type: application/json" \
  -d '{
    "description": "销售部FTP（已更新）"
  }'

# 删除FTP配置
curl -X DELETE http://localhost:8010/api/v1/tenants/1/ftp/1
```

## 8. 注意事项

1. 项目未上生产环境，无需考虑前后兼容和数据迁移
2. Username 保持全局唯一性，确保 FTP 认证逻辑不受影响
3. 软删除后 Username 是否可复用，需根据业务需求确定
