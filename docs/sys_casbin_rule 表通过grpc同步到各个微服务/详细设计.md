# sys_casbin_rule è¡¨é€šè¿‡ gRPC åŒæ­¥åˆ°å„ä¸ªå¾®æœåŠ¡ - è®¾è®¡æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| åˆ›å»ºæ—¥æœŸ | 2026-02-08 |
| ç‰ˆæœ¬ | v2.0 |
| çŠ¶æ€ | è®¾è®¡ä¸­ |
| ä½œè€… | æ¶æ„å›¢é˜Ÿ |

> **é¡¹ç›®èƒŒæ™¯**ï¼šæœ¬ç³»ç»Ÿå°šæœªç”Ÿäº§éƒ¨ç½²ï¼Œä¸å­˜åœ¨çº¿ä¸Šç”¨æˆ·å’Œè¿è¡Œä¸­çš„æœåŠ¡å®ä¾‹ã€‚å› æ­¤æœ¬æ–¹æ¡ˆé‡‡ç”¨**ä¸€æ¬¡æ€§åˆ‡æ¢**ç­–ç•¥â€”â€”ç›´æ¥å°†æ‰€æœ‰å¾®æœåŠ¡ä»æ—§çš„æ•°æ®åº“ç›´è¿æ–¹å¼æ›¿æ¢ä¸º gRPC Provider æ–¹å¼ï¼Œæ— éœ€ç°åº¦å‘å¸ƒã€é…ç½®å¼€å…³æˆ–æ–°æ—§æ¨¡å¼å¹¶å­˜çš„è¿‡æ¸¡æœºåˆ¶ã€‚

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å„æœåŠ¡ Casbin ç­–ç•¥åŠ è½½ç°çŠ¶

å½“å‰ç³»ç»Ÿä¸­ï¼Œä¸åŒå¾®æœåŠ¡çš„ Casbin ç­–ç•¥åŠ è½½æ–¹å¼**å¹¶ä¸ç»Ÿä¸€**ï¼š

| æœåŠ¡ | ç­–ç•¥æ•°æ®æ¥æº | è¿æ¥åœ°å€ | Casbin API | è¡¨å |
|------|-------------|---------|------------|------|
| **security-management** | å¤šç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“ï¼ˆETCD è·å–é…ç½®ï¼‰ | å„ç§Ÿæˆ·ç‹¬ç«‹ DB | `SetupForTenant(db, tenantID)` | `sys_casbin_rule` |
| **evidence-management** (command) | ç›´è¿ security-management çš„æ•°æ®åº“ | `postgres-security:5432/securitydb` | `Setup(db, "")` (å·²åºŸå¼ƒ) | `sys_casbin_rule`* |
| **file-storage-service** | æœ¬æœåŠ¡ç‹¬ç«‹æ•°æ®åº“ | `postgres-file-storage-service:5432/file_storage_service_db` | `Setup(db, "")` (å·²åºŸå¼ƒ) | `sys_casbin_rule` |
| **tenant-service** | æœ¬æœåŠ¡ç‹¬ç«‹æ•°æ®åº“ | å„è‡ªé…ç½® | `Setup(db, "")` (å·²åºŸå¼ƒ) | `sys_casbin_rule` |

> \* evidence-management çš„è¿ç§»æ¨¡å‹å®šä¹‰ä¸º `sys_casbin_rules`ï¼ˆå¤æ•°ï¼‰ï¼Œä½† `gormAdapter` å®é™…åˆ›å»ºçš„è¡¨ä¸º `sys_casbin_rule`ï¼ˆå•æ•°ï¼‰ï¼Œå­˜åœ¨ä¸ä¸€è‡´ã€‚

**å…³é”®å‘ç°ï¼š**

1. **åªæœ‰ evidence-management ç›´è¿äº† security-management çš„æ•°æ®åº“**ã€‚å…¶ `masterDB` é…ç½®å¦‚ä¸‹ï¼š

```yaml
# evidence-management/command/config/settings.yml
database:
  masterDB: # å­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼Œè§’è‰²ä¿¡æ¯ï¼Œæƒé™ä¿¡æ¯
    driver: postgres
    source: postgres://tenant:123456@postgres-security:5432/securitydb
```

2. **file-storage-service å’Œ tenant-service ä½¿ç”¨å„è‡ªç‹¬ç«‹æ•°æ®åº“**ï¼ŒCasbin è§„åˆ™å­˜å‚¨åœ¨å„è‡ªçš„ `sys_casbin_rule` è¡¨ä¸­ã€‚

3. **security-management å·²å®Œå…¨é‡‡ç”¨å¤šç§Ÿæˆ·æ¶æ„**ï¼Œä¸å†æœ‰ `database.masterDB` é…ç½®ï¼š

```yaml
# security-management/config/settings.yml
# æ³¨æ„ï¼š
# æœ¬æœåŠ¡å®Œå…¨é‡‡ç”¨å¤šç§Ÿæˆ·æ¶æ„ï¼Œæ‰€æœ‰ç§Ÿæˆ·çš„æ•°æ®åº“é…ç½®éƒ½ä» ETCD è·å–
# ä¸éœ€è¦é…ç½®é»˜è®¤æ•°æ®åº“è¿æ¥ï¼ˆdatabase.masterDB å·²ç§»é™¤ï¼‰
```

4. **åªæœ‰ security-management å·²è¿ç§»åˆ° `SetupForTenant`**ï¼Œå…¶ä»–ä¸‰ä¸ªæœåŠ¡ä»ä½¿ç”¨å·²åºŸå¼ƒçš„ `Setup(db, "")` å‡½æ•°ã€‚

### 1.2 æ¶æ„å›¾ï¼ˆç°çŠ¶ï¼‰

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚    security-management       â”‚
                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                            â”‚  â”‚  ETCD â†’ å„ç§Ÿæˆ·ç‹¬ç«‹ DB    â”‚  â”‚
                            â”‚  â”‚  SetupForTenant(db, id) â”‚  â”‚
                            â”‚  â”‚  â†’ sys_casbin_rule      â”‚  â”‚
                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                            â”‚            â†‘                 â”‚
                            â”‚            â”‚ DB: securitydb  â”‚
                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                            â”‚  â”‚   port 5432      â”‚       â”‚
                            â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â†‘
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ ç›´è¿ (masterDB)     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
           â”‚ evidence-mgmt   â”‚          â”‚
           â”‚ (command)       â”‚          â”‚
           â”‚ Setup(db, "")   â”‚          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                                        â”‚  â† ä¸å­˜åœ¨ç›´è¿!
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
           â”‚ file-storage    â”‚â”€â”€â”€â”€ âœ• â”€â”€â”€â”˜
           â”‚ ç‹¬ç«‹ DB          â”‚
           â”‚ Setup(db, "")   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ tenant-service  â”‚
           â”‚ ç‹¬ç«‹ DB          â”‚
           â”‚ Setup(db, "")   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å­˜åœ¨çš„é—®é¢˜

#### 1.3.1 æ•°æ®åº“å±‚é¢è€¦åˆï¼ˆevidence-managementï¼‰

evidence-management çš„ `masterDB` ç›´è¿ security-management çš„ `securitydb`ï¼Œè¿åäº†å¾®æœåŠ¡çš„æ•°æ®ç‹¬ç«‹æ€§åŸåˆ™ï¼š
- æ•°æ®åº“å¯†ç ã€Schema å˜æ›´ç­‰éœ€è¦è·¨æœåŠ¡åè°ƒ
- è¿æ¥æ± èµ„æºè¢«å¤–éƒ¨æœåŠ¡æ¶ˆè€—
- æ— æ³•ç‹¬ç«‹æ‰©ç¼©å®¹æ•°æ®åº“

#### 1.3.2 ç­–ç•¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆfile-storage-serviceã€tenant-serviceï¼‰

è¿™ä¸¤ä¸ªæœåŠ¡ä½¿ç”¨å„è‡ªç‹¬ç«‹æ•°æ®åº“ä¸­çš„ `sys_casbin_rule` è¡¨ï¼Œä½†**è§„åˆ™æ•°æ®çš„æ¥æºå’ŒåŒæ­¥æœºåˆ¶ä¸æ˜ç¡®**ï¼š
- å¦‚ä½•ä¿è¯å„æœåŠ¡çš„ç­–ç•¥è§„åˆ™ä¸ security-management ä¿æŒä¸€è‡´ï¼Ÿ
- å½“ security-management çš„ç­–ç•¥æ›´æ–°æ—¶ï¼Œè¿™äº›ç‹¬ç«‹æ•°æ®åº“ä¸­çš„è§„åˆ™å¦‚ä½•æ›´æ–°ï¼Ÿ

#### 1.3.3 API ç‰ˆæœ¬ä¸ç»Ÿä¸€

security-management å·²ä½¿ç”¨ `SetupForTenant(db, tenantID int)`ï¼ˆæ”¯æŒå¤šç§Ÿæˆ·ï¼‰ï¼Œå…¶ä½™æœåŠ¡ä»ä½¿ç”¨å·²åºŸå¼ƒçš„ `Setup(db, "")` å‡½æ•°ã€‚

---

## 2. è®¾è®¡ç›®æ ‡

### 2.1 æ ¸å¿ƒç›®æ ‡

1. **è§£è€¦æ•°æ®åº“ä¾èµ–**ï¼šæ‰€æœ‰å¾®æœåŠ¡ä¸å†ç›´è¿ security-management çš„æ•°æ®åº“ï¼Œä¹Ÿä¸åœ¨æœ¬åœ°ç»´æŠ¤ `sys_casbin_rule` è¡¨
2. **ç»Ÿä¸€ç­–ç•¥æ¥æº**ï¼šæ‰€æœ‰ Casbin ç­–ç•¥è§„åˆ™ç»Ÿä¸€ä» security-management é€šè¿‡ gRPC è·å–
3. **é›¶æ€§èƒ½å½±å“**ï¼š`Enforce()` ä»ä¸ºæœ¬åœ°å†…å­˜æ“ä½œï¼›ä»… `LoadPolicy()`ï¼ˆä½é¢‘æ“ä½œï¼‰èµ° gRPC
4. **å¤šç§Ÿæˆ·æ”¯æŒ**ï¼šgRPC æ¥å£æ„ŸçŸ¥ç§Ÿæˆ· IDï¼Œæ”¯æŒæŒ‰ç§Ÿæˆ·æŸ¥è¯¢ç­–ç•¥
5. **ç»Ÿä¸€ API**ï¼šæ‰€æœ‰æœåŠ¡ç»Ÿä¸€ä½¿ç”¨æ–°çš„ `SetupWithGrpc` å‡½æ•°


### 2.2 éç›®æ ‡

1. **ä¸æ”¹å˜ Casbin æ¨¡å‹å®šä¹‰**ï¼šRBAC æ¨¡å‹ï¼ˆ`r = sub, obj, act`ï¼‰ä¿æŒä¸å˜
2. **ä¸æ”¹å˜ Redis Watcher çš„é€šçŸ¥æœºåˆ¶**ï¼šRedis pub/sub é¢‘é“ï¼ˆ`/casbin/tenant/{tenantID}`ï¼‰å’Œè§¦å‘æ–¹å¼ä¸å˜ï¼Œä½†ç­–ç•¥åŠ è½½çš„åº•å±‚ä»æ•°æ®åº“æ”¹ä¸º gRPC
3. **ä¸æ”¹å˜æƒé™åˆ¤æ–­é€»è¾‘**ï¼š`Enforce()` çš„è°ƒç”¨æ–¹å¼å’Œä¸šåŠ¡é€»è¾‘ä¸å˜
4. **ä¸æ”¹å˜ security-management è‡ªèº«çš„ç­–ç•¥åŠ è½½æ–¹å¼**ï¼šsecurity-management ä½œä¸ºæ•°æ®æºï¼Œç»§ç»­ä½¿ç”¨ `gormAdapter` + æœ¬åœ°æ•°æ®åº“

> **å·²çŸ¥é™åˆ¶ï¼š`[role_definition]` æœªåŒ…å«åœ¨æ¨¡å‹ä¸­**
>
> å½“å‰ `jxt-core/sdk/pkg/casbin/mycasbin.go` ä¸­çš„ Casbin æ¨¡å‹å®šä¹‰ä¸åŒ…å« `[role_definition]` æ®µã€‚
> è¿™æ„å‘³ç€æ•°æ®åº“ä¸­å¦‚æœå­˜åœ¨ `g` ç±»å‹ï¼ˆè§’è‰²ç»§æ‰¿ï¼‰çš„ç­–ç•¥è§„åˆ™ï¼Œ`persist.LoadPolicyLine()` ä¼š**é™é»˜è·³è¿‡**è¿™äº›è§„åˆ™ã€‚
>
> **å½“å‰å½±å“**ï¼šæ— ã€‚ç»ä»£ç å®¡æŸ¥ç¡®è®¤ï¼Œå½“å‰ç³»ç»Ÿ**ä¸ä¾èµ–è§’è‰²ç»§æ‰¿**ï¼š
> - ç”Ÿäº§ä»£ç åªé€šè¿‡ `AddNamedPolicies("p", ...)` å†™å…¥ `p` ç±»å‹ç­–ç•¥ï¼ˆè§ `sys_role_repository.go`ï¼‰
> - `Enforce()` ç›´æ¥ä¼ å…¥ `rolekey`ï¼ˆå¦‚ `"editor"`ï¼‰ï¼Œä½¿ç”¨ `r.sub == p.sub` ç›´æ¥åŒ¹é…ï¼Œä¸ç»è¿‡ `g(r.sub, p.sub)` è§’è‰²è§£æ
> - `g` ç±»å‹è§„åˆ™ä»…å­˜åœ¨äºæµ‹è¯•è¾…åŠ©ä»£ç ä¸­ï¼ˆ`DefaultCasbinGrouping()`ï¼‰ï¼Œç”¨äºéªŒè¯ gRPC æ¥å£çš„æ•°æ®ä¼ è¾“èƒ½åŠ›
>
> **æœªæ¥æ‰©å±•**ï¼šå¦‚æœéœ€è¦æ”¯æŒè§’è‰²ç»§æ‰¿ï¼ˆç”¨æˆ·â†’è§’è‰²æ˜ å°„ï¼‰ï¼Œéœ€å¦å¼€ issueï¼š
> 1. åœ¨æ¨¡å‹ä¸­æ·»åŠ  `[role_definition] g = _, _`
> 2. å°† matcher æ”¹ä¸º `g(r.sub, p.sub) && ...`
> 3. æ·»åŠ å¯¹åº”çš„ `AddGroupingPolicy` è°ƒç”¨
>
> æ­¤é™åˆ¶ä¸åœ¨æœ¬æ¬¡ gRPC ç­–ç•¥åŒæ­¥æ”¹é€ èŒƒå›´å†…ã€‚

---

## 3. è§£å†³æ–¹æ¡ˆè®¾è®¡

### 3.1 ç›®æ ‡æ¶æ„

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚        security-management           â”‚
                        â”‚                                      â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                        â”‚  â”‚ ETCD â†’ ç§Ÿæˆ·DB â”‚  â”‚ gRPC :9000   â”‚  â”‚
                        â”‚  â”‚ gormAdapter  â”‚  â”‚              â”‚  â”‚
                        â”‚  â”‚ sys_casbin_  â”‚  â”‚ CasbinPolicy â”‚  â”‚
                        â”‚  â”‚ rule (per DB)â”‚  â”‚ Service      â”‚  â”‚
                        â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                        â”‚         â”‚  DBæŸ¥è¯¢          â”‚ gRPC API â”‚
                        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚ gRPC (GetPolicies)
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                        â”‚                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ evidence-mgmt    â”‚    â”‚ file-storage      â”‚    â”‚ tenant-service   â”‚
          â”‚                  â”‚    â”‚                   â”‚    â”‚                  â”‚
          â”‚ GrpcAdapter      â”‚    â”‚ GrpcAdapter       â”‚    â”‚ GrpcAdapter      â”‚
          â”‚  â†“ LoadPolicy    â”‚    â”‚  â†“ LoadPolicy     â”‚    â”‚  â†“ LoadPolicy    â”‚
          â”‚ gRPC â†’ è·å–ç­–ç•¥   â”‚    â”‚ gRPC â†’ è·å–ç­–ç•¥    â”‚    â”‚ gRPC â†’ è·å–ç­–ç•¥   â”‚
          â”‚  â†“               â”‚    â”‚  â†“                â”‚    â”‚  â†“               â”‚
          â”‚ SyncedEnforcer   â”‚    â”‚ SyncedEnforcer    â”‚    â”‚ SyncedEnforcer   â”‚
          â”‚ (å†…å­˜ç­–ç•¥)        â”‚    â”‚ (å†…å­˜ç­–ç•¥)         â”‚    â”‚ (å†…å­˜ç­–ç•¥)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒå˜æ›´**ï¼š

- **æ–°å¢ `CasbinPolicyService`**ï¼šsecurity-management çš„ gRPC æœåŠ¡ç«¯æ–°å¢ RPC æ¥å£ï¼ŒæŒ‰ `tenant_id` æŸ¥è¯¢ç­–ç•¥
- **æ–°å¢ `GrpcAdapter`**ï¼šjxt-core ä¸­å®ç° Casbin `persist.Adapter` æ¥å£ï¼Œé€šè¿‡ gRPC è·å–ç­–ç•¥æ•°æ®
- **æ–°å¢ `SetupWithGrpc`**ï¼šjxt-core ä¸­æä¾›æ–°å‡½æ•°ï¼Œä½¿ç”¨ `GrpcAdapter` æ›¿ä»£ `gormAdapter`
- **ç§»é™¤æœ¬åœ° DB ä¾èµ–**ï¼šå¾®æœåŠ¡ä¸å†éœ€è¦è¿æ¥ä»»ä½•æ•°æ®åº“æ¥åŠ è½½ Casbin ç­–ç•¥

### 3.2 å…³é”®è®¾è®¡å†³ç­–

#### 3.2.1 æ€§èƒ½å½±å“åˆ†æ

| æ“ä½œ | é¢‘ç‡ | è·¯å¾„ | å½±å“ |
|------|------|------|------|
| `Enforce(sub, obj, act)` | æ¯æ¬¡ HTTP è¯·æ±‚ | æœ¬åœ°å†…å­˜ â†’ **é›¶å½±å“** | æ—  |
| `LoadPolicy()` | å¯åŠ¨æ—¶ + Redis Watcher é€šçŸ¥æ—¶ | gRPC â†’ security-management â†’ ç§Ÿæˆ· DB | å¯æ¥å—ï¼ˆms çº§å»¶è¿Ÿï¼‰ |

`LoadPolicy()` çš„è°ƒç”¨åœºæ™¯ï¼š
1. **æœåŠ¡å¯åŠ¨**ï¼šåˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡ï¼ˆå¯å®¹å¿æ•°ç™¾æ¯«ç§’å»¶è¿Ÿï¼‰
2. **Redis Watcher å›è°ƒ**ï¼šæƒé™å˜æ›´æ—¶è§¦å‘ï¼ˆä½é¢‘ï¼Œæ¯æ¬¡è§’è‰²/æƒé™ä¿®æ”¹åï¼‰

#### 3.2.2 å¤šç§Ÿæˆ·æ•°æ®åº“è·¯ç”±

security-management çš„å¤šç§Ÿæˆ·æ¶æ„å†³å®šäº† gRPC æœåŠ¡å¿…é¡»æŒ‰ `tenant_id` è·¯ç”±åˆ°æ­£ç¡®çš„ç§Ÿæˆ·æ•°æ®åº“ã€‚è·¯ç”±é€»è¾‘éµå¾ªç°æœ‰ gRPC æœåŠ¡çš„æ ‡å‡†æ¨¡å¼ï¼š

```
gRPC è¯·æ±‚ (tenant_id=5)
    â†’ CasbinPolicyServer.GetPolicies()
        â†’ ctx = context.WithValue(ctx, global.TenantIDKey, 5)
        â†’ repo.GetOrm(ctx)                    // æ ‡å‡† GormRepository æ¨¡å¼
            â†’ sdk.Runtime.GetTenantDB(5)       // è·å–ç§Ÿæˆ· 5 çš„ DB è¿æ¥
                â†’ æŸ¥è¯¢è¯¥ç§Ÿæˆ· DB ä¸­çš„ sys_casbin_rule è¡¨
```

è¿™ä¸ `UserInfoServer`ã€`OrgInfoServer` ç­‰ç°æœ‰ gRPC æœåŠ¡çš„å¤šç§Ÿæˆ·å¤„ç†æ¨¡å¼å®Œå…¨ä¸€è‡´ã€‚

#### 3.2.3 ä¸ç°æœ‰ Redis Watcher çš„åä½œ

æƒé™å˜æ›´çš„å®Œæ•´æµç¨‹ï¼š

```
1. security-management ä¿®æ”¹æƒé™ï¼ˆè§’è‰²/èœå•/APIå…³è”ï¼‰
2. Casbin enforcer é€šè¿‡ gormAdapter æ›´æ–° sys_casbin_rule è¡¨
3. Redis Watcher å‘å¸ƒé€šçŸ¥åˆ° /casbin/tenant/{tenantID}
4. å„å¾®æœåŠ¡çš„ SyncedEnforcer æ”¶åˆ° Redis é€šçŸ¥
5. è§¦å‘ enforcer.LoadPolicy()
6. GrpcAdapter.LoadPolicy() â†’ gRPC è°ƒç”¨ GetPolicies(tenant_id)
7. security-management æŸ¥è¯¢å¯¹åº”ç§Ÿæˆ· DB è¿”å›ç­–ç•¥
8. GrpcAdapter ä½¿ç”¨ persist.LoadPolicyLine() åŠ è½½åˆ° model
```

**å”¯ä¸€å˜åŒ–**ï¼šæ­¥éª¤ 6 çš„ `LoadPolicy()` åº•å±‚ä»"gormAdapter ç›´æ¥æŸ¥æ•°æ®åº“"å˜ä¸º"GrpcAdapter é€šè¿‡ gRPC æŸ¥è¿œç¨‹æ•°æ®åº“"ã€‚Redis Watcher çš„é€šçŸ¥æœºåˆ¶ï¼ˆpub/sub é¢‘é“ã€è§¦å‘æ–¹å¼ï¼‰å®Œå…¨ä¸å˜ã€‚

#### 3.2.4 ä¸¤ç§ Adapter å¹¶å­˜çš„å®‰å…¨æ€§åˆ†æ

æ”¹é€ åï¼Œç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨ä¸¤ç§ `LoadPolicy()` è·¯å¾„ï¼š

| æœåŠ¡ | Adapter | LoadPolicy è·¯å¾„ | è§¦å‘æ—¶æœº |
|------|---------|-----------------|----------|
| **security-management** | `gormAdapter`ï¼ˆä¸å˜ï¼‰ | ç›´æ¥æŸ¥æœ¬åœ°ç§Ÿæˆ· DB | å¯åŠ¨ + Redis Watcher å›è°ƒ |
| **å…¶ä»–å¾®æœåŠ¡** | `GrpcAdapter`ï¼ˆæ–°å¢ï¼‰ | gRPC â†’ security-management â†’ ç§Ÿæˆ· DB | å¯åŠ¨ + Redis Watcher å›è°ƒ |

**ä¸ä¼šäº§ç”Ÿå¾ªç¯é€šçŸ¥**ï¼š

éœ€è¦ç¡®è®¤çš„å…³é”®é—®é¢˜æ˜¯ï¼šsecurity-management è‡ªèº«ä¹Ÿè®¢é˜…äº† Redis Watcherï¼ˆ`IgnoreSelf: false`ï¼‰ï¼Œå½“å®ƒæ”¶åˆ°é€šçŸ¥åè°ƒç”¨ `LoadPolicy()`ï¼Œæ˜¯å¦ä¼šå†æ¬¡è§¦å‘ Watcher é€šçŸ¥ï¼Ÿ

```
æƒé™ä¿®æ”¹ â†’ gormAdapter.SavePolicy() â†’ å†™å…¥ DB â†’ Watcher å‘å¸ƒé€šçŸ¥
                                                        â†“
security-management æ”¶åˆ°é€šçŸ¥ â†’ enforcer.LoadPolicy()
                                    â†“
                              gormAdapter.LoadPolicy() â†’ è¯»å– DBï¼ˆåªè¯»æ“ä½œï¼‰
                                    â†“
                              âœ… ä¸è§¦å‘ SavePolicy()ï¼Œä¸å‘å¸ƒ Watcher é€šçŸ¥
                              âœ… ä¸ä¼šäº§ç”Ÿå¾ªç¯
```

**åŸå› **ï¼š`LoadPolicy()` æ˜¯**çº¯è¯»æ“ä½œ**â€”â€”å®ƒä»æ•°æ®åº“ï¼ˆæˆ– gRPCï¼‰è¯»å–ç­–ç•¥å¹¶åŠ è½½åˆ°å†…å­˜ model ä¸­ï¼Œä¸ä¼šè°ƒç”¨ `SavePolicy()`ï¼Œå› æ­¤ä¸ä¼šè§¦å‘ Redis Watcher å‘å¸ƒæ–°é€šçŸ¥ã€‚è¿™å¯¹ `gormAdapter` å’Œ `GrpcAdapter` éƒ½æˆç«‹ã€‚

åŒç†ï¼Œå…¶ä»–å¾®æœåŠ¡æ”¶åˆ° Watcher é€šçŸ¥åï¼š
```
å¾®æœåŠ¡æ”¶åˆ°é€šçŸ¥ â†’ enforcer.LoadPolicy()
                    â†“
              GrpcAdapter.LoadPolicy() â†’ gRPC GetPolicies()
                    â†“
              security-management æŸ¥ DB è¿”å›æ•°æ®ï¼ˆåªè¯»ï¼Œä¸è§¦å‘ Watcherï¼‰
                    â†“
              âœ… ä¸ä¼šäº§ç”Ÿå¾ªç¯
```

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 Proto å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š`security-management/admin/interface/grpc/casbin/proto/casbin_policy.proto`

> éµå¾ªç°æœ‰çº¦å®šï¼š`{module}/interface/grpc/{entity}/proto/{entity}.proto`

```protobuf
syntax = "proto3";

package casbin;

option go_package = ".;proto";

// CasbinPolicyService æä¾› Casbin ç­–ç•¥è§„åˆ™çš„ gRPC æŸ¥è¯¢æœåŠ¡
service CasbinPolicyService {
  // GetPolicies è·å–æŒ‡å®šç§Ÿæˆ·çš„æ‰€æœ‰ Casbin ç­–ç•¥è§„åˆ™
  rpc GetPolicies(GetPoliciesRequest) returns (GetPoliciesResponse) {}
}

// GetPoliciesRequest æŸ¥è¯¢ç­–ç•¥è¯·æ±‚
message GetPoliciesRequest {
  // ç§Ÿæˆ· IDï¼ˆå¿…å¡«ï¼‰ï¼Œéµå¾ªæ‰€æœ‰ç°æœ‰ gRPC æ¥å£çš„çº¦å®šï¼štenant_id å§‹ç»ˆä¸ºç¬¬ä¸€ä¸ªå­—æ®µ
  int32 tenant_id = 1;
}

// GetPoliciesResponse æŸ¥è¯¢ç­–ç•¥å“åº”
message GetPoliciesResponse {
  repeated CasbinPolicyEntry policies = 1;  // ç­–ç•¥è§„åˆ™åˆ—è¡¨
}

// CasbinPolicyEntry å•æ¡ Casbin ç­–ç•¥è§„åˆ™
message CasbinPolicyEntry {
  string p_type = 1;  // ç­–ç•¥ç±»å‹: "p"(ç­–ç•¥) æˆ– "g"(è§’è‰²ç»§æ‰¿)
  string v0 = 2;      // é€šå¸¸ä¸º sub (è§’è‰²å)
  string v1 = 3;      // é€šå¸¸ä¸º obj (èµ„æºè·¯å¾„)
  string v2 = 4;      // é€šå¸¸ä¸º act (HTTP æ–¹æ³•)
  string v3 = 5;      // å¯é€‰æ‰©å±•å­—æ®µ
  string v4 = 6;      // å¯é€‰æ‰©å±•å­—æ®µ
  string v5 = 7;      // å¯é€‰æ‰©å±•å­—æ®µ
}
```

**è®¾è®¡è¯´æ˜**ï¼š

1. **ä¸€æ¬¡è¿”å›æ‰€æœ‰ç±»å‹ç­–ç•¥**ï¼ˆ`p` å’Œ `g`ï¼‰ï¼Œå®¢æˆ·ç«¯æŒ‰ `p_type` åˆ†å‘ï¼Œé¿å…å¤šæ¬¡ RPC è°ƒç”¨
2. **ä¸åŒ…å« `StreamPolicies`**ï¼šå•æ¬¡æŸ¥è¯¢è¶³ä»¥æ»¡è¶³å½“å‰éœ€æ±‚ï¼ˆç­–ç•¥æ¡ç›®é€šå¸¸åœ¨æ•°ç™¾åˆ°æ•°åƒçº§åˆ«ï¼‰ï¼Œå¦‚æœªæ¥éœ€è¦å†æ‰©å±•
3. **`go_package = ".;proto"`**ï¼šä¸ `user.proto`ã€`org.proto` ç­‰ä¿æŒä¸€è‡´

### 4.2 gRPC æœåŠ¡ç«¯å®ç°ï¼ˆsecurity-managementï¼‰

#### 4.2.1 Repository æ¥å£

**æ–‡ä»¶ä½ç½®**ï¼š`security-management/admin/domain/aggregate/repository/casbin_rule.go`

> éµå¾ªç°æœ‰çº¦å®šï¼šRepository æ¥å£å®šä¹‰åœ¨ `aggregate/repository/` ç›®å½•ä¸‹ï¼Œä¸ `sys_role.go`ã€`sys_user.go` ç­‰ä¿æŒä¸€è‡´ã€‚

```go
package repository

import (
    "context"
    "jxt-evidence-system/security-management/admin/domain/aggregate"
)

// CasbinRuleRepository sys_casbin_rule ä»“å‚¨æ¥å£
type CasbinRuleRepository interface {
    // FindAll æŸ¥è¯¢æ‰€æœ‰ç­–ç•¥è§„åˆ™ï¼ˆp å’Œ g ç±»å‹ï¼‰
    // é€šè¿‡ ctx ä¸­çš„ TenantIDKey è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”ç§Ÿæˆ·æ•°æ®åº“
    FindAll(ctx context.Context, result *[]aggregate.CasbinRule) error
}
```

**è®¾è®¡è¯´æ˜**ï¼š

- **ä¸ä½¿ç”¨ `FindByTenant(ctx, tenantID, ...)`**ï¼šç§Ÿæˆ·è·¯ç”±é€šè¿‡ ctx ä¸­çš„ `global.TenantIDKey` å®ç°ï¼Œä¸ç°æœ‰ `GormRepository.GetOrm(ctx)` æ¨¡å¼ä¸€è‡´
- **ä¸æŒ‰ `policyType` è¿‡æ»¤**ï¼šä¸€æ¬¡æŸ¥è¯¢å…¨éƒ¨è§„åˆ™ï¼Œç”±å®¢æˆ·ç«¯æŒ‰ `p_type` åˆ†å‘

#### 4.2.2 Repository å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`security-management/admin/infrastructure/persistence/gorm/casbin_rule_repository.go`

```go
package persistence

import (
    "context"
    "jxt-evidence-system/security-management/admin/domain/aggregate"
)

type GormCasbinRuleRepository struct {
    GormRepository // å¤ç”¨ç°æœ‰çš„ GormRepositoryï¼Œè‡ªåŠ¨é€šè¿‡ ctx è·å–ç§Ÿæˆ· DB
}

func NewGormCasbinRuleRepository() *GormCasbinRuleRepository {
    return &GormCasbinRuleRepository{}
}

func (r *GormCasbinRuleRepository) FindAll(ctx context.Context, result *[]aggregate.CasbinRule) error {
    db, err := r.GetOrm(ctx) // é€šè¿‡ ctx ä¸­çš„ TenantIDKey â†’ sdk.Runtime.GetTenantDB(tenantID)
    if err != nil {
        return err
    }
    return db.Find(result).Error
}
```

#### 4.2.3 gRPC Server å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`security-management/admin/interface/grpc/casbin/casbin_policy_server.go`

```go
package casbin

import (
    "context"

    "google.golang.org/grpc/codes"
    "google.golang.org/grpc/status"

    proto "jxt-evidence-system/security-management/admin/interface/grpc/casbin/proto"
    "jxt-evidence-system/security-management/admin/domain/aggregate"
    "jxt-evidence-system/security-management/admin/domain/aggregate/repository"
    "jxt-evidence-system/security-management/common/global"
)

// CasbinPolicyServer å®ç° CasbinPolicyService gRPC æœåŠ¡
type CasbinPolicyServer struct {
    proto.UnimplementedCasbinPolicyServiceServer
    casbinRuleRepo repository.CasbinRuleRepository
}

func (s *CasbinPolicyServer) GetPolicies(
    ctx context.Context,
    req *proto.GetPoliciesRequest,
) (*proto.GetPoliciesResponse, error) {
    // 1. éªŒè¯å¹¶è§£æ tenant_idï¼ˆä¸ UserInfoServer ç­‰ç°æœ‰æœåŠ¡ä¸€è‡´ï¼‰
    tenantID, err := parseTenantID(req.TenantId)
    if err != nil {
        return nil, status.Errorf(codes.InvalidArgument, "invalid tenant_id: %v", err)
    }

    // 2. æ³¨å…¥ç§Ÿæˆ· ID åˆ° context
    ctx = context.WithValue(ctx, global.TenantIDKey, tenantID)

    // 3. æŸ¥è¯¢è¯¥ç§Ÿæˆ·çš„æ‰€æœ‰ Casbin è§„åˆ™
    var rules []aggregate.CasbinRule
    if err := s.casbinRuleRepo.FindAll(ctx, &rules); err != nil {
        return nil, status.Errorf(codes.Internal, "failed to query casbin rules: %v", err)
    }

    // 4. è½¬æ¢ä¸º proto æ ¼å¼
    policies := make([]*proto.CasbinPolicyEntry, 0, len(rules))
    for _, rule := range rules {
        policies = append(policies, &proto.CasbinPolicyEntry{
            PType: rule.Ptype,
            V0:    rule.V0,
            V1:    rule.V1,
            V2:    rule.V2,
            V3:    rule.V3,
            V4:    rule.V4,
            V5:    rule.V5,
        })
    }

    return &proto.GetPoliciesResponse{Policies: policies}, nil
}

// parseTenantID éªŒè¯ tenant_idï¼ˆä¸ç°æœ‰ gRPC æœåŠ¡å…±ç”¨ï¼‰
func parseTenantID(id int32) (int, error) {
    if id <= 0 {
        return 0, fmt.Errorf("tenant_id must be positive, got %d", id)
    }
    return int(id), nil
}
```

#### 4.2.4 DI æ³¨å†Œ

**æ–‡ä»¶ä½ç½®**ï¼š`security-management/admin/interface/grpc/casbin/dependencies.go`

> éµå¾ªç°æœ‰çº¦å®šï¼šä½¿ç”¨ `sync.Once` + `di.Provide` æ¨¡å¼ã€‚

```go
package casbin

import (
    "jxt-evidence-system/security-management/admin/domain/aggregate/repository"
    "jxt-evidence-system/security-management/common/di"
    "sync"

    "github.com/ChenBigdata421/jxt-core/sdk/pkg/logger"
)

var (
    registrations = make([]func(), 0)
    registerOnce  = sync.Once{}
)

func RegisterDependencies() {
    registerOnce.Do(func() {
        for _, f := range registrations {
            f()
        }
    })
}

func init() {
    registrations = append(registrations, registerCasbinPolicyServerDependencies)
}

func registerCasbinPolicyServerDependencies() {
    err := di.Provide(func(repo repository.CasbinRuleRepository) *CasbinPolicyServer {
        return &CasbinPolicyServer{casbinRuleRepo: repo}
    })
    if err != nil {
        logger.Fatalf("Failed to provide CasbinPolicyServer: %v", err)
    }
}
```

#### 4.2.5 æœåŠ¡æ³¨å†Œï¼ˆserver.go å˜æ›´ï¼‰

åœ¨ `security-management/cmd/api/server.go` ä¸­æ–°å¢æœåŠ¡æ³¨å†Œï¼š

```go
// æ–°å¢ import
import (
    "jxt-evidence-system/security-management/admin/interface/grpc/casbin"
    casbinProto "jxt-evidence-system/security-management/admin/interface/grpc/casbin/proto"
)

// åœ¨ zrpc.MustNewServer å›è°ƒä¸­æ–°å¢ï¼š
if cfg.Services["casbin_policy"].Enabled {
    err := di.Invoke(func(grpcSrv *casbin.CasbinPolicyServer) {
        casbinProto.RegisterCasbinPolicyServiceServer(grpcServer, grpcSrv)
        registeredServices = append(registeredServices, "CasbinPolicyService")
    })
    if err != nil {
        logger.Fatalf("Failed to resolve CasbinPolicyServer: %v", err)
    }
}
```

#### 4.2.6 DI ä»“å‚¨æ³¨å†Œ

åœ¨ `security-management/admin/infrastructure/persistence/gorm/dependencies.go`ï¼ˆæˆ–å¯¹åº”çš„ DI æ³¨å†Œæ–‡ä»¶ï¼‰ä¸­æ–°å¢ï¼š

```go
func registerCasbinRuleRepositoryDependencies() {
    err := di.Provide(func() repository.CasbinRuleRepository {
        return persistence.NewGormCasbinRuleRepository()
    })
    if err != nil {
        logger.Fatalf("Failed to provide CasbinRuleRepository: %v", err)
    }
}
```

### 4.3 jxt-core SDK æ”¹é€ 

> **è®¾è®¡å†³ç­–**ï¼šé‡‡ç”¨ **PolicyProvider æ¥å£æ–¹æ¡ˆ**ï¼ˆæ–¹æ¡ˆ A å˜ä½“ï¼‰ï¼Œè€Œéç›´æ¥åœ¨ jxt-core ä¸­ä¾èµ– gRPC proto ç”Ÿæˆä»£ç ã€‚
>
> **åŸå› **ï¼š
> 1. jxt-core æ˜¯å…±äº«åº“ï¼Œä¸åº”æŒæœ‰ security-management çš„ proto å®šä¹‰ï¼ˆä¼šå¯¼è‡´å¾ªç¯ä¾èµ–æˆ–è§’è‰²é”™ä½ï¼‰
> 2. å®šä¹‰ transport-agnostic çš„ `PolicyProvider` æ¥å£ï¼Œå¾®æœåŠ¡è‡ªè¡Œå®ç° gRPC é€‚é…å™¨
> 3. ä¸ç°æœ‰æ¨¡å¼ä¸€è‡´ï¼š`SetupForTenant(db *gorm.DB, ...)` æ¥å—æŠ½è±¡ï¼Œ`SetupWithProvider(provider, ...)` åŒç†
> 4. æ˜“äºæµ‹è¯•ï¼šå¯ä»¥è½»æ¾ mock `PolicyProvider` è¿›è¡Œå•å…ƒæµ‹è¯•

#### 4.3.1 PolicyProvider æ¥å£å’Œ PolicyRule ç»“æ„ä½“

**æ–‡ä»¶ä½ç½®**ï¼š`jxt-core/sdk/pkg/casbin/provider.go`ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

```go
package mycasbin

import (
    "context"
)

// PolicyRule è¡¨ç¤ºä¸€æ¡ Casbin ç­–ç•¥è§„åˆ™
type PolicyRule struct {
    PType string // ç­–ç•¥ç±»å‹: "p"(ç­–ç•¥) æˆ– "g"(è§’è‰²ç»§æ‰¿)
    V0    string // é€šå¸¸ä¸º sub (è§’è‰²å)
    V1    string // é€šå¸¸ä¸º obj (èµ„æºè·¯å¾„)
    V2    string // é€šå¸¸ä¸º act (HTTP æ–¹æ³•)
    V3    string // å¯é€‰æ‰©å±•å­—æ®µ
    V4    string // å¯é€‰æ‰©å±•å­—æ®µ
    V5    string // å¯é€‰æ‰©å±•å­—æ®µ
}

// PolicyProvider ç­–ç•¥æä¾›è€…æ¥å£
//
// å¾®æœåŠ¡é€šè¿‡å®ç°æ­¤æ¥å£æ¥æä¾›ç­–ç•¥æ•°æ®ï¼Œjxt-core ä¸å…³å¿ƒå…·ä½“çš„æ•°æ®æ¥æº
//ï¼ˆgRPCã€HTTPã€ç›´æ¥æ•°æ®åº“æŸ¥è¯¢éƒ½å¯ä»¥ï¼‰
type PolicyProvider interface {
    // GetPolicies è·å–æŒ‡å®šç§Ÿæˆ·çš„æ‰€æœ‰ç­–ç•¥è§„åˆ™
    //
    // å‚æ•°ï¼š
    //   - ctx: ä¸Šä¸‹æ–‡ï¼ˆç”¨äºè¶…æ—¶æ§åˆ¶ã€å–æ¶ˆç­‰ï¼‰
    //   - tenantID: ç§Ÿæˆ· ID
    //
    // è¿”å›ï¼š
    //   - []PolicyRule: ç­–ç•¥è§„åˆ™åˆ—è¡¨ï¼ˆåŒ…å« p å’Œ g ç±»å‹ï¼‰
    //   - error: é”™è¯¯ä¿¡æ¯
    GetPolicies(ctx context.Context, tenantID int) ([]PolicyRule, error)
}
```

**è®¾è®¡è¯´æ˜**ï¼š

1. **`PolicyRule` æ˜¯çº¯ Go ç»“æ„ä½“**ï¼šä¸ä¾èµ–ä»»ä½• proto æˆ– gRPC åŒ…ï¼Œjxt-core é›¶å¤–éƒ¨ä¼ è¾“åè®®ä¾èµ–
2. **`PolicyProvider` æ˜¯å•æ–¹æ³•æ¥å£**ï¼šç¬¦åˆ Go çš„æ¥å£è®¾è®¡å“²å­¦ï¼ˆå°æ¥å£ï¼‰ï¼Œæ˜“äºå®ç°å’Œ mock
3. **`tenantID` ä½œä¸ºå‚æ•°ä¼ å…¥**ï¼šè€Œéä» context ä¸­æå–ï¼Œä¿æŒæ¥å£è¯­ä¹‰æ˜ç¡®

#### 4.3.2 ProviderAdapter å®ç°

**æ–‡ä»¶ä½ç½®**ï¼š`jxt-core/sdk/pkg/casbin/provider_adapter.go`ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

`ProviderAdapter` å®ç° Casbin çš„ `persist.Adapter` æ¥å£ï¼Œé€šè¿‡ `PolicyProvider` è·å–ç­–ç•¥æ•°æ®ã€‚

```go
package mycasbin

import (
    "context"
    "fmt"
    "strings"
    "time"

    "github.com/casbin/casbin/v2/model"
    "github.com/casbin/casbin/v2/persist"
)

// ProviderAdapter åŸºäº PolicyProvider çš„ Casbin é€‚é…å™¨
// å®ç° persist.Adapter æ¥å£ï¼ˆåªè¯»ï¼‰
type ProviderAdapter struct {
    provider PolicyProvider
    tenantID int
    timeout  time.Duration
}

// NewProviderAdapter åˆ›å»ºåŸºäº Provider çš„é€‚é…å™¨
func NewProviderAdapter(provider PolicyProvider, tenantID int) *ProviderAdapter {
    return &ProviderAdapter{
        provider: provider,
        tenantID: tenantID,
        timeout:  5 * time.Second, // Provider è°ƒç”¨è¶…æ—¶
    }
}

// LoadPolicy ä» Provider åŠ è½½æ‰€æœ‰ç­–ç•¥åˆ° model
// è¿™æ˜¯ Casbin SyncedEnforcer åœ¨ LoadPolicy() æ—¶è°ƒç”¨çš„æ ¸å¿ƒæ–¹æ³•
func (a *ProviderAdapter) LoadPolicy(m model.Model) error {
    ctx, cancel := context.WithTimeout(context.Background(), a.timeout)
    defer cancel()

    rules, err := a.provider.GetPolicies(ctx, a.tenantID)
    if err != nil {
        return fmt.Errorf("provider GetPolicies failed: %w", err)
    }

    // ä½¿ç”¨ persist.LoadPolicyLine å°†æ¯æ¡ç­–ç•¥åŠ è½½åˆ° model
    // è¿™æ˜¯ Casbin å®˜æ–¹æ¨èçš„ç­–ç•¥åŠ è½½æ–¹å¼
    for _, rule := range rules {
        line := policyRuleToLine(rule)
        persist.LoadPolicyLine(line, m)
    }

    return nil
}

// policyRuleToLine å°† PolicyRule è½¬æ¢ä¸º Casbin ç­–ç•¥è¡Œæ ¼å¼
// æ ¼å¼: "p_type, v0, v1, v2, ..."ï¼ˆé€—å·åˆ†éš”ï¼Œéç©ºå­—æ®µï¼‰
//
// å‰ç½®æ¡ä»¶ï¼šPolicyRule çš„å­—æ®µå¿…é¡»ä»å·¦åˆ°å³è¿ç»­å¡«å……ï¼Œä¸å…è®¸ä¸­é—´å­˜åœ¨ç©ºæ´ã€‚
// ä¾‹å¦‚ V0="admin", V1="", V2="/api/test" æ˜¯éæ³•çš„ï¼ˆV1 ä¸ºç©ºä½† V2 æœ‰å€¼ï¼‰ã€‚
// è¿™æ˜¯ Casbin çš„æ ‡å‡†æ•°æ®æ ¼å¼çº¦æŸï¼ŒgormAdapter å†™å…¥çš„æ•°æ®å¤©ç„¶æ»¡è¶³æ­¤æ¡ä»¶ã€‚
// å¦‚æœæ•°æ®è¿åæ­¤çº¦æŸï¼Œå‡½æ•°ä¼šåœ¨é¦–ä¸ªç©ºå­—æ®µå¤„æˆªæ–­ï¼Œåç»­å­—æ®µå°†è¢«å¿½ç•¥ã€‚
func policyRuleToLine(r PolicyRule) string {
    parts := []string{r.PType}
    for _, v := range []string{r.V0, r.V1, r.V2, r.V3, r.V4, r.V5} {
        if v == "" {
            break // Casbin ç­–ç•¥å­—æ®µä»å·¦åˆ°å³è¿ç»­å¡«å……ï¼Œé‡åˆ°ç©ºå³ç»“æŸ
        }
        parts = append(parts, v)
    }
    return strings.Join(parts, ", ")
}

// === ä»¥ä¸‹æ–¹æ³•ä¸º persist.Adapter æ¥å£è¦æ±‚ä½†ä¸å®ç°ï¼ˆåªè¯»é€‚é…å™¨ï¼‰ ===

func (a *ProviderAdapter) SavePolicy(m model.Model) error {
    return fmt.Errorf("ProviderAdapter is read-only: SavePolicy not supported")
}

func (a *ProviderAdapter) AddPolicy(sec string, ptype string, rule []string) error {
    return fmt.Errorf("ProviderAdapter is read-only: AddPolicy not supported")
}

func (a *ProviderAdapter) RemovePolicy(sec string, ptype string, rule []string) error {
    return fmt.Errorf("ProviderAdapter is read-only: RemovePolicy not supported")
}

func (a *ProviderAdapter) RemoveFilteredPolicy(sec string, ptype string, fieldIndex int, fieldValues ...string) error {
    return fmt.Errorf("ProviderAdapter is read-only: RemoveFilteredPolicy not supported")
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **ä½¿ç”¨ `persist.LoadPolicyLine(line, model)`**ï¼šè¿™æ˜¯ Casbin å®˜æ–¹ APIï¼Œå°†æ–‡æœ¬è¡Œ `"p, admin, /api/*, GET"` è§£æå¹¶åŠ è½½åˆ° model å¯¹åº”çš„ section ä¸­
2. **`policyRuleToLine` æ ¼å¼**ï¼š`"p_type, v0, v1, v2, ..."`ï¼Œä¸ Casbin ç­–ç•¥æ–‡ä»¶æ ¼å¼ä¸€è‡´
3. **åªè¯»é€‚é…å™¨**ï¼šå¾®æœåŠ¡ç«¯ä¸é€šè¿‡ Adapter å†™å…¥ç­–ç•¥ï¼Œå†™å…¥ä»ç”± security-management çš„ gormAdapter å®Œæˆ
4. **è¶…æ—¶æ§åˆ¶**ï¼šé»˜è®¤ 5 ç§’ Provider è°ƒç”¨è¶…æ—¶
5. **jxt-core é›¶ proto ä¾èµ–**ï¼š`ProviderAdapter` åªä¾èµ– `PolicyProvider` æ¥å£å’Œ `PolicyRule` ç»“æ„ä½“ï¼Œä¸å¯¼å…¥ä»»ä½• gRPC/proto åŒ…

#### 4.3.3 SetupWithProvider å‡½æ•°

**æ–‡ä»¶ä½ç½®**ï¼š`jxt-core/sdk/pkg/casbin/mycasbin.go`ï¼ˆåœ¨ç°æœ‰æ–‡ä»¶ä¸­æ–°å¢ï¼‰

```go
// SetupWithProvider é€šè¿‡ PolicyProvider åˆ›å»º Casbin enforcerï¼ˆä¾›å¾®æœåŠ¡ä½¿ç”¨ï¼‰
// ä¸ SetupForTenant çš„åŒºåˆ«ï¼šä¸éœ€è¦æœ¬åœ°æ•°æ®åº“è¿æ¥ï¼Œç­–ç•¥ä» Provider è·å–
//
// âš ï¸ ä»…ä¾›é security-management çš„å¾®æœåŠ¡ä½¿ç”¨ï¼ˆè¿œç¨‹è·å–æ¨¡å¼ï¼‰
// security-management è‡ªèº«è¯·ç»§ç»­ä½¿ç”¨ SetupForTenant
//
// å‚æ•°ï¼š
//   - provider: ç­–ç•¥æä¾›è€…ï¼ˆç”±å¾®æœåŠ¡å®ç°ï¼Œé€šå¸¸æ˜¯ gRPC é€‚é…å™¨ï¼‰
//   - tenantID: ç§Ÿæˆ· ID
//
// è¿”å›ï¼š
//   - *casbin.SyncedEnforcer: å·²åŠ è½½ç­–ç•¥çš„ Casbin enforcer
//   - error: åˆå§‹åŒ–é”™è¯¯
func SetupWithProvider(provider PolicyProvider, tenantID int) (*casbin.SyncedEnforcer, error) {
    // 1. åˆ›å»º ProviderAdapter
    adapter := NewProviderAdapter(provider, tenantID)

    // 2. åŠ è½½ä¸ SetupForTenant ç›¸åŒçš„ RBAC æ¨¡å‹
    m, err := model.NewModelFromString(text) // text å˜é‡å·²åœ¨ mycasbin.go ä¸­å®šä¹‰
    if err != nil {
        return nil, fmt.Errorf("failed to create casbin model: %w", err)
    }

    // 3. åˆ›å»º SyncedEnforcer
    e, err := casbin.NewSyncedEnforcer(m, adapter)
    if err != nil {
        return nil, fmt.Errorf("failed to create casbin enforcer: %w", err)
    }

    // 4. åŠ è½½ç­–ç•¥ï¼ˆé€šè¿‡ ProviderAdapter â†’ Provider â†’ è¿œç¨‹æœåŠ¡ï¼‰
    if err := e.LoadPolicy(); err != nil {
        return nil, fmt.Errorf("failed to load policy via provider: %w", err)
    }

    // 5. è®¾ç½® Redis Watcherï¼ˆè°ƒç”¨æå–çš„å…¬å…± helperï¼‰
    setupRedisWatcherForEnforcer(e, tenantID)

    // 6. è®¾ç½®æ—¥å¿—
    log.SetLogger(&Logger{})
    e.EnableLog(true)

    return e, nil
}
```

#### 4.3.4 setupRedisWatcherForEnforcer è¾…åŠ©å‡½æ•°

**æ–‡ä»¶ä½ç½®**ï¼š`jxt-core/sdk/pkg/casbin/mycasbin.go`

ä» `SetupForTenant` ä¸­æå– Redis Watcher è®¾ç½®ä»£ç ä¸ºç‹¬ç«‹å‡½æ•°ï¼Œé¿å…ä¸ `SetupWithProvider` é‡å¤ï¼š

```go
// setupRedisWatcherForEnforcer ä¸º enforcer è®¾ç½® Redis Watcher
// ä» SetupForTenant å’Œ SetupWithProvider å…±åŒè°ƒç”¨ï¼Œæ¶ˆé™¤ä»£ç é‡å¤
//
// è¡Œä¸ºï¼š
//   - å¦‚æœ Redis å·²é…ç½®ï¼Œåˆ›å»º Watcher å¹¶è®¾ç½®å›è°ƒ
//   - å¦‚æœ Redis æœªé…ç½®æˆ–åˆ›å»ºå¤±è´¥ï¼Œä»…è®°å½•æ—¥å¿—ï¼ˆä¸é˜»æ­¢ enforcer åˆ›å»ºï¼‰
//   - æ¯ä¸ªç§Ÿæˆ·ä½¿ç”¨ç‹¬ç«‹çš„ Redis é¢‘é“: /casbin/tenant/{tenantID}
func setupRedisWatcherForEnforcer(e *casbin.SyncedEnforcer, tenantID int) {
    if config.CacheConfig.Redis == nil {
        return
    }

    channel := fmt.Sprintf("/casbin/tenant/%d", tenantID)

    w, err := redisWatcher.NewWatcher(config.CacheConfig.Redis.Addr, redisWatcher.WatcherOptions{
        Options: redis.Options{
            Network:  "tcp",
            Password: config.CacheConfig.Redis.Password,
        },
        Channel:    channel,
        IgnoreSelf: false,
    })
    if err != nil {
        logger.Errorf("ç§Ÿæˆ· %d Redis Watcher åˆ›å»ºå¤±è´¥: %v", tenantID, err)
        return
    }

    tenantEnforcer := e
    _ = w.SetUpdateCallback(func(msg string) {
        logger.Infof("casbin updateCallback (ç§Ÿæˆ· %d) msg: %v", tenantID, msg)
        if err := tenantEnforcer.LoadPolicy(); err != nil {
            logger.Errorf("casbin LoadPolicy (ç§Ÿæˆ· %d) err: %v", tenantID, err)
        }
    })
    _ = e.SetWatcher(w)
}
```

**é‡æ„åçš„ `SetupForTenant` ä¹Ÿè°ƒç”¨æ­¤å‡½æ•°**ï¼š

```go
func SetupForTenant(db *gorm.DB, tenantID int) (*casbin.SyncedEnforcer, error) {
    // ... åˆ›å»º adapterã€modelã€enforcerã€åŠ è½½ç­–ç•¥ï¼ˆä¸å˜ï¼‰...

    // 5. è®¾ç½® Redis Watcherï¼ˆæ”¹ä¸ºè°ƒç”¨å…¬å…± helperï¼‰
    setupRedisWatcherForEnforcer(e, tenantID)

    // 6. è®¾ç½®æ—¥å¿—
    log.SetLogger(&Logger{})
    e.EnableLog(true)
    return e, nil
}
```

#### 4.3.5 å‘åå…¼å®¹ç­–ç•¥å’Œé˜²è¯¯ç”¨æªæ–½

**å‘åå…¼å®¹ç­–ç•¥**ï¼š

| å‡½æ•° | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `SetupForTenant(db, tenantID)` | security-management å†…éƒ¨ä½¿ç”¨ï¼ˆæœ¬åœ° DBï¼‰ | âœ… ä¿ç•™ï¼Œä¸å˜ |
| `Setup(db, "")` | æ—§ç‰ˆå‘åå…¼å®¹ | âš ï¸ å·²åºŸå¼ƒï¼Œè®¡åˆ’ç§»é™¤ |
| `SetupWithProvider(provider, tenantID)` | å¾®æœåŠ¡ä½¿ç”¨ï¼ˆè¿œç¨‹è·å–ï¼‰ | ğŸ†• æ–°å¢ |

**é˜²è¯¯ç”¨æªæ–½**ï¼š

ä¸‰ä¸ªå‡½æ•°å…±å­˜äº `jxt-core/sdk/pkg/casbin/` åŒä¸€ä¸ª package ä¸­ï¼Œéœ€è¦é˜²æ­¢å¼€å‘è€…åœ¨é”™è¯¯çš„æœåŠ¡ä¸­è°ƒç”¨é”™è¯¯çš„å‡½æ•°ï¼š

1. **å‡½æ•°æ³¨é‡Šæ˜ç¡®æ ‡æ³¨é€‚ç”¨èŒƒå›´**ï¼š

```go
// SetupForTenant ä¸ºæŒ‡å®šç§Ÿæˆ·åˆ›å»ºç‹¬ç«‹çš„ Casbin enforcer
// âš ï¸ ä»…ä¾› security-management ä½¿ç”¨ï¼ˆæœ¬åœ°æ•°æ®åº“ç›´è¿æ¨¡å¼ï¼‰
// å…¶ä»–å¾®æœåŠ¡è¯·ä½¿ç”¨ SetupWithProvider
func SetupForTenant(db *gorm.DB, tenantID int) (*casbin.SyncedEnforcer, error)

// SetupWithProvider é€šè¿‡ PolicyProvider åˆ›å»º Casbin enforcer
// âš ï¸ ä»…ä¾›é security-management çš„å¾®æœåŠ¡ä½¿ç”¨ï¼ˆè¿œç¨‹è·å–æ¨¡å¼ï¼‰
// security-management è‡ªèº«è¯·ç»§ç»­ä½¿ç”¨ SetupForTenant
func SetupWithProvider(provider PolicyProvider, tenantID int) (*casbin.SyncedEnforcer, error)
```

2. **å‚æ•°ç±»å‹å¤©ç„¶éš”ç¦»**ï¼š`SetupForTenant` éœ€è¦ `*gorm.DB`ï¼ˆæœ¬åœ°æ•°æ®åº“è¿æ¥ï¼‰ï¼Œ`SetupWithProvider` éœ€è¦ `PolicyProvider` æ¥å£ã€‚security-management ä¸ä¼šå®ç° `PolicyProvider`ï¼ˆå®ƒæœ¬èº«å°±æ˜¯æ•°æ®æºï¼‰ï¼Œå…¶ä»–å¾®æœåŠ¡æ”¹é€ åä¸å†æŒæœ‰ security-management çš„æ•°æ®åº“è¿æ¥ï¼Œå› æ­¤**å‚æ•°ç±»å‹æœ¬èº«å°±æ˜¯ä¸€é“é˜²çº¿**ã€‚

3. **Code Review æ£€æŸ¥é¡¹**ï¼šåœ¨ PR Review ä¸­æ£€æŸ¥â€”â€”security-management ä¸­ä¸åº”å‡ºç° `SetupWithProvider` è°ƒç”¨ï¼Œå…¶ä»–å¾®æœåŠ¡ä¸­ä¸åº”å‡ºç° `SetupForTenant` è°ƒç”¨ã€‚

### 4.4 å¾®æœåŠ¡å®¢æˆ·ç«¯é›†æˆ

å„å¾®æœåŠ¡å·²æœ‰æˆç†Ÿçš„ gRPC å®¢æˆ·ç«¯æ¶æ„ï¼ˆ`ConnectionManager` + Service Clientsï¼‰ï¼Œæ–°å¢ Casbin ç­–ç•¥è·å–éµå¾ªç°æœ‰æ¨¡å¼ã€‚

**æ ¸å¿ƒæ€è·¯**ï¼šæ¯ä¸ªå¾®æœåŠ¡å®ç° `PolicyProvider` æ¥å£çš„ gRPC ç‰ˆæœ¬ï¼ˆ`GrpcCasbinPolicyProvider`ï¼‰ï¼Œå°è£… proto å®¢æˆ·ç«¯ + `ExecuteWithNetworkRetry`ï¼Œç„¶åä¼ å…¥ `SetupWithProvider`ã€‚

#### 4.4.1 evidence-management æ”¹é€ 

**å½“å‰çŠ¶æ€**ï¼š`masterDB` ç›´è¿ security-management çš„ `securitydb`ï¼Œä½¿ç”¨ `Setup(db, "")` åŠ è½½ç­–ç•¥ã€‚

**æ­¥éª¤ 1ï¼šå¤åˆ¶ proto æ–‡ä»¶**

ä» security-management å¤åˆ¶ Casbin gRPC proto å®šä¹‰ï¼ˆéµå¾ªç°æœ‰æ¨¡å¼ï¼‰ï¼š

```
evidence-management/shared/infrastructure/grpc/proto/
â”œâ”€â”€ bwc/           â† å·²æœ‰ï¼ˆä» security-management å¤åˆ¶ï¼‰
â”œâ”€â”€ org/           â† å·²æœ‰
â”œâ”€â”€ user/          â† å·²æœ‰
â”œâ”€â”€ storagesite/   â† å·²æœ‰
â”œâ”€â”€ enforce_type/  â† å·²æœ‰
â””â”€â”€ casbin/        â† ğŸ†• æ–°å¢ï¼ˆä» security-management å¤åˆ¶ï¼‰
    â”œâ”€â”€ casbin_policy.proto
    â”œâ”€â”€ casbin_policy.pb.go
    â””â”€â”€ casbin_policy_grpc.pb.go
```

**æ­¥éª¤ 2ï¼šå®ç° GrpcCasbinPolicyProvider**

**æ–°å¢æ–‡ä»¶**ï¼š`evidence-management/shared/infrastructure/grpc/client/casbin_policy_provider.go`

> éµå¾ªç°æœ‰æ¨¡å¼ï¼Œä¸ `userinfo_service_client.go`ã€`orginfo_service_client.go` ç­‰å¹¶åˆ—ã€‚
> ä¸åŒç‚¹ï¼šæ­¤æ–‡ä»¶å®ç° jxt-core çš„ `PolicyProvider` æ¥å£ï¼Œè€Œéç‹¬ç«‹çš„ service clientã€‚

```go
package grpc_client

import (
    "context"
    "fmt"
    "sync"

    mycasbin "github.com/ChenBigdata421/jxt-core/sdk/pkg/casbin"
    "github.com/ChenBigdata421/jxt-core/sdk/pkg/logger"

    pb "jxt-evidence-system/evidence-management/shared/infrastructure/grpc/proto/casbin"
)

// GrpcCasbinPolicyProvider é€šè¿‡ gRPC è·å– Casbin ç­–ç•¥çš„ Provider
// å®ç° mycasbin.PolicyProvider æ¥å£
type GrpcCasbinPolicyProvider struct {
    connectionManager *ConnectionManager
    client            pb.CasbinPolicyServiceClient
    initOnce          func()
}

// NewGrpcCasbinPolicyProvider åˆ›å»º gRPC ç­–ç•¥æä¾›è€…
func NewGrpcCasbinPolicyProvider(connManager *ConnectionManager) *GrpcCasbinPolicyProvider {
    provider := &GrpcCasbinPolicyProvider{
        connectionManager: connManager,
    }

    // æ‡’åŠ è½½å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼ˆä¸ UserInfoServiceClient ç›¸åŒæ¨¡å¼ï¼‰
    var once sync.Once
    provider.initOnce = func() {
        once.Do(func() {
            conn := connManager.GetConnection() // è¿”å› *grpc.ClientConnï¼Œæ—  error
            provider.client = pb.NewCasbinPolicyServiceClient(conn)
            logger.Info("Casbin ç­–ç•¥æœåŠ¡å®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ")
        })
    }

    return provider
}

// GetPolicies å®ç° mycasbin.PolicyProvider æ¥å£
// é€šè¿‡ gRPC ä» security-management è·å–æŒ‡å®šç§Ÿæˆ·çš„ç­–ç•¥
func (p *GrpcCasbinPolicyProvider) GetPolicies(ctx context.Context, tenantID int) ([]mycasbin.PolicyRule, error) {
    p.initOnce()

    req := &pb.GetPoliciesRequest{
        TenantId: int32(tenantID),
    }

    logger.Debug(fmt.Sprintf("è°ƒç”¨ GetPoliciesï¼ŒtenantID: %d", tenantID))

    // ä½¿ç”¨ ExecuteWithNetworkRetry åŒ…è£… gRPC è°ƒç”¨ï¼ˆ3 æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
    var resp *pb.GetPoliciesResponse
    err := p.connectionManager.ExecuteWithNetworkRetry(ctx, func() error {
        var err error
        resp, err = p.client.GetPolicies(ctx, req)
        return err
    })

    if err != nil {
        logger.Error(fmt.Sprintf("GetPolicies å¤±è´¥ (ç§Ÿæˆ· %d): %v", tenantID, err))
        return nil, fmt.Errorf("gRPC GetPolicies å¤±è´¥: %w", err)
    }

    // å°† proto å“åº”è½¬æ¢ä¸º PolicyRuleï¼ˆproto â†’ é€šç”¨ç»“æ„ä½“ï¼‰
    rules := make([]mycasbin.PolicyRule, 0, len(resp.Policies))
    for _, policy := range resp.Policies {
        rules = append(rules, mycasbin.PolicyRule{
            PType: policy.PType,
            V0:    policy.V0,
            V1:    policy.V1,
            V2:    policy.V2,
            V3:    policy.V3,
            V4:    policy.V4,
            V5:    policy.V5,
        })
    }

    logger.Debug(fmt.Sprintf("GetPolicies æˆåŠŸ (ç§Ÿæˆ· %d)ï¼Œç­–ç•¥æ•°: %d", tenantID, len(rules)))
    return rules, nil
}

// ç¼–è¯‘æœŸéªŒè¯ï¼šç¡®ä¿ GrpcCasbinPolicyProvider å®ç°äº† PolicyProvider æ¥å£
var _ mycasbin.PolicyProvider = (*GrpcCasbinPolicyProvider)(nil)
```

**æ­¥éª¤ 3ï¼šä¿®æ”¹åˆå§‹åŒ–ä»£ç **

**æ”¹é€ æ–‡ä»¶**ï¼š`evidence-management/shared/common/database/initialize.go`

```go
// æ”¹é€ å‰ï¼ˆå½“å‰ä»£ç ï¼Œç¬¬ 275 è¡Œï¼‰ï¼š
e := mycasbin.Setup(db, "")  // db æ˜¯ masterDBï¼ŒæŒ‡å‘ security-management çš„ securitydb

// æ”¹é€ åï¼š
provider := grpc_client.NewGrpcCasbinPolicyProvider(connManager) // å¤ç”¨ç°æœ‰ ConnectionManager
e, err := mycasbin.SetupWithProvider(provider, tenantID)
if err != nil {
    log.Fatalf("casbin init via provider failed: %v", err)
}
```

**é™„åŠ å˜æ›´**ï¼š
- ç§»é™¤ `masterDB` é…ç½®ï¼ševidence-management ä¸å†éœ€è¦è¿æ¥ security-management çš„æ•°æ®åº“
- ç§»é™¤ `sys_casbin_rule` / `sys_casbin_rules` çš„è¿ç§»æ¨¡å‹ï¼ˆä¸å†éœ€è¦æœ¬åœ°è¡¨ï¼‰
- ç»Ÿä¸€è¡¨åï¼šæ¸…ç† `sys_casbin_rules`ï¼ˆå¤æ•°ï¼‰çš„æ®‹ç•™å®šä¹‰

#### 4.4.2 file-storage-service æ”¹é€ 

**å½“å‰çŠ¶æ€**ï¼šä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ `file_storage_service_db`ï¼Œ`Setup(db, "")` åŠ è½½æœ¬åœ°ç­–ç•¥ã€‚

**æ”¹é€ æ–‡ä»¶**ï¼š`file-storage-service/common/database/initialize.go`

```go
// æ”¹é€ å‰ï¼ˆå½“å‰ä»£ç ï¼‰ï¼š
e := mycasbin.Setup(db, "")  // db æ˜¯ file-storage-service è‡ªå·±çš„æ•°æ®åº“

// æ”¹é€ åï¼š
provider := grpc_client.NewGrpcCasbinPolicyProvider(connManager) // å¤ç”¨ç°æœ‰ ConnectionManager
e, err := mycasbin.SetupWithProvider(provider, tenantID)
if err != nil {
    log.Fatalf("casbin init via provider failed: %v", err)
}
```

**é™„åŠ å˜æ›´**ï¼š
- ä¸å†éœ€è¦æœ¬åœ° `sys_casbin_rule` è¡¨
- æ–°å¢ `casbin_policy_provider.go`ï¼ˆä¸ evidence-management å®ç°ç›¸åŒï¼Œéµå¾ª `userinfo_service_client.go` æ¨¡å¼ï¼‰
- æ–°å¢ proto æ–‡ä»¶ï¼š`file-storage-service/infrastructure/grpc/proto/casbin/`ï¼ˆä» security-management å¤åˆ¶ï¼‰

#### 4.4.3 tenant-service æ”¹é€ 

**å½“å‰çŠ¶æ€**ï¼šä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“ï¼Œ`Setup(db, "")` åŠ è½½æœ¬åœ°ç­–ç•¥ã€‚

**æ”¹é€ æ–‡ä»¶**ï¼š`tenant-service/common/database/initialize.go`

```go
// æ”¹é€ å‰ï¼š
e := mycasbin.Setup(db, "")

// æ”¹é€ åï¼š
provider := grpc_client.NewGrpcCasbinPolicyProvider(connManager)
e, err := mycasbin.SetupWithProvider(provider, tenantID)
if err != nil {
    log.Fatalf("casbin init via provider failed: %v", err)
}
```

**é™„åŠ å˜æ›´**ï¼š
- ä¸å†éœ€è¦æœ¬åœ° `sys_casbin_rule` è¡¨
- æ–°å¢ gRPC å®¢æˆ·ç«¯ä»£ç ï¼ˆtenant-service ç›®å‰å¯èƒ½è¿˜æ²¡æœ‰ gRPC å®¢æˆ·ç«¯åŸºç¡€è®¾æ–½ï¼Œéœ€è¦æ–°å»º `ConnectionManager`ï¼‰
- æ–°å¢ `casbin_policy_provider.go` å’Œ proto æ–‡ä»¶

---

## 5. é…ç½®å˜æ›´

### 5.1 security-management é…ç½®

åœ¨ `security-management/config/settings.yml` çš„ `grpc.server.services` ä¸­æ–°å¢ï¼š

```yaml
grpc:
  server:
    services:
      # ... ç°æœ‰æœåŠ¡ ...
      casbin_policy:
        enabled: true
        interceptors: ["logging"]  # ä¸éœ€è¦ authï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰
```

### 5.2 å¾®æœåŠ¡é…ç½®

å„å¾®æœåŠ¡çš„ gRPC å®¢æˆ·ç«¯å·²æœ‰é…ç½®ï¼ˆè¿æ¥ security-managementï¼‰ï¼Œæ— éœ€æ–°å¢é…ç½®ã€‚`CasbinPolicyService` å¤ç”¨ç°æœ‰çš„ `ConnectionManager` å’Œ ETCD æœåŠ¡å‘ç°ã€‚

> **æ³¨æ„**ï¼šç”±äºæœ¬é¡¹ç›®å°šæœªç”Ÿäº§éƒ¨ç½²ï¼Œä¸éœ€è¦ç°åº¦é…ç½®å¼€å…³ï¼ˆå¦‚ `casbin.mode`ï¼‰ã€‚æ‰€æœ‰å¾®æœåŠ¡ç›´æ¥ä¸€æ¬¡æ€§åˆ‡æ¢åˆ° `SetupWithProvider` æ–¹å¼ï¼Œæ—§çš„ `Setup(db, "")` è°ƒç”¨å’Œç›¸å…³æ•°æ®åº“é…ç½®åœ¨æ”¹é€ æ—¶ä¸€å¹¶ç§»é™¤ã€‚

### 5.3 éœ€ç§»é™¤çš„é…ç½®

æ”¹é€ å®Œæˆåï¼Œä»¥ä¸‹é…ç½®å¯ç§»é™¤ï¼š

```yaml
# evidence-management/command/config/settings.yml
# ç§»é™¤ masterDB é…ç½®ï¼ˆä¸å†éœ€è¦è¿æ¥ security-management çš„æ•°æ®åº“ï¼‰
database:
  # masterDB: â† æ•´ä¸ª masterDB èŠ‚ç‚¹å¯ç§»é™¤
  commandDB: ...  # ä¿ç•™
  queryDB: ...    # ä¿ç•™
```

> **æ³¨æ„**ï¼š`masterDB` å¯èƒ½è¿˜è¢«å…¶ä»–åŠŸèƒ½ä½¿ç”¨ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ç­‰ï¼‰ï¼Œéœ€ç¡®è®¤æ˜¯å¦æ‰€æœ‰å¯¹ `masterDB` çš„ä¾èµ–éƒ½å·²è¿ç§»åˆ° gRPC åå†ç§»é™¤ã€‚

---

## 6. é”™è¯¯å¤„ç†ä¸å®¹é”™

### 6.1 å¯åŠ¨é˜¶æ®µ

```
æœåŠ¡å¯åŠ¨
    â†’ SetupWithProvider(provider, tenantID)
        â†’ ProviderAdapter.LoadPolicy()
            â†’ GrpcCasbinPolicyProvider.GetPolicies()
                â†’ ExecuteWithNetworkRetry(gRPC GetPolicies())
                    â”œâ”€â”€ æˆåŠŸ â†’ æ­£å¸¸å¯åŠ¨
                    â”œâ”€â”€ è¶…æ—¶/ç½‘ç»œé”™è¯¯ â†’ é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼Œ3 æ¬¡ï¼‰
                    â”‚   â””â”€â”€ å…¨éƒ¨å¤±è´¥ â†’ å¯åŠ¨å¤±è´¥ï¼Œè¿›ç¨‹é€€å‡º
                    â””â”€â”€ æœåŠ¡æœªæ³¨å†Œ â†’ å¯åŠ¨å¤±è´¥ï¼Œè¿›ç¨‹é€€å‡º
```

**è®¾è®¡åŸåˆ™**ï¼šå¯åŠ¨æ—¶ç­–ç•¥åŠ è½½å¤±è´¥ä¸åšé™çº§å¤„ç†ï¼Œç›´æ¥å¤±è´¥é€€å‡ºã€‚åŸå› ï¼š
- æ²¡æœ‰ç­–ç•¥çš„æœåŠ¡ç­‰äºæ²¡æœ‰æƒé™æ§åˆ¶ï¼Œæ¯”ä¸å¯åŠ¨æ›´å±é™©
- è¿ç»´å¯ä»¥é€šè¿‡ Kubernetes é‡å¯ç­–ç•¥è‡ªåŠ¨æ¢å¤

### 6.2 è¿è¡Œæ—¶ï¼ˆRedis Watcher è§¦å‘ LoadPolicyï¼‰

```
Redis Watcher å›è°ƒ
    â†’ enforcer.LoadPolicy()
        â†’ ProviderAdapter.LoadPolicy()
            â†’ GrpcCasbinPolicyProvider.GetPolicies()
                â†’ ExecuteWithNetworkRetry(gRPC GetPolicies())
                    â”œâ”€â”€ æˆåŠŸ â†’ ç­–ç•¥æ›´æ–°å®Œæˆ
                    â””â”€â”€ å¤±è´¥ â†’ ä¿ç•™å½“å‰å†…å­˜ä¸­çš„ç­–ç•¥ï¼ˆä¸æ¸…ç©ºï¼‰
                             â†’ è®°å½•é”™è¯¯æ—¥å¿—
                             â†’ ç­‰å¾…ä¸‹æ¬¡ Watcher é€šçŸ¥é‡è¯•
```

**å…³é”®ä¿æŠ¤æœºåˆ¶**ï¼š`SyncedEnforcer.LoadPolicy()` åœ¨ Adapter è¿”å›é”™è¯¯æ—¶**ä¸ä¼šæ¸…ç©ºå†…å­˜ä¸­çš„å·²æœ‰ç­–ç•¥**ã€‚è¿™æ˜¯ Casbin v2.54.0 çš„é»˜è®¤è¡Œä¸ºâ€”â€”LoadPolicy æ–¹æ³•å…ˆè°ƒç”¨ `adapter.LoadPolicy(newModel)`ï¼Œå¦‚æœ adapter è¿”å› errorï¼Œåˆ™ä¿ç•™åŸ model ä¸æ›¿æ¢ã€‚

> **å·²éªŒè¯**ï¼šé€šè¿‡å•å…ƒæµ‹è¯•ç¡®è®¤ Casbin v2.54.0 çš„ `SyncedEnforcer.LoadPolicy()` åœ¨ adapter è¿”å› error æ—¶ä¿ç•™æ‰€æœ‰åŸç­–ç•¥ï¼ˆåŒ…æ‹¬ p ç­–ç•¥å’Œ g ç­–ç•¥ï¼‰ï¼Œä¸ä¼šæ¸…ç©ºå†…å­˜ä¸­çš„ç­–ç•¥ã€‚
>
> **æµ‹è¯•æ–‡ä»¶**ï¼š`jxt-core/sdk/pkg/casbin/load_policy_error_test.go`
> - `TestLoadPolicy_ErrorBehavior` - åŸºç¡€åœºæ™¯éªŒè¯
> - `TestLoadPolicy_ErrorBehaviorWithMultiplePolicies` - å¤šæ¡ç­–ç•¥åœºæ™¯éªŒè¯
> - `TestLoadPolicy_RBMModelWithRoleDefinition` - RBAC æ¨¡å‹ï¼ˆå«è§’è‰²ç»§æ‰¿ï¼‰éªŒè¯
>
> **éªŒè¯ç»“æœ**ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

### 6.3 gRPC è¿æ¥å¥åº·æ£€æŸ¥

å¤ç”¨ç°æœ‰ `ConnectionManager` çš„å¥åº·æ£€æŸ¥æœºåˆ¶ï¼š
- **æ£€æŸ¥é—´éš”**ï¼š30 ç§’
- **è‡ªåŠ¨é‡è¿**ï¼š5 æ¬¡é‡è¯•ï¼Œ10 ç§’é—´éš”
- **ç½‘ç»œçº§é‡è¯•**ï¼š`ExecuteWithNetworkRetry()`ï¼Œ3 æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿


---

## 7. ä¾èµ–å…³ç³»å˜æ›´

### 7.1 æ”¹é€ å‰

```
evidence-management â”€â”€DBç›´è¿â”€â”€â†’ security-management DB (securitydb)
                                â”œâ”€â”€ sys_casbin_rule
                                â”œâ”€â”€ sys_user
                                â””â”€â”€ ...

file-storage-service â”€â”€æœ¬åœ°DBâ”€â”€â†’ file_storage_service_db
                                â””â”€â”€ sys_casbin_ruleï¼ˆç‹¬ç«‹å‰¯æœ¬ï¼‰

tenant-service â”€â”€æœ¬åœ°DBâ”€â”€â†’ tenant_service_db
                          â””â”€â”€ sys_casbin_ruleï¼ˆç‹¬ç«‹å‰¯æœ¬ï¼‰
```

**é—®é¢˜**ï¼š
- evidence-management è·¨æœåŠ¡ç›´è¿æ•°æ®åº“ï¼Œè¿åå¾®æœåŠ¡è¾¹ç•Œ
- file-storage-service å’Œ tenant-service çš„ç­–ç•¥æ˜¯ç‹¬ç«‹å‰¯æœ¬ï¼Œä¸ security-management ä¸åŒæ­¥

### 7.2 æ”¹é€ å

```
evidence-management â”€â”€gRPCâ”€â”€â†’ security-management â”€â”€DBâ”€â”€â†’ å„ç§Ÿæˆ· DB
                                                          â””â”€â”€ sys_casbin_ruleï¼ˆå”¯ä¸€æ•°æ®æºï¼‰

file-storage-service â”€â”€gRPCâ”€â”€â†’ security-management â”€â”€DBâ”€â”€â†’ å„ç§Ÿæˆ· DB
                                                          â””â”€â”€ sys_casbin_ruleï¼ˆå”¯ä¸€æ•°æ®æºï¼‰

tenant-service â”€â”€gRPCâ”€â”€â†’ security-management â”€â”€DBâ”€â”€â†’ å„ç§Ÿæˆ· DB
                                                     â””â”€â”€ sys_casbin_ruleï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
```

**æ”¹è¿›**ï¼š
- æ‰€æœ‰æœåŠ¡é€šè¿‡ gRPC API è®¿é—®ç­–ç•¥ï¼Œä¸å†ç›´è¿æ•°æ®åº“
- `sys_casbin_rule` å”¯ä¸€æ•°æ®æºåœ¨ security-management çš„ç§Ÿæˆ·æ•°æ®åº“ä¸­
- å„å¾®æœåŠ¡æ— éœ€æœ¬åœ°ç­–ç•¥è¡¨

---

## 8. æµ‹è¯•è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•ç›®æ ‡ | æµ‹è¯•å†…å®¹ | æ–‡ä»¶ä½ç½® |
|----------|----------|----------|
| `ProviderAdapter.LoadPolicy()` | Mock `PolicyProvider`ï¼ŒéªŒè¯ç­–ç•¥æ­£ç¡®åŠ è½½åˆ° model | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |
| `policyRuleToLine()` | å„ç§ç­–ç•¥æ ¼å¼è½¬æ¢ï¼ˆp/gç±»å‹ï¼Œç©ºå­—æ®µå¤„ç†ï¼‰ | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |
| `GrpcCasbinPolicyProvider.GetPolicies()` | Mock gRPC clientï¼ŒéªŒè¯ proto â†’ PolicyRule è½¬æ¢å’Œç½‘ç»œé‡è¯• | `evidence-management/shared/infrastructure/grpc/client/casbin_policy_provider_test.go` |
| `CasbinPolicyServer.GetPolicies()` | Mock repositoryï¼ŒéªŒè¯å¤šç§Ÿæˆ·è·¯ç”±å’Œå“åº”æ ¼å¼ | `security-management/admin/interface/grpc/casbin/casbin_policy_server_test.go` |
| `GormCasbinRuleRepository.FindAll()` | éªŒè¯æ­£ç¡®æŸ¥è¯¢ç§Ÿæˆ·æ•°æ®åº“ | `security-management/admin/infrastructure/persistence/gorm/casbin_rule_repository_test.go` |
| ç­–ç•¥æ ¼å¼è¾¹ç•Œæµ‹è¯• | V0-V5 å„ç§ç©ºå€¼ç»„åˆï¼ˆå…¨ç©ºã€ä»… V0ã€V0-V2ã€å…¨å¡«å……ï¼‰ï¼›`g` ç±»å‹ä¸¤å­—æ®µè§„åˆ™ï¼›éªŒè¯ `policyRuleToLine` è¾“å‡ºä¸ gormAdapter ä¸€è‡´ | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |
| å¤šç§Ÿæˆ·å¹¶å‘æµ‹è¯• | åŒæ—¶ä¸ºå¤šä¸ªç§Ÿæˆ·ï¼ˆâ‰¥3ï¼‰è°ƒç”¨ `SetupWithProvider`ï¼ŒéªŒè¯å„ç§Ÿæˆ· enforcer å®ä¾‹éš”ç¦»ã€ç­–ç•¥ä¸äº¤å‰ | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |
| gRPC è¶…æ—¶æµ‹è¯• | Mock `PolicyProvider` å»¶è¿Ÿè¶…è¿‡ 5 ç§’ï¼ŒéªŒè¯ `ProviderAdapter.LoadPolicy()` è¿”å› `context deadline exceeded` é”™è¯¯ | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |
| Watcher å›è°ƒé‡è¯•æµ‹è¯• | æ¨¡æ‹Ÿ `LoadPolicy()` è¿ç»­å¤šæ¬¡å¤±è´¥ï¼ˆProvider è¿”å› errorï¼‰ï¼ŒéªŒè¯ Watcher å›è°ƒä¸ panicã€å·²æœ‰ç­–ç•¥ä¿ç•™ã€ä¸‹æ¬¡é€šçŸ¥ä»ä¼šè§¦å‘é‡è¯• | `jxt-core/sdk/pkg/casbin/provider_adapter_test.go` |

### 8.2 é›†æˆæµ‹è¯•

| æµ‹è¯•åœºæ™¯ | éªŒè¯å†…å®¹ |
|----------|----------|
| å¯åŠ¨åŠ è½½ | å¾®æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡ gRPC æˆåŠŸåŠ è½½ç­–ç•¥ |
| æƒé™å˜æ›´åŒæ­¥ | security-management ä¿®æ”¹æƒé™ â†’ Redis é€šçŸ¥ â†’ å¾®æœåŠ¡é‡æ–°åŠ è½½ â†’ æƒé™ç”Ÿæ•ˆ |
| å¤šç§Ÿæˆ·éš”ç¦» | ç§Ÿæˆ· A çš„ç­–ç•¥å˜æ›´ä¸å½±å“ç§Ÿæˆ· B |
| gRPC è¶…æ—¶ | security-management å“åº”è¶…æ—¶æ—¶çš„é”™è¯¯å¤„ç† |
| æœåŠ¡é‡å¯ | security-management é‡å¯åå¾®æœåŠ¡è‡ªåŠ¨é‡è¿å¹¶åŠ è½½ç­–ç•¥ |

### 8.3 æ€§èƒ½æµ‹è¯•

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| `GetPolicies` å“åº”æ—¶é—´ | P99 < 100msï¼ˆ1000æ¡ç­–ç•¥ï¼‰ | å‹æµ‹å·¥å…·ï¼ˆghz/grpcurlï¼‰ |
| `LoadPolicy` ç«¯åˆ°ç«¯æ—¶é—´ | < 500msï¼ˆå«ç½‘ç»œï¼‰ | å¾®æœåŠ¡æ—¥å¿—è®¡æ—¶ |
| å¹¶å‘åŠ è½½ | 10 ä¸ªå¾®æœåŠ¡å®ä¾‹åŒæ—¶ LoadPolicy | å¹¶å‘æµ‹è¯• |

---

## 9. è¿ç§»è®¡åˆ’

> **è¯´æ˜**ï¼šç”±äºæœ¬é¡¹ç›®å°šæœªç”Ÿäº§éƒ¨ç½²ï¼Œä¸éœ€è¦ç°åº¦å‘å¸ƒæˆ–åˆ†é˜¶æ®µè¯•ç‚¹ã€‚ä»¥ä¸‹è¿ç§»è®¡åˆ’é‡‡ç”¨**ä¸¤é˜¶æ®µä¸€æ¬¡æ€§åˆ‡æ¢**ç­–ç•¥ã€‚

### 9.1 é˜¶æ®µåˆ’åˆ†

```
é˜¶æ®µ 1: åŸºç¡€è®¾æ–½å»ºè®¾              é˜¶æ®µ 2: å…¨é‡åˆ‡æ¢ + æ¸…ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘  jxt-core æ–°å¢            â”‚   â”‚ â‘£ evidence-management     â”‚
â”‚   PolicyProvider          â”‚   â”‚   åˆ‡æ¢åˆ° Provider æ¨¡å¼     â”‚
â”‚   ProviderAdapter         â”‚   â”‚   ç§»é™¤ masterDB é…ç½®       â”‚
â”‚   SetupWithProvider       â”‚   â”‚                           â”‚
â”‚                           â”‚   â”‚ â‘¤ file-storage-service    â”‚
â”‚ â‘¡ security-management     â”‚   â”‚   åˆ‡æ¢åˆ° Provider æ¨¡å¼     â”‚
â”‚   æ–°å¢ gRPC æœåŠ¡ç«¯          â”‚   â”‚   ç§»é™¤æœ¬åœ° sys_casbin_rule â”‚
â”‚                           â”‚   â”‚                           â”‚
â”‚ â‘¢ éªŒè¯ gRPC æ¥å£           â”‚   â”‚ â‘¥ tenant-service          â”‚
â”‚                           â”‚   â”‚   åˆ‡æ¢åˆ° Provider æ¨¡å¼     â”‚
â”‚                           â”‚   â”‚                           â”‚
â”‚                           â”‚   â”‚ â‘¦ æ¸…ç†æ—§ä»£ç                â”‚
â”‚                           â”‚   â”‚   ç§»é™¤åºŸå¼ƒçš„ Setup() è°ƒç”¨   â”‚
â”‚                           â”‚   â”‚   ç§»é™¤æœ¬åœ°ç­–ç•¥è¡¨è¿ç§»æ¨¡å‹     â”‚
â”‚                           â”‚   â”‚                           â”‚
â”‚                           â”‚   â”‚ â‘§ å›å½’æµ‹è¯•                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         1-2 å‘¨                          1-2 å‘¨
```

### 9.2 å„é˜¶æ®µè¯¦æƒ…

#### é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½å»ºè®¾ï¼ˆ1-2 å‘¨ï¼‰

| æ­¥éª¤ | å†…å®¹ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| â‘  jxt-core SDK | æ–°å¢ `PolicyProvider`ã€`ProviderAdapter`ã€`SetupWithProvider` | å•å…ƒæµ‹è¯•é€šè¿‡ |
| â‘¡ security-management gRPC æœåŠ¡ç«¯ | æ–°å¢ protoã€Repositoryã€Serverã€DI | å•å…ƒæµ‹è¯• + gRPC æ‰‹åŠ¨è°ƒç”¨æµ‹è¯• |
| â‘¢ éªŒè¯ gRPC æ¥å£ | éƒ¨ç½² security-managementï¼Œç”¨ `grpcurl` éªŒè¯æ¥å£ | `grpcurl -d '{"tenant_id": 1}' localhost:9000 casbin.CasbinPolicyService/GetPolicies` |

**é˜¶æ®µ 1 å®Œæˆæ ‡å‡†**ï¼š`GetPolicies` æ¥å£è¿”å›æ­£ç¡®çš„ç­–ç•¥æ•°æ®ï¼Œå¤šç§Ÿæˆ·è·¯ç”±æ­£ç¡®ã€‚

#### é˜¶æ®µ 2ï¼šå…¨é‡åˆ‡æ¢ + æ¸…ç†ï¼ˆ1-2 å‘¨ï¼‰

| æ­¥éª¤ | å†…å®¹ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| â‘£ evidence-management | æ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)`ï¼Œç§»é™¤ `masterDB` é…ç½® | é›†æˆæµ‹è¯• |
| â‘¤ file-storage-service | æ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)`ï¼Œç§»é™¤æœ¬åœ° `sys_casbin_rule` è¡¨ | é›†æˆæµ‹è¯• |
| â‘¥ tenant-service | æ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)`ï¼Œæ–°å»º gRPC å®¢æˆ·ç«¯åŸºç¡€è®¾æ–½ï¼ˆå¦‚éœ€è¦ï¼‰ | é›†æˆæµ‹è¯• |
| â‘¦ æ¸…ç†æ—§ä»£ç  | ç§»é™¤åºŸå¼ƒçš„ `Setup()` è°ƒç”¨ã€æœ¬åœ°ç­–ç•¥è¡¨è¿ç§»æ¨¡å‹ã€`masterDB` æ®‹ç•™å¼•ç”¨ | ä»£ç å®¡æŸ¥ |
| â‘§ å›å½’æµ‹è¯• | å…¨éƒ¨æœåŠ¡å®Œæ•´æƒé™åŠŸèƒ½å›å½’ | Ginkgo æµ‹è¯•å¥—ä»¶ï¼ˆ115+ ç”¨ä¾‹ï¼‰+ æ‰‹åŠ¨æµ‹è¯• |

**é˜¶æ®µ 2 å®Œæˆæ ‡å‡†**ï¼šæ‰€æœ‰å¾®æœåŠ¡é€šè¿‡ `SetupWithProvider` åŠ è½½ç­–ç•¥ï¼Œæ—§çš„æ•°æ®åº“ç›´è¿ä»£ç å’Œé…ç½®å·²å…¨éƒ¨æ¸…ç†ã€‚

---

## 10. é£é™©ä¸ç¼“è§£æªæ–½

| # | é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|---|------|------|------|----------|
| 1 | security-management æˆä¸ºç­–ç•¥åŠ è½½ç“¶é¢ˆ | æ‰€æœ‰å¾®æœåŠ¡çš„ `LoadPolicy()` ä¾èµ–å•ä¸€æœåŠ¡ | ä½ | `LoadPolicy()` æ˜¯ä½é¢‘æ“ä½œï¼ˆå¯åŠ¨ + æƒé™å˜æ›´ï¼‰ï¼Œä¸æ˜¯é«˜å¹¶å‘åœºæ™¯ã€‚ç›‘æ§ gRPC è¯·æ±‚é‡å’Œå»¶è¿Ÿ |
| 2 | security-management ä¸å¯ç”¨ | å¾®æœåŠ¡æ— æ³•åŠ è½½æ–°ç­–ç•¥ | ä½ | è¿è¡Œæ—¶ä¿ç•™å·²æœ‰ç­–ç•¥ä¸æ¸…ç©ºï¼›å¯åŠ¨æ—¶ Kubernetes é‡å¯ç­–ç•¥å…œåº•ï¼›å¤šå‰¯æœ¬éƒ¨ç½² |
| 3 | gRPC ç½‘ç»œåˆ†åŒº | ç­–ç•¥æ›´æ–°å»¶è¿Ÿ | ä½ | å¤ç”¨ `ConnectionManager` è‡ªåŠ¨é‡è¿ï¼›Redis Watcher ä¸‹æ¬¡é€šçŸ¥é‡è¯• |
| 4 | å¤šç§Ÿæˆ·è·¯ç”±é”™è¯¯ | åŠ è½½äº†é”™è¯¯ç§Ÿæˆ·çš„ç­–ç•¥ | æä½ | å¤ç”¨å·²éªŒè¯çš„ `GormRepository.GetOrm(ctx)` æ¨¡å¼ï¼›é›†æˆæµ‹è¯•è¦†ç›–å¤šç§Ÿæˆ·åœºæ™¯ |
| 5 | `persist.LoadPolicyLine` æ ¼å¼ä¸å…¼å®¹ | ç­–ç•¥åŠ è½½å¤±è´¥ | æä½ | å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰ `p_type` å’Œå­—æ®µç»„åˆï¼›ä¸ gormAdapter çš„è¾“å‡ºæ ¼å¼å¯¹æ¯”éªŒè¯ |
| 6 | Casbin ç‰ˆæœ¬å‡çº§å¯¼è‡´è¡Œä¸ºå˜åŒ– | `LoadPolicy` é”™è¯¯æ—¶å¯èƒ½æ¸…ç©ºç­–ç•¥ | ä½ | é”å®š Casbin v2.54.0 ç‰ˆæœ¬ï¼›å‡çº§å‰éªŒè¯ `LoadPolicy` é”™è¯¯å¤„ç†è¡Œä¸º |

---

## 11. ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 11.1 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ¥æº | å‘Šè­¦é˜ˆå€¼ |
|------|------|----------|
| `grpc_casbin_get_policies_duration_seconds` | security-management | P99 > 500ms |
| `grpc_casbin_get_policies_error_total` | security-management | > 0/minï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰ |
| `casbin_load_policy_duration_seconds` | å„å¾®æœåŠ¡ | P99 > 1s |
| `casbin_load_policy_error_total` | å„å¾®æœåŠ¡ | > 0/minï¼ˆæŒç»­ 5 åˆ†é’Ÿï¼‰ |
| `casbin_policy_count` | å„å¾®æœåŠ¡ï¼ˆåŠ è½½åç»Ÿè®¡ï¼‰ | çªé™ > 50% |

### 11.2 æ—¥å¿—è§„èŒƒ

```
# æˆåŠŸåŠ è½½
INFO  [casbin] tenant=5 policies_loaded=238 duration=45ms source=grpc

# åŠ è½½å¤±è´¥ï¼ˆè¿è¡Œæ—¶ï¼‰
ERROR [casbin] tenant=5 action=reload error="grpc GetPolicies failed: context deadline exceeded" policies_retained=238

# åŠ è½½å¤±è´¥ï¼ˆå¯åŠ¨æ—¶ï¼‰
FATAL [casbin] tenant=5 action=init error="grpc GetPolicies failed: connection refused" retry=5/5
```

### 11.3 å¥åº·æ£€æŸ¥ç«¯ç‚¹

å„å¾®æœåŠ¡çš„å¥åº·æ£€æŸ¥åº”åŒ…å« Casbin çŠ¶æ€ï¼š

```json
{
  "status": "healthy",
  "components": {
    "casbin": {
      "status": "healthy",
      "last_load": "2026-02-08T10:30:00Z",
      "policy_count": 238,
      "source": "grpc"
    }
  }
}
```

---

## 12. æ€»ç»“

### 12.1 æ ¸å¿ƒå˜æ›´ä¸€è§ˆ

| ç»„ä»¶ | å˜æ›´å†…å®¹ | å½±å“èŒƒå›´ |
|------|----------|----------|
| **jxt-core** | æ–°å¢ `PolicyProvider` æ¥å£ã€`ProviderAdapter`ã€`SetupWithProvider`ï¼›æå– `setupRedisWatcherForEnforcer` | å…±äº«åº“ |
| **security-management** | æ–°å¢ CasbinPolicyService gRPC æœåŠ¡ç«¯ | æœåŠ¡ç«¯ |
| **evidence-management** | æ–°å¢ `GrpcCasbinPolicyProvider`ï¼Œæ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)`ï¼Œç§»é™¤ `masterDB` | å®¢æˆ·ç«¯ |
| **file-storage-service** | æ–°å¢ `GrpcCasbinPolicyProvider`ï¼Œæ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)` | å®¢æˆ·ç«¯ |
| **tenant-service** | æ–°å¢ `GrpcCasbinPolicyProvider`ï¼Œæ›¿æ¢ `Setup(db)` â†’ `SetupWithProvider(provider)` | å®¢æˆ·ç«¯ |

### 12.2 æ–¹æ¡ˆä¼˜åŠ¿

1. **æ¶ˆé™¤è·¨æœåŠ¡æ•°æ®åº“ç›´è¿**ï¼ševidence-management ä¸å†ç›´è¿ security-management çš„ securitydb
2. **ç­–ç•¥æ•°æ®å•ä¸€æ¥æº**ï¼šæ‰€æœ‰æœåŠ¡ä» security-management è·å–ç­–ç•¥ï¼Œæ¶ˆé™¤æ•°æ®ä¸ä¸€è‡´
3. **å¤šç§Ÿæˆ·å®Œæ•´æ”¯æŒ**ï¼šgRPC æ¥å£æŒ‰ `tenant_id` è·¯ç”±ï¼Œä¸ç°æœ‰å¤šç§Ÿæˆ·æ¶æ„ä¸€è‡´
4. **æœ€å°åŒ–å˜æ›´**ï¼šåªå½±å“ `LoadPolicy()` åº•å±‚å®ç°ï¼Œ`Enforce()` å’Œ Redis Watcher æœºåˆ¶ä¸å˜
5. **å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**ï¼šgRPC ç«¯å£ 9000ã€`ConnectionManager`ã€ETCD æœåŠ¡å‘ç°ã€DI å®¹å™¨
6. **ä¸€æ¬¡æ€§åˆ‡æ¢**ï¼šé¡¹ç›®å°šæœªç”Ÿäº§éƒ¨ç½²ï¼Œæ— éœ€ç°åº¦è¿‡æ¸¡ï¼Œç›´æ¥æ›¿æ¢æ—§ä»£ç ï¼Œå‡å°‘ç»´æŠ¤è´Ÿæ‹…