# 租户服务数据库密码加密存储方案

**文档版本**: v1.0
**创建日期**: 2026-02-03
**状态**: 设计中

## 1. 问题描述

当前 `PublishTenantServiceDatabaseConfig` 方法发布到 etcd 的数据库配置**不包含密码**，导致其他微服务无法从 etcd 获取完整的数据库连接信息。

### 1.1 当前代码问题

**文件**: `distribution/application/service/etcd_publisher.go:537-551`

```go
// 注意：不发布加密后的连接字符串，只发布基本信息
// 微服务需要时从数据库获取完整配置（包括加密的密码）
data := map[string]interface{}{
    "tenantId":     cfg.GetTenantId(),
    "serviceCode":  cfg.GetServiceCode(),
    "driver":       cfg.GetDriver(),
    "host":         cfg.GetHost(),
    "port":         cfg.GetPort(),
    "database":     cfg.GetDatabase(),
    "username":     cfg.GetUsername(),
    "sslMode":      cfg.GetSSLMode(),
    "maxOpenConns": cfg.GetMaxOpenConns(),
    "maxIdleConns": cfg.GetMaxIdleConns(),
    // 注意：密码不发布到 etcd，需要密码的服务应通过内部API获取
}
```

### 1.2 影响范围

| 影响项 | 描述 |
|-------|------|
| 微服务 | 无法从 etcd 获取数据库密码，无法建立连接 |
| jxt-core | Provider 无法获取完整数据库配置 |
| 系统架构 | etcd 作为配置中心的功能不完整 |

## 2. 解决方案设计

### 方案选择

| 方案 | 描述 | 优势 | 劣势 | 推荐度 |
|-----|------|------|------|--------|
| **方案1** | 在 etcd 中发布加密密码 | 配置完整，减少依赖 | 需要密钥共享机制 | ⭐⭐⭐⭐⭐ |
| 方案2 | 通过内部 API 获取密码 | 密钥集中管理 | 增加服务依赖，性能问题 | ⭐⭐ |
| 方案3 | 使用 Kubernetes Secrets | 原生支持 | 需要额外配置系统 | ⭐⭐⭐ |

**推荐方案1：在 etcd 中发布加密后的密码**

### 2.1 方案1架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      密码加密存储流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐    │
│  │  创建/更新    │ --> │  AES-GCM     │ --> │  存储到DB     │    │
│  │  配置        │     │  加密        │     │  (加密)       │    │
│  └──────────────┘     └──────────────┘     └──────────────┘    │
│                                                         │        │
│                                                         v        │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐    │
│  │  发布到etcd   │ <-- │  获取加密    │ <-- │  从DB读取     │    │
│  │  (含加密密码) │     │  密码        │     │  配置         │    │
│  └──────────────┘     └──────────────┘     └──────────────┘    │
│                                                         │        │
│                                                         v        │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐    │
│  │  微服务读取   │ --> │  AES-GCM     │ --> │  建立DB连接   │    │
│  │  etcd配置     │     │  解密        │     │              │    │
│  └──────────────┘     └──────────────┘     └──────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 实施步骤

### 3.1 步骤1：添加获取加密密码的方法

**文件**: `tenant/domain/aggregate/tenant_service_database_config.go`

```go
// GetPasswordEncrypted 获取加密后的密码（用于发布到etcd）
// 返回值是已经通过 AES-GCM 加密的 Base64 编码字符串
func (c *TenantServiceDatabaseConfig) GetPasswordEncrypted() string {
	return c.Password
}

// HasPassword 检查是否已设置密码
func (c *TenantServiceDatabaseConfig) HasPassword() bool {
	return c.Password != ""
}
```

### 3.2 步骤2：更新 Publisher 接口

**文件**: `distribution/application/service/etcd_publisher.go`

修改 `serviceConfig` 接口，添加 `GetPasswordEncrypted()` 方法：

```go
type serviceConfig interface {
    GetTenantId() int
    GetServiceCode() string
    GetDriver() string
    GetHost() string
    GetPort() int
    GetDatabase() string
    GetUsername() string
    GetSSLMode() string
    GetMaxOpenConns() int
    GetMaxIdleConns() int
    GetPasswordEncrypted() string  // 新增：获取加密后的密码
}
```

### 3.3 步骤3：修改发布逻辑

**文件**: `distribution/application/service/etcd_publisher.go`

```go
func (p *EtcdPublisher) PublishTenantServiceDatabaseConfig(ctx context.Context, config interface{}) error {
    if p.client == nil {
        logger.Warn("etcd client not available, skip publishing tenant service database config")
        return nil
    }

    cfg, ok := config.(serviceConfig)
    if !ok {
        return fmt.Errorf("invalid config type for tenant service database config")
    }

    key := fmt.Sprintf("/tenants/%d/database/%s", cfg.GetTenantId(), cfg.GetServiceCode())

    // 构建配置数据（包含加密后的密码）
    data := map[string]interface{}{
        "tenantId":        cfg.GetTenantId(),
        "serviceCode":     cfg.GetServiceCode(),
        "driver":          cfg.GetDriver(),
        "host":            cfg.GetHost(),
        "port":            cfg.GetPort(),
        "database":        cfg.GetDatabase(),
        "username":        cfg.GetUsername(),
        "password":        cfg.GetPasswordEncrypted(),  // 加密后的密码
        "sslMode":         cfg.GetSSLMode(),
        "maxOpenConns":    cfg.GetMaxOpenConns(),
        "maxIdleConns":    cfg.GetMaxIdleConns(),
        "passwordEncrypted": true,  // 标识字段，表示密码已加密
    }

    value, err := json.Marshal(data)
    if err != nil {
        return fmt.Errorf("failed to marshal tenant service database config: %w", err)
    }

    if err := p.client.Put(ctx, key, string(value)); err != nil {
        return fmt.Errorf("failed to publish tenant service database config to etcd: %w", err)
    }

    logger.Info("tenant service database config published to etcd",
        zap.Int("tenantId", cfg.GetTenantId()),
        zap.String("serviceCode", cfg.GetServiceCode()),
        zap.Bool("hasPassword", cfg.GetPasswordEncrypted() != ""))

    return nil
}
```

### 3.4 步骤4：更新 jxt-core Provider

**文件**: `jxt-core/sdk/pkg/tenant/provider/models.go`

```go
// ServiceDatabaseConfig 服务级数据库配置
type ServiceDatabaseConfig struct {
    TenantID       int    `json:"tenantId"`
    ServiceCode    string `json:"serviceCode"`
    Driver         string `json:"driver"`
    Host           string `json:"host"`
    Port           int    `json:"port"`
    Database       string `json:"database"`
    Username       string `json:"username"`
    Password       string `json:"password"`        // 加密后的密码
    SSLMode        string `json:"sslMode"`
    MaxOpenConns   int    `json:"maxOpenConns"`
    MaxIdleConns   int    `json:"maxIdleConns"`
    PasswordEncrypted bool `json:"passwordEncrypted"` // 密码加密标识
}
```

### 3.5 步骤5：微服务端解密逻辑

**微服务需要使用相同的密钥解密密码：**

```go
// 在微服务中
import "jxt-evidence-system/jxt-core/pkg/crypto"

func GetDatabaseConfigFromEtcd(tenantID int, serviceCode string) (*DatabaseConfig, error) {
    // 1. 从 jxt-core Provider 获取配置
    config, err := provider.GetServiceDatabaseConfig(tenantID, serviceCode)
    if err != nil {
        return nil, err
    }

    // 2. 解密密码
    cryptoService := crypto.NewDefaultCryptoService()  // 使用相同的密钥
    password, err := cryptoService.Decrypt(config.Password)
    if err != nil {
        return nil, fmt.Errorf("failed to decrypt password: %w", err)
    }

    // 3. 构建数据库连接
    dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s",
        config.Username, password, config.Host, config.Port, config.Database)

    return &DatabaseConfig{DSN: dsn}, nil
}
```

## 4. 密钥管理策略

### 4.1 密钥来源

**当前实现**: `common/crypto/crypto.go`

```go
const (
    // 默认密钥（生产环境应从环境变量获取）
    defaultEncryptionKey = "12345678901234567890123456789012"  // 32 bytes for AES-256
)

// 从环境变量获取密钥
func getEncryptionKey() string {
    if key := os.Getenv("ENCRYPTION_KEY"); key != "" {
        return key
    }
    return defaultEncryptionKey
}
```

### 4.2 密钥共享要求

| 服务 | 密钥要求 | 说明 |
|-----|---------|------|
| tenant-service | ✅ 必需 | 加密存储密码 |
| jxt-core | ✅ 必需 | 解密密码给微服务使用 |
| evidence-command | ✅ 必需 | 连接命令数据库 |
| evidence-query | ✅ 必需 | 连接查询数据库 |
| file-storage | ✅ 必需 | 连接存储数据库 |
| security-management | ✅ 必需 | 连接安全数据库 |

### 4.3 密钥配置方式

**方式1：环境变量（推荐）**
```bash
export ENCRYPTION_KEY="your-32-byte-encryption-key-here"
```

**方式2：配置文件**
```yaml
# config/settings.yml
encryption:
  key: "your-32-byte-encryption-key-here"
```

**方式3：密钥管理服务（生产环境推荐）**
- HashiCorp Vault
- AWS KMS
- Azure Key Vault

## 5. 安全考虑

### 5.1 加密算法

**当前**: AES-256-GCM
**密钥长度**: 32 bytes (256 bits)
**Base64 编码**: 用于 etcd 存储

### 5.2 访问控制

1. **etcd 访问控制**: 限制只有授权服务才能读取 `/tenants/*/database/*` 路径
2. **网络隔离**: etcd 应在内部网络中访问
3. **审计日志**: 记录所有密码解密操作

### 5.3 密钥轮换

**建议**: 每 90-180 天轮换一次密钥

**轮换流程**:
1. 生成新密钥
2. 使用新密钥加密新密码
3. 重新发布所有租户配置到 etcd
4. 更新所有微服务的密钥
5. 删除旧密钥

## 6. 验收标准

### 6.1 功能验收

- [ ] etcd 中包含 `password` 字段（加密后）
- [ ] `passwordEncrypted` 标识为 `true`
- [ ] 微服务可以解密并连接数据库
- [ ] 单元测试通过

### 6.2 安全验收

- [ ] 密码以加密形式存储在 etcd
- [ ] 明文密码不在日志中出现
- [ ] 密钥通过环境变量配置

### 6.3 兼容性验收

- [ ] 现有租户配置自动重新发布
- [ ] jxt-core 正确解析新格式
- [ ] 所有微服务正常连接

## 7. 回滚计划

如果实施出现问题，按以下步骤回滚：

1. 恢复 `etcd_publisher.go` 到修改前版本
2. 重新发布配置（不含密码）
3. 微服务使用原 API 获取密码的方式

## 8. 相关文档

- [02-新格式设计.md](./02-新格式设计.md)
- [03-实施计划.md](./03-实施计划.md)
- [05-jxt-core适配指南.md](./05-jxt-core适配指南.md)
